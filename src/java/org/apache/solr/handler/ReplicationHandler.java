begin_unit
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_package
DECL|package|org.apache.solr.handler
package|package
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
package|;
end_package
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|httpclient
operator|.
name|HttpClient
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|IndexCommit
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|ModifiableSolrParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|SolrParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|FastOutputStream
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|NamedList
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|SimpleOrderedMap
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|core
operator|.
name|CloseHook
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|core
operator|.
name|IndexDeletionPolicyWrapper
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|core
operator|.
name|SolrCore
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|core
operator|.
name|SolrEventListener
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|request
operator|.
name|BinaryQueryResponseWriter
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|request
operator|.
name|SolrQueryRequest
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|request
operator|.
name|SolrQueryResponse
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|search
operator|.
name|SolrIndexSearcher
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|RefCounted
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|plugin
operator|.
name|SolrCoreAware
import|;
end_import
begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import
begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|*
import|;
end_import
begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|ByteBuffer
import|;
end_import
begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|channels
operator|.
name|FileChannel
import|;
end_import
begin_import
import|import
name|java
operator|.
name|text
operator|.
name|NumberFormat
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|*
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|locks
operator|.
name|ReentrantLock
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|zip
operator|.
name|Adler32
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|zip
operator|.
name|Checksum
import|;
end_import
begin_comment
comment|/**  *<p> A Handler which provides a REST API for replication and serves replication requests from Slaves.  *<p/>  *</p>  *<p>When running on the master, it provides the following commands  *<ol>  *<li>Get the current replicatable index version (command=indexversion)</li>  *<li>Get the list of files for a given index version (command=filelist&amp;indexversion=&lt;VERSION&gt;)</li>  *<li>Get full or a part (chunk) of a given index or a config file (command=filecontent&amp;file=&lt;FILE_NAME&gt;)  * You can optionally specify an offset and length to get that chunk of the file.  * You can request a configuration file by using "cf" parameter instead of the "file" parameter.</li>  *<li>Get status/statistics (command=details)</li>  *</ol>  *</p>  *<p>When running on the slave, it provides the following commands  *<ol>  *<li>Perform a snap pull now (command=snappull)</li>  *<li>Get status/statistics (command=details)</li>  *<li>Abort a snap pull (command=abort)</li>  *<li>Enable/Disable polling the master for new versions (command=enablepoll or command=disablepoll)</li>  *</ol>  *</p>  *  * @version $Id$  * @since solr 1.4  */
end_comment
begin_class
DECL|class|ReplicationHandler
specifier|public
class|class
name|ReplicationHandler
extends|extends
name|RequestHandlerBase
implements|implements
name|SolrCoreAware
block|{
DECL|field|LOG
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|ReplicationHandler
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|core
specifier|private
name|SolrCore
name|core
decl_stmt|;
DECL|field|snapPuller
specifier|private
name|SnapPuller
name|snapPuller
decl_stmt|;
DECL|field|snapPullLock
specifier|private
name|ReentrantLock
name|snapPullLock
init|=
operator|new
name|ReentrantLock
argument_list|()
decl_stmt|;
DECL|field|includeConfFiles
specifier|private
name|List
argument_list|<
name|String
argument_list|>
name|includeConfFiles
decl_stmt|;
DECL|field|isMaster
specifier|private
name|boolean
name|isMaster
init|=
literal|false
decl_stmt|;
DECL|field|isSlave
specifier|private
name|boolean
name|isSlave
init|=
literal|false
decl_stmt|;
DECL|field|replicateOnOptimize
specifier|private
name|boolean
name|replicateOnOptimize
init|=
literal|false
decl_stmt|;
DECL|field|replicateOnCommit
specifier|private
name|boolean
name|replicateOnCommit
init|=
literal|false
decl_stmt|;
DECL|field|numTimesReplicated
specifier|private
name|int
name|numTimesReplicated
init|=
literal|0
decl_stmt|;
DECL|field|confFileInfoCache
specifier|private
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
name|confFileInfoCache
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|FileInfo
argument_list|>
argument_list|()
decl_stmt|;
DECL|field|reserveCommitDuration
specifier|private
name|Integer
name|reserveCommitDuration
init|=
name|SnapPuller
operator|.
name|readInterval
argument_list|(
literal|"00:00:10"
argument_list|)
decl_stmt|;
DECL|field|indexCommitPoint
specifier|private
specifier|volatile
name|IndexCommit
name|indexCommitPoint
decl_stmt|;
DECL|method|handleRequestBody
specifier|public
name|void
name|handleRequestBody
parameter_list|(
name|SolrQueryRequest
name|req
parameter_list|,
name|SolrQueryResponse
name|rsp
parameter_list|)
throws|throws
name|Exception
block|{
name|rsp
operator|.
name|setHttpCaching
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|SolrParams
name|solrParams
init|=
name|req
operator|.
name|getParams
argument_list|()
decl_stmt|;
name|String
name|command
init|=
name|solrParams
operator|.
name|get
argument_list|(
name|COMMAND
argument_list|)
decl_stmt|;
if|if
condition|(
name|command
operator|==
literal|null
condition|)
block|{
name|rsp
operator|.
name|add
argument_list|(
literal|"status"
argument_list|,
literal|"OK"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// This command does not give the current index version of the master
comment|// It gives the current 'replicateable' index version
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_INDEX_VERSION
argument_list|)
condition|)
block|{
name|IndexCommit
name|commitPoint
init|=
name|indexCommitPoint
decl_stmt|;
comment|// make a copy so it won't change
if|if
condition|(
name|commitPoint
operator|!=
literal|null
condition|)
block|{
name|rsp
operator|.
name|add
argument_list|(
name|CMD_INDEX_VERSION
argument_list|,
name|commitPoint
operator|.
name|getVersion
argument_list|()
argument_list|)
expr_stmt|;
name|rsp
operator|.
name|add
argument_list|(
name|GENERATION
argument_list|,
name|commitPoint
operator|.
name|getGeneration
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// This happens when replication is not configured to happen after startup and no commit/optimize
comment|// has happened yet.
name|rsp
operator|.
name|add
argument_list|(
name|CMD_INDEX_VERSION
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|rsp
operator|.
name|add
argument_list|(
name|GENERATION
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_GET_FILE
argument_list|)
condition|)
block|{
name|getFileStream
argument_list|(
name|solrParams
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_GET_FILE_LIST
argument_list|)
condition|)
block|{
name|getFileList
argument_list|(
name|solrParams
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_SNAP_SHOOT
argument_list|)
condition|)
block|{
name|doSnapShoot
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_SNAP_PULL
argument_list|)
condition|)
block|{
name|doSnapPull
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_DISABLE_POLL
argument_list|)
condition|)
block|{
if|if
condition|(
name|snapPuller
operator|!=
literal|null
condition|)
name|snapPuller
operator|.
name|disablePoll
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_ENABLE_POLL
argument_list|)
condition|)
block|{
if|if
condition|(
name|snapPuller
operator|!=
literal|null
condition|)
name|snapPuller
operator|.
name|enablePoll
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_ABORT_SNAP_PULL
argument_list|)
condition|)
block|{
if|if
condition|(
name|snapPuller
operator|!=
literal|null
condition|)
name|snapPuller
operator|.
name|abortPull
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_FILE_CHECKSUM
argument_list|)
condition|)
block|{
comment|// this command is not used by anyone
name|getFileChecksum
argument_list|(
name|solrParams
argument_list|,
name|rsp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_SHOW_COMMITS
argument_list|)
condition|)
block|{
name|rsp
operator|.
name|add
argument_list|(
name|CMD_SHOW_COMMITS
argument_list|,
name|getCommits
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|command
operator|.
name|equals
argument_list|(
name|CMD_DETAILS
argument_list|)
condition|)
block|{
name|getReplicationDetails
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getCommits
specifier|private
name|List
argument_list|<
name|NamedList
argument_list|>
name|getCommits
parameter_list|()
block|{
name|Map
argument_list|<
name|Long
argument_list|,
name|IndexCommit
argument_list|>
name|commits
init|=
name|core
operator|.
name|getDeletionPolicy
argument_list|()
operator|.
name|getCommits
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|NamedList
argument_list|>
name|l
init|=
operator|new
name|ArrayList
argument_list|<
name|NamedList
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|IndexCommit
name|c
range|:
name|commits
operator|.
name|values
argument_list|()
control|)
block|{
try|try
block|{
name|NamedList
name|nl
init|=
operator|new
name|NamedList
argument_list|()
decl_stmt|;
name|nl
operator|.
name|add
argument_list|(
name|CMD_INDEX_VERSION
argument_list|,
name|c
operator|.
name|getVersion
argument_list|()
argument_list|)
expr_stmt|;
name|nl
operator|.
name|add
argument_list|(
name|GENERATION
argument_list|,
name|c
operator|.
name|getGeneration
argument_list|()
argument_list|)
expr_stmt|;
name|nl
operator|.
name|add
argument_list|(
name|CMD_GET_FILE_LIST
argument_list|,
name|c
operator|.
name|getFileNames
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|l
operator|.
name|add
argument_list|(
name|nl
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception while reading files for commit "
operator|+
name|c
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|l
return|;
block|}
comment|/**    * Gets the checksum of a file    */
DECL|method|getFileChecksum
specifier|private
name|void
name|getFileChecksum
parameter_list|(
name|SolrParams
name|solrParams
parameter_list|,
name|SolrQueryResponse
name|rsp
parameter_list|)
block|{
name|Checksum
name|checksum
init|=
operator|new
name|Adler32
argument_list|()
decl_stmt|;
name|File
name|dir
init|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getIndexDir
argument_list|()
argument_list|)
decl_stmt|;
name|rsp
operator|.
name|add
argument_list|(
name|CHECKSUM
argument_list|,
name|getCheckSums
argument_list|(
name|solrParams
operator|.
name|getParams
argument_list|(
name|FILE
argument_list|)
argument_list|,
name|dir
argument_list|,
name|checksum
argument_list|)
argument_list|)
expr_stmt|;
name|dir
operator|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getResourceLoader
argument_list|()
operator|.
name|getConfigDir
argument_list|()
argument_list|)
expr_stmt|;
name|rsp
operator|.
name|add
argument_list|(
name|CONF_CHECKSUM
argument_list|,
name|getCheckSums
argument_list|(
name|solrParams
operator|.
name|getParams
argument_list|(
name|CONF_FILE_SHORT
argument_list|)
argument_list|,
name|dir
argument_list|,
name|checksum
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|getCheckSums
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|getCheckSums
parameter_list|(
name|String
index|[]
name|files
parameter_list|,
name|File
name|dir
parameter_list|,
name|Checksum
name|checksum
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|checksumMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
argument_list|()
decl_stmt|;
if|if
condition|(
name|files
operator|==
literal|null
operator|||
name|files
operator|.
name|length
operator|==
literal|0
condition|)
return|return
name|checksumMap
return|;
for|for
control|(
name|String
name|file
range|:
name|files
control|)
block|{
name|File
name|f
init|=
operator|new
name|File
argument_list|(
name|dir
argument_list|,
name|file
argument_list|)
decl_stmt|;
name|Long
name|checkSumVal
init|=
name|getCheckSum
argument_list|(
name|checksum
argument_list|,
name|f
argument_list|)
decl_stmt|;
if|if
condition|(
name|checkSumVal
operator|!=
literal|null
condition|)
name|checksumMap
operator|.
name|put
argument_list|(
name|file
argument_list|,
name|checkSumVal
argument_list|)
expr_stmt|;
block|}
return|return
name|checksumMap
return|;
block|}
DECL|method|getCheckSum
specifier|static
name|Long
name|getCheckSum
parameter_list|(
name|Checksum
name|checksum
parameter_list|,
name|File
name|f
parameter_list|)
block|{
name|FileInputStream
name|fis
init|=
literal|null
decl_stmt|;
name|checksum
operator|.
name|reset
argument_list|()
expr_stmt|;
name|byte
index|[]
name|buffer
init|=
operator|new
name|byte
index|[
literal|1024
operator|*
literal|1024
index|]
decl_stmt|;
name|int
name|bytesRead
decl_stmt|;
try|try
block|{
name|fis
operator|=
operator|new
name|FileInputStream
argument_list|(
name|f
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|bytesRead
operator|=
name|fis
operator|.
name|read
argument_list|(
name|buffer
argument_list|)
operator|)
operator|>=
literal|0
condition|)
name|checksum
operator|.
name|update
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|bytesRead
argument_list|)
expr_stmt|;
return|return
name|checksum
operator|.
name|getValue
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception in finding checksum of "
operator|+
name|f
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|closeNoExp
argument_list|(
name|fis
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
DECL|method|doSnapPull
name|void
name|doSnapPull
parameter_list|()
block|{
if|if
condition|(
operator|!
name|isSlave
condition|)
return|return;
if|if
condition|(
operator|!
name|snapPullLock
operator|.
name|tryLock
argument_list|()
condition|)
return|return;
try|try
block|{
name|snapPuller
operator|.
name|fetchLatestIndex
argument_list|(
name|core
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"SnapPull failed "
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|snapPullLock
operator|.
name|unlock
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|isReplicating
name|boolean
name|isReplicating
parameter_list|()
block|{
return|return
name|snapPullLock
operator|.
name|isLocked
argument_list|()
return|;
block|}
DECL|method|doSnapShoot
specifier|private
name|void
name|doSnapShoot
parameter_list|(
name|SolrQueryResponse
name|rsp
parameter_list|)
block|{
try|try
block|{
operator|new
name|SnapShooter
argument_list|(
name|core
argument_list|)
operator|.
name|createSnapAsync
argument_list|(
name|core
operator|.
name|getDeletionPolicy
argument_list|()
operator|.
name|getLatestCommit
argument_list|()
operator|.
name|getFileNames
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|rsp
operator|.
name|add
argument_list|(
literal|"exception"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * This method adds an Object of FileStream to the resposnse .    * The FileStream implements a custom protocol which is understood by SnapPuller.FileFetcher    *    * @see org.apache.solr.handler.SnapPuller.FileFetcher    */
DECL|method|getFileStream
specifier|private
name|void
name|getFileStream
parameter_list|(
name|SolrParams
name|solrParams
parameter_list|,
name|SolrQueryResponse
name|rsp
parameter_list|)
block|{
name|ModifiableSolrParams
name|rawParams
init|=
operator|new
name|ModifiableSolrParams
argument_list|(
name|solrParams
argument_list|)
decl_stmt|;
name|rawParams
operator|.
name|set
argument_list|(
name|CommonParams
operator|.
name|WT
argument_list|,
name|FILE_STREAM
argument_list|)
expr_stmt|;
name|rsp
operator|.
name|add
argument_list|(
name|FILE_STREAM
argument_list|,
operator|new
name|FileStream
argument_list|(
name|solrParams
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
DECL|method|getFileList
specifier|private
name|void
name|getFileList
parameter_list|(
name|SolrParams
name|solrParams
parameter_list|,
name|SolrQueryResponse
name|rsp
parameter_list|)
block|{
name|String
name|v
init|=
name|solrParams
operator|.
name|get
argument_list|(
name|CMD_INDEX_VERSION
argument_list|)
decl_stmt|;
if|if
condition|(
name|v
operator|==
literal|null
condition|)
block|{
name|rsp
operator|.
name|add
argument_list|(
literal|"status"
argument_list|,
literal|"no indexversion specified"
argument_list|)
expr_stmt|;
return|return;
block|}
name|long
name|version
init|=
name|Long
operator|.
name|parseLong
argument_list|(
name|v
argument_list|)
decl_stmt|;
name|IndexCommit
name|commit
init|=
name|core
operator|.
name|getDeletionPolicy
argument_list|()
operator|.
name|getCommitPoint
argument_list|(
name|version
argument_list|)
decl_stmt|;
if|if
condition|(
name|commit
operator|==
literal|null
condition|)
block|{
name|rsp
operator|.
name|add
argument_list|(
literal|"status"
argument_list|,
literal|"invalid indexversion"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// reserve the indexcommit for sometime
name|core
operator|.
name|getDeletionPolicy
argument_list|()
operator|.
name|setReserveDuration
argument_list|(
name|version
argument_list|,
name|reserveCommitDuration
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|>
name|result
init|=
operator|new
name|ArrayList
argument_list|<
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
try|try
block|{
comment|//get all the files in the commit
name|Collection
argument_list|<
name|String
argument_list|>
name|files
init|=
name|commit
operator|.
name|getFileNames
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|fileName
range|:
name|files
control|)
block|{
name|File
name|file
init|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getIndexDir
argument_list|()
argument_list|,
name|fileName
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|fileMeta
init|=
name|getFileInfo
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|result
operator|.
name|add
argument_list|(
name|fileMeta
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|rsp
operator|.
name|add
argument_list|(
literal|"status"
argument_list|,
literal|"unable to get file names for given indexversion"
argument_list|)
expr_stmt|;
name|rsp
operator|.
name|add
argument_list|(
literal|"exception"
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unable to get file names for indexCommit version: "
operator|+
name|version
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
name|rsp
operator|.
name|add
argument_list|(
name|CMD_GET_FILE_LIST
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|includeConfFiles
operator|==
literal|null
condition|)
return|return;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Adding config files to list: "
operator|+
name|includeConfFiles
argument_list|)
expr_stmt|;
comment|//if configuration files need to be included get their details
name|List
argument_list|<
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|>
name|confFiles
init|=
name|getConfFileCache
argument_list|(
name|includeConfFiles
argument_list|)
decl_stmt|;
name|rsp
operator|.
name|add
argument_list|(
name|CONF_FILES
argument_list|,
name|confFiles
argument_list|)
expr_stmt|;
block|}
comment|/**    * For configuration files, checksum of the file is included    * because, unlike index files, they may have same content but different timestamps.    *<p/>    * The local conf files information is cached so that everytime it does not have to    * compute the checksum. The cache is refreshed only if the lastModified of the file changes    */
DECL|method|getConfFileCache
name|List
argument_list|<
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|>
name|getConfFileCache
parameter_list|(
name|Collection
argument_list|<
name|String
argument_list|>
name|filenames
parameter_list|)
block|{
name|List
argument_list|<
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|>
name|confFiles
init|=
operator|new
name|ArrayList
argument_list|<
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
synchronized|synchronized
init|(
name|confFileInfoCache
init|)
block|{
name|File
name|confDir
init|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getResourceLoader
argument_list|()
operator|.
name|getConfigDir
argument_list|()
argument_list|)
decl_stmt|;
name|Checksum
name|checksum
init|=
literal|null
decl_stmt|;
for|for
control|(
name|String
name|cf
range|:
name|filenames
control|)
block|{
name|File
name|f
init|=
operator|new
name|File
argument_list|(
name|confDir
argument_list|,
name|cf
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|f
operator|.
name|exists
argument_list|()
operator|||
name|f
operator|.
name|isDirectory
argument_list|()
condition|)
continue|continue;
comment|//must not happen
name|FileInfo
name|info
init|=
name|confFileInfoCache
operator|.
name|get
argument_list|(
name|cf
argument_list|)
decl_stmt|;
if|if
condition|(
name|info
operator|==
literal|null
operator|||
name|info
operator|.
name|lastmodified
operator|!=
name|f
operator|.
name|lastModified
argument_list|()
operator|||
name|info
operator|.
name|size
operator|!=
name|f
operator|.
name|length
argument_list|()
condition|)
block|{
if|if
condition|(
name|checksum
operator|==
literal|null
condition|)
name|checksum
operator|=
operator|new
name|Adler32
argument_list|()
expr_stmt|;
name|info
operator|=
operator|new
name|FileInfo
argument_list|(
name|f
operator|.
name|lastModified
argument_list|()
argument_list|,
name|cf
argument_list|,
name|f
operator|.
name|length
argument_list|()
argument_list|,
name|getCheckSum
argument_list|(
name|checksum
argument_list|,
name|f
argument_list|)
argument_list|)
expr_stmt|;
name|confFileInfoCache
operator|.
name|put
argument_list|(
name|cf
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
name|confFiles
operator|.
name|add
argument_list|(
name|info
operator|.
name|getAsMap
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|confFiles
return|;
block|}
DECL|class|FileInfo
specifier|private
specifier|static
class|class
name|FileInfo
block|{
DECL|field|lastmodified
name|long
name|lastmodified
decl_stmt|;
DECL|field|name
name|String
name|name
decl_stmt|;
DECL|field|size
name|long
name|size
decl_stmt|;
DECL|field|checksum
name|long
name|checksum
decl_stmt|;
DECL|method|FileInfo
specifier|public
name|FileInfo
parameter_list|(
name|long
name|lasmodified
parameter_list|,
name|String
name|name
parameter_list|,
name|long
name|size
parameter_list|,
name|long
name|checksum
parameter_list|)
block|{
name|this
operator|.
name|lastmodified
operator|=
name|lasmodified
expr_stmt|;
name|this
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|this
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|this
operator|.
name|checksum
operator|=
name|checksum
expr_stmt|;
block|}
DECL|method|getAsMap
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|getAsMap
parameter_list|()
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|map
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|()
decl_stmt|;
name|map
operator|.
name|put
argument_list|(
name|NAME
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|map
operator|.
name|put
argument_list|(
name|SIZE
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|map
operator|.
name|put
argument_list|(
name|LAST_MODIFIED
argument_list|,
name|lastmodified
argument_list|)
expr_stmt|;
name|map
operator|.
name|put
argument_list|(
name|CHECKSUM
argument_list|,
name|checksum
argument_list|)
expr_stmt|;
return|return
name|map
return|;
block|}
block|}
DECL|method|disablePoll
name|void
name|disablePoll
parameter_list|()
block|{
if|if
condition|(
name|isSlave
condition|)
name|snapPuller
operator|.
name|disablePoll
argument_list|()
expr_stmt|;
block|}
DECL|method|enablePoll
name|void
name|enablePoll
parameter_list|()
block|{
if|if
condition|(
name|isSlave
condition|)
name|snapPuller
operator|.
name|enablePoll
argument_list|()
expr_stmt|;
block|}
DECL|method|isPollingDisabled
name|boolean
name|isPollingDisabled
parameter_list|()
block|{
return|return
name|snapPuller
operator|.
name|isPollingDisabled
argument_list|()
return|;
block|}
DECL|method|getTimesReplicatedSinceStartup
name|int
name|getTimesReplicatedSinceStartup
parameter_list|()
block|{
return|return
name|numTimesReplicated
return|;
block|}
DECL|method|setTimesReplicatedSinceStartup
name|void
name|setTimesReplicatedSinceStartup
parameter_list|()
block|{
name|numTimesReplicated
operator|++
expr_stmt|;
block|}
DECL|method|getIndexSize
name|long
name|getIndexSize
parameter_list|()
block|{
return|return
name|computeIndexSize
argument_list|(
operator|new
name|File
argument_list|(
name|core
operator|.
name|getIndexDir
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
DECL|method|computeIndexSize
specifier|private
name|long
name|computeIndexSize
parameter_list|(
name|File
name|f
parameter_list|)
block|{
if|if
condition|(
name|f
operator|.
name|isFile
argument_list|()
condition|)
return|return
name|f
operator|.
name|length
argument_list|()
return|;
name|File
index|[]
name|files
init|=
name|f
operator|.
name|listFiles
argument_list|()
decl_stmt|;
name|long
name|size
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|files
operator|!=
literal|null
operator|&&
name|files
operator|.
name|length
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|File
name|file
range|:
name|files
control|)
name|size
operator|+=
name|file
operator|.
name|length
argument_list|()
expr_stmt|;
block|}
return|return
name|size
return|;
block|}
comment|/**    * Collects the details such as name, size ,lastModified of a file    */
DECL|method|getFileInfo
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|getFileInfo
parameter_list|(
name|File
name|file
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|fileMeta
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
argument_list|()
decl_stmt|;
name|fileMeta
operator|.
name|put
argument_list|(
name|NAME
argument_list|,
name|file
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|fileMeta
operator|.
name|put
argument_list|(
name|SIZE
argument_list|,
name|file
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|fileMeta
operator|.
name|put
argument_list|(
name|LAST_MODIFIED
argument_list|,
name|file
operator|.
name|lastModified
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|fileMeta
return|;
block|}
DECL|method|getDescription
specifier|public
name|String
name|getDescription
parameter_list|()
block|{
return|return
literal|"ReplicationHandler provides replication of index and configuration files from Master to Slaves"
return|;
block|}
DECL|method|getSourceId
specifier|public
name|String
name|getSourceId
parameter_list|()
block|{
return|return
literal|"$Id$"
return|;
block|}
DECL|method|getSource
specifier|public
name|String
name|getSource
parameter_list|()
block|{
return|return
literal|"$URL$"
return|;
block|}
DECL|method|getVersion
specifier|public
name|String
name|getVersion
parameter_list|()
block|{
return|return
literal|"$Revision$"
return|;
block|}
DECL|method|readableSize
name|String
name|readableSize
parameter_list|(
name|long
name|size
parameter_list|)
block|{
name|NumberFormat
name|formatter
init|=
name|NumberFormat
operator|.
name|getNumberInstance
argument_list|()
decl_stmt|;
name|formatter
operator|.
name|setMaximumFractionDigits
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|*
literal|1024
operator|)
operator|>
literal|0
condition|)
block|{
return|return
name|formatter
operator|.
name|format
argument_list|(
name|size
operator|*
literal|1.0d
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|*
literal|1024
operator|)
argument_list|)
operator|+
literal|" GB"
return|;
block|}
elseif|else
if|if
condition|(
name|size
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
operator|>
literal|0
condition|)
block|{
return|return
name|formatter
operator|.
name|format
argument_list|(
name|size
operator|*
literal|1.0d
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
argument_list|)
operator|+
literal|" MB"
return|;
block|}
elseif|else
if|if
condition|(
name|size
operator|/
literal|1024
operator|>
literal|0
condition|)
block|{
return|return
name|formatter
operator|.
name|format
argument_list|(
name|size
operator|*
literal|1.0d
operator|/
literal|1024
argument_list|)
operator|+
literal|" KB"
return|;
block|}
else|else
block|{
return|return
name|String
operator|.
name|valueOf
argument_list|(
name|size
argument_list|)
operator|+
literal|" bytes"
return|;
block|}
block|}
DECL|method|getIndexVersion
specifier|private
name|long
index|[]
name|getIndexVersion
parameter_list|()
block|{
name|long
name|version
index|[]
init|=
operator|new
name|long
index|[
literal|2
index|]
decl_stmt|;
name|RefCounted
argument_list|<
name|SolrIndexSearcher
argument_list|>
name|searcher
init|=
name|core
operator|.
name|getSearcher
argument_list|()
decl_stmt|;
try|try
block|{
name|version
index|[
literal|0
index|]
operator|=
name|searcher
operator|.
name|get
argument_list|()
operator|.
name|getReader
argument_list|()
operator|.
name|getIndexCommit
argument_list|()
operator|.
name|getVersion
argument_list|()
expr_stmt|;
name|version
index|[
literal|1
index|]
operator|=
name|searcher
operator|.
name|get
argument_list|()
operator|.
name|getReader
argument_list|()
operator|.
name|getIndexCommit
argument_list|()
operator|.
name|getGeneration
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unable to get index version : "
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|searcher
operator|.
name|decref
argument_list|()
expr_stmt|;
block|}
return|return
name|version
return|;
block|}
annotation|@
name|Override
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
DECL|method|getStatistics
specifier|public
name|NamedList
name|getStatistics
parameter_list|()
block|{
name|NamedList
name|list
init|=
name|super
operator|.
name|getStatistics
argument_list|()
decl_stmt|;
if|if
condition|(
name|core
operator|!=
literal|null
condition|)
block|{
name|list
operator|.
name|add
argument_list|(
literal|"indexSize"
argument_list|,
name|readableSize
argument_list|(
name|getIndexSize
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|long
index|[]
name|versionGen
init|=
name|getIndexVersion
argument_list|()
decl_stmt|;
name|list
operator|.
name|add
argument_list|(
name|CMD_INDEX_VERSION
argument_list|,
name|versionGen
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|list
operator|.
name|add
argument_list|(
name|GENERATION
argument_list|,
name|versionGen
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|list
operator|.
name|add
argument_list|(
literal|"indexPath"
argument_list|,
name|core
operator|.
name|getIndexDir
argument_list|()
argument_list|)
expr_stmt|;
name|list
operator|.
name|add
argument_list|(
literal|"isMaster"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|isMaster
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isSlave
condition|)
block|{
name|list
operator|.
name|add
argument_list|(
name|MASTER_URL
argument_list|,
name|snapPuller
operator|.
name|getMasterUrl
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|snapPuller
operator|.
name|getPollInterval
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|list
operator|.
name|add
argument_list|(
name|SnapPuller
operator|.
name|POLL_INTERVAL
argument_list|,
name|snapPuller
operator|.
name|getPollInterval
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|list
operator|.
name|add
argument_list|(
literal|"isPollingDisabled"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|isPollingDisabled
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|list
operator|.
name|add
argument_list|(
literal|"isReplicating"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|isReplicating
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isMaster
condition|)
block|{
name|list
operator|.
name|add
argument_list|(
literal|"confFilesToReplicate"
argument_list|,
name|includeConfFiles
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|replicateOnCommit
condition|)
name|list
operator|.
name|add
argument_list|(
name|REPLICATE_AFTER
argument_list|,
literal|"commit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|replicateOnOptimize
condition|)
name|list
operator|.
name|add
argument_list|(
name|REPLICATE_AFTER
argument_list|,
literal|"optimize"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|list
return|;
block|}
comment|/**    * Used for showing statistics and progress information.    */
DECL|method|getReplicationDetails
name|void
name|getReplicationDetails
parameter_list|(
name|SolrQueryResponse
name|resp
parameter_list|)
block|{
name|String
name|timeLastReplicated
init|=
literal|""
decl_stmt|,
name|confFilesReplicated
init|=
literal|""
decl_stmt|,
name|confFilesReplicatedTime
init|=
literal|""
decl_stmt|,
name|timesIndexReplicated
init|=
literal|""
decl_stmt|,
name|timesConfigReplicated
init|=
literal|""
decl_stmt|;
name|NamedList
argument_list|<
name|Object
argument_list|>
name|details
init|=
operator|new
name|SimpleOrderedMap
argument_list|<
name|Object
argument_list|>
argument_list|()
decl_stmt|;
name|FileInputStream
name|inFile
init|=
literal|null
decl_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"indexSize"
argument_list|,
name|readableSize
argument_list|(
name|getIndexSize
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"indexPath"
argument_list|,
name|core
operator|.
name|getIndexDir
argument_list|()
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
name|CMD_SHOW_COMMITS
argument_list|,
name|getCommits
argument_list|()
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"isMaster"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|isMaster
argument_list|)
argument_list|)
expr_stmt|;
name|long
index|[]
name|versionAndGeneration
init|=
name|getIndexVersion
argument_list|()
decl_stmt|;
name|details
operator|.
name|add
argument_list|(
name|CMD_INDEX_VERSION
argument_list|,
name|versionAndGeneration
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
name|GENERATION
argument_list|,
name|versionAndGeneration
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|IndexCommit
name|commit
init|=
name|indexCommitPoint
decl_stmt|;
comment|// make a copy so it won't change
if|if
condition|(
name|isMaster
operator|&&
name|commit
operator|!=
literal|null
condition|)
block|{
name|details
operator|.
name|add
argument_list|(
literal|"replicatable"
operator|+
name|CMD_INDEX_VERSION
argument_list|,
name|commit
operator|.
name|getVersion
argument_list|()
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"replicatable"
operator|+
name|GENERATION
argument_list|,
name|commit
operator|.
name|getGeneration
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isSlave
condition|)
block|{
try|try
block|{
name|Properties
name|props
init|=
operator|new
name|Properties
argument_list|()
decl_stmt|;
name|File
name|f
init|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getDataDir
argument_list|()
argument_list|,
name|SnapPuller
operator|.
name|REPLICATION_PROPERTIES
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
operator|.
name|exists
argument_list|()
condition|)
block|{
name|inFile
operator|=
operator|new
name|FileInputStream
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|props
operator|.
name|load
argument_list|(
name|inFile
argument_list|)
expr_stmt|;
name|timeLastReplicated
operator|=
name|props
operator|.
name|getProperty
argument_list|(
literal|"indexReplicatedAt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|.
name|containsKey
argument_list|(
literal|"timesIndexReplicated"
argument_list|)
condition|)
name|timesIndexReplicated
operator|=
name|props
operator|.
name|getProperty
argument_list|(
literal|"timesIndexReplicated"
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|.
name|containsKey
argument_list|(
literal|"confFilesReplicated"
argument_list|)
condition|)
name|confFilesReplicated
operator|=
name|props
operator|.
name|getProperty
argument_list|(
literal|"confFilesReplicated"
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|.
name|containsKey
argument_list|(
literal|"confFilesReplicatedAt"
argument_list|)
condition|)
name|confFilesReplicatedTime
operator|=
name|props
operator|.
name|getProperty
argument_list|(
literal|"confFilesReplicatedAt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|.
name|containsKey
argument_list|(
literal|"timesConfigReplicated"
argument_list|)
condition|)
name|timesConfigReplicated
operator|=
name|props
operator|.
name|getProperty
argument_list|(
literal|"timesConfigReplicated"
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception while reading "
operator|+
name|SnapPuller
operator|.
name|REPLICATION_PROPERTIES
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|closeNoExp
argument_list|(
name|inFile
argument_list|)
expr_stmt|;
block|}
name|HttpClient
name|client
init|=
literal|null
decl_stmt|;
try|try
block|{
name|client
operator|=
operator|new
name|HttpClient
argument_list|()
expr_stmt|;
name|NamedList
name|nl
init|=
name|snapPuller
operator|.
name|getCommandResponse
argument_list|(
name|client
argument_list|,
name|CMD_DETAILS
argument_list|)
decl_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"masterDetails"
argument_list|,
name|nl
operator|.
name|get
argument_list|(
name|CMD_DETAILS
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception while invoking a 'details' method on master "
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|client
operator|!=
literal|null
condition|)
name|client
operator|.
name|getHttpConnectionManager
argument_list|()
operator|.
name|closeIdleConnections
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|details
operator|.
name|add
argument_list|(
name|MASTER_URL
argument_list|,
name|snapPuller
operator|.
name|getMasterUrl
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|snapPuller
operator|.
name|getPollInterval
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|details
operator|.
name|add
argument_list|(
name|SnapPuller
operator|.
name|POLL_INTERVAL
argument_list|,
name|snapPuller
operator|.
name|getPollInterval
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|snapPuller
operator|.
name|getNextScheduledExecTime
argument_list|()
operator|!=
literal|null
operator|&&
operator|!
name|isPollingDisabled
argument_list|()
condition|)
block|{
name|Date
name|d
init|=
operator|new
name|Date
argument_list|(
name|snapPuller
operator|.
name|getNextScheduledExecTime
argument_list|()
argument_list|)
decl_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"nextExecutionAt"
argument_list|,
name|d
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isPollingDisabled
argument_list|()
condition|)
block|{
name|details
operator|.
name|add
argument_list|(
literal|"nextExecutionAt"
argument_list|,
literal|"Polling disabled"
argument_list|)
expr_stmt|;
block|}
else|else
name|details
operator|.
name|add
argument_list|(
literal|"nextExecutionAt"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeLastReplicated
operator|!=
literal|null
operator|&&
name|timeLastReplicated
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|Date
name|d
init|=
operator|new
name|Date
argument_list|(
name|Long
operator|.
name|valueOf
argument_list|(
name|timeLastReplicated
argument_list|)
argument_list|)
decl_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"indexReplicatedAt"
argument_list|,
name|d
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|details
operator|.
name|add
argument_list|(
literal|"indexReplicatedAt"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
name|details
operator|.
name|add
argument_list|(
literal|"timesIndexReplicated"
argument_list|,
name|timesIndexReplicated
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"confFilesReplicated"
argument_list|,
name|confFilesReplicated
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"timesConfigReplicated"
argument_list|,
name|timesConfigReplicated
argument_list|)
expr_stmt|;
if|if
condition|(
name|confFilesReplicatedTime
operator|!=
literal|null
operator|&&
name|confFilesReplicatedTime
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|Date
name|d
init|=
operator|new
name|Date
argument_list|(
name|Long
operator|.
name|valueOf
argument_list|(
name|confFilesReplicatedTime
argument_list|)
argument_list|)
decl_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"confFilesReplicatedAt"
argument_list|,
name|d
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|details
operator|.
name|add
argument_list|(
literal|"confFilesReplicatedAt"
argument_list|,
name|confFilesReplicatedTime
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|long
name|bytesToDownload
init|=
literal|0
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|filesToDownload
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
if|if
condition|(
name|snapPuller
operator|.
name|getFilesToDownload
argument_list|()
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|file
range|:
name|snapPuller
operator|.
name|getFilesToDownload
argument_list|()
control|)
block|{
name|filesToDownload
operator|.
name|add
argument_list|(
operator|(
name|String
operator|)
name|file
operator|.
name|get
argument_list|(
name|NAME
argument_list|)
argument_list|)
expr_stmt|;
name|bytesToDownload
operator|+=
operator|(
name|Long
operator|)
name|file
operator|.
name|get
argument_list|(
name|SIZE
argument_list|)
expr_stmt|;
block|}
block|}
comment|//get list of conf files to download
for|for
control|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|file
range|:
name|snapPuller
operator|.
name|getConfFilesToDownload
argument_list|()
control|)
block|{
name|filesToDownload
operator|.
name|add
argument_list|(
operator|(
name|String
operator|)
name|file
operator|.
name|get
argument_list|(
name|NAME
argument_list|)
argument_list|)
expr_stmt|;
name|bytesToDownload
operator|+=
operator|(
name|Long
operator|)
name|file
operator|.
name|get
argument_list|(
name|SIZE
argument_list|)
expr_stmt|;
block|}
name|details
operator|.
name|add
argument_list|(
literal|"filesToDownload"
argument_list|,
name|filesToDownload
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"numFilesToDownload"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|filesToDownload
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"bytesToDownload"
argument_list|,
name|readableSize
argument_list|(
name|bytesToDownload
argument_list|)
argument_list|)
expr_stmt|;
name|long
name|bytesDownloaded
init|=
literal|0
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|filesDownloaded
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|file
range|:
name|snapPuller
operator|.
name|getFilesDownloaded
argument_list|()
control|)
block|{
name|filesDownloaded
operator|.
name|add
argument_list|(
operator|(
name|String
operator|)
name|file
operator|.
name|get
argument_list|(
name|NAME
argument_list|)
argument_list|)
expr_stmt|;
name|bytesDownloaded
operator|+=
operator|(
name|Long
operator|)
name|file
operator|.
name|get
argument_list|(
name|SIZE
argument_list|)
expr_stmt|;
block|}
comment|//get list of conf files downloaded
for|for
control|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|file
range|:
name|snapPuller
operator|.
name|getConfFilesDownloaded
argument_list|()
control|)
block|{
name|filesDownloaded
operator|.
name|add
argument_list|(
operator|(
name|String
operator|)
name|file
operator|.
name|get
argument_list|(
name|NAME
argument_list|)
argument_list|)
expr_stmt|;
name|bytesDownloaded
operator|+=
operator|(
name|Long
operator|)
name|file
operator|.
name|get
argument_list|(
name|SIZE
argument_list|)
expr_stmt|;
block|}
name|details
operator|.
name|add
argument_list|(
literal|"filesDownloaded"
argument_list|,
name|filesDownloaded
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"numFilesDownloaded"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|filesDownloaded
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|currentFile
init|=
name|snapPuller
operator|.
name|getCurrentFile
argument_list|()
decl_stmt|;
name|String
name|currFile
init|=
literal|null
decl_stmt|;
name|long
name|currFileSize
init|=
literal|0
decl_stmt|,
name|currFileSizeDownloaded
init|=
literal|0
decl_stmt|;
name|float
name|percentDownloaded
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|currentFile
operator|!=
literal|null
condition|)
block|{
name|currFile
operator|=
operator|(
name|String
operator|)
name|currentFile
operator|.
name|get
argument_list|(
name|NAME
argument_list|)
expr_stmt|;
name|currFileSize
operator|=
operator|(
name|Long
operator|)
name|currentFile
operator|.
name|get
argument_list|(
name|SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|currentFile
operator|.
name|containsKey
argument_list|(
literal|"bytesDownloaded"
argument_list|)
condition|)
block|{
name|currFileSizeDownloaded
operator|=
operator|(
name|Long
operator|)
name|currentFile
operator|.
name|get
argument_list|(
literal|"bytesDownloaded"
argument_list|)
expr_stmt|;
name|bytesDownloaded
operator|+=
name|currFileSizeDownloaded
expr_stmt|;
if|if
condition|(
name|currFileSize
operator|>
literal|0
condition|)
name|percentDownloaded
operator|=
operator|(
name|currFileSizeDownloaded
operator|*
literal|100
operator|)
operator|/
name|currFileSize
expr_stmt|;
block|}
block|}
name|long
name|timeElapsed
init|=
literal|0
decl_stmt|,
name|estimatedTimeRemaining
init|=
literal|0
decl_stmt|;
name|Date
name|replicationStartTime
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|snapPuller
operator|.
name|getReplicationStartTime
argument_list|()
operator|>
literal|0
condition|)
block|{
name|replicationStartTime
operator|=
operator|new
name|Date
argument_list|(
name|snapPuller
operator|.
name|getReplicationStartTime
argument_list|()
argument_list|)
expr_stmt|;
name|timeElapsed
operator|=
operator|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|-
name|snapPuller
operator|.
name|getReplicationStartTime
argument_list|()
operator|)
operator|/
literal|1000
expr_stmt|;
block|}
if|if
condition|(
name|replicationStartTime
operator|!=
literal|null
condition|)
block|{
name|details
operator|.
name|add
argument_list|(
literal|"replicationStartTime"
argument_list|,
name|replicationStartTime
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|details
operator|.
name|add
argument_list|(
literal|"timeElapsed"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|timeElapsed
argument_list|)
operator|+
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytesDownloaded
operator|>
literal|0
condition|)
name|estimatedTimeRemaining
operator|=
operator|(
operator|(
name|bytesToDownload
operator|-
name|bytesDownloaded
operator|)
operator|*
name|timeElapsed
operator|)
operator|/
name|bytesDownloaded
expr_stmt|;
name|float
name|totalPercent
init|=
literal|0
decl_stmt|;
name|long
name|downloadSpeed
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bytesToDownload
operator|>
literal|0
condition|)
name|totalPercent
operator|=
operator|(
name|bytesDownloaded
operator|*
literal|100
operator|)
operator|/
name|bytesToDownload
expr_stmt|;
if|if
condition|(
name|timeElapsed
operator|>
literal|0
condition|)
name|downloadSpeed
operator|=
operator|(
name|bytesDownloaded
operator|/
name|timeElapsed
operator|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"currentFile"
argument_list|,
name|currFile
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"currentFileSize"
argument_list|,
name|readableSize
argument_list|(
name|currFileSize
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"currentFileSizeDownloaded"
argument_list|,
name|readableSize
argument_list|(
name|currFileSizeDownloaded
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"currentFileSizePercent"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|percentDownloaded
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"bytesDownloaded"
argument_list|,
name|readableSize
argument_list|(
name|bytesDownloaded
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"totalPercent"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|totalPercent
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"timeRemaining"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|estimatedTimeRemaining
argument_list|)
operator|+
literal|"s"
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"downloadSpeed"
argument_list|,
name|readableSize
argument_list|(
name|downloadSpeed
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"isPollingDisabled"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|isPollingDisabled
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|details
operator|.
name|add
argument_list|(
literal|"isReplicating"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|isReplicating
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Exception while writing details: "
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|isMaster
condition|)
block|{
name|details
operator|.
name|add
argument_list|(
name|CONF_FILES
argument_list|,
name|includeConfFiles
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|replicateOnCommit
condition|)
name|details
operator|.
name|add
argument_list|(
name|REPLICATE_AFTER
argument_list|,
literal|"commit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|replicateOnOptimize
condition|)
name|details
operator|.
name|add
argument_list|(
name|REPLICATE_AFTER
argument_list|,
literal|"optimize"
argument_list|)
expr_stmt|;
block|}
name|resp
operator|.
name|add
argument_list|(
name|CMD_DETAILS
argument_list|,
name|details
argument_list|)
expr_stmt|;
block|}
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
DECL|method|inform
specifier|public
name|void
name|inform
parameter_list|(
name|SolrCore
name|core
parameter_list|)
block|{
name|this
operator|.
name|core
operator|=
name|core
expr_stmt|;
name|registerFileStreamResponseWriter
argument_list|()
expr_stmt|;
name|registerCloseHook
argument_list|()
expr_stmt|;
name|NamedList
name|slave
init|=
operator|(
name|NamedList
operator|)
name|initArgs
operator|.
name|get
argument_list|(
literal|"slave"
argument_list|)
decl_stmt|;
if|if
condition|(
name|slave
operator|!=
literal|null
condition|)
block|{
name|snapPuller
operator|=
operator|new
name|SnapPuller
argument_list|(
name|slave
argument_list|,
name|this
argument_list|,
name|core
argument_list|)
expr_stmt|;
name|isSlave
operator|=
literal|true
expr_stmt|;
block|}
name|NamedList
name|master
init|=
operator|(
name|NamedList
operator|)
name|initArgs
operator|.
name|get
argument_list|(
literal|"master"
argument_list|)
decl_stmt|;
if|if
condition|(
name|master
operator|!=
literal|null
condition|)
block|{
name|String
name|includeFiles
init|=
operator|(
name|String
operator|)
name|master
operator|.
name|get
argument_list|(
name|CONF_FILES
argument_list|)
decl_stmt|;
if|if
condition|(
name|includeFiles
operator|!=
literal|null
operator|&&
operator|!
name|includeFiles
operator|.
name|trim
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|includeConfFiles
operator|=
name|Arrays
operator|.
name|asList
argument_list|(
name|includeFiles
operator|.
name|split
argument_list|(
literal|","
argument_list|)
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Replication enabled for following config files: "
operator|+
name|includeConfFiles
argument_list|)
expr_stmt|;
block|}
name|List
name|snapshot
init|=
name|master
operator|.
name|getAll
argument_list|(
literal|"snapshot"
argument_list|)
decl_stmt|;
name|boolean
name|snapshotOnCommit
init|=
name|snapshot
operator|.
name|contains
argument_list|(
literal|"commit"
argument_list|)
decl_stmt|;
name|boolean
name|snapshotOnOptimize
init|=
name|snapshot
operator|.
name|contains
argument_list|(
literal|"optimize"
argument_list|)
decl_stmt|;
name|List
name|replicateAfter
init|=
name|master
operator|.
name|getAll
argument_list|(
name|REPLICATE_AFTER
argument_list|)
decl_stmt|;
name|replicateOnCommit
operator|=
name|replicateAfter
operator|.
name|contains
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
name|replicateOnOptimize
operator|=
name|replicateAfter
operator|.
name|contains
argument_list|(
literal|"optimize"
argument_list|)
expr_stmt|;
if|if
condition|(
name|replicateOnOptimize
operator|||
name|snapshotOnOptimize
condition|)
block|{
name|core
operator|.
name|getUpdateHandler
argument_list|()
operator|.
name|registerOptimizeCallback
argument_list|(
name|getEventListener
argument_list|(
name|snapshotOnOptimize
argument_list|,
name|replicateOnOptimize
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|replicateOnCommit
operator|||
name|snapshotOnCommit
condition|)
block|{
name|replicateOnCommit
operator|=
literal|true
expr_stmt|;
name|core
operator|.
name|getUpdateHandler
argument_list|()
operator|.
name|registerCommitCallback
argument_list|(
name|getEventListener
argument_list|(
name|snapshotOnCommit
argument_list|,
name|replicateOnCommit
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|replicateAfter
operator|.
name|contains
argument_list|(
literal|"startup"
argument_list|)
condition|)
block|{
name|RefCounted
argument_list|<
name|SolrIndexSearcher
argument_list|>
name|s
init|=
name|core
operator|.
name|getNewestSearcher
argument_list|(
literal|false
argument_list|)
decl_stmt|;
try|try
block|{
name|indexCommitPoint
operator|=
name|s
operator|.
name|get
argument_list|()
operator|.
name|getReader
argument_list|()
operator|.
name|getIndexCommit
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unable to get IndexCommit on startup"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|s
operator|.
name|decref
argument_list|()
expr_stmt|;
block|}
block|}
name|String
name|reserve
init|=
operator|(
name|String
operator|)
name|master
operator|.
name|get
argument_list|(
name|RESERVE
argument_list|)
decl_stmt|;
if|if
condition|(
name|reserve
operator|!=
literal|null
operator|&&
operator|!
name|reserve
operator|.
name|trim
argument_list|()
operator|.
name|equals
argument_list|(
literal|""
argument_list|)
condition|)
block|{
name|reserveCommitDuration
operator|=
name|SnapPuller
operator|.
name|readInterval
argument_list|(
name|reserve
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Commits will be reserved for  "
operator|+
name|reserveCommitDuration
argument_list|)
expr_stmt|;
name|isMaster
operator|=
literal|true
expr_stmt|;
block|}
block|}
comment|/**    * register a closehook    */
DECL|method|registerCloseHook
specifier|private
name|void
name|registerCloseHook
parameter_list|()
block|{
name|core
operator|.
name|addCloseHook
argument_list|(
operator|new
name|CloseHook
argument_list|()
block|{
specifier|public
name|void
name|close
parameter_list|(
name|SolrCore
name|core
parameter_list|)
block|{
if|if
condition|(
name|snapPuller
operator|!=
literal|null
condition|)
block|{
name|snapPuller
operator|.
name|destroy
argument_list|()
expr_stmt|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
comment|/**    * A ResponseWriter is registered automatically for wt=filestream    * This response writer is used to transfer index files in a block-by-block manner within    * the same HTTP response.    */
DECL|method|registerFileStreamResponseWriter
specifier|private
name|void
name|registerFileStreamResponseWriter
parameter_list|()
block|{
name|core
operator|.
name|registerResponseWriter
argument_list|(
name|FILE_STREAM
argument_list|,
operator|new
name|BinaryQueryResponseWriter
argument_list|()
block|{
specifier|public
name|void
name|write
parameter_list|(
name|OutputStream
name|out
parameter_list|,
name|SolrQueryRequest
name|request
parameter_list|,
name|SolrQueryResponse
name|resp
parameter_list|)
throws|throws
name|IOException
block|{
name|FileStream
name|stream
init|=
operator|(
name|FileStream
operator|)
name|resp
operator|.
name|getValues
argument_list|()
operator|.
name|get
argument_list|(
name|FILE_STREAM
argument_list|)
decl_stmt|;
name|stream
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|write
parameter_list|(
name|Writer
name|writer
parameter_list|,
name|SolrQueryRequest
name|request
parameter_list|,
name|SolrQueryResponse
name|response
parameter_list|)
throws|throws
name|IOException
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"This is a binary writer , Cannot write to a characterstream"
argument_list|)
throw|;
block|}
specifier|public
name|String
name|getContentType
parameter_list|(
name|SolrQueryRequest
name|request
parameter_list|,
name|SolrQueryResponse
name|response
parameter_list|)
block|{
return|return
literal|"application/octet-stream"
return|;
block|}
specifier|public
name|void
name|init
parameter_list|(
name|NamedList
name|args
parameter_list|)
block|{
comment|/*no op*/
block|}
block|}
argument_list|)
expr_stmt|;
block|}
comment|/**    * Register a listener for postcommit/optimize    *    * @param snapshoot do a snapshoot    * @param getCommit get a commitpoint also    * @return an instance of the eventlistener    */
DECL|method|getEventListener
specifier|private
name|SolrEventListener
name|getEventListener
parameter_list|(
specifier|final
name|boolean
name|snapshoot
parameter_list|,
specifier|final
name|boolean
name|getCommit
parameter_list|)
block|{
return|return
operator|new
name|SolrEventListener
argument_list|()
block|{
specifier|public
name|void
name|init
parameter_list|(
name|NamedList
name|args
parameter_list|)
block|{
comment|/*no op*/
block|}
comment|/**        * This refreshes the latest replicateable index commit and optionally can create Snapshots as well        */
specifier|public
name|void
name|postCommit
parameter_list|()
block|{
if|if
condition|(
name|getCommit
condition|)
block|{
name|indexCommitPoint
operator|=
name|core
operator|.
name|getDeletionPolicy
argument_list|()
operator|.
name|getLatestCommit
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|snapshoot
condition|)
block|{
try|try
block|{
name|SnapShooter
name|snapShooter
init|=
operator|new
name|SnapShooter
argument_list|(
name|core
argument_list|)
decl_stmt|;
name|snapShooter
operator|.
name|createSnapAsync
argument_list|(
name|core
operator|.
name|getDeletionPolicy
argument_list|()
operator|.
name|getLatestCommit
argument_list|()
operator|.
name|getFileNames
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Exception while snapshooting"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|public
name|void
name|newSearcher
parameter_list|(
name|SolrIndexSearcher
name|newSearcher
parameter_list|,
name|SolrIndexSearcher
name|currentSearcher
parameter_list|)
block|{
comment|/*no op*/
block|}
block|}
return|;
block|}
DECL|method|closeNoExp
specifier|static
name|void
name|closeNoExp
parameter_list|(
name|Closeable
name|closeable
parameter_list|)
block|{
try|try
block|{
if|if
condition|(
name|closeable
operator|!=
literal|null
condition|)
name|closeable
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
comment|/*no op*/
block|}
block|}
DECL|class|FileStream
specifier|private
class|class
name|FileStream
block|{
DECL|field|params
specifier|private
name|SolrParams
name|params
decl_stmt|;
DECL|field|fos
specifier|private
name|FastOutputStream
name|fos
decl_stmt|;
DECL|field|indexVersion
specifier|private
name|Long
name|indexVersion
decl_stmt|;
DECL|field|delPolicy
specifier|private
name|IndexDeletionPolicyWrapper
name|delPolicy
decl_stmt|;
DECL|method|FileStream
specifier|public
name|FileStream
parameter_list|(
name|SolrParams
name|solrParams
parameter_list|)
block|{
name|params
operator|=
name|solrParams
expr_stmt|;
name|delPolicy
operator|=
name|core
operator|.
name|getDeletionPolicy
argument_list|()
expr_stmt|;
block|}
DECL|method|write
specifier|public
name|void
name|write
parameter_list|(
name|OutputStream
name|out
parameter_list|)
block|{
name|fos
operator|=
operator|new
name|FastOutputStream
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|String
name|fileName
init|=
name|params
operator|.
name|get
argument_list|(
name|FILE
argument_list|)
decl_stmt|;
name|String
name|cfileName
init|=
name|params
operator|.
name|get
argument_list|(
name|CONF_FILE_SHORT
argument_list|)
decl_stmt|;
name|String
name|sOffset
init|=
name|params
operator|.
name|get
argument_list|(
name|OFFSET
argument_list|)
decl_stmt|;
name|String
name|sLen
init|=
name|params
operator|.
name|get
argument_list|(
name|LEN
argument_list|)
decl_stmt|;
name|String
name|sChecksum
init|=
name|params
operator|.
name|get
argument_list|(
name|CHECKSUM
argument_list|)
decl_stmt|;
name|String
name|sindexVersion
init|=
name|params
operator|.
name|get
argument_list|(
name|CMD_INDEX_VERSION
argument_list|)
decl_stmt|;
if|if
condition|(
name|sindexVersion
operator|!=
literal|null
condition|)
name|indexVersion
operator|=
name|Long
operator|.
name|parseLong
argument_list|(
name|sindexVersion
argument_list|)
expr_stmt|;
name|FileInputStream
name|inputStream
init|=
literal|null
decl_stmt|;
name|int
name|packetsWritten
init|=
literal|0
decl_stmt|;
try|try
block|{
name|long
name|offset
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|len
init|=
operator|-
literal|1
decl_stmt|;
comment|//check if checksum is requested
name|boolean
name|useChecksum
init|=
name|Boolean
operator|.
name|parseBoolean
argument_list|(
name|sChecksum
argument_list|)
decl_stmt|;
if|if
condition|(
name|sOffset
operator|!=
literal|null
condition|)
name|offset
operator|=
name|Long
operator|.
name|parseLong
argument_list|(
name|sOffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|sLen
operator|!=
literal|null
condition|)
name|len
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|sLen
argument_list|)
expr_stmt|;
if|if
condition|(
name|fileName
operator|==
literal|null
operator|&&
name|cfileName
operator|==
literal|null
condition|)
block|{
comment|//no filename do nothing
name|writeNothing
argument_list|()
expr_stmt|;
block|}
name|File
name|file
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|cfileName
operator|!=
literal|null
condition|)
block|{
comment|//if if is a conf file read from config diectory
name|file
operator|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getResourceLoader
argument_list|()
operator|.
name|getConfigDir
argument_list|()
argument_list|,
name|cfileName
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|//else read from the indexdirectory
name|file
operator|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getIndexDir
argument_list|()
argument_list|,
name|fileName
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|file
operator|.
name|exists
argument_list|()
operator|&&
name|file
operator|.
name|canRead
argument_list|()
condition|)
block|{
name|inputStream
operator|=
operator|new
name|FileInputStream
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|FileChannel
name|channel
init|=
name|inputStream
operator|.
name|getChannel
argument_list|()
decl_stmt|;
comment|//if offset is mentioned move the pointer to that point
if|if
condition|(
name|offset
operator|!=
operator|-
literal|1
condition|)
name|channel
operator|.
name|position
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|byte
index|[]
name|buf
init|=
operator|new
name|byte
index|[
operator|(
name|len
operator|==
operator|-
literal|1
operator|||
name|len
operator|>
name|PACKET_SZ
operator|)
condition|?
name|PACKET_SZ
else|:
name|len
index|]
decl_stmt|;
name|Checksum
name|checksum
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|useChecksum
condition|)
name|checksum
operator|=
operator|new
name|Adler32
argument_list|()
expr_stmt|;
name|ByteBuffer
name|bb
init|=
name|ByteBuffer
operator|.
name|wrap
argument_list|(
name|buf
argument_list|)
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
name|bb
operator|.
name|clear
argument_list|()
expr_stmt|;
name|long
name|bytesRead
init|=
name|channel
operator|.
name|read
argument_list|(
name|bb
argument_list|)
decl_stmt|;
if|if
condition|(
name|bytesRead
operator|<=
literal|0
condition|)
block|{
name|writeNothing
argument_list|()
expr_stmt|;
name|fos
operator|.
name|close
argument_list|()
expr_stmt|;
break|break;
block|}
name|fos
operator|.
name|writeInt
argument_list|(
operator|(
name|int
operator|)
name|bytesRead
argument_list|)
expr_stmt|;
if|if
condition|(
name|useChecksum
condition|)
block|{
name|checksum
operator|.
name|reset
argument_list|()
expr_stmt|;
name|checksum
operator|.
name|update
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
operator|(
name|int
operator|)
name|bytesRead
argument_list|)
expr_stmt|;
name|fos
operator|.
name|writeLong
argument_list|(
name|checksum
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|fos
operator|.
name|write
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
operator|(
name|int
operator|)
name|bytesRead
argument_list|)
expr_stmt|;
name|fos
operator|.
name|flush
argument_list|()
expr_stmt|;
if|if
condition|(
name|indexVersion
operator|!=
literal|null
operator|&&
operator|(
name|packetsWritten
operator|%
literal|5
operator|==
literal|0
operator|)
condition|)
block|{
comment|//after every 5 packets reserve the commitpoint for some time
name|delPolicy
operator|.
name|setReserveDuration
argument_list|(
name|indexVersion
argument_list|,
name|reserveCommitDuration
argument_list|)
expr_stmt|;
block|}
name|packetsWritten
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|writeNothing
argument_list|()
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception while writing response for params: "
operator|+
name|params
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|closeNoExp
argument_list|(
name|inputStream
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**      * Used to write a marker for EOF      */
DECL|method|writeNothing
specifier|private
name|void
name|writeNothing
parameter_list|()
throws|throws
name|IOException
block|{
name|fos
operator|.
name|writeInt
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|fos
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
block|}
DECL|field|MASTER_URL
specifier|public
specifier|static
specifier|final
name|String
name|MASTER_URL
init|=
literal|"masterUrl"
decl_stmt|;
DECL|field|COMMAND
specifier|public
specifier|static
specifier|final
name|String
name|COMMAND
init|=
literal|"command"
decl_stmt|;
DECL|field|CMD_DETAILS
specifier|public
specifier|static
specifier|final
name|String
name|CMD_DETAILS
init|=
literal|"details"
decl_stmt|;
DECL|field|CMD_SNAP_SHOOT
specifier|public
specifier|static
specifier|final
name|String
name|CMD_SNAP_SHOOT
init|=
literal|"snapshoot"
decl_stmt|;
DECL|field|CMD_SNAP_PULL
specifier|public
specifier|static
specifier|final
name|String
name|CMD_SNAP_PULL
init|=
literal|"snappull"
decl_stmt|;
DECL|field|CMD_ABORT_SNAP_PULL
specifier|public
specifier|static
specifier|final
name|String
name|CMD_ABORT_SNAP_PULL
init|=
literal|"abortsnappull"
decl_stmt|;
DECL|field|CMD_GET_FILE_LIST
specifier|public
specifier|static
specifier|final
name|String
name|CMD_GET_FILE_LIST
init|=
literal|"filelist"
decl_stmt|;
DECL|field|CMD_GET_FILE
specifier|public
specifier|static
specifier|final
name|String
name|CMD_GET_FILE
init|=
literal|"filecontent"
decl_stmt|;
DECL|field|CMD_FILE_CHECKSUM
specifier|public
specifier|static
specifier|final
name|String
name|CMD_FILE_CHECKSUM
init|=
literal|"filechecksum"
decl_stmt|;
DECL|field|CMD_DISABLE_POLL
specifier|public
specifier|static
specifier|final
name|String
name|CMD_DISABLE_POLL
init|=
literal|"disablepoll"
decl_stmt|;
DECL|field|CMD_ENABLE_POLL
specifier|public
specifier|static
specifier|final
name|String
name|CMD_ENABLE_POLL
init|=
literal|"enablepoll"
decl_stmt|;
DECL|field|CMD_INDEX_VERSION
specifier|public
specifier|static
specifier|final
name|String
name|CMD_INDEX_VERSION
init|=
literal|"indexversion"
decl_stmt|;
DECL|field|CMD_SHOW_COMMITS
specifier|public
specifier|static
specifier|final
name|String
name|CMD_SHOW_COMMITS
init|=
literal|"commits"
decl_stmt|;
DECL|field|GENERATION
specifier|public
specifier|static
specifier|final
name|String
name|GENERATION
init|=
literal|"generation"
decl_stmt|;
DECL|field|OFFSET
specifier|public
specifier|static
specifier|final
name|String
name|OFFSET
init|=
literal|"offset"
decl_stmt|;
DECL|field|LEN
specifier|public
specifier|static
specifier|final
name|String
name|LEN
init|=
literal|"len"
decl_stmt|;
DECL|field|FILE
specifier|public
specifier|static
specifier|final
name|String
name|FILE
init|=
literal|"file"
decl_stmt|;
DECL|field|NAME
specifier|public
specifier|static
specifier|final
name|String
name|NAME
init|=
literal|"name"
decl_stmt|;
DECL|field|SIZE
specifier|public
specifier|static
specifier|final
name|String
name|SIZE
init|=
literal|"size"
decl_stmt|;
DECL|field|LAST_MODIFIED
specifier|public
specifier|static
specifier|final
name|String
name|LAST_MODIFIED
init|=
literal|"lastmodified"
decl_stmt|;
DECL|field|CONF_FILE_SHORT
specifier|public
specifier|static
specifier|final
name|String
name|CONF_FILE_SHORT
init|=
literal|"cf"
decl_stmt|;
DECL|field|CHECKSUM
specifier|public
specifier|static
specifier|final
name|String
name|CHECKSUM
init|=
literal|"checksum"
decl_stmt|;
DECL|field|CONF_CHECKSUM
specifier|public
specifier|static
specifier|final
name|String
name|CONF_CHECKSUM
init|=
literal|"confchecksum"
decl_stmt|;
DECL|field|CONF_FILES
specifier|public
specifier|static
specifier|final
name|String
name|CONF_FILES
init|=
literal|"confFiles"
decl_stmt|;
DECL|field|REPLICATE_AFTER
specifier|public
specifier|static
specifier|final
name|String
name|REPLICATE_AFTER
init|=
literal|"replicateAfter"
decl_stmt|;
DECL|field|FILE_STREAM
specifier|public
specifier|static
specifier|final
name|String
name|FILE_STREAM
init|=
literal|"filestream"
decl_stmt|;
DECL|field|PACKET_SZ
specifier|public
specifier|static
specifier|final
name|int
name|PACKET_SZ
init|=
literal|1024
operator|*
literal|1024
decl_stmt|;
comment|// 1MB
DECL|field|RESERVE
specifier|public
specifier|static
specifier|final
name|String
name|RESERVE
init|=
literal|"commitReserveDuration"
decl_stmt|;
block|}
end_class
end_unit
