begin_unit
begin_package
DECL|package|org.apache.lucene.replicator.nrt
package|package
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|replicator
operator|.
name|nrt
package|;
end_package
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Path
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicBoolean
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicLong
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|document
operator|.
name|Document
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|IOUtils
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|LineFileDocs
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|LuceneTestCase
operator|.
name|SuppressCodecs
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|LuceneTestCase
operator|.
name|SuppressSysoutChecks
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|LuceneTestCase
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|TestUtil
import|;
end_import
begin_import
import|import
name|com
operator|.
name|carrotsearch
operator|.
name|randomizedtesting
operator|.
name|SeedUtils
import|;
end_import
begin_comment
comment|// MockRandom's .sd file has no index header/footer:
end_comment
begin_class
annotation|@
name|SuppressCodecs
argument_list|(
block|{
literal|"MockRandom"
block|,
literal|"Memory"
block|,
literal|"Direct"
block|,
literal|"SimpleText"
block|}
argument_list|)
annotation|@
name|SuppressSysoutChecks
argument_list|(
name|bugUrl
operator|=
literal|"Stuff gets printed, important stuff for debugging a failure"
argument_list|)
DECL|class|TestNRTReplication
specifier|public
class|class
name|TestNRTReplication
extends|extends
name|LuceneTestCase
block|{
comment|/** cwd where we start each child (server) node */
DECL|field|childTempDir
specifier|private
name|Path
name|childTempDir
decl_stmt|;
DECL|field|nodeStartCounter
specifier|final
name|AtomicLong
name|nodeStartCounter
init|=
operator|new
name|AtomicLong
argument_list|()
decl_stmt|;
DECL|field|nextPrimaryGen
specifier|private
name|long
name|nextPrimaryGen
decl_stmt|;
DECL|field|lastPrimaryGen
specifier|private
name|long
name|lastPrimaryGen
decl_stmt|;
DECL|field|docs
name|LineFileDocs
name|docs
decl_stmt|;
comment|/** Launches a child "server" (separate JVM), which is either primary or replica node */
DECL|method|startNode
specifier|private
name|NodeProcess
name|startNode
parameter_list|(
name|int
name|primaryTCPPort
parameter_list|,
specifier|final
name|int
name|id
parameter_list|,
name|Path
name|indexPath
parameter_list|,
name|long
name|forcePrimaryVersion
parameter_list|,
name|boolean
name|willCrash
parameter_list|)
throws|throws
name|IOException
block|{
name|List
argument_list|<
name|String
argument_list|>
name|cmd
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|cmd
operator|.
name|add
argument_list|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.home"
argument_list|)
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"file.separator"
argument_list|)
operator|+
literal|"bin"
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"file.separator"
argument_list|)
operator|+
literal|"java"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Xmx512m"
argument_list|)
expr_stmt|;
name|long
name|myPrimaryGen
decl_stmt|;
if|if
condition|(
name|primaryTCPPort
operator|!=
operator|-
literal|1
condition|)
block|{
comment|// I am a replica
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.primaryTCPPort="
operator|+
name|primaryTCPPort
argument_list|)
expr_stmt|;
name|myPrimaryGen
operator|=
name|lastPrimaryGen
expr_stmt|;
block|}
else|else
block|{
name|myPrimaryGen
operator|=
name|nextPrimaryGen
operator|++
expr_stmt|;
name|lastPrimaryGen
operator|=
name|myPrimaryGen
expr_stmt|;
block|}
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.primaryGen="
operator|+
name|myPrimaryGen
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.closeorcrash=false"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.node=true"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.nodeid="
operator|+
name|id
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.startNS="
operator|+
name|Node
operator|.
name|globalStartNS
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.indexpath="
operator|+
name|indexPath
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.checkonclose=true"
argument_list|)
expr_stmt|;
if|if
condition|(
name|primaryTCPPort
operator|==
operator|-
literal|1
condition|)
block|{
comment|// We are the primary node
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.isPrimary=true"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.nrtreplication.forcePrimaryVersion="
operator|+
name|forcePrimaryVersion
argument_list|)
expr_stmt|;
block|}
comment|// Mixin our own counter because this is called from a fresh thread which means the seed otherwise isn't changing each time we spawn a
comment|// new node:
name|long
name|seed
init|=
name|random
argument_list|()
operator|.
name|nextLong
argument_list|()
operator|*
name|nodeStartCounter
operator|.
name|incrementAndGet
argument_list|()
decl_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-Dtests.seed="
operator|+
name|SeedUtils
operator|.
name|formatSeed
argument_list|(
name|seed
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-ea"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"-cp"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.class.path"
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
literal|"org.junit.runner.JUnitCore"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|add
argument_list|(
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
operator|.
name|replace
argument_list|(
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
argument_list|,
literal|"SimpleServer"
argument_list|)
argument_list|)
expr_stmt|;
name|message
argument_list|(
literal|"child process command: "
operator|+
name|cmd
argument_list|)
expr_stmt|;
name|ProcessBuilder
name|pb
init|=
operator|new
name|ProcessBuilder
argument_list|(
name|cmd
argument_list|)
decl_stmt|;
name|pb
operator|.
name|redirectErrorStream
argument_list|(
literal|true
argument_list|)
expr_stmt|;
comment|// Important, so that the scary looking hs_err_<pid>.log appear under our test temp dir:
name|pb
operator|.
name|directory
argument_list|(
name|childTempDir
operator|.
name|toFile
argument_list|()
argument_list|)
expr_stmt|;
name|Process
name|p
init|=
name|pb
operator|.
name|start
argument_list|()
decl_stmt|;
name|BufferedReader
name|r
decl_stmt|;
try|try
block|{
name|r
operator|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|InputStreamReader
argument_list|(
name|p
operator|.
name|getInputStream
argument_list|()
argument_list|,
name|IOUtils
operator|.
name|UTF_8
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UnsupportedEncodingException
name|uee
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|uee
argument_list|)
throw|;
block|}
name|int
name|tcpPort
init|=
operator|-
literal|1
decl_stmt|;
name|long
name|initCommitVersion
init|=
operator|-
literal|1
decl_stmt|;
name|long
name|initInfosVersion
init|=
operator|-
literal|1
decl_stmt|;
name|Pattern
name|logTimeStart
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"^[0-9\\.]+s .*"
argument_list|)
decl_stmt|;
name|boolean
name|sawExistingSegmentsFile
init|=
literal|false
decl_stmt|;
while|while
condition|(
literal|true
condition|)
block|{
name|String
name|l
init|=
name|r
operator|.
name|readLine
argument_list|()
decl_stmt|;
if|if
condition|(
name|l
operator|==
literal|null
condition|)
block|{
name|message
argument_list|(
literal|"top: node="
operator|+
name|id
operator|+
literal|" failed to start"
argument_list|)
expr_stmt|;
try|try
block|{
name|p
operator|.
name|waitFor
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
name|message
argument_list|(
literal|"exit value="
operator|+
name|p
operator|.
name|exitValue
argument_list|()
argument_list|)
expr_stmt|;
name|message
argument_list|(
literal|"top: now fail test replica R"
operator|+
name|id
operator|+
literal|" failed to start"
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"replica R"
operator|+
name|id
operator|+
literal|" failed to start"
argument_list|)
throw|;
block|}
if|if
condition|(
name|logTimeStart
operator|.
name|matcher
argument_list|(
name|l
argument_list|)
operator|.
name|matches
argument_list|()
condition|)
block|{
comment|// Already a well-formed log output:
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|l
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|message
argument_list|(
name|l
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|l
operator|.
name|startsWith
argument_list|(
literal|"PORT: "
argument_list|)
condition|)
block|{
name|tcpPort
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|l
operator|.
name|substring
argument_list|(
literal|6
argument_list|)
operator|.
name|trim
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|l
operator|.
name|startsWith
argument_list|(
literal|"COMMIT VERSION: "
argument_list|)
condition|)
block|{
name|initCommitVersion
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|l
operator|.
name|substring
argument_list|(
literal|16
argument_list|)
operator|.
name|trim
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|l
operator|.
name|startsWith
argument_list|(
literal|"INFOS VERSION: "
argument_list|)
condition|)
block|{
name|initInfosVersion
operator|=
name|Integer
operator|.
name|parseInt
argument_list|(
name|l
operator|.
name|substring
argument_list|(
literal|15
argument_list|)
operator|.
name|trim
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|l
operator|.
name|contains
argument_list|(
literal|"will crash after"
argument_list|)
condition|)
block|{
name|willCrash
operator|=
literal|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|l
operator|.
name|startsWith
argument_list|(
literal|"NODE STARTED"
argument_list|)
condition|)
block|{
break|break;
block|}
elseif|else
if|if
condition|(
name|l
operator|.
name|contains
argument_list|(
literal|"replica cannot start: existing segments file="
argument_list|)
condition|)
block|{
name|sawExistingSegmentsFile
operator|=
literal|true
expr_stmt|;
block|}
block|}
specifier|final
name|boolean
name|finalWillCrash
init|=
name|willCrash
decl_stmt|;
comment|// Baby sits the child process, pulling its stdout and printing to our stdout:
name|AtomicBoolean
name|nodeClosing
init|=
operator|new
name|AtomicBoolean
argument_list|()
decl_stmt|;
name|Thread
name|pumper
init|=
name|ThreadPumper
operator|.
name|start
argument_list|(
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
name|message
argument_list|(
literal|"now wait for process "
operator|+
name|p
argument_list|)
expr_stmt|;
try|try
block|{
name|p
operator|.
name|waitFor
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|t
argument_list|)
throw|;
block|}
name|message
argument_list|(
literal|"done wait for process "
operator|+
name|p
argument_list|)
expr_stmt|;
name|int
name|exitValue
init|=
name|p
operator|.
name|exitValue
argument_list|()
decl_stmt|;
name|message
argument_list|(
literal|"exit value="
operator|+
name|exitValue
operator|+
literal|" willCrash="
operator|+
name|finalWillCrash
argument_list|)
expr_stmt|;
if|if
condition|(
name|exitValue
operator|!=
literal|0
operator|&&
name|finalWillCrash
operator|==
literal|false
condition|)
block|{
comment|// should fail test
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"node "
operator|+
name|id
operator|+
literal|" process had unexpected non-zero exit status="
operator|+
name|exitValue
argument_list|)
throw|;
block|}
block|}
block|}
argument_list|,
name|r
argument_list|,
name|System
operator|.
name|out
argument_list|,
literal|null
argument_list|,
name|nodeClosing
argument_list|)
decl_stmt|;
name|pumper
operator|.
name|setName
argument_list|(
literal|"pump"
operator|+
name|id
argument_list|)
expr_stmt|;
name|message
argument_list|(
literal|"top: node="
operator|+
name|id
operator|+
literal|" started at tcpPort="
operator|+
name|tcpPort
operator|+
literal|" initCommitVersion="
operator|+
name|initCommitVersion
operator|+
literal|" initInfosVersion="
operator|+
name|initInfosVersion
argument_list|)
expr_stmt|;
return|return
operator|new
name|NodeProcess
argument_list|(
name|p
argument_list|,
name|id
argument_list|,
name|tcpPort
argument_list|,
name|pumper
argument_list|,
name|primaryTCPPort
operator|==
operator|-
literal|1
argument_list|,
name|initCommitVersion
argument_list|,
name|initInfosVersion
argument_list|,
name|nodeClosing
argument_list|)
return|;
block|}
annotation|@
name|Override
DECL|method|setUp
specifier|public
name|void
name|setUp
parameter_list|()
throws|throws
name|Exception
block|{
name|super
operator|.
name|setUp
argument_list|()
expr_stmt|;
name|Node
operator|.
name|globalStartNS
operator|=
name|System
operator|.
name|nanoTime
argument_list|()
expr_stmt|;
name|childTempDir
operator|=
name|createTempDir
argument_list|(
literal|"child"
argument_list|)
expr_stmt|;
name|docs
operator|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|tearDown
specifier|public
name|void
name|tearDown
parameter_list|()
throws|throws
name|Exception
block|{
name|super
operator|.
name|tearDown
argument_list|()
expr_stmt|;
name|docs
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testReplicateDeleteAllDocuments
specifier|public
name|void
name|testReplicateDeleteAllDocuments
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|primaryPath
init|=
name|createTempDir
argument_list|(
literal|"primary"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|primaryPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|Path
name|replicaPath
init|=
name|createTempDir
argument_list|(
literal|"replica"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|replicaPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
decl_stmt|;
comment|// Tell primary current replicas:
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
name|Connection
name|primaryC
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
decl_stmt|;
name|primaryC
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|primaryC
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|// Nothing in replica index yet
name|assertVersionAndHits
argument_list|(
name|replica
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Wait for replica to show the change
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|// Delete all docs from primary
if|if
condition|(
name|random
argument_list|()
operator|.
name|nextBoolean
argument_list|()
condition|)
block|{
comment|// Inefficiently:
for|for
control|(
name|int
name|id
init|=
literal|0
init|;
name|id
operator|<
literal|10
condition|;
name|id
operator|++
control|)
block|{
name|primary
operator|.
name|deleteDocument
argument_list|(
name|primaryC
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// Efficiently:
name|primary
operator|.
name|deleteAllDocuments
argument_list|(
name|primaryC
argument_list|)
expr_stmt|;
block|}
comment|// Replica still shows 10 docs:
name|assertVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion2
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion2
operator|>
name|primaryVersion1
argument_list|)
expr_stmt|;
comment|// Wait for replica to show the change
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// Index 10 docs again:
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|primaryC
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion3
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion3
operator|>
name|primaryVersion2
argument_list|)
expr_stmt|;
comment|// Wait for replica to show the change
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion3
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|primaryC
operator|.
name|close
argument_list|()
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testReplicateForceMerge
specifier|public
name|void
name|testReplicateForceMerge
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|primaryPath
init|=
name|createTempDir
argument_list|(
literal|"primary"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|primaryPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|Path
name|replicaPath
init|=
name|createTempDir
argument_list|(
literal|"replica"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|replicaPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
name|Connection
name|primaryC
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
decl_stmt|;
name|primaryC
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|primaryC
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Index 10 more docs into primary:
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|primaryC
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion2
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion2
operator|>
name|primaryVersion1
argument_list|)
expr_stmt|;
name|primary
operator|.
name|forceMerge
argument_list|(
name|primaryC
argument_list|)
expr_stmt|;
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion3
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion3
operator|>
name|primaryVersion2
argument_list|)
expr_stmt|;
comment|// Wait for replica to show the change
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion3
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|primaryC
operator|.
name|close
argument_list|()
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// Start up, index 10 docs, replicate, but crash and restart the replica without committing it:
DECL|method|testReplicaCrashNoCommit
specifier|public
name|void
name|testReplicaCrashNoCommit
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|primaryPath
init|=
name|createTempDir
argument_list|(
literal|"primary"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|primaryPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|Path
name|replicaPath
init|=
name|createTempDir
argument_list|(
literal|"replica"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|replicaPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Wait for replica to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|// Crash replica:
name|replica
operator|.
name|crash
argument_list|()
expr_stmt|;
comment|// Restart replica:
name|replica
operator|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|replicaPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
expr_stmt|;
comment|// On startup the replica searches the last commit (empty here):
name|assertVersionAndHits
argument_list|(
name|replica
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// Ask replica to sync:
name|replica
operator|.
name|newNRTPoint
argument_list|(
name|primaryVersion1
argument_list|,
literal|0
argument_list|,
name|primary
operator|.
name|tcpPort
argument_list|)
expr_stmt|;
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// Start up, index 10 docs, replicate, commit, crash and restart the replica
DECL|method|testReplicaCrashWithCommit
specifier|public
name|void
name|testReplicaCrashWithCommit
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|primaryPath
init|=
name|createTempDir
argument_list|(
literal|"primary"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|primaryPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|Path
name|replicaPath
init|=
name|createTempDir
argument_list|(
literal|"replica"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|replicaPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Wait for replica to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|// Commit and crash replica:
name|replica
operator|.
name|commit
argument_list|()
expr_stmt|;
name|replica
operator|.
name|crash
argument_list|()
expr_stmt|;
comment|// Restart replica:
name|replica
operator|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|replicaPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
expr_stmt|;
comment|// On startup the replica searches the last commit:
name|assertVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// Start up, index 10 docs, replicate, commit, crash, index more docs, replicate, then restart the replica
DECL|method|testIndexingWhileReplicaIsDown
specifier|public
name|void
name|testIndexingWhileReplicaIsDown
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|primaryPath
init|=
name|createTempDir
argument_list|(
literal|"primary"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|primaryPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|Path
name|replicaPath
init|=
name|createTempDir
argument_list|(
literal|"replica"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|replicaPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Wait for replica to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|// Commit and crash replica:
name|replica
operator|.
name|commit
argument_list|()
expr_stmt|;
name|replica
operator|.
name|crash
argument_list|()
expr_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|)
expr_stmt|;
comment|// Index 10 more docs, while replica is down
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// And flush:
name|long
name|primaryVersion2
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion2
operator|>
name|primaryVersion1
argument_list|)
expr_stmt|;
comment|// Now restart replica:
name|replica
operator|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|replicaPath
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// On startup the replica still searches its last commit:
name|assertVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|// Now ask replica to sync:
name|replica
operator|.
name|newNRTPoint
argument_list|(
name|primaryVersion2
argument_list|,
literal|0
argument_list|,
name|primary
operator|.
name|tcpPort
argument_list|)
expr_stmt|;
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion2
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// Crash primary and promote a replica
DECL|method|testCrashPrimary1
specifier|public
name|void
name|testCrashPrimary1
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|path1
init|=
name|createTempDir
argument_list|(
literal|"1"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Path
name|path2
init|=
name|createTempDir
argument_list|(
literal|"2"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Wait for replica to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|// Crash primary:
name|primary
operator|.
name|crash
argument_list|()
expr_stmt|;
comment|// Promote replica:
name|replica
operator|.
name|commit
argument_list|()
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
name|primary
operator|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|false
argument_list|)
expr_stmt|;
comment|// Should still see 10 docs:
name|assertVersionAndHits
argument_list|(
name|primary
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// Crash primary and then restart it
DECL|method|testCrashPrimary2
specifier|public
name|void
name|testCrashPrimary2
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|path1
init|=
name|createTempDir
argument_list|(
literal|"1"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Path
name|path2
init|=
name|createTempDir
argument_list|(
literal|"2"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Wait for replica to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|primary
operator|.
name|commit
argument_list|()
expr_stmt|;
comment|// Index 10 docs, but crash before replicating or committing:
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Crash primary:
name|primary
operator|.
name|crash
argument_list|()
expr_stmt|;
comment|// Restart it:
name|primary
operator|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 more docs
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
name|long
name|primaryVersion2
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion2
operator|>
name|primaryVersion1
argument_list|)
expr_stmt|;
comment|// Wait for replica to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion2
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// Crash primary and then restart it, while a replica node is down, then bring replica node back up and make sure it properly "unforks" itself
DECL|method|testCrashPrimary3
specifier|public
name|void
name|testCrashPrimary3
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|path1
init|=
name|createTempDir
argument_list|(
literal|"1"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Path
name|path2
init|=
name|createTempDir
argument_list|(
literal|"2"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Wait for replica to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|replica
operator|.
name|commit
argument_list|()
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
name|primary
operator|.
name|crash
argument_list|()
expr_stmt|;
comment|// At this point replica is "in the future": it has 10 docs committed, but the primary crashed before committing so it has 0 docs
comment|// Restart primary:
name|primary
operator|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
expr_stmt|;
comment|// Index 20 docs into primary:
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Flush primary, but there are no replicas to sync to:
name|long
name|primaryVersion2
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
comment|// Now restart replica, which on init should detect on a "lost branch" because its 10 docs that were committed came from a different
comment|// primary node:
name|replica
operator|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|assertVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion2
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testCrashPrimaryWhileCopying
specifier|public
name|void
name|testCrashPrimaryWhileCopying
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|path1
init|=
name|createTempDir
argument_list|(
literal|"1"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Path
name|path2
init|=
name|createTempDir
argument_list|(
literal|"2"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 100 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes (async) to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
name|TestUtil
operator|.
name|nextInt
argument_list|(
name|random
argument_list|()
argument_list|,
literal|1
argument_list|,
literal|30
argument_list|)
argument_list|)
expr_stmt|;
comment|// Crash primary, likely/hopefully while replica is still copying
name|primary
operator|.
name|crash
argument_list|()
expr_stmt|;
comment|// Could see either 100 docs (replica finished before crash) or 0 docs:
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|replica
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_SEARCH_ALL
argument_list|)
expr_stmt|;
name|c
operator|.
name|flush
argument_list|()
expr_stmt|;
name|long
name|version
init|=
name|c
operator|.
name|in
operator|.
name|readVLong
argument_list|()
decl_stmt|;
name|int
name|hitCount
init|=
name|c
operator|.
name|in
operator|.
name|readVInt
argument_list|()
decl_stmt|;
if|if
condition|(
name|version
operator|==
literal|0
condition|)
block|{
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|hitCount
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assertEquals
argument_list|(
name|primaryVersion1
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|100
argument_list|,
name|hitCount
argument_list|)
expr_stmt|;
block|}
block|}
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testCrashReplica
specifier|public
name|void
name|testCrashReplica
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|path1
init|=
name|createTempDir
argument_list|(
literal|"1"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Path
name|path2
init|=
name|createTempDir
argument_list|(
literal|"2"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Index 10 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes to replica:
name|long
name|primaryVersion1
init|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|// Wait for replica to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica
argument_list|,
name|primaryVersion1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|// Crash replica
name|replica
operator|.
name|crash
argument_list|()
expr_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|)
expr_stmt|;
comment|// Lots of new flushes while replica is down:
name|long
name|primaryVersion2
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|iter
init|=
literal|0
init|;
name|iter
operator|<
literal|10
condition|;
name|iter
operator|++
control|)
block|{
comment|// Index 10 docs into primary:
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
name|primaryVersion2
operator|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
comment|// Start up replica again:
name|replica
operator|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// Now ask replica to sync:
name|replica
operator|.
name|newNRTPoint
argument_list|(
name|primaryVersion2
argument_list|,
literal|0
argument_list|,
name|primary
operator|.
name|tcpPort
argument_list|)
expr_stmt|;
comment|// Make sure it sees all docs that were indexed while it was down:
name|assertVersionAndHits
argument_list|(
name|primary
argument_list|,
name|primaryVersion2
argument_list|,
literal|110
argument_list|)
expr_stmt|;
name|replica
operator|.
name|close
argument_list|()
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testFullClusterCrash
specifier|public
name|void
name|testFullClusterCrash
parameter_list|()
throws|throws
name|Exception
block|{
name|Path
name|path1
init|=
name|createTempDir
argument_list|(
literal|"1"
argument_list|)
decl_stmt|;
name|NodeProcess
name|primary
init|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Path
name|path2
init|=
name|createTempDir
argument_list|(
literal|"2"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica1
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|Path
name|path3
init|=
name|createTempDir
argument_list|(
literal|"3"
argument_list|)
decl_stmt|;
name|NodeProcess
name|replica2
init|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|2
argument_list|,
name|path3
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|sendReplicasToPrimary
argument_list|(
name|primary
argument_list|,
name|replica1
argument_list|,
name|replica2
argument_list|)
expr_stmt|;
comment|// Index 50 docs into primary:
name|LineFileDocs
name|docs
init|=
operator|new
name|LineFileDocs
argument_list|(
name|random
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|primaryVersion1
init|=
literal|0
decl_stmt|;
for|for
control|(
name|int
name|iter
init|=
literal|0
init|;
name|iter
operator|<
literal|5
condition|;
name|iter
operator|++
control|)
block|{
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Refresh primary, which also pushes to replicas:
name|primaryVersion1
operator|=
name|primary
operator|.
name|flush
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|primaryVersion1
operator|>
literal|0
argument_list|)
expr_stmt|;
block|}
comment|// Wait for replicas to sync up:
name|waitForVersionAndHits
argument_list|(
name|replica1
argument_list|,
name|primaryVersion1
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|waitForVersionAndHits
argument_list|(
name|replica2
argument_list|,
name|primaryVersion1
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|primary
operator|.
name|commit
argument_list|()
expr_stmt|;
name|replica1
operator|.
name|commit
argument_list|()
expr_stmt|;
name|replica2
operator|.
name|commit
argument_list|()
expr_stmt|;
comment|// Index 10 more docs, but don't sync to replicas:
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_INDEXING
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|Document
name|doc
init|=
name|docs
operator|.
name|nextDoc
argument_list|()
decl_stmt|;
name|primary
operator|.
name|addOrUpdateDocument
argument_list|(
name|c
argument_list|,
name|doc
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Full cluster crash
name|primary
operator|.
name|crash
argument_list|()
expr_stmt|;
name|replica1
operator|.
name|crash
argument_list|()
expr_stmt|;
name|replica2
operator|.
name|crash
argument_list|()
expr_stmt|;
comment|// Full cluster restart
name|primary
operator|=
name|startNode
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|path1
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|replica1
operator|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|1
argument_list|,
name|path2
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|replica2
operator|=
name|startNode
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|,
literal|2
argument_list|,
name|path3
argument_list|,
operator|-
literal|1
argument_list|,
literal|true
argument_list|)
expr_stmt|;
comment|// Only 50 because we didn't commit primary before the crash:
comment|// It's -1 because it's unpredictable how IW changes segments version on init:
name|assertVersionAndHits
argument_list|(
name|primary
argument_list|,
operator|-
literal|1
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|assertVersionAndHits
argument_list|(
name|replica1
argument_list|,
name|primary
operator|.
name|initInfosVersion
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|assertVersionAndHits
argument_list|(
name|replica2
argument_list|,
name|primary
operator|.
name|initInfosVersion
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|primary
operator|.
name|close
argument_list|()
expr_stmt|;
name|replica1
operator|.
name|close
argument_list|()
expr_stmt|;
name|replica2
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|/** Tell primary current replicas. */
DECL|method|sendReplicasToPrimary
specifier|private
name|void
name|sendReplicasToPrimary
parameter_list|(
name|NodeProcess
name|primary
parameter_list|,
name|NodeProcess
modifier|...
name|replicas
parameter_list|)
throws|throws
name|IOException
block|{
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|primary
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_SET_REPLICAS
argument_list|)
expr_stmt|;
name|c
operator|.
name|out
operator|.
name|writeVInt
argument_list|(
name|replicas
operator|.
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|id
init|=
literal|0
init|;
name|id
operator|<
name|replicas
operator|.
name|length
condition|;
name|id
operator|++
control|)
block|{
name|NodeProcess
name|replica
init|=
name|replicas
index|[
name|id
index|]
decl_stmt|;
name|c
operator|.
name|out
operator|.
name|writeVInt
argument_list|(
name|replica
operator|.
name|id
argument_list|)
expr_stmt|;
name|c
operator|.
name|out
operator|.
name|writeVInt
argument_list|(
name|replica
operator|.
name|tcpPort
argument_list|)
expr_stmt|;
block|}
name|c
operator|.
name|flush
argument_list|()
expr_stmt|;
name|c
operator|.
name|in
operator|.
name|readByte
argument_list|()
expr_stmt|;
block|}
block|}
comment|/** Verifies this node is currently searching the specified version with the specified total hit count, or that it eventually does when    *  keepTrying is true. */
DECL|method|assertVersionAndHits
specifier|private
name|void
name|assertVersionAndHits
parameter_list|(
name|NodeProcess
name|node
parameter_list|,
name|long
name|expectedVersion
parameter_list|,
name|int
name|expectedHitCount
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|node
operator|.
name|tcpPort
argument_list|)
init|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_SEARCH_ALL
argument_list|)
expr_stmt|;
name|c
operator|.
name|flush
argument_list|()
expr_stmt|;
name|long
name|version
init|=
name|c
operator|.
name|in
operator|.
name|readVLong
argument_list|()
decl_stmt|;
name|int
name|hitCount
init|=
name|c
operator|.
name|in
operator|.
name|readVInt
argument_list|()
decl_stmt|;
if|if
condition|(
name|expectedVersion
operator|!=
operator|-
literal|1
condition|)
block|{
name|assertEquals
argument_list|(
literal|"wrong searcher version, with hitCount="
operator|+
name|hitCount
argument_list|,
name|expectedVersion
argument_list|,
name|version
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
name|expectedHitCount
argument_list|,
name|hitCount
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|waitForVersionAndHits
specifier|private
name|void
name|waitForVersionAndHits
parameter_list|(
name|NodeProcess
name|node
parameter_list|,
name|long
name|expectedVersion
parameter_list|,
name|int
name|expectedHitCount
parameter_list|)
throws|throws
name|Exception
block|{
try|try
init|(
name|Connection
name|c
init|=
operator|new
name|Connection
argument_list|(
name|node
operator|.
name|tcpPort
argument_list|)
init|)
block|{
while|while
condition|(
literal|true
condition|)
block|{
name|c
operator|.
name|out
operator|.
name|writeByte
argument_list|(
name|SimplePrimaryNode
operator|.
name|CMD_SEARCH_ALL
argument_list|)
expr_stmt|;
name|c
operator|.
name|flush
argument_list|()
expr_stmt|;
name|long
name|version
init|=
name|c
operator|.
name|in
operator|.
name|readVLong
argument_list|()
decl_stmt|;
name|int
name|hitCount
init|=
name|c
operator|.
name|in
operator|.
name|readVInt
argument_list|()
decl_stmt|;
if|if
condition|(
name|version
operator|==
name|expectedVersion
condition|)
block|{
name|assertEquals
argument_list|(
name|expectedHitCount
argument_list|,
name|hitCount
argument_list|)
expr_stmt|;
break|break;
block|}
name|assertTrue
argument_list|(
name|version
operator|<
name|expectedVersion
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|message
specifier|static
name|void
name|message
parameter_list|(
name|String
name|message
parameter_list|)
block|{
name|long
name|now
init|=
name|System
operator|.
name|nanoTime
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"%5.3fs       :     parent [%11s] %s"
argument_list|,
operator|(
name|now
operator|-
name|Node
operator|.
name|globalStartNS
operator|)
operator|/
literal|1000000000.
argument_list|,
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|,
name|message
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_class
end_unit
