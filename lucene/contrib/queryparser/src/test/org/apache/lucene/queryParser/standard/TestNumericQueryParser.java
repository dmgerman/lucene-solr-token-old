begin_unit
begin_package
DECL|package|org.apache.lucene.queryParser.standard
package|package
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|queryParser
operator|.
name|standard
package|;
end_package
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|text
operator|.
name|DateFormat
import|;
end_import
begin_import
import|import
name|java
operator|.
name|text
operator|.
name|NumberFormat
import|;
end_import
begin_import
import|import
name|java
operator|.
name|text
operator|.
name|ParseException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|text
operator|.
name|SimpleDateFormat
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Random
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TimeZone
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|analysis
operator|.
name|Analyzer
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|analysis
operator|.
name|MockAnalyzer
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|document
operator|.
name|Document
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|document
operator|.
name|Field
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|document
operator|.
name|NumericField
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|IndexReader
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|RandomIndexWriter
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|queryParser
operator|.
name|core
operator|.
name|QueryNodeException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|queryParser
operator|.
name|core
operator|.
name|parser
operator|.
name|EscapeQuerySyntax
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|queryParser
operator|.
name|standard
operator|.
name|config
operator|.
name|NumberDateFormat
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|queryParser
operator|.
name|standard
operator|.
name|config
operator|.
name|NumericConfig
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|queryParser
operator|.
name|standard
operator|.
name|parser
operator|.
name|EscapeQuerySyntaxImpl
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|IndexSearcher
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|Query
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|TopDocs
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|store
operator|.
name|Directory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|LuceneTestCase
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|_TestUtil
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|AfterClass
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|BeforeClass
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Ignore
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import
begin_class
annotation|@
name|Ignore
argument_list|(
literal|"Class has problems with DateFormat"
argument_list|)
DECL|class|TestNumericQueryParser
specifier|public
class|class
name|TestNumericQueryParser
extends|extends
name|LuceneTestCase
block|{
DECL|enum|NumberType
specifier|private
specifier|static
enum|enum
name|NumberType
block|{
DECL|enum constant|NEGATIVE
DECL|enum constant|ZERO
DECL|enum constant|POSITIVE
name|NEGATIVE
block|,
name|ZERO
block|,
name|POSITIVE
block|;   }
DECL|field|DATE_STYLES
specifier|final
specifier|private
specifier|static
name|int
index|[]
name|DATE_STYLES
init|=
block|{
name|DateFormat
operator|.
name|FULL
block|,
name|DateFormat
operator|.
name|LONG
block|,
name|DateFormat
operator|.
name|MEDIUM
block|,
name|DateFormat
operator|.
name|SHORT
block|}
decl_stmt|;
DECL|field|PRECISION_STEP
specifier|final
specifier|private
specifier|static
name|int
name|PRECISION_STEP
init|=
literal|8
decl_stmt|;
DECL|field|FIELD_NAME
specifier|final
specifier|private
specifier|static
name|String
name|FIELD_NAME
init|=
literal|"field"
decl_stmt|;
DECL|field|LOCALE
specifier|private
specifier|static
name|Locale
name|LOCALE
decl_stmt|;
DECL|field|TIMEZONE
specifier|private
specifier|static
name|TimeZone
name|TIMEZONE
decl_stmt|;
DECL|field|RANDOM_NUMBER_MAP
specifier|private
specifier|static
name|Map
argument_list|<
name|String
argument_list|,
name|Number
argument_list|>
name|RANDOM_NUMBER_MAP
decl_stmt|;
DECL|field|ESCAPER
specifier|final
specifier|private
specifier|static
name|EscapeQuerySyntax
name|ESCAPER
init|=
operator|new
name|EscapeQuerySyntaxImpl
argument_list|()
decl_stmt|;
DECL|field|DATE_FIELD_NAME
specifier|final
specifier|private
specifier|static
name|String
name|DATE_FIELD_NAME
init|=
literal|"date"
decl_stmt|;
DECL|field|DATE_STYLE
specifier|private
specifier|static
name|int
name|DATE_STYLE
decl_stmt|;
DECL|field|TIME_STYLE
specifier|private
specifier|static
name|int
name|TIME_STYLE
decl_stmt|;
DECL|field|ANALYZER
specifier|private
specifier|static
name|Analyzer
name|ANALYZER
decl_stmt|;
DECL|field|NUMBER_FORMAT
specifier|private
specifier|static
name|NumberFormat
name|NUMBER_FORMAT
decl_stmt|;
DECL|field|qp
specifier|private
specifier|static
name|StandardQueryParser
name|qp
decl_stmt|;
DECL|field|DATE_FORMAT
specifier|private
specifier|static
name|NumberDateFormat
name|DATE_FORMAT
decl_stmt|;
DECL|method|init
specifier|static
name|void
name|init
parameter_list|()
block|{
try|try
block|{
name|LOCALE
operator|=
name|randomLocale
argument_list|(
name|random
argument_list|)
expr_stmt|;
name|TIMEZONE
operator|=
name|randomTimeZone
argument_list|(
name|random
argument_list|)
expr_stmt|;
name|DATE_STYLE
operator|=
name|randomDateStyle
argument_list|(
name|random
argument_list|)
expr_stmt|;
name|TIME_STYLE
operator|=
name|randomDateStyle
argument_list|(
name|random
argument_list|)
expr_stmt|;
name|ANALYZER
operator|=
operator|new
name|MockAnalyzer
argument_list|(
name|random
argument_list|)
expr_stmt|;
name|qp
operator|=
operator|new
name|StandardQueryParser
argument_list|(
name|ANALYZER
argument_list|)
expr_stmt|;
name|NUMBER_FORMAT
operator|=
name|NumberFormat
operator|.
name|getNumberInstance
argument_list|(
name|LOCALE
argument_list|)
expr_stmt|;
name|NUMBER_FORMAT
operator|.
name|setMaximumFractionDigits
argument_list|(
operator|(
name|random
operator|.
name|nextInt
argument_list|()
operator|&
literal|20
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|NUMBER_FORMAT
operator|.
name|setMinimumFractionDigits
argument_list|(
operator|(
name|random
operator|.
name|nextInt
argument_list|()
operator|&
literal|20
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|NUMBER_FORMAT
operator|.
name|setMaximumIntegerDigits
argument_list|(
operator|(
name|random
operator|.
name|nextInt
argument_list|()
operator|&
literal|20
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|NUMBER_FORMAT
operator|.
name|setMinimumIntegerDigits
argument_list|(
operator|(
name|random
operator|.
name|nextInt
argument_list|()
operator|&
literal|20
operator|)
operator|+
literal|4
argument_list|)
expr_stmt|;
comment|// the loop checks for< 1000, this is a must!
comment|// assumes localized date pattern will have at least year, month, day, hour, minute
name|SimpleDateFormat
name|dateFormat
init|=
operator|(
name|SimpleDateFormat
operator|)
name|DateFormat
operator|.
name|getDateTimeInstance
argument_list|(
name|DATE_STYLE
argument_list|,
name|TIME_STYLE
argument_list|,
name|LOCALE
argument_list|)
decl_stmt|;
comment|// not all date patterns includes era, full year, timezone and second, so we add them here
name|dateFormat
operator|.
name|applyPattern
argument_list|(
name|dateFormat
operator|.
name|toPattern
argument_list|()
operator|+
literal|" G s Z yyyy"
argument_list|)
expr_stmt|;
name|dateFormat
operator|.
name|setTimeZone
argument_list|(
name|TIMEZONE
argument_list|)
expr_stmt|;
name|DATE_FORMAT
operator|=
operator|new
name|NumberDateFormat
argument_list|(
name|dateFormat
argument_list|)
expr_stmt|;
name|HashMap
argument_list|<
name|String
argument_list|,
name|Number
argument_list|>
name|randomNumberMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|Number
argument_list|>
argument_list|()
decl_stmt|;
name|double
name|randomDouble
decl_stmt|;
name|long
name|randomLong
decl_stmt|;
name|int
name|randomInt
decl_stmt|;
name|float
name|randomFloat
decl_stmt|;
name|long
name|randomDate
decl_stmt|;
while|while
condition|(
operator|(
name|randomLong
operator|=
name|normalizeNumber
argument_list|(
name|Math
operator|.
name|abs
argument_list|(
name|random
operator|.
name|nextLong
argument_list|()
argument_list|)
argument_list|)
operator|.
name|longValue
argument_list|()
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
while|while
condition|(
operator|(
name|randomDouble
operator|=
name|normalizeNumber
argument_list|(
name|Math
operator|.
name|abs
argument_list|(
name|random
operator|.
name|nextDouble
argument_list|()
argument_list|)
argument_list|)
operator|.
name|doubleValue
argument_list|()
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
while|while
condition|(
operator|(
name|randomFloat
operator|=
name|normalizeNumber
argument_list|(
name|Math
operator|.
name|abs
argument_list|(
name|random
operator|.
name|nextFloat
argument_list|()
argument_list|)
argument_list|)
operator|.
name|floatValue
argument_list|()
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
while|while
condition|(
operator|(
name|randomInt
operator|=
name|normalizeNumber
argument_list|(
name|Math
operator|.
name|abs
argument_list|(
name|random
operator|.
name|nextInt
argument_list|()
argument_list|)
argument_list|)
operator|.
name|intValue
argument_list|()
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
comment|// make sure random date is at least one second from 0
while|while
condition|(
operator|(
name|randomDate
operator|=
name|normalizeNumber
argument_list|(
name|Math
operator|.
name|abs
argument_list|(
name|random
operator|.
name|nextLong
argument_list|()
argument_list|)
argument_list|)
operator|.
name|longValue
argument_list|()
operator|)
operator|<
literal|1000
condition|)
empty_stmt|;
comment|// prune date value so it doesn't pass in insane values to some calendars.
name|randomDate
operator|=
name|randomDate
operator|%
literal|3400000000000l
expr_stmt|;
comment|// truncate to second
name|randomDate
operator|=
operator|(
name|randomDate
operator|/
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
name|randomNumberMap
operator|.
name|put
argument_list|(
name|NumericField
operator|.
name|DataType
operator|.
name|LONG
operator|.
name|name
argument_list|()
argument_list|,
name|randomLong
argument_list|)
expr_stmt|;
name|randomNumberMap
operator|.
name|put
argument_list|(
name|NumericField
operator|.
name|DataType
operator|.
name|INT
operator|.
name|name
argument_list|()
argument_list|,
name|randomInt
argument_list|)
expr_stmt|;
name|randomNumberMap
operator|.
name|put
argument_list|(
name|NumericField
operator|.
name|DataType
operator|.
name|FLOAT
operator|.
name|name
argument_list|()
argument_list|,
name|randomFloat
argument_list|)
expr_stmt|;
name|randomNumberMap
operator|.
name|put
argument_list|(
name|NumericField
operator|.
name|DataType
operator|.
name|DOUBLE
operator|.
name|name
argument_list|()
argument_list|,
name|randomDouble
argument_list|)
expr_stmt|;
name|randomNumberMap
operator|.
name|put
argument_list|(
name|DATE_FIELD_NAME
argument_list|,
name|randomDate
argument_list|)
expr_stmt|;
name|RANDOM_NUMBER_MAP
operator|=
name|Collections
operator|.
name|unmodifiableMap
argument_list|(
name|randomNumberMap
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ParseException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
DECL|field|directory
specifier|private
specifier|static
name|Directory
name|directory
init|=
literal|null
decl_stmt|;
DECL|field|reader
specifier|private
specifier|static
name|IndexReader
name|reader
init|=
literal|null
decl_stmt|;
DECL|field|searcher
specifier|private
specifier|static
name|IndexSearcher
name|searcher
init|=
literal|null
decl_stmt|;
annotation|@
name|BeforeClass
DECL|method|beforeClass
specifier|public
specifier|static
name|void
name|beforeClass
parameter_list|()
throws|throws
name|Exception
block|{
name|init
argument_list|()
expr_stmt|;
name|directory
operator|=
name|newDirectory
argument_list|()
expr_stmt|;
name|RandomIndexWriter
name|writer
init|=
operator|new
name|RandomIndexWriter
argument_list|(
name|random
argument_list|,
name|directory
argument_list|,
name|newIndexWriterConfig
argument_list|(
name|TEST_VERSION_CURRENT
argument_list|,
operator|new
name|MockAnalyzer
argument_list|(
name|random
argument_list|)
argument_list|)
operator|.
name|setMaxBufferedDocs
argument_list|(
name|_TestUtil
operator|.
name|nextInt
argument_list|(
name|random
argument_list|,
literal|50
argument_list|,
literal|1000
argument_list|)
argument_list|)
operator|.
name|setMergePolicy
argument_list|(
name|newLogMergePolicy
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|Document
name|doc
init|=
operator|new
name|Document
argument_list|()
decl_stmt|;
name|HashMap
argument_list|<
name|String
argument_list|,
name|NumericConfig
argument_list|>
name|numericConfigMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|NumericConfig
argument_list|>
argument_list|()
decl_stmt|;
name|HashMap
argument_list|<
name|String
argument_list|,
name|NumericField
argument_list|>
name|numericFieldMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|NumericField
argument_list|>
argument_list|()
decl_stmt|;
name|qp
operator|.
name|setNumericConfigMap
argument_list|(
name|numericConfigMap
argument_list|)
expr_stmt|;
for|for
control|(
name|NumericField
operator|.
name|DataType
name|type
range|:
name|NumericField
operator|.
name|DataType
operator|.
name|values
argument_list|()
control|)
block|{
name|numericConfigMap
operator|.
name|put
argument_list|(
name|type
operator|.
name|name
argument_list|()
argument_list|,
operator|new
name|NumericConfig
argument_list|(
name|PRECISION_STEP
argument_list|,
name|NUMBER_FORMAT
argument_list|,
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|NumericField
name|field
init|=
operator|new
name|NumericField
argument_list|(
name|type
operator|.
name|name
argument_list|()
argument_list|,
name|PRECISION_STEP
argument_list|,
name|Field
operator|.
name|Store
operator|.
name|YES
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|numericFieldMap
operator|.
name|put
argument_list|(
name|type
operator|.
name|name
argument_list|()
argument_list|,
name|field
argument_list|)
expr_stmt|;
name|doc
operator|.
name|add
argument_list|(
name|field
argument_list|)
expr_stmt|;
block|}
name|numericConfigMap
operator|.
name|put
argument_list|(
name|DATE_FIELD_NAME
argument_list|,
operator|new
name|NumericConfig
argument_list|(
name|PRECISION_STEP
argument_list|,
name|DATE_FORMAT
argument_list|,
name|NumericField
operator|.
name|DataType
operator|.
name|LONG
argument_list|)
argument_list|)
expr_stmt|;
name|NumericField
name|dateField
init|=
operator|new
name|NumericField
argument_list|(
name|DATE_FIELD_NAME
argument_list|,
name|PRECISION_STEP
argument_list|,
name|Field
operator|.
name|Store
operator|.
name|YES
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|numericFieldMap
operator|.
name|put
argument_list|(
name|DATE_FIELD_NAME
argument_list|,
name|dateField
argument_list|)
expr_stmt|;
name|doc
operator|.
name|add
argument_list|(
name|dateField
argument_list|)
expr_stmt|;
for|for
control|(
name|NumberType
name|numberType
range|:
name|NumberType
operator|.
name|values
argument_list|()
control|)
block|{
name|setFieldValues
argument_list|(
name|numberType
argument_list|,
name|numericFieldMap
argument_list|)
expr_stmt|;
if|if
condition|(
name|VERBOSE
condition|)
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Indexing document: "
operator|+
name|doc
argument_list|)
expr_stmt|;
name|writer
operator|.
name|addDocument
argument_list|(
name|doc
argument_list|)
expr_stmt|;
block|}
name|reader
operator|=
name|writer
operator|.
name|getReader
argument_list|()
expr_stmt|;
name|searcher
operator|=
name|newSearcher
argument_list|(
name|reader
argument_list|)
expr_stmt|;
name|writer
operator|.
name|close
argument_list|()
expr_stmt|;
comment|//  SimpleDateFormat df = new SimpleDateFormat(
comment|//      "yyyy.MM.dd G 'at' HH:mm:ss z", LOCALE.ENGLISH);
comment|// assumes localized date pattern will have at least year, month, day, hour, minute
name|SimpleDateFormat
name|df
init|=
operator|(
name|SimpleDateFormat
operator|)
name|DateFormat
operator|.
name|getDateTimeInstance
argument_list|(
name|randomDateStyle
argument_list|(
name|random
argument_list|)
argument_list|,
name|randomDateStyle
argument_list|(
name|random
argument_list|)
argument_list|,
name|LOCALE
operator|.
name|ENGLISH
argument_list|)
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|df
operator|.
name|toPattern
argument_list|()
argument_list|)
expr_stmt|;
comment|// most of date pattern do not include era, so we add it here. Also,
comment|// sometimes second is not available, we make sure it's present too
name|df
operator|.
name|applyPattern
argument_list|(
name|df
operator|.
name|toPattern
argument_list|()
operator|+
literal|" G s Z yyyy"
argument_list|)
expr_stmt|;
name|df
operator|.
name|setTimeZone
argument_list|(
name|TIMEZONE
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|TIMEZONE
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|TIMEZONE
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|TIMEZONE
argument_list|)
expr_stmt|;
name|long
name|l1
init|=
literal|0
decl_stmt|;
name|long
name|l2
init|=
operator|-
literal|30000
decl_stmt|;
name|String
name|d1
init|=
name|df
operator|.
name|format
argument_list|(
operator|new
name|Date
argument_list|(
name|l1
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|d2
init|=
name|df
operator|.
name|format
argument_list|(
operator|new
name|Date
argument_list|(
name|l2
argument_list|)
argument_list|)
decl_stmt|;
name|long
name|newL1
init|=
name|df
operator|.
name|parse
argument_list|(
name|d1
argument_list|)
operator|.
name|getTime
argument_list|()
decl_stmt|;
name|long
name|newL2
init|=
name|df
operator|.
name|parse
argument_list|(
name|d2
argument_list|)
operator|.
name|getTime
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|l1
operator|+
literal|" => "
operator|+
name|d1
operator|+
literal|" => "
operator|+
name|newL1
argument_list|)
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|l2
operator|+
literal|" => "
operator|+
name|d2
operator|+
literal|" => "
operator|+
name|newL2
argument_list|)
expr_stmt|;
block|}
DECL|method|getNumberType
specifier|private
specifier|static
name|Number
name|getNumberType
parameter_list|(
name|NumberType
name|numberType
parameter_list|,
name|String
name|fieldName
parameter_list|)
block|{
switch|switch
condition|(
name|numberType
condition|)
block|{
case|case
name|POSITIVE
case|:
return|return
name|RANDOM_NUMBER_MAP
operator|.
name|get
argument_list|(
name|fieldName
argument_list|)
return|;
case|case
name|NEGATIVE
case|:
name|Number
name|number
init|=
name|RANDOM_NUMBER_MAP
operator|.
name|get
argument_list|(
name|fieldName
argument_list|)
decl_stmt|;
if|if
condition|(
name|NumericField
operator|.
name|DataType
operator|.
name|LONG
operator|.
name|name
argument_list|()
operator|.
name|equals
argument_list|(
name|fieldName
argument_list|)
operator|||
name|DATE_FIELD_NAME
operator|.
name|equals
argument_list|(
name|fieldName
argument_list|)
condition|)
block|{
name|number
operator|=
operator|-
name|number
operator|.
name|longValue
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|NumericField
operator|.
name|DataType
operator|.
name|DOUBLE
operator|.
name|name
argument_list|()
operator|.
name|equals
argument_list|(
name|fieldName
argument_list|)
condition|)
block|{
name|number
operator|=
operator|-
name|number
operator|.
name|doubleValue
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|NumericField
operator|.
name|DataType
operator|.
name|FLOAT
operator|.
name|name
argument_list|()
operator|.
name|equals
argument_list|(
name|fieldName
argument_list|)
condition|)
block|{
name|number
operator|=
operator|-
name|number
operator|.
name|floatValue
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|NumericField
operator|.
name|DataType
operator|.
name|INT
operator|.
name|name
argument_list|()
operator|.
name|equals
argument_list|(
name|fieldName
argument_list|)
condition|)
block|{
name|number
operator|=
operator|-
name|number
operator|.
name|intValue
argument_list|()
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"field name not found: "
operator|+
name|fieldName
argument_list|)
throw|;
block|}
return|return
name|number
return|;
default|default:
return|return
literal|0
return|;
block|}
block|}
DECL|method|setFieldValues
specifier|private
specifier|static
name|void
name|setFieldValues
parameter_list|(
name|NumberType
name|numberType
parameter_list|,
name|HashMap
argument_list|<
name|String
argument_list|,
name|NumericField
argument_list|>
name|numericFieldMap
parameter_list|)
block|{
name|Number
name|number
init|=
name|getNumberType
argument_list|(
name|numberType
argument_list|,
name|NumericField
operator|.
name|DataType
operator|.
name|DOUBLE
operator|.
name|name
argument_list|()
argument_list|)
decl_stmt|;
name|numericFieldMap
operator|.
name|get
argument_list|(
name|NumericField
operator|.
name|DataType
operator|.
name|DOUBLE
operator|.
name|name
argument_list|()
argument_list|)
operator|.
name|setDoubleValue
argument_list|(
name|number
operator|.
name|doubleValue
argument_list|()
argument_list|)
expr_stmt|;
name|number
operator|=
name|getNumberType
argument_list|(
name|numberType
argument_list|,
name|NumericField
operator|.
name|DataType
operator|.
name|INT
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|numericFieldMap
operator|.
name|get
argument_list|(
name|NumericField
operator|.
name|DataType
operator|.
name|INT
operator|.
name|name
argument_list|()
argument_list|)
operator|.
name|setIntValue
argument_list|(
name|number
operator|.
name|intValue
argument_list|()
argument_list|)
expr_stmt|;
name|number
operator|=
name|getNumberType
argument_list|(
name|numberType
argument_list|,
name|NumericField
operator|.
name|DataType
operator|.
name|LONG
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|numericFieldMap
operator|.
name|get
argument_list|(
name|NumericField
operator|.
name|DataType
operator|.
name|LONG
operator|.
name|name
argument_list|()
argument_list|)
operator|.
name|setLongValue
argument_list|(
name|number
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
name|number
operator|=
name|getNumberType
argument_list|(
name|numberType
argument_list|,
name|NumericField
operator|.
name|DataType
operator|.
name|FLOAT
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|numericFieldMap
operator|.
name|get
argument_list|(
name|NumericField
operator|.
name|DataType
operator|.
name|FLOAT
operator|.
name|name
argument_list|()
argument_list|)
operator|.
name|setFloatValue
argument_list|(
name|number
operator|.
name|floatValue
argument_list|()
argument_list|)
expr_stmt|;
name|number
operator|=
name|getNumberType
argument_list|(
name|numberType
argument_list|,
name|DATE_FIELD_NAME
argument_list|)
expr_stmt|;
name|numericFieldMap
operator|.
name|get
argument_list|(
name|DATE_FIELD_NAME
argument_list|)
operator|.
name|setLongValue
argument_list|(
name|number
operator|.
name|longValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|randomDateStyle
specifier|private
specifier|static
name|int
name|randomDateStyle
parameter_list|(
name|Random
name|random
parameter_list|)
block|{
return|return
name|DATE_STYLES
index|[
name|random
operator|.
name|nextInt
argument_list|(
name|DATE_STYLES
operator|.
name|length
argument_list|)
index|]
return|;
block|}
annotation|@
name|Test
DECL|method|testInclusiveNumericRange
specifier|public
name|void
name|testInclusiveNumericRange
parameter_list|()
throws|throws
name|Exception
block|{
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|ZERO
argument_list|,
name|NumberType
operator|.
name|ZERO
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|ZERO
argument_list|,
name|NumberType
operator|.
name|POSITIVE
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
name|NumberType
operator|.
name|ZERO
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
name|NumberType
operator|.
name|POSITIVE
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// @Test
comment|// test disabled since standard syntax parser does not work with inclusive and
comment|// exclusive at the same time
comment|//   public void testInclusiveLowerNumericRange() throws Exception {
comment|//   assertRangeQuery(NumberType.NEGATIVE, NumberType.ZERO, true, false, 1);
comment|//   assertRangeQuery(NumberType.ZERO, NumberType.POSITIVE, true, false, 1);
comment|//   assertRangeQuery(NumberType.NEGATIVE, NumberType.POSITIVE, true, false, 2);
comment|//   assertRangeQuery(NumberType.NEGATIVE, NumberType.NEGATIVE, true, false, 1);
comment|//   }
comment|// @Test
comment|// test disabled since standard syntax parser does not work with inclusive and
comment|// exclusive at the same time
comment|//   public void testInclusiveUpperNumericRange() throws Exception {
comment|//     assertRangeQuery(NumberType.NEGATIVE, NumberType.ZERO, false, true, 1);
comment|//     assertRangeQuery(NumberType.ZERO, NumberType.POSITIVE, false, true, 1);
comment|//     assertRangeQuery(NumberType.NEGATIVE, NumberType.POSITIVE, false, true, 2);
comment|//     assertRangeQuery(NumberType.NEGATIVE, NumberType.NEGATIVE, false, true, 1);
comment|//   }
annotation|@
name|Test
DECL|method|testExclusiveNumericRange
specifier|public
name|void
name|testExclusiveNumericRange
parameter_list|()
throws|throws
name|Exception
block|{
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|ZERO
argument_list|,
name|NumberType
operator|.
name|ZERO
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|ZERO
argument_list|,
name|NumberType
operator|.
name|POSITIVE
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
name|NumberType
operator|.
name|ZERO
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
name|NumberType
operator|.
name|POSITIVE
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|assertRangeQuery
argument_list|(
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testSimpleNumericQuery
specifier|public
name|void
name|testSimpleNumericQuery
parameter_list|()
throws|throws
name|Exception
block|{
name|assertSimpleQuery
argument_list|(
name|NumberType
operator|.
name|ZERO
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|assertSimpleQuery
argument_list|(
name|NumberType
operator|.
name|POSITIVE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|assertSimpleQuery
argument_list|(
name|NumberType
operator|.
name|NEGATIVE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|assertRangeQuery
specifier|public
name|void
name|assertRangeQuery
parameter_list|(
name|NumberType
name|lowerType
parameter_list|,
name|NumberType
name|upperType
parameter_list|,
name|boolean
name|upperInclusive
parameter_list|,
name|boolean
name|lowerInclusive
parameter_list|,
name|int
name|expectedDocCount
parameter_list|)
throws|throws
name|QueryNodeException
throws|,
name|IOException
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|String
name|lowerInclusiveStr
init|=
operator|(
name|lowerInclusive
condition|?
literal|"["
else|:
literal|"{"
operator|)
decl_stmt|;
name|String
name|upperInclusiveStr
init|=
operator|(
name|upperInclusive
condition|?
literal|"]"
else|:
literal|"}"
operator|)
decl_stmt|;
for|for
control|(
name|NumericField
operator|.
name|DataType
name|type
range|:
name|NumericField
operator|.
name|DataType
operator|.
name|values
argument_list|()
control|)
block|{
name|String
name|lowerStr
init|=
name|numberToString
argument_list|(
name|getNumberType
argument_list|(
name|lowerType
argument_list|,
name|type
operator|.
name|name
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|upperStr
init|=
name|numberToString
argument_list|(
name|getNumberType
argument_list|(
name|upperType
argument_list|,
name|type
operator|.
name|name
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"+"
argument_list|)
operator|.
name|append
argument_list|(
name|type
operator|.
name|name
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|':'
argument_list|)
operator|.
name|append
argument_list|(
name|lowerInclusiveStr
argument_list|)
operator|.
name|append
argument_list|(
literal|'"'
argument_list|)
operator|.
name|append
argument_list|(
name|lowerStr
argument_list|)
operator|.
name|append
argument_list|(
literal|"\" TO \""
argument_list|)
operator|.
name|append
argument_list|(
name|upperStr
argument_list|)
operator|.
name|append
argument_list|(
literal|'"'
argument_list|)
operator|.
name|append
argument_list|(
name|upperInclusiveStr
argument_list|)
operator|.
name|append
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
name|String
name|lowerDateStr
init|=
name|ESCAPER
operator|.
name|escape
argument_list|(
name|DATE_FORMAT
operator|.
name|format
argument_list|(
operator|new
name|Date
argument_list|(
name|getNumberType
argument_list|(
name|lowerType
argument_list|,
name|DATE_FIELD_NAME
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
argument_list|)
argument_list|,
name|LOCALE
argument_list|,
name|EscapeQuerySyntax
operator|.
name|Type
operator|.
name|STRING
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
name|String
name|upperDateStr
init|=
name|ESCAPER
operator|.
name|escape
argument_list|(
name|DATE_FORMAT
operator|.
name|format
argument_list|(
operator|new
name|Date
argument_list|(
name|getNumberType
argument_list|(
name|upperType
argument_list|,
name|DATE_FIELD_NAME
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
argument_list|)
argument_list|,
name|LOCALE
argument_list|,
name|EscapeQuerySyntax
operator|.
name|Type
operator|.
name|STRING
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"+"
argument_list|)
operator|.
name|append
argument_list|(
name|DATE_FIELD_NAME
argument_list|)
operator|.
name|append
argument_list|(
literal|':'
argument_list|)
operator|.
name|append
argument_list|(
name|lowerInclusiveStr
argument_list|)
operator|.
name|append
argument_list|(
literal|'"'
argument_list|)
operator|.
name|append
argument_list|(
name|lowerDateStr
argument_list|)
operator|.
name|append
argument_list|(
literal|"\" TO \""
argument_list|)
operator|.
name|append
argument_list|(
name|upperDateStr
argument_list|)
operator|.
name|append
argument_list|(
literal|'"'
argument_list|)
operator|.
name|append
argument_list|(
name|upperInclusiveStr
argument_list|)
expr_stmt|;
name|testQuery
argument_list|(
name|sb
operator|.
name|toString
argument_list|()
argument_list|,
name|expectedDocCount
argument_list|)
expr_stmt|;
block|}
DECL|method|assertSimpleQuery
specifier|public
name|void
name|assertSimpleQuery
parameter_list|(
name|NumberType
name|numberType
parameter_list|,
name|int
name|expectedDocCount
parameter_list|)
throws|throws
name|QueryNodeException
throws|,
name|IOException
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|NumericField
operator|.
name|DataType
name|type
range|:
name|NumericField
operator|.
name|DataType
operator|.
name|values
argument_list|()
control|)
block|{
name|String
name|numberStr
init|=
name|numberToString
argument_list|(
name|getNumberType
argument_list|(
name|numberType
argument_list|,
name|type
operator|.
name|name
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|'+'
argument_list|)
operator|.
name|append
argument_list|(
name|type
operator|.
name|name
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|":\""
argument_list|)
operator|.
name|append
argument_list|(
name|numberStr
argument_list|)
operator|.
name|append
argument_list|(
literal|"\" "
argument_list|)
expr_stmt|;
block|}
name|String
name|dateStr
init|=
name|ESCAPER
operator|.
name|escape
argument_list|(
name|DATE_FORMAT
operator|.
name|format
argument_list|(
operator|new
name|Date
argument_list|(
name|getNumberType
argument_list|(
name|numberType
argument_list|,
name|DATE_FIELD_NAME
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|)
argument_list|)
argument_list|,
name|LOCALE
argument_list|,
name|EscapeQuerySyntax
operator|.
name|Type
operator|.
name|STRING
argument_list|)
operator|.
name|toString
argument_list|()
decl_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|'+'
argument_list|)
operator|.
name|append
argument_list|(
name|DATE_FIELD_NAME
argument_list|)
operator|.
name|append
argument_list|(
literal|":\""
argument_list|)
operator|.
name|append
argument_list|(
name|dateStr
argument_list|)
operator|.
name|append
argument_list|(
literal|'"'
argument_list|)
expr_stmt|;
name|testQuery
argument_list|(
name|sb
operator|.
name|toString
argument_list|()
argument_list|,
name|expectedDocCount
argument_list|)
expr_stmt|;
block|}
DECL|method|testQuery
specifier|private
name|void
name|testQuery
parameter_list|(
name|String
name|queryStr
parameter_list|,
name|int
name|expectedDocCount
parameter_list|)
throws|throws
name|QueryNodeException
throws|,
name|IOException
block|{
if|if
condition|(
name|VERBOSE
condition|)
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Parsing: "
operator|+
name|queryStr
argument_list|)
expr_stmt|;
name|Query
name|query
init|=
name|qp
operator|.
name|parse
argument_list|(
name|queryStr
argument_list|,
name|FIELD_NAME
argument_list|)
decl_stmt|;
if|if
condition|(
name|VERBOSE
condition|)
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Querying: "
operator|+
name|query
argument_list|)
expr_stmt|;
name|TopDocs
name|topDocs
init|=
name|searcher
operator|.
name|search
argument_list|(
name|query
argument_list|,
literal|1000
argument_list|)
decl_stmt|;
name|String
name|msg
init|=
literal|"Query<"
operator|+
name|queryStr
operator|+
literal|"> retrieved "
operator|+
name|topDocs
operator|.
name|totalHits
operator|+
literal|" document(s), "
operator|+
name|expectedDocCount
operator|+
literal|" document(s) expected."
decl_stmt|;
if|if
condition|(
name|VERBOSE
condition|)
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|msg
argument_list|,
name|expectedDocCount
argument_list|,
name|topDocs
operator|.
name|totalHits
argument_list|)
expr_stmt|;
block|}
DECL|method|numberToString
specifier|private
specifier|static
name|String
name|numberToString
parameter_list|(
name|Number
name|number
parameter_list|)
block|{
return|return
name|ESCAPER
operator|.
name|escape
argument_list|(
name|NUMBER_FORMAT
operator|.
name|format
argument_list|(
name|number
argument_list|)
argument_list|,
name|LOCALE
argument_list|,
name|EscapeQuerySyntax
operator|.
name|Type
operator|.
name|STRING
argument_list|)
operator|.
name|toString
argument_list|()
return|;
block|}
DECL|method|normalizeNumber
specifier|private
specifier|static
name|Number
name|normalizeNumber
parameter_list|(
name|Number
name|number
parameter_list|)
throws|throws
name|ParseException
block|{
return|return
name|NUMBER_FORMAT
operator|.
name|parse
argument_list|(
name|NUMBER_FORMAT
operator|.
name|format
argument_list|(
name|number
argument_list|)
argument_list|)
return|;
block|}
annotation|@
name|AfterClass
DECL|method|afterClass
specifier|public
specifier|static
name|void
name|afterClass
parameter_list|()
throws|throws
name|Exception
block|{
name|searcher
operator|.
name|close
argument_list|()
expr_stmt|;
name|searcher
operator|=
literal|null
expr_stmt|;
name|reader
operator|.
name|close
argument_list|()
expr_stmt|;
name|reader
operator|=
literal|null
expr_stmt|;
name|directory
operator|.
name|close
argument_list|()
expr_stmt|;
name|directory
operator|=
literal|null
expr_stmt|;
block|}
block|}
end_class
end_unit
