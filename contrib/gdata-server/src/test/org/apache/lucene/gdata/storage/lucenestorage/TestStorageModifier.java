begin_unit
begin_package
DECL|package|org.apache.lucene.gdata.storage.lucenestorage
package|package
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|lucenestorage
package|;
end_package
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|junit
operator|.
name|framework
operator|.
name|TestCase
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|data
operator|.
name|GDataAccount
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|data
operator|.
name|ServerBaseEntry
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|data
operator|.
name|ServerBaseFeed
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|server
operator|.
name|registry
operator|.
name|ProvidedService
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|StorageException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|lucenestorage
operator|.
name|StorageEntryWrapper
operator|.
name|StorageOperation
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|lucenestorage
operator|.
name|util
operator|.
name|ReferenceCounter
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|utils
operator|.
name|ProvidedServiceStub
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|Term
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|BooleanClause
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|BooleanQuery
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|Hits
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|IndexSearcher
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|Query
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|TermQuery
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|store
operator|.
name|Directory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|store
operator|.
name|RAMDirectory
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|BaseEntry
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|DateTime
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|Entry
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|PlainTextConstruct
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|TextContent
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|util
operator|.
name|ParseException
import|;
end_import
begin_class
DECL|class|TestStorageModifier
specifier|public
class|class
name|TestStorageModifier
extends|extends
name|TestCase
block|{
DECL|field|modifier
specifier|private
name|StorageModifier
name|modifier
decl_stmt|;
DECL|field|count
specifier|private
name|int
name|count
init|=
literal|1
decl_stmt|;
DECL|field|configurator
specifier|private
name|ProvidedService
name|configurator
decl_stmt|;
DECL|field|dir
specifier|private
name|Directory
name|dir
decl_stmt|;
DECL|field|controller
specifier|private
name|StorageCoreController
name|controller
decl_stmt|;
DECL|field|feedId
specifier|private
specifier|static
name|String
name|feedId
init|=
literal|"myFeed"
decl_stmt|;
DECL|field|username
specifier|private
specifier|static
name|String
name|username
init|=
literal|"simon"
decl_stmt|;
DECL|field|password
specifier|private
specifier|static
name|String
name|password
init|=
literal|"test"
decl_stmt|;
DECL|field|service
specifier|private
specifier|static
name|String
name|service
init|=
literal|"myService"
decl_stmt|;
DECL|method|setUp
specifier|protected
name|void
name|setUp
parameter_list|()
throws|throws
name|Exception
block|{
name|this
operator|.
name|controller
operator|=
operator|new
name|StorageCoreController
argument_list|()
expr_stmt|;
name|this
operator|.
name|dir
operator|=
operator|new
name|RAMDirectory
argument_list|()
expr_stmt|;
name|this
operator|.
name|controller
operator|.
name|setStorageDir
argument_list|(
name|this
operator|.
name|dir
argument_list|)
expr_stmt|;
name|this
operator|.
name|controller
operator|.
name|setKeepRecoveredFiles
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|this
operator|.
name|controller
operator|.
name|setOptimizeInterval
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|this
operator|.
name|controller
operator|.
name|setRecover
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|this
operator|.
name|controller
operator|.
name|setBufferSize
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|this
operator|.
name|controller
operator|.
name|setPersistFactor
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|this
operator|.
name|controller
operator|.
name|initialize
argument_list|()
expr_stmt|;
name|this
operator|.
name|configurator
operator|=
operator|new
name|ProvidedServiceStub
argument_list|()
expr_stmt|;
name|this
operator|.
name|modifier
operator|=
name|this
operator|.
name|controller
operator|.
name|getStorageModifier
argument_list|()
expr_stmt|;
name|this
operator|.
name|dir
operator|=
name|this
operator|.
name|controller
operator|.
name|getDirectory
argument_list|()
expr_stmt|;
block|}
DECL|method|tearDown
specifier|protected
name|void
name|tearDown
parameter_list|()
throws|throws
name|Exception
block|{
name|this
operator|.
name|count
operator|=
literal|1
expr_stmt|;
comment|// destroy all resources
name|this
operator|.
name|controller
operator|.
name|destroy
argument_list|()
expr_stmt|;
block|}
comment|/*      * Test method for      * 'org.apache.lucene.storage.lucenestorage.StorageModifier.updateEntry(StroageEntryWrapper)'      */
DECL|method|testUpdateEntry
specifier|public
name|void
name|testUpdateEntry
parameter_list|()
throws|throws
name|IOException
throws|,
name|InterruptedException
throws|,
name|ParseException
throws|,
name|StorageException
block|{
name|testInsertEntry
argument_list|()
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|this
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|Entry
name|e
init|=
operator|new
name|Entry
argument_list|()
decl_stmt|;
name|e
operator|.
name|setId
argument_list|(
literal|""
operator|+
name|i
argument_list|)
expr_stmt|;
name|String
name|insertString
init|=
literal|"Hello world"
operator|+
name|i
decl_stmt|;
name|e
operator|.
name|setTitle
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
name|insertString
argument_list|)
argument_list|)
expr_stmt|;
name|ServerBaseEntry
name|en
init|=
name|getServerEntry
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|StorageEntryWrapper
name|wrapper
init|=
operator|new
name|StorageEntryWrapper
argument_list|(
name|en
argument_list|,
name|StorageOperation
operator|.
name|UPDATE
argument_list|)
decl_stmt|;
name|this
operator|.
name|modifier
operator|.
name|updateEntry
argument_list|(
name|wrapper
argument_list|)
expr_stmt|;
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|innerQuery
init|=
name|this
operator|.
name|controller
operator|.
name|getStorageQuery
argument_list|()
decl_stmt|;
name|BaseEntry
name|fetchedEntry
init|=
name|innerQuery
operator|.
name|get
argument_list|()
operator|.
name|singleEntryQuery
argument_list|(
literal|""
operator|+
name|i
argument_list|,
name|feedId
argument_list|,
name|this
operator|.
name|configurator
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"updated Title:"
argument_list|,
name|insertString
argument_list|,
name|fetchedEntry
operator|.
name|getTitle
argument_list|()
operator|.
name|getPlainText
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// double updates
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|this
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|Entry
name|e
init|=
operator|new
name|Entry
argument_list|()
decl_stmt|;
name|e
operator|.
name|setId
argument_list|(
literal|""
operator|+
name|i
argument_list|)
expr_stmt|;
name|String
name|insertString
init|=
literal|"Hello world"
operator|+
name|i
decl_stmt|;
name|e
operator|.
name|setTitle
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
name|insertString
argument_list|)
argument_list|)
expr_stmt|;
name|ServerBaseEntry
name|en
init|=
name|getServerEntry
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|StorageEntryWrapper
name|wrapper
init|=
operator|new
name|StorageEntryWrapper
argument_list|(
name|en
argument_list|,
name|StorageOperation
operator|.
name|UPDATE
argument_list|)
decl_stmt|;
name|this
operator|.
name|modifier
operator|.
name|updateEntry
argument_list|(
name|wrapper
argument_list|)
expr_stmt|;
name|e
operator|=
operator|new
name|Entry
argument_list|()
expr_stmt|;
name|e
operator|.
name|setId
argument_list|(
literal|""
operator|+
name|i
argument_list|)
expr_stmt|;
name|insertString
operator|=
literal|"Foo Bar"
operator|+
name|i
expr_stmt|;
name|e
operator|.
name|setTitle
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
name|insertString
argument_list|)
argument_list|)
expr_stmt|;
name|en
operator|=
name|getServerEntry
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|wrapper
operator|=
operator|new
name|StorageEntryWrapper
argument_list|(
name|en
argument_list|,
name|StorageOperation
operator|.
name|UPDATE
argument_list|)
expr_stmt|;
name|this
operator|.
name|modifier
operator|.
name|updateEntry
argument_list|(
name|wrapper
argument_list|)
expr_stmt|;
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|innerQuery
init|=
name|this
operator|.
name|controller
operator|.
name|getStorageQuery
argument_list|()
decl_stmt|;
name|BaseEntry
name|fetchedEntry
init|=
name|innerQuery
operator|.
name|get
argument_list|()
operator|.
name|singleEntryQuery
argument_list|(
literal|""
operator|+
name|i
argument_list|,
name|feedId
argument_list|,
name|this
operator|.
name|configurator
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"updated Title:"
argument_list|,
name|insertString
argument_list|,
name|fetchedEntry
operator|.
name|getTitle
argument_list|()
operator|.
name|getPlainText
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * Test method for      * 'org.apache.lucene.storage.lucenestorage.StorageModifier.insertEntry(StroageEntryWrapper)'      */
DECL|method|testInsertEntry
specifier|public
name|void
name|testInsertEntry
parameter_list|()
throws|throws
name|IOException
throws|,
name|InterruptedException
throws|,
name|ParseException
throws|,
name|StorageException
block|{
name|Thread
name|a
init|=
name|getRunnerThread
argument_list|(
name|this
operator|.
name|count
argument_list|)
decl_stmt|;
name|Thread
name|b
init|=
name|getRunnerThread
argument_list|(
operator|(
name|this
operator|.
name|count
operator|+=
literal|10
operator|)
argument_list|)
decl_stmt|;
name|b
operator|.
name|start
argument_list|()
expr_stmt|;
name|a
operator|.
name|start
argument_list|()
expr_stmt|;
comment|//         wait for the first thread to check for the inserted entries
name|a
operator|.
name|join
argument_list|()
expr_stmt|;
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|this
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|innerQuery
init|=
name|this
operator|.
name|controller
operator|.
name|getStorageQuery
argument_list|()
decl_stmt|;
name|BaseEntry
name|e
init|=
name|innerQuery
operator|.
name|get
argument_list|()
operator|.
name|singleEntryQuery
argument_list|(
literal|""
operator|+
name|i
argument_list|,
name|feedId
argument_list|,
name|this
operator|.
name|configurator
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"get entry for id"
operator|+
name|i
argument_list|,
literal|""
operator|+
name|i
argument_list|,
name|e
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
comment|/*         	 * if an exception occures the tread can at least finnish running before the         	 * controller will be closed in the tearDown method         	 */
name|b
operator|.
name|join
argument_list|()
expr_stmt|;
block|}
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|query
init|=
name|this
operator|.
name|controller
operator|.
name|getStorageQuery
argument_list|()
decl_stmt|;
name|this
operator|.
name|count
operator|+=
literal|10
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|this
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|BaseEntry
name|e
init|=
name|query
operator|.
name|get
argument_list|()
operator|.
name|singleEntryQuery
argument_list|(
literal|""
operator|+
name|i
argument_list|,
name|feedId
argument_list|,
name|this
operator|.
name|configurator
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"get entry for id"
operator|+
name|i
argument_list|,
literal|""
operator|+
name|i
argument_list|,
name|e
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|BaseEntry
name|e
init|=
name|query
operator|.
name|get
argument_list|()
operator|.
name|singleEntryQuery
argument_list|(
literal|""
operator|+
name|this
operator|.
name|count
argument_list|,
name|feedId
argument_list|,
name|this
operator|.
name|configurator
argument_list|)
decl_stmt|;
name|assertNull
argument_list|(
literal|"not entry for ID"
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|query
operator|.
name|decrementRef
argument_list|()
expr_stmt|;
block|}
comment|/*      * Test method for      * 'org.apache.lucene.storage.lucenestorage.StorageModifier.deleteEntry(String)'      */
DECL|method|testDeleteEntry
specifier|public
name|void
name|testDeleteEntry
parameter_list|()
throws|throws
name|IOException
throws|,
name|InterruptedException
throws|,
name|ParseException
throws|,
name|StorageException
block|{
name|testInsertEntry
argument_list|()
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|this
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|2
operator|==
literal|0
operator|||
name|i
operator|<
literal|10
condition|)
block|{
name|ServerBaseEntry
name|entry
init|=
operator|new
name|ServerBaseEntry
argument_list|()
decl_stmt|;
name|entry
operator|.
name|setId
argument_list|(
literal|""
operator|+
name|i
argument_list|)
expr_stmt|;
name|entry
operator|.
name|setFeedId
argument_list|(
name|feedId
argument_list|)
expr_stmt|;
name|this
operator|.
name|modifier
operator|.
name|deleteEntry
argument_list|(
operator|new
name|StorageEntryWrapper
argument_list|(
name|entry
argument_list|,
name|StorageOperation
operator|.
name|DELETE
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|query
init|=
name|this
operator|.
name|controller
operator|.
name|getStorageQuery
argument_list|()
decl_stmt|;
if|if
condition|(
name|i
operator|%
literal|2
operator|==
literal|0
operator|||
name|i
operator|<
literal|10
condition|)
block|{
name|assertNull
argument_list|(
name|query
operator|.
name|get
argument_list|()
operator|.
name|singleEntryQuery
argument_list|(
literal|""
operator|+
name|i
argument_list|,
name|feedId
argument_list|,
name|this
operator|.
name|configurator
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|assertEquals
argument_list|(
literal|""
operator|+
name|i
argument_list|,
name|query
operator|.
name|get
argument_list|()
operator|.
name|singleEntryQuery
argument_list|(
literal|""
operator|+
name|i
argument_list|,
name|feedId
argument_list|,
name|this
operator|.
name|configurator
argument_list|)
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|query
operator|.
name|decrementRef
argument_list|()
expr_stmt|;
block|}
name|this
operator|.
name|controller
operator|.
name|forceWrite
argument_list|()
expr_stmt|;
name|IndexSearcher
name|searcher
init|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|dir
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|this
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|Query
name|luceneQuery
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|StorageEntryWrapper
operator|.
name|FIELD_ENTRY_ID
argument_list|,
literal|""
operator|+
name|i
argument_list|)
argument_list|)
decl_stmt|;
name|Hits
name|hits
init|=
name|searcher
operator|.
name|search
argument_list|(
name|luceneQuery
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|%
literal|2
operator|==
literal|0
operator|||
name|i
operator|<
literal|10
condition|)
block|{
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|hits
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|hits
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|searcher
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testSaveUser
specifier|public
name|void
name|testSaveUser
parameter_list|()
throws|throws
name|StorageException
throws|,
name|IOException
block|{
name|GDataAccount
name|user
init|=
operator|new
name|GDataAccount
argument_list|()
decl_stmt|;
name|user
operator|.
name|setName
argument_list|(
name|username
argument_list|)
expr_stmt|;
name|user
operator|.
name|setPassword
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|StorageAccountWrapper
name|wrapper
init|=
operator|new
name|StorageAccountWrapper
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|this
operator|.
name|modifier
operator|.
name|createAccount
argument_list|(
name|wrapper
argument_list|)
expr_stmt|;
name|IndexSearcher
name|searcher
init|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|dir
argument_list|)
decl_stmt|;
name|Query
name|q
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|StorageAccountWrapper
operator|.
name|FIELD_ACCOUNTNAME
argument_list|,
name|username
argument_list|)
argument_list|)
decl_stmt|;
name|Hits
name|h
init|=
name|searcher
operator|.
name|search
argument_list|(
name|q
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"length == 1"
argument_list|,
literal|1
argument_list|,
name|h
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|GDataAccount
name|storedUser
init|=
name|StorageAccountWrapper
operator|.
name|buildEntity
argument_list|(
name|h
operator|.
name|doc
argument_list|(
literal|0
argument_list|)
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|storedUser
operator|.
name|equals
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|searcher
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testDeleteUser
specifier|public
name|void
name|testDeleteUser
parameter_list|()
throws|throws
name|StorageException
throws|,
name|IOException
block|{
name|testSaveUser
argument_list|()
expr_stmt|;
name|this
operator|.
name|modifier
operator|.
name|deleteAccount
argument_list|(
name|username
argument_list|)
expr_stmt|;
name|IndexSearcher
name|searcher
init|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|dir
argument_list|)
decl_stmt|;
name|Query
name|q
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|StorageAccountWrapper
operator|.
name|FIELD_ACCOUNTNAME
argument_list|,
name|username
argument_list|)
argument_list|)
decl_stmt|;
name|Hits
name|h
init|=
name|searcher
operator|.
name|search
argument_list|(
name|q
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"length == 0"
argument_list|,
literal|0
argument_list|,
name|h
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|searcher
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testUpdateUser
specifier|public
name|void
name|testUpdateUser
parameter_list|()
throws|throws
name|StorageException
throws|,
name|IOException
block|{
name|testSaveUser
argument_list|()
expr_stmt|;
name|GDataAccount
name|user
init|=
operator|new
name|GDataAccount
argument_list|()
decl_stmt|;
name|user
operator|.
name|setName
argument_list|(
name|username
argument_list|)
expr_stmt|;
name|user
operator|.
name|setPassword
argument_list|(
literal|"newPass"
argument_list|)
expr_stmt|;
name|StorageAccountWrapper
name|wrapper
init|=
operator|new
name|StorageAccountWrapper
argument_list|(
name|user
argument_list|)
decl_stmt|;
name|this
operator|.
name|modifier
operator|.
name|updateAccount
argument_list|(
name|wrapper
argument_list|)
expr_stmt|;
name|IndexSearcher
name|searcher
init|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|dir
argument_list|)
decl_stmt|;
name|Query
name|q
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|StorageAccountWrapper
operator|.
name|FIELD_ACCOUNTNAME
argument_list|,
name|username
argument_list|)
argument_list|)
decl_stmt|;
name|Hits
name|h
init|=
name|searcher
operator|.
name|search
argument_list|(
name|q
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"length == 1"
argument_list|,
literal|1
argument_list|,
name|h
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|GDataAccount
name|storedUser
init|=
name|StorageAccountWrapper
operator|.
name|buildEntity
argument_list|(
name|h
operator|.
name|doc
argument_list|(
literal|0
argument_list|)
argument_list|)
decl_stmt|;
name|assertTrue
argument_list|(
name|storedUser
operator|.
name|equals
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|assertFalse
argument_list|(
name|storedUser
operator|.
name|getPassword
argument_list|()
operator|.
name|equals
argument_list|(
name|password
argument_list|)
argument_list|)
expr_stmt|;
name|searcher
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testSaveFeed
specifier|public
name|void
name|testSaveFeed
parameter_list|()
throws|throws
name|IOException
throws|,
name|StorageException
block|{
name|String
name|title
init|=
literal|"myTitle"
decl_stmt|;
name|ServerBaseFeed
name|feed
init|=
operator|new
name|ServerBaseFeed
argument_list|()
decl_stmt|;
name|feed
operator|.
name|setId
argument_list|(
name|feedId
argument_list|)
expr_stmt|;
name|feed
operator|.
name|setTitle
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
name|title
argument_list|)
argument_list|)
expr_stmt|;
name|feed
operator|.
name|setServiceType
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|feed
operator|.
name|setServiceConfig
argument_list|(
name|this
operator|.
name|configurator
argument_list|)
expr_stmt|;
name|StorageFeedWrapper
name|wrapper
init|=
operator|new
name|StorageFeedWrapper
argument_list|(
name|feed
argument_list|,
name|username
argument_list|)
decl_stmt|;
name|this
operator|.
name|modifier
operator|.
name|createFeed
argument_list|(
name|wrapper
argument_list|)
expr_stmt|;
name|IndexSearcher
name|searcher
init|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|dir
argument_list|)
decl_stmt|;
name|Query
name|q
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|StorageFeedWrapper
operator|.
name|FIELD_FEED_ID
argument_list|,
name|feedId
argument_list|)
argument_list|)
decl_stmt|;
name|Hits
name|h
init|=
name|searcher
operator|.
name|search
argument_list|(
name|q
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"length == 1"
argument_list|,
literal|1
argument_list|,
name|h
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|searcher
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|testDeleteFeed
specifier|public
name|void
name|testDeleteFeed
parameter_list|()
throws|throws
name|IOException
throws|,
name|StorageException
block|{
name|testSaveFeed
argument_list|()
expr_stmt|;
name|Entry
name|e
init|=
operator|new
name|Entry
argument_list|()
decl_stmt|;
name|e
operator|.
name|setTitle
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
literal|"hello world"
argument_list|)
argument_list|)
expr_stmt|;
name|ServerBaseEntry
name|entry
init|=
operator|new
name|ServerBaseEntry
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|entry
operator|.
name|setFeedId
argument_list|(
name|feedId
argument_list|)
expr_stmt|;
name|entry
operator|.
name|setId
argument_list|(
literal|"testme"
argument_list|)
expr_stmt|;
name|entry
operator|.
name|setServiceConfig
argument_list|(
name|this
operator|.
name|configurator
argument_list|)
expr_stmt|;
name|StorageEntryWrapper
name|entryWrapper
init|=
operator|new
name|StorageEntryWrapper
argument_list|(
name|entry
argument_list|,
name|StorageOperation
operator|.
name|INSERT
argument_list|)
decl_stmt|;
name|this
operator|.
name|modifier
operator|.
name|insertEntry
argument_list|(
name|entryWrapper
argument_list|)
expr_stmt|;
name|this
operator|.
name|modifier
operator|.
name|forceWrite
argument_list|()
expr_stmt|;
name|this
operator|.
name|modifier
operator|.
name|deleteFeed
argument_list|(
name|feedId
argument_list|)
expr_stmt|;
name|IndexSearcher
name|searcher
init|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|dir
argument_list|)
decl_stmt|;
name|Query
name|q
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|StorageFeedWrapper
operator|.
name|FIELD_FEED_ID
argument_list|,
name|feedId
argument_list|)
argument_list|)
decl_stmt|;
name|Query
name|q1
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|StorageEntryWrapper
operator|.
name|FIELD_FEED_REFERENCE
argument_list|,
name|feedId
argument_list|)
argument_list|)
decl_stmt|;
name|BooleanQuery
name|boolQuery
init|=
operator|new
name|BooleanQuery
argument_list|()
decl_stmt|;
name|boolQuery
operator|.
name|add
argument_list|(
name|q
argument_list|,
name|BooleanClause
operator|.
name|Occur
operator|.
name|SHOULD
argument_list|)
expr_stmt|;
name|boolQuery
operator|.
name|add
argument_list|(
name|q1
argument_list|,
name|BooleanClause
operator|.
name|Occur
operator|.
name|SHOULD
argument_list|)
expr_stmt|;
name|Hits
name|h
init|=
name|searcher
operator|.
name|search
argument_list|(
name|boolQuery
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"length == 0"
argument_list|,
literal|0
argument_list|,
name|h
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|searcher
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|/**      * @throws IOException      * @throws StorageException      */
DECL|method|testUpdateFeed
specifier|public
name|void
name|testUpdateFeed
parameter_list|()
throws|throws
name|IOException
throws|,
name|StorageException
block|{
name|testSaveFeed
argument_list|()
expr_stmt|;
name|ServerBaseFeed
name|feed
init|=
operator|new
name|ServerBaseFeed
argument_list|()
decl_stmt|;
name|String
name|title
init|=
literal|"myTitle"
decl_stmt|;
name|String
name|newusername
init|=
literal|"doug"
decl_stmt|;
name|feed
operator|.
name|setTitle
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
name|title
argument_list|)
argument_list|)
expr_stmt|;
name|feed
operator|.
name|setId
argument_list|(
name|feedId
argument_list|)
expr_stmt|;
name|feed
operator|.
name|setServiceType
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|feed
operator|.
name|setServiceConfig
argument_list|(
name|this
operator|.
name|configurator
argument_list|)
expr_stmt|;
name|StorageFeedWrapper
name|wrapper
init|=
operator|new
name|StorageFeedWrapper
argument_list|(
name|feed
argument_list|,
name|newusername
argument_list|)
decl_stmt|;
name|this
operator|.
name|modifier
operator|.
name|updateFeed
argument_list|(
name|wrapper
argument_list|)
expr_stmt|;
name|IndexSearcher
name|searcher
init|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|dir
argument_list|)
decl_stmt|;
name|Query
name|q
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|StorageFeedWrapper
operator|.
name|FIELD_FEED_ID
argument_list|,
name|feedId
argument_list|)
argument_list|)
decl_stmt|;
name|Hits
name|h
init|=
name|searcher
operator|.
name|search
argument_list|(
name|q
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"length == 1"
argument_list|,
literal|1
argument_list|,
name|h
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|h
operator|.
name|doc
argument_list|(
literal|0
argument_list|)
operator|.
name|get
argument_list|(
name|StorageFeedWrapper
operator|.
name|FIELD_ACCOUNTREFERENCE
argument_list|)
operator|.
name|equals
argument_list|(
name|newusername
argument_list|)
argument_list|)
expr_stmt|;
name|searcher
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
DECL|method|getRunnerThread
specifier|private
name|Thread
name|getRunnerThread
parameter_list|(
name|int
name|idIndex
parameter_list|)
block|{
name|Thread
name|t
init|=
operator|new
name|Thread
argument_list|(
operator|new
name|Runner
argument_list|(
name|idIndex
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|t
return|;
block|}
DECL|class|Runner
specifier|private
class|class
name|Runner
implements|implements
name|Runnable
block|{
DECL|field|idIndex
specifier|private
name|int
name|idIndex
decl_stmt|;
DECL|method|Runner
specifier|public
name|Runner
parameter_list|(
name|int
name|idIndex
parameter_list|)
block|{
name|this
operator|.
name|idIndex
operator|=
name|idIndex
expr_stmt|;
block|}
DECL|method|run
specifier|public
name|void
name|run
parameter_list|()
block|{
for|for
control|(
name|int
name|i
init|=
name|idIndex
init|;
name|i
operator|<
name|idIndex
operator|+
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|BaseEntry
name|e
init|=
name|buildEntry
argument_list|(
literal|""
operator|+
name|i
argument_list|)
decl_stmt|;
try|try
block|{
name|ServerBaseEntry
name|en
init|=
operator|new
name|ServerBaseEntry
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|en
operator|.
name|setFeedId
argument_list|(
name|feedId
argument_list|)
expr_stmt|;
name|en
operator|.
name|setServiceConfig
argument_list|(
name|configurator
argument_list|)
expr_stmt|;
name|StorageEntryWrapper
name|wrapper
init|=
operator|new
name|StorageEntryWrapper
argument_list|(
name|en
argument_list|,
name|StorageOperation
operator|.
name|INSERT
argument_list|)
decl_stmt|;
name|modifier
operator|.
name|insertEntry
argument_list|(
name|wrapper
argument_list|)
expr_stmt|;
comment|//                    System.out.println("insert: "+i+" Thread: "+Thread.currentThread().getName());
block|}
catch|catch
parameter_list|(
name|Exception
name|e1
parameter_list|)
block|{
name|e1
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
block|}
comment|// end run
DECL|method|buildEntry
specifier|private
name|BaseEntry
name|buildEntry
parameter_list|(
name|String
name|id
parameter_list|)
block|{
name|Entry
name|e
init|=
operator|new
name|Entry
argument_list|()
decl_stmt|;
name|e
operator|.
name|setId
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|e
operator|.
name|setTitle
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
literal|"Monty Python"
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|.
name|setPublished
argument_list|(
name|DateTime
operator|.
name|now
argument_list|()
argument_list|)
expr_stmt|;
name|e
operator|.
name|setUpdated
argument_list|(
name|DateTime
operator|.
name|now
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|content
init|=
literal|"1st soldier with a keen interest in birds: Who goes there?"
operator|+
literal|"King Arthur: It is I, Arthur, son of Uther Pendragon, from the castle of Camelot. King of the Britons, defeater of the Saxons, Sovereign of all England!"
operator|+
literal|"1st soldier with a keen interest in birds: Pull the other one!"
operator|+
literal|"King Arthur: I am, and this is my trusty servant Patsy. We have ridden the length and breadth of the land in search of knights who will join me in my court at Camelot. I must speak with your lord and master."
operator|+
literal|"1st soldier with a keen interest in birds: What? Ridden on a horse?"
operator|+
literal|"King Arthur: Yes!"
decl_stmt|;
name|e
operator|.
name|setContent
argument_list|(
operator|new
name|TextContent
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
name|content
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|.
name|setSummary
argument_list|(
operator|new
name|PlainTextConstruct
argument_list|(
literal|"The Holy Grail"
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|e
return|;
block|}
block|}
DECL|method|getServerEntry
specifier|private
name|ServerBaseEntry
name|getServerEntry
parameter_list|(
name|BaseEntry
name|e
parameter_list|)
block|{
name|ServerBaseEntry
name|en
init|=
operator|new
name|ServerBaseEntry
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|en
operator|.
name|setFeedId
argument_list|(
name|feedId
argument_list|)
expr_stmt|;
name|en
operator|.
name|setServiceConfig
argument_list|(
name|this
operator|.
name|configurator
argument_list|)
expr_stmt|;
return|return
name|en
return|;
block|}
block|}
end_class
end_unit
