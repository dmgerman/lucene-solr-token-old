begin_unit
begin_package
DECL|package|org.apache.lucene.gdata.storage.lucenestorage
package|package
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|lucenestorage
package|;
end_package
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|analysis
operator|.
name|standard
operator|.
name|StandardAnalyzer
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|server
operator|.
name|registry
operator|.
name|GDataServerRegistry
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|IDGenerator
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|StorageController
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|StorageException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|lucenestorage
operator|.
name|configuration
operator|.
name|StorageConfigurator
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|storage
operator|.
name|lucenestorage
operator|.
name|util
operator|.
name|ReferenceCounter
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|IndexModifier
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|IndexSearcher
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|store
operator|.
name|Directory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|store
operator|.
name|FSDirectory
import|;
end_import
begin_comment
comment|/**   * TODO document this   * @author Simon Willnauer   *   */
end_comment
begin_class
DECL|class|StorageCoreController
specifier|public
class|class
name|StorageCoreController
implements|implements
name|StorageController
block|{
DECL|field|LOG
specifier|protected
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|StorageCoreController
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|searcher
specifier|private
name|IndexSearcher
name|searcher
decl_stmt|;
DECL|field|coreController
specifier|private
specifier|static
name|StorageCoreController
name|coreController
decl_stmt|;
DECL|field|storageDir
specifier|private
specifier|final
name|Directory
name|storageDir
decl_stmt|;
DECL|field|modifier
specifier|private
specifier|final
name|StorageModifier
name|modifier
decl_stmt|;
DECL|field|storageQuery
specifier|private
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|storageQuery
decl_stmt|;
DECL|field|currentBuffer
specifier|private
name|StorageBuffer
name|currentBuffer
decl_stmt|;
DECL|field|storageControllerLock
specifier|private
name|Object
name|storageControllerLock
init|=
operator|new
name|Object
argument_list|()
decl_stmt|;
DECL|field|DEFAULT_STORAGE_BUFFER_SIZE
specifier|private
specifier|static
specifier|final
name|int
name|DEFAULT_STORAGE_BUFFER_SIZE
init|=
literal|10
decl_stmt|;
DECL|field|DEFAULT_STORAGE_PERSIST_FACTOR
specifier|private
specifier|static
specifier|final
name|int
name|DEFAULT_STORAGE_PERSIST_FACTOR
init|=
literal|10
decl_stmt|;
DECL|field|STORAGELOG
specifier|private
specifier|static
specifier|final
name|String
name|STORAGELOG
init|=
literal|".lucenestorage"
decl_stmt|;
DECL|field|storageBufferSize
specifier|private
name|int
name|storageBufferSize
decl_stmt|;
DECL|field|storagePersistFactor
specifier|private
name|int
name|storagePersistFactor
decl_stmt|;
DECL|field|configurator
specifier|private
name|StorageConfigurator
name|configurator
decl_stmt|;
DECL|field|idGenerator
specifier|private
name|IDGenerator
name|idGenerator
decl_stmt|;
DECL|field|indexOptimizeInterval
specifier|private
name|int
name|indexOptimizeInterval
decl_stmt|;
DECL|method|StorageCoreController
specifier|private
name|StorageCoreController
parameter_list|()
throws|throws
name|IOException
throws|,
name|StorageException
block|{
name|this
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
DECL|method|StorageCoreController
specifier|private
name|StorageCoreController
parameter_list|(
specifier|final
name|Directory
name|dir
parameter_list|)
throws|throws
name|IOException
throws|,
name|StorageException
block|{
synchronized|synchronized
init|(
name|StorageCoreController
operator|.
name|class
init|)
block|{
try|try
block|{
name|this
operator|.
name|idGenerator
operator|=
operator|new
name|IDGenerator
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|StorageException
argument_list|(
literal|"Can't create ID Generator"
argument_list|,
name|e
argument_list|)
throw|;
block|}
name|boolean
name|createNewStorage
init|=
literal|false
decl_stmt|;
if|if
condition|(
name|dir
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|configurator
operator|=
name|StorageConfigurator
operator|.
name|getStorageConfigurator
argument_list|()
expr_stmt|;
name|String
name|storageDirPath
init|=
name|this
operator|.
name|configurator
operator|.
name|getStorageDirectory
argument_list|()
decl_stmt|;
name|File
name|storeDir
init|=
operator|new
name|File
argument_list|(
name|storageDirPath
argument_list|)
decl_stmt|;
name|File
name|storageLog
init|=
operator|new
name|File
argument_list|(
name|storeDir
operator|.
name|getAbsolutePath
argument_list|()
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"file.separator"
argument_list|)
operator|+
name|STORAGELOG
argument_list|)
decl_stmt|;
try|try
block|{
if|if
condition|(
name|storeDir
operator|.
name|isDirectory
argument_list|()
operator|&&
operator|!
name|storageLog
operator|.
name|exists
argument_list|()
condition|)
block|{
if|if
condition|(
name|createLuceneStorageLog
argument_list|(
name|storeDir
argument_list|)
condition|)
block|{
name|this
operator|.
name|storageDir
operator|=
name|FSDirectory
operator|.
name|getDirectory
argument_list|(
name|storeDir
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|createNewStorage
operator|=
literal|true
expr_stmt|;
block|}
else|else
throw|throw
operator|new
name|StorageException
argument_list|(
literal|"could not create storage log file in "
operator|+
name|storageDirPath
argument_list|)
throw|;
block|}
else|else
name|this
operator|.
name|storageDir
operator|=
name|FSDirectory
operator|.
name|getDirectory
argument_list|(
name|storeDir
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|storageLog
operator|.
name|delete
argument_list|()
expr_stmt|;
throw|throw
name|e
throw|;
block|}
name|this
operator|.
name|indexOptimizeInterval
operator|=
name|this
operator|.
name|configurator
operator|.
name|getIndexOptimizeInterval
argument_list|()
expr_stmt|;
name|this
operator|.
name|storageBufferSize
operator|=
name|this
operator|.
name|configurator
operator|.
name|getStorageBufferSize
argument_list|()
operator|<
name|DEFAULT_STORAGE_BUFFER_SIZE
condition|?
name|DEFAULT_STORAGE_BUFFER_SIZE
else|:
name|this
operator|.
name|configurator
operator|.
name|getStorageBufferSize
argument_list|()
expr_stmt|;
name|this
operator|.
name|storagePersistFactor
operator|=
name|this
operator|.
name|configurator
operator|.
name|getStoragepersistFactor
argument_list|()
operator|<
name|DEFAULT_STORAGE_PERSIST_FACTOR
condition|?
name|DEFAULT_STORAGE_PERSIST_FACTOR
else|:
name|this
operator|.
name|configurator
operator|.
name|getStoragepersistFactor
argument_list|()
expr_stmt|;
block|}
else|else
name|this
operator|.
name|storageDir
operator|=
name|dir
expr_stmt|;
name|this
operator|.
name|currentBuffer
operator|=
operator|new
name|StorageBuffer
argument_list|(
name|this
operator|.
name|storageBufferSize
argument_list|)
expr_stmt|;
name|this
operator|.
name|modifier
operator|=
name|createStorageModifier
argument_list|(
name|createNewStorage
argument_list|)
expr_stmt|;
name|this
operator|.
name|searcher
operator|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|storageDir
argument_list|)
expr_stmt|;
name|GDataServerRegistry
operator|.
name|getRegistry
argument_list|()
operator|.
name|registerStorage
argument_list|(
name|this
argument_list|)
expr_stmt|;
comment|// TODO reverse dependency here
block|}
block|}
DECL|method|createStorageModifier
specifier|private
name|StorageModifier
name|createStorageModifier
parameter_list|(
name|boolean
name|create
parameter_list|)
throws|throws
name|IOException
block|{
name|IndexModifier
name|indexModifier
init|=
operator|new
name|IndexModifier
argument_list|(
name|this
operator|.
name|storageDir
argument_list|,
operator|new
name|StandardAnalyzer
argument_list|()
argument_list|,
name|create
argument_list|)
decl_stmt|;
return|return
operator|new
name|StorageModifier
argument_list|(
name|indexModifier
argument_list|,
name|this
operator|.
name|currentBuffer
argument_list|,
name|this
operator|.
name|storagePersistFactor
argument_list|,
name|this
operator|.
name|indexOptimizeInterval
argument_list|)
return|;
block|}
comment|/**TODO document this       * @return       */
DECL|method|getStorageModifier
specifier|public
name|StorageModifier
name|getStorageModifier
parameter_list|()
block|{
return|return
name|this
operator|.
name|modifier
return|;
block|}
comment|/**TODO document this       * @return       * @throws IOException       * @throws StorageException       */
DECL|method|getStorageCoreController
specifier|public
specifier|static
name|StorageCoreController
name|getStorageCoreController
parameter_list|()
throws|throws
name|IOException
throws|,
name|StorageException
block|{
synchronized|synchronized
init|(
name|StorageCoreController
operator|.
name|class
init|)
block|{
if|if
condition|(
name|coreController
operator|==
literal|null
condition|)
name|coreController
operator|=
operator|new
name|StorageCoreController
argument_list|()
expr_stmt|;
return|return
name|coreController
return|;
block|}
block|}
comment|/**TODO document this       * @param dir       * @return       * @throws IOException       * @throws StorageException       */
DECL|method|getStorageCoreController
specifier|protected
specifier|static
name|StorageCoreController
name|getStorageCoreController
parameter_list|(
specifier|final
name|Directory
name|dir
parameter_list|)
throws|throws
name|IOException
throws|,
name|StorageException
block|{
synchronized|synchronized
init|(
name|StorageCoreController
operator|.
name|class
init|)
block|{
if|if
condition|(
name|coreController
operator|==
literal|null
condition|)
name|coreController
operator|=
operator|new
name|StorageCoreController
argument_list|(
name|dir
argument_list|)
expr_stmt|;
return|return
name|coreController
return|;
block|}
block|}
comment|/**TODO document this       * @return       * @throws IOException       */
DECL|method|getStorageQuery
specifier|public
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|getStorageQuery
parameter_list|()
throws|throws
name|IOException
block|{
synchronized|synchronized
init|(
name|this
operator|.
name|storageControllerLock
init|)
block|{
if|if
condition|(
name|this
operator|.
name|storageQuery
operator|==
literal|null
condition|)
block|{
name|this
operator|.
name|storageQuery
operator|=
name|getNewStorageQueryHolder
argument_list|(
operator|new
name|StorageQuery
argument_list|(
name|this
operator|.
name|currentBuffer
argument_list|,
name|this
operator|.
name|searcher
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isInfoEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|info
argument_list|(
literal|"Relese new StorageQuery"
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|storageQuery
operator|.
name|increamentReference
argument_list|()
expr_stmt|;
return|return
name|this
operator|.
name|storageQuery
return|;
block|}
block|}
DECL|method|getNewStorageQueryHolder
specifier|private
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|getNewStorageQueryHolder
parameter_list|(
specifier|final
name|StorageQuery
name|query
parameter_list|)
block|{
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
name|holder
init|=
operator|new
name|ReferenceCounter
argument_list|<
name|StorageQuery
argument_list|>
argument_list|(
name|query
argument_list|)
block|{
specifier|public
name|void
name|close
parameter_list|()
block|{
try|try
block|{
if|if
condition|(
name|LOG
operator|.
name|isInfoEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|info
argument_list|(
literal|"close StorageQuery -- zero references remaining"
argument_list|)
expr_stmt|;
name|this
operator|.
name|resource
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Error during close call on StorageQuery"
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
decl_stmt|;
name|holder
operator|.
name|increamentReference
argument_list|()
expr_stmt|;
return|return
name|holder
return|;
block|}
DECL|method|registerNewStorageQuery
specifier|protected
name|void
name|registerNewStorageQuery
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|LOG
operator|.
name|isInfoEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|info
argument_list|(
literal|"new StorageQuery requested -- create new storage buffer"
argument_list|)
expr_stmt|;
synchronized|synchronized
init|(
name|this
operator|.
name|storageControllerLock
init|)
block|{
if|if
condition|(
name|this
operator|.
name|storageQuery
operator|!=
literal|null
condition|)
name|this
operator|.
name|storageQuery
operator|.
name|decrementRef
argument_list|()
expr_stmt|;
name|this
operator|.
name|searcher
operator|=
operator|new
name|IndexSearcher
argument_list|(
name|this
operator|.
name|storageDir
argument_list|)
expr_stmt|;
name|this
operator|.
name|storageQuery
operator|=
literal|null
expr_stmt|;
name|this
operator|.
name|currentBuffer
operator|=
operator|new
name|StorageBuffer
argument_list|(
name|this
operator|.
name|storageBufferSize
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|releaseNewStorageBuffer
specifier|protected
name|StorageBuffer
name|releaseNewStorageBuffer
parameter_list|()
block|{
synchronized|synchronized
init|(
name|this
operator|.
name|storageControllerLock
init|)
block|{
return|return
name|this
operator|.
name|currentBuffer
return|;
block|}
block|}
comment|/**TODO document this       * @return       * @throws IOException       */
DECL|method|createIndexModifier
specifier|public
name|IndexModifier
name|createIndexModifier
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|LOG
operator|.
name|isInfoEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|info
argument_list|(
literal|"new IndexModifier created - release to StorageModifier"
argument_list|)
expr_stmt|;
synchronized|synchronized
init|(
name|this
operator|.
name|storageControllerLock
init|)
block|{
return|return
operator|new
name|IndexModifier
argument_list|(
name|this
operator|.
name|storageDir
argument_list|,
operator|new
name|StandardAnalyzer
argument_list|()
argument_list|,
literal|false
argument_list|)
return|;
block|}
block|}
DECL|method|close
specifier|private
name|void
name|close
parameter_list|()
throws|throws
name|IOException
block|{
synchronized|synchronized
init|(
name|this
operator|.
name|storageControllerLock
init|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isInfoEnabled
argument_list|()
condition|)
name|LOG
operator|.
name|info
argument_list|(
literal|"StorageController has been closed -- server is shutting down -- release all resources"
argument_list|)
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|storageQuery
operator|!=
literal|null
condition|)
name|this
operator|.
name|storageQuery
operator|.
name|decrementRef
argument_list|()
expr_stmt|;
name|coreController
operator|=
literal|null
expr_stmt|;
name|this
operator|.
name|modifier
operator|.
name|close
argument_list|()
expr_stmt|;
comment|//TODO make sure all resources will be released
block|}
block|}
comment|/**TODO document this       * @return       */
DECL|method|getStorageBufferSize
specifier|public
name|int
name|getStorageBufferSize
parameter_list|()
block|{
return|return
name|this
operator|.
name|storageBufferSize
return|;
block|}
comment|/**       * @param storageBufferSize       */
DECL|method|setStorageBufferSize
specifier|public
name|void
name|setStorageBufferSize
parameter_list|(
name|int
name|storageBufferSize
parameter_list|)
block|{
name|this
operator|.
name|storageBufferSize
operator|=
name|storageBufferSize
expr_stmt|;
block|}
comment|/**TODO document this       * @return       */
DECL|method|getStoragePersistFactor
specifier|public
name|int
name|getStoragePersistFactor
parameter_list|()
block|{
return|return
name|this
operator|.
name|storagePersistFactor
return|;
block|}
comment|/**       * @param storagePersistFactor       */
DECL|method|setStoragePersistFactor
specifier|public
name|void
name|setStoragePersistFactor
parameter_list|(
name|int
name|storagePersistFactor
parameter_list|)
block|{
name|this
operator|.
name|storagePersistFactor
operator|=
name|storagePersistFactor
expr_stmt|;
block|}
comment|/**       * @throws IOException       * @throws StorageException       */
DECL|method|forceWrite
specifier|public
name|void
name|forceWrite
parameter_list|()
throws|throws
name|IOException
throws|,
name|StorageException
block|{
name|this
operator|.
name|modifier
operator|.
name|forceWrite
argument_list|()
expr_stmt|;
block|}
DECL|method|createLuceneStorageLog
specifier|private
name|boolean
name|createLuceneStorageLog
parameter_list|(
name|File
name|storageDirectory
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|storageDirectory
operator|.
name|isDirectory
argument_list|()
operator|&&
operator|!
name|storageDirectory
operator|.
name|exists
argument_list|()
condition|)
block|{
name|storageDirectory
operator|.
name|createNewFile
argument_list|()
expr_stmt|;
block|}
name|File
name|file
init|=
operator|new
name|File
argument_list|(
name|storageDirectory
operator|.
name|getAbsolutePath
argument_list|()
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"file.separator"
argument_list|)
operator|+
name|STORAGELOG
argument_list|)
decl_stmt|;
return|return
name|file
operator|.
name|createNewFile
argument_list|()
return|;
block|}
comment|/**TODO document this       * @return       * @throws StorageException       */
DECL|method|releaseID
specifier|public
specifier|synchronized
name|String
name|releaseID
parameter_list|()
throws|throws
name|StorageException
block|{
try|try
block|{
return|return
name|this
operator|.
name|idGenerator
operator|.
name|getUID
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|StorageException
argument_list|(
literal|"Can't release new ID"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**       * @see org.apache.lucene.gdata.storage.StorageController#destroy()       */
DECL|method|destroy
specifier|public
name|void
name|destroy
parameter_list|()
block|{
try|try
block|{
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Closing StorageCoreController failed -- "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class
end_unit
