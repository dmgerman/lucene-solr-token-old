begin_unit
begin_comment
comment|/**   * Copyright 2004 The Apache Software Foundation   *   * Licensed under the Apache License, Version 2.0 (the "License");   * you may not use this file except in compliance with the License.   * You may obtain a copy of the License at   *   *     http://www.apache.org/licenses/LICENSE-2.0   *   * Unless required by applicable law or agreed to in writing, software   * distributed under the License is distributed on an "AS IS" BASIS,   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.   * See the License for the specific language governing permissions and   * limitations under the License.   */
end_comment
begin_package
DECL|package|org.apache.lucene.gdata.server
package|package
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|server
package|;
end_package
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|StringReader
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|StringWriter
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|Writer
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|servlet
operator|.
name|http
operator|.
name|HttpServletResponse
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|Source
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|Templates
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|Transformer
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|TransformerException
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|stream
operator|.
name|StreamResult
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|stream
operator|.
name|StreamSource
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|server
operator|.
name|GDataRequest
operator|.
name|OutputFormat
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|server
operator|.
name|registry
operator|.
name|ProvidedService
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|gdata
operator|.
name|utils
operator|.
name|DateFormater
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|BaseEntry
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|BaseFeed
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|DateTime
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|data
operator|.
name|ExtensionProfile
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|util
operator|.
name|common
operator|.
name|xml
operator|.
name|XmlWriter
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gdata
operator|.
name|util
operator|.
name|common
operator|.
name|xml
operator|.
name|XmlWriter
operator|.
name|Namespace
import|;
end_import
begin_comment
comment|/**  * The FeedRequest Class wraps the current HttpServletResponse. Any action on the  * HttpServletRequest will be executed via this class. This represents an  * abstraction on the plain {@link HttpServletResponse}. Any action which has  * to be performed on the underlying {@link HttpServletResponse} will be  * executed within this class.  *<p>  * The GData basically writes two different kinds of response to the output  * stream.  *<ol>  *<li>update, delete or insert requests will respond with a status code and if  * successful the feed entry modified or created</li>  *<li>get requests will respond with a status code and if successful the  * requested feed</li>  *</ol>  *   * For this purpose the {@link GDataResponse} class provides the overloaded  * method  * {@link org.apache.lucene.gdata.server.GDataResponse#sendResponse}  * which sends the entry e.g feed to the output stream.  *</p>  *<p>  * This class will set the HTTP<tt>Last-Modified</tt> Header to enable  * clients to send<tt>If-Modified-Since</tt> request header to avoid  * retrieving the content again if it hasn't changed. If the content hasn't  * changed since the If-Modified-Since time, then the GData service returns a  * 304 (Not Modified) HTTP response.  *</p>  *   *   *   *   * @author Simon Willnauer  *   */
end_comment
begin_class
DECL|class|GDataResponse
specifier|public
class|class
name|GDataResponse
block|{
comment|/**      * Response code bad request      */
DECL|field|BAD_REQUEST
specifier|public
specifier|static
specifier|final
name|int
name|BAD_REQUEST
init|=
name|HttpServletResponse
operator|.
name|SC_BAD_REQUEST
decl_stmt|;
comment|/**      * Response code version conflict      */
DECL|field|CONFLICT
specifier|public
specifier|static
specifier|final
name|int
name|CONFLICT
init|=
name|HttpServletResponse
operator|.
name|SC_CONFLICT
decl_stmt|;
comment|/**      * Response code forbidden access      */
DECL|field|FORBIDDEN
specifier|public
specifier|static
specifier|final
name|int
name|FORBIDDEN
init|=
name|HttpServletResponse
operator|.
name|SC_FORBIDDEN
decl_stmt|;
comment|/**      * Response code internal server error      */
DECL|field|SERVER_ERROR
specifier|public
specifier|static
specifier|final
name|int
name|SERVER_ERROR
init|=
name|HttpServletResponse
operator|.
name|SC_INTERNAL_SERVER_ERROR
decl_stmt|;
comment|/**      * Response code not found      */
DECL|field|NOT_FOUND
specifier|public
specifier|static
specifier|final
name|int
name|NOT_FOUND
init|=
name|HttpServletResponse
operator|.
name|SC_NOT_FOUND
decl_stmt|;
comment|/**      * Response code not modified since      */
DECL|field|NOT_MODIFIED
specifier|public
specifier|static
specifier|final
name|int
name|NOT_MODIFIED
init|=
name|HttpServletResponse
operator|.
name|SC_NOT_MODIFIED
decl_stmt|;
comment|/**      * Response code created      */
DECL|field|CREATED
specifier|public
specifier|static
specifier|final
name|int
name|CREATED
init|=
name|HttpServletResponse
operator|.
name|SC_CREATED
decl_stmt|;
comment|/**      * Response code unauthorized access      */
DECL|field|UNAUTHORIZED
specifier|public
specifier|static
specifier|final
name|int
name|UNAUTHORIZED
init|=
name|HttpServletResponse
operator|.
name|SC_UNAUTHORIZED
decl_stmt|;
DECL|field|LOG
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|GDataResponse
operator|.
name|class
argument_list|)
decl_stmt|;
DECL|field|error
specifier|private
name|int
name|error
decl_stmt|;
DECL|field|isError
specifier|private
name|boolean
name|isError
init|=
literal|false
decl_stmt|;
DECL|field|encoding
specifier|private
name|String
name|encoding
decl_stmt|;
DECL|field|outputFormat
specifier|private
name|OutputFormat
name|outputFormat
decl_stmt|;
DECL|field|response
specifier|private
specifier|final
name|HttpServletResponse
name|response
decl_stmt|;
DECL|field|XMLMIME_ATOM
specifier|protected
specifier|static
specifier|final
name|String
name|XMLMIME_ATOM
init|=
literal|"text/xml"
decl_stmt|;
DECL|field|XMLMIME_RSS
specifier|protected
specifier|static
specifier|final
name|String
name|XMLMIME_RSS
init|=
literal|"text/xml"
decl_stmt|;
DECL|field|HEADER_LASTMODIFIED
specifier|private
specifier|static
specifier|final
name|String
name|HEADER_LASTMODIFIED
init|=
literal|"Last-Modified"
decl_stmt|;
comment|/**      * Creates a new GDataResponse      *       * @param response -      *            The underlying {@link HttpServletResponse}      */
DECL|method|GDataResponse
specifier|public
name|GDataResponse
parameter_list|(
name|HttpServletResponse
name|response
parameter_list|)
block|{
if|if
condition|(
name|response
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"response must not be null"
argument_list|)
throw|;
name|this
operator|.
name|response
operator|=
name|response
expr_stmt|;
block|}
comment|/**      * Sets an error code to this FeedResponse.      *       * @param errorCode -      *            {@link HttpServletResponse} error code      */
DECL|method|setError
specifier|public
name|void
name|setError
parameter_list|(
name|int
name|errorCode
parameter_list|)
block|{
name|this
operator|.
name|isError
operator|=
literal|true
expr_stmt|;
name|this
operator|.
name|error
operator|=
name|errorCode
expr_stmt|;
block|}
comment|/**      * Sets the status of the underlying response      *       * @see HttpServletResponse      * @param responseCode -      *            the status of the response      */
DECL|method|setResponseCode
specifier|public
name|void
name|setResponseCode
parameter_list|(
name|int
name|responseCode
parameter_list|)
block|{
name|this
operator|.
name|response
operator|.
name|setStatus
argument_list|(
name|responseCode
argument_list|)
expr_stmt|;
block|}
comment|/**      * This method sends the specified error to the user if set      *       * @throws IOException -      *             if an I/O Exception occurs      */
DECL|method|sendError
specifier|public
name|void
name|sendError
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|this
operator|.
name|isError
condition|)
name|this
operator|.
name|response
operator|.
name|sendError
argument_list|(
name|this
operator|.
name|error
argument_list|)
expr_stmt|;
block|}
comment|/**      * @return - the {@link HttpServletResponse} writer      * @throws IOException -      *             If an I/O exception occurs      */
DECL|method|getWriter
specifier|public
name|Writer
name|getWriter
parameter_list|()
throws|throws
name|IOException
block|{
return|return
name|this
operator|.
name|response
operator|.
name|getWriter
argument_list|()
return|;
block|}
comment|/**      * Sends a response for a get e.g. query request. This method must not      * invoked in a case of an error performing the requested action.      *       * @param feed -      *            the feed to respond to the client      * @param service - the service to render the feed      *       * @throws IOException -      *             if an I/O exception occurs, often caused by an already      *             closed Writer or OutputStream      *       */
DECL|method|sendResponse
specifier|public
name|void
name|sendResponse
parameter_list|(
specifier|final
name|BaseFeed
name|feed
parameter_list|,
specifier|final
name|ProvidedService
name|service
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|feed
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"feed must not be null"
argument_list|)
throw|;
if|if
condition|(
name|service
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"provided service must not be null"
argument_list|)
throw|;
name|DateTime
name|time
init|=
name|feed
operator|.
name|getUpdated
argument_list|()
decl_stmt|;
if|if
condition|(
name|time
operator|!=
literal|null
condition|)
name|setLastModifiedHeader
argument_list|(
name|time
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
name|FormatWriter
name|writer
init|=
name|FormatWriter
operator|.
name|getFormatWriter
argument_list|(
name|this
argument_list|,
name|service
argument_list|)
decl_stmt|;
name|writer
operator|.
name|generateOutputFormat
argument_list|(
name|feed
argument_list|,
name|this
operator|.
name|response
argument_list|)
expr_stmt|;
block|}
comment|/**      *       * Sends a response for an update, insert or delete request. This method      * must not invoked in a case of an error performing the requested action. If      * the specified response format is ATOM the default namespace will be set      * to ATOM.      *       * @param entry -      *            the modified / created entry to send      * @param service - the service to render the feed      * @throws IOException -      *             if an I/O exception occurs, often caused by an already      *             closed Writer or OutputStream      */
DECL|method|sendResponse
specifier|public
name|void
name|sendResponse
parameter_list|(
name|BaseEntry
name|entry
parameter_list|,
name|ProvidedService
name|service
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|entry
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"entry must not be null"
argument_list|)
throw|;
if|if
condition|(
name|service
operator|==
literal|null
condition|)
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"service must not be null"
argument_list|)
throw|;
name|DateTime
name|time
init|=
name|entry
operator|.
name|getUpdated
argument_list|()
decl_stmt|;
if|if
condition|(
name|time
operator|!=
literal|null
condition|)
name|setLastModifiedHeader
argument_list|(
name|time
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
name|FormatWriter
name|writer
init|=
name|FormatWriter
operator|.
name|getFormatWriter
argument_list|(
name|this
argument_list|,
name|service
argument_list|)
decl_stmt|;
name|writer
operator|.
name|generateOutputFormat
argument_list|(
name|entry
argument_list|,
name|this
operator|.
name|response
argument_list|)
expr_stmt|;
block|}
comment|/**      * This encoding will be used to encode the xml representation of feed or      * entry written to the {@link HttpServletResponse} output stream.      *       * @return - the entry / feed encoding      */
DECL|method|getEncoding
specifier|public
name|String
name|getEncoding
parameter_list|()
block|{
return|return
name|this
operator|.
name|encoding
return|;
block|}
comment|/**      * This encoding will be used to encode the xml representation of feed or      * entry written to the {@link HttpServletResponse} output stream.<i>UTF-8</i>      *<i>ISO-8859-1</i>      *       * @param encoding -      *            string represents the encoding      */
DECL|method|setEncoding
specifier|public
name|void
name|setEncoding
parameter_list|(
name|String
name|encoding
parameter_list|)
block|{
name|this
operator|.
name|encoding
operator|=
name|encoding
expr_stmt|;
block|}
comment|/**      * @return - the response      *         {@link org.apache.lucene.gdata.server.GDataRequest.OutputFormat}      */
DECL|method|getOutputFormat
specifier|public
name|OutputFormat
name|getOutputFormat
parameter_list|()
block|{
return|return
name|this
operator|.
name|outputFormat
return|;
block|}
comment|/**      * @param outputFormat -      *            the response      *            {@link org.apache.lucene.gdata.server.GDataRequest.OutputFormat}      */
DECL|method|setOutputFormat
specifier|public
name|void
name|setOutputFormat
parameter_list|(
name|OutputFormat
name|outputFormat
parameter_list|)
block|{
name|this
operator|.
name|outputFormat
operator|=
name|outputFormat
expr_stmt|;
block|}
comment|/**      * @see Object#toString()      */
annotation|@
name|Override
DECL|method|toString
specifier|public
name|String
name|toString
parameter_list|()
block|{
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|(
literal|" GDataResponse: "
argument_list|)
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"Error: "
argument_list|)
operator|.
name|append
argument_list|(
name|this
operator|.
name|error
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|" outputFormat: "
argument_list|)
operator|.
name|append
argument_list|(
name|getOutputFormat
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|" encoding: "
argument_list|)
operator|.
name|append
argument_list|(
name|this
operator|.
name|encoding
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
DECL|method|setLastModifiedHeader
specifier|protected
name|void
name|setLastModifiedHeader
parameter_list|(
name|long
name|lastModified
parameter_list|)
block|{
name|String
name|lastMod
init|=
name|DateFormater
operator|.
name|formatDate
argument_list|(
operator|new
name|Date
argument_list|(
name|lastModified
argument_list|)
argument_list|,
name|DateFormater
operator|.
name|HTTP_HEADER_DATE_FORMAT
argument_list|)
decl_stmt|;
name|this
operator|.
name|response
operator|.
name|setHeader
argument_list|(
name|HEADER_LASTMODIFIED
argument_list|,
name|lastMod
argument_list|)
expr_stmt|;
block|}
comment|/**      * @see HttpServletResponse#setStatus(int)      * @param status - the request status code      */
DECL|method|setStatus
specifier|public
name|void
name|setStatus
parameter_list|(
name|int
name|status
parameter_list|)
block|{
name|this
operator|.
name|response
operator|.
name|setStatus
argument_list|(
name|status
argument_list|)
expr_stmt|;
block|}
DECL|class|FormatWriter
specifier|private
specifier|static
specifier|abstract
class|class
name|FormatWriter
block|{
DECL|method|getFormatWriter
specifier|static
name|FormatWriter
name|getFormatWriter
parameter_list|(
specifier|final
name|GDataResponse
name|response
parameter_list|,
specifier|final
name|ProvidedService
name|service
parameter_list|)
block|{
name|OutputFormat
name|format
init|=
name|response
operator|.
name|getOutputFormat
argument_list|()
decl_stmt|;
if|if
condition|(
name|format
operator|==
name|OutputFormat
operator|.
name|HTML
condition|)
block|{
return|return
operator|new
name|HTMLFormatWriter
argument_list|(
name|service
argument_list|)
return|;
block|}
return|return
operator|new
name|SyndicateFormatWriter
argument_list|(
name|service
argument_list|,
name|format
argument_list|,
name|response
operator|.
name|getEncoding
argument_list|()
argument_list|)
return|;
block|}
DECL|method|generateOutputFormat
specifier|abstract
name|void
name|generateOutputFormat
parameter_list|(
specifier|final
name|BaseFeed
name|feed
parameter_list|,
specifier|final
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|IOException
function_decl|;
DECL|method|generateOutputFormat
specifier|abstract
name|void
name|generateOutputFormat
parameter_list|(
specifier|final
name|BaseEntry
name|entry
parameter_list|,
specifier|final
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|IOException
function_decl|;
DECL|class|HTMLFormatWriter
specifier|private
specifier|static
class|class
name|HTMLFormatWriter
extends|extends
name|FormatWriter
block|{
DECL|field|CONTENT_TYPE
specifier|private
specifier|static
specifier|final
name|String
name|CONTENT_TYPE
init|=
literal|"text/html"
decl_stmt|;
DECL|field|service
specifier|private
specifier|final
name|ProvidedService
name|service
decl_stmt|;
DECL|method|HTMLFormatWriter
name|HTMLFormatWriter
parameter_list|(
specifier|final
name|ProvidedService
name|service
parameter_list|)
block|{
name|this
operator|.
name|service
operator|=
name|service
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|generateOutputFormat
name|void
name|generateOutputFormat
parameter_list|(
name|BaseFeed
name|feed
parameter_list|,
specifier|final
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|IOException
block|{
name|Templates
name|template
init|=
name|this
operator|.
name|service
operator|.
name|getTransformTemplate
argument_list|()
decl_stmt|;
name|response
operator|.
name|setContentType
argument_list|(
name|CONTENT_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|template
operator|==
literal|null
condition|)
block|{
name|sendNotAvailable
argument_list|(
name|response
argument_list|)
expr_stmt|;
return|return;
block|}
name|StringWriter
name|writer
init|=
operator|new
name|StringWriter
argument_list|()
decl_stmt|;
name|XmlWriter
name|xmlWriter
init|=
operator|new
name|XmlWriter
argument_list|(
name|writer
argument_list|)
decl_stmt|;
name|feed
operator|.
name|generateAtom
argument_list|(
name|xmlWriter
argument_list|,
name|this
operator|.
name|service
operator|.
name|getExtensionProfile
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
name|writeHtml
argument_list|(
name|template
argument_list|,
name|response
operator|.
name|getWriter
argument_list|()
argument_list|,
name|writer
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|TransformerException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Can not transform feed for service "
operator|+
name|this
operator|.
name|service
operator|.
name|getName
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|sendNotAvailable
argument_list|(
name|response
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|generateOutputFormat
name|void
name|generateOutputFormat
parameter_list|(
name|BaseEntry
name|entry
parameter_list|,
specifier|final
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|IOException
block|{
name|Templates
name|template
init|=
name|this
operator|.
name|service
operator|.
name|getTransformTemplate
argument_list|()
decl_stmt|;
name|response
operator|.
name|setContentType
argument_list|(
name|CONTENT_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|template
operator|==
literal|null
condition|)
block|{
name|sendNotAvailable
argument_list|(
name|response
argument_list|)
expr_stmt|;
return|return;
block|}
name|StringWriter
name|writer
init|=
operator|new
name|StringWriter
argument_list|()
decl_stmt|;
name|XmlWriter
name|xmlWriter
init|=
operator|new
name|XmlWriter
argument_list|(
name|writer
argument_list|)
decl_stmt|;
name|entry
operator|.
name|generateAtom
argument_list|(
name|xmlWriter
argument_list|,
name|this
operator|.
name|service
operator|.
name|getExtensionProfile
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
name|writeHtml
argument_list|(
name|template
argument_list|,
name|response
operator|.
name|getWriter
argument_list|()
argument_list|,
name|writer
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|TransformerException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Can not transform feed for service "
operator|+
name|this
operator|.
name|service
operator|.
name|getName
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|sendNotAvailable
argument_list|(
name|response
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|writeHtml
specifier|private
name|void
name|writeHtml
parameter_list|(
specifier|final
name|Templates
name|template
parameter_list|,
specifier|final
name|Writer
name|writer
parameter_list|,
specifier|final
name|StringWriter
name|source
parameter_list|)
throws|throws
name|TransformerException
block|{
name|Transformer
name|transformer
init|=
name|template
operator|.
name|newTransformer
argument_list|()
decl_stmt|;
name|Source
name|tranformSource
init|=
operator|new
name|StreamSource
argument_list|(
operator|new
name|StringReader
argument_list|(
name|source
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|transformer
operator|.
name|transform
argument_list|(
name|tranformSource
argument_list|,
operator|new
name|StreamResult
argument_list|(
name|writer
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|sendNotAvailable
specifier|private
name|void
name|sendNotAvailable
parameter_list|(
specifier|final
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|IOException
block|{
name|response
operator|.
name|sendError
argument_list|(
name|HttpServletResponse
operator|.
name|SC_SERVICE_UNAVAILABLE
argument_list|,
literal|"No transformation stylesheet available"
argument_list|)
expr_stmt|;
block|}
block|}
DECL|class|SyndicateFormatWriter
specifier|private
specifier|static
class|class
name|SyndicateFormatWriter
extends|extends
name|FormatWriter
block|{
DECL|field|DEFAUL_NAMESPACE_URI
specifier|private
specifier|static
specifier|final
name|String
name|DEFAUL_NAMESPACE_URI
init|=
literal|"http://www.w3.org/2005/Atom"
decl_stmt|;
DECL|field|DEFAULT_NAMESPACE
specifier|private
specifier|static
specifier|final
name|Namespace
name|DEFAULT_NAMESPACE
init|=
operator|new
name|Namespace
argument_list|(
literal|""
argument_list|,
name|DEFAUL_NAMESPACE_URI
argument_list|)
decl_stmt|;
DECL|field|service
specifier|private
specifier|final
name|ProvidedService
name|service
decl_stmt|;
DECL|field|encoding
specifier|private
specifier|final
name|String
name|encoding
decl_stmt|;
DECL|field|format
specifier|private
specifier|final
name|OutputFormat
name|format
decl_stmt|;
DECL|method|SyndicateFormatWriter
name|SyndicateFormatWriter
parameter_list|(
specifier|final
name|ProvidedService
name|service
parameter_list|,
specifier|final
name|OutputFormat
name|format
parameter_list|,
name|String
name|encoding
parameter_list|)
block|{
name|this
operator|.
name|service
operator|=
name|service
expr_stmt|;
name|this
operator|.
name|format
operator|=
name|format
expr_stmt|;
name|this
operator|.
name|encoding
operator|=
name|encoding
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|generateOutputFormat
name|void
name|generateOutputFormat
parameter_list|(
specifier|final
name|BaseFeed
name|feed
parameter_list|,
specifier|final
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|IOException
block|{
name|XmlWriter
name|writer
init|=
literal|null
decl_stmt|;
try|try
block|{
name|writer
operator|=
name|createWriter
argument_list|(
name|response
operator|.
name|getWriter
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|format
operator|==
name|OutputFormat
operator|.
name|ATOM
condition|)
block|{
name|response
operator|.
name|setContentType
argument_list|(
name|XMLMIME_ATOM
argument_list|)
expr_stmt|;
name|feed
operator|.
name|generateAtom
argument_list|(
name|writer
argument_list|,
name|this
operator|.
name|service
operator|.
name|getExtensionProfile
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|response
operator|.
name|setContentType
argument_list|(
name|XMLMIME_RSS
argument_list|)
expr_stmt|;
name|feed
operator|.
name|generateRss
argument_list|(
name|writer
argument_list|,
name|this
operator|.
name|service
operator|.
name|getExtensionProfile
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|writer
operator|!=
literal|null
condition|)
name|writer
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|generateOutputFormat
name|void
name|generateOutputFormat
parameter_list|(
specifier|final
name|BaseEntry
name|entry
parameter_list|,
specifier|final
name|HttpServletResponse
name|response
parameter_list|)
throws|throws
name|IOException
block|{
name|XmlWriter
name|writer
init|=
literal|null
decl_stmt|;
try|try
block|{
name|writer
operator|=
name|createWriter
argument_list|(
name|response
operator|.
name|getWriter
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|this
operator|.
name|format
operator|==
name|OutputFormat
operator|.
name|ATOM
condition|)
block|{
name|response
operator|.
name|setContentType
argument_list|(
name|XMLMIME_ATOM
argument_list|)
expr_stmt|;
name|entry
operator|.
name|generateAtom
argument_list|(
name|writer
argument_list|,
name|this
operator|.
name|service
operator|.
name|getExtensionProfile
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|response
operator|.
name|setContentType
argument_list|(
name|XMLMIME_RSS
argument_list|)
expr_stmt|;
name|entry
operator|.
name|generateRss
argument_list|(
name|writer
argument_list|,
name|this
operator|.
name|service
operator|.
name|getExtensionProfile
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|writer
operator|!=
literal|null
condition|)
name|writer
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|createWriter
specifier|private
name|XmlWriter
name|createWriter
parameter_list|(
specifier|final
name|Writer
name|target
parameter_list|)
throws|throws
name|IOException
block|{
name|XmlWriter
name|writer
init|=
operator|new
name|XmlWriter
argument_list|(
name|target
argument_list|,
name|this
operator|.
name|encoding
argument_list|)
decl_stmt|;
comment|// set the default namespace to Atom if Atom is the response format
if|if
condition|(
name|this
operator|.
name|format
operator|==
name|OutputFormat
operator|.
name|ATOM
condition|)
name|writer
operator|.
name|setDefaultNamespace
argument_list|(
name|DEFAULT_NAMESPACE
argument_list|)
expr_stmt|;
return|return
name|writer
return|;
block|}
block|}
block|}
block|}
end_class
end_unit
