begin_unit
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_package
DECL|package|org.apache.solr.cloud
package|package
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|cloud
package|;
end_package
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|lang
operator|.
name|StringUtils
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|IOUtils
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|LuceneTestCase
operator|.
name|Slow
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|JSONTestUtil
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|SolrTestCaseJ4
operator|.
name|SuppressSSL
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|SolrClient
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|SolrQuery
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|SolrRequest
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|SolrServerException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|impl
operator|.
name|HttpSolrClient
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|request
operator|.
name|AbstractUpdateRequest
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|request
operator|.
name|ContentStreamUpdateRequest
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|request
operator|.
name|CoreAdminRequest
operator|.
name|Create
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|request
operator|.
name|CoreAdminRequest
operator|.
name|Unload
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|request
operator|.
name|QueryRequest
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|request
operator|.
name|UpdateRequest
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|response
operator|.
name|CollectionAdminResponse
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|response
operator|.
name|QueryResponse
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|response
operator|.
name|UpdateResponse
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|SolrDocument
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|SolrException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|SolrInputDocument
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|cloud
operator|.
name|ClusterState
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|cloud
operator|.
name|Slice
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|cloud
operator|.
name|ZkCoreNodeProps
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|cloud
operator|.
name|ZkNodeProps
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|cloud
operator|.
name|ZkStateReader
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CollectionParams
operator|.
name|CollectionAction
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|ModifiableSolrParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|UpdateParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|ExecutorUtil
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|NamedList
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|DefaultSolrThreadFactory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|RTimer
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import
begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import
begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|invoke
operator|.
name|MethodHandles
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Callable
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|CompletionService
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutorCompletionService
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Future
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|SynchronousQueue
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadPoolExecutor
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicInteger
import|;
end_import
begin_comment
comment|/**  * This test simply does a bunch of basic things in solrcloud mode and asserts things  * work as expected.  */
end_comment
begin_class
annotation|@
name|Slow
annotation|@
name|SuppressSSL
argument_list|(
name|bugUrl
operator|=
literal|"https://issues.apache.org/jira/browse/SOLR-5776"
argument_list|)
DECL|class|BasicDistributedZkTest
specifier|public
class|class
name|BasicDistributedZkTest
extends|extends
name|AbstractFullDistribZkTestBase
block|{
DECL|field|log
specifier|private
specifier|static
specifier|final
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|MethodHandles
operator|.
name|lookup
argument_list|()
operator|.
name|lookupClass
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|DEFAULT_COLLECTION
specifier|private
specifier|static
specifier|final
name|String
name|DEFAULT_COLLECTION
init|=
literal|"collection1"
decl_stmt|;
DECL|field|DEBUG
specifier|protected
specifier|static
specifier|final
name|boolean
name|DEBUG
init|=
literal|false
decl_stmt|;
DECL|field|t1
name|String
name|t1
init|=
literal|"a_t"
decl_stmt|;
DECL|field|i1
name|String
name|i1
init|=
literal|"a_i1"
decl_stmt|;
DECL|field|tlong
name|String
name|tlong
init|=
literal|"other_tl1"
decl_stmt|;
DECL|field|oddField
name|String
name|oddField
init|=
literal|"oddField_s"
decl_stmt|;
DECL|field|missingField
name|String
name|missingField
init|=
literal|"ignore_exception__missing_but_valid_field_t"
decl_stmt|;
DECL|field|otherCollectionClients
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|SolrClient
argument_list|>
argument_list|>
name|otherCollectionClients
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
DECL|field|oneInstanceCollection
specifier|private
name|String
name|oneInstanceCollection
init|=
literal|"oneInstanceCollection"
decl_stmt|;
DECL|field|oneInstanceCollection2
specifier|private
name|String
name|oneInstanceCollection2
init|=
literal|"oneInstanceCollection2"
decl_stmt|;
DECL|field|nodeCounter
specifier|private
name|AtomicInteger
name|nodeCounter
init|=
operator|new
name|AtomicInteger
argument_list|()
decl_stmt|;
DECL|field|executor
name|ThreadPoolExecutor
name|executor
init|=
operator|new
name|ExecutorUtil
operator|.
name|MDCAwareThreadPoolExecutor
argument_list|(
literal|0
argument_list|,
name|Integer
operator|.
name|MAX_VALUE
argument_list|,
literal|5
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|,
operator|new
name|SynchronousQueue
argument_list|<
name|Runnable
argument_list|>
argument_list|()
argument_list|,
operator|new
name|DefaultSolrThreadFactory
argument_list|(
literal|"testExecutor"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|completionService
name|CompletionService
argument_list|<
name|Object
argument_list|>
name|completionService
decl_stmt|;
DECL|field|pending
name|Set
argument_list|<
name|Future
argument_list|<
name|Object
argument_list|>
argument_list|>
name|pending
decl_stmt|;
DECL|method|BasicDistributedZkTest
specifier|public
name|BasicDistributedZkTest
parameter_list|()
block|{
name|sliceCount
operator|=
literal|2
expr_stmt|;
name|completionService
operator|=
operator|new
name|ExecutorCompletionService
argument_list|<>
argument_list|(
name|executor
argument_list|)
expr_stmt|;
name|pending
operator|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|setDistributedParams
specifier|protected
name|void
name|setDistributedParams
parameter_list|(
name|ModifiableSolrParams
name|params
parameter_list|)
block|{
if|if
condition|(
name|r
operator|.
name|nextBoolean
argument_list|()
condition|)
block|{
comment|// don't set shards, let that be figured out from the cloud state
block|}
else|else
block|{
comment|// use shard ids rather than physical locations
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|getShardCount
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|sb
operator|.
name|append
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|"shard"
operator|+
operator|(
name|i
operator|+
literal|3
operator|)
argument_list|)
expr_stmt|;
block|}
name|params
operator|.
name|set
argument_list|(
literal|"shards"
argument_list|,
name|sb
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
annotation|@
name|ShardsFixed
argument_list|(
name|num
operator|=
literal|4
argument_list|)
DECL|method|test
specifier|public
name|void
name|test
parameter_list|()
throws|throws
name|Exception
block|{
comment|// setLoggingLevel(null);
name|ZkStateReader
name|zkStateReader
init|=
name|cloudClient
operator|.
name|getZkStateReader
argument_list|()
decl_stmt|;
comment|// make sure we have leaders for each shard
for|for
control|(
name|int
name|j
init|=
literal|1
init|;
name|j
operator|<
name|sliceCount
condition|;
name|j
operator|++
control|)
block|{
name|zkStateReader
operator|.
name|getLeaderRetry
argument_list|(
name|DEFAULT_COLLECTION
argument_list|,
literal|"shard"
operator|+
name|j
argument_list|,
literal|10000
argument_list|)
expr_stmt|;
block|}
comment|// make sure we again have leaders for each shard
name|waitForRecoveriesToFinish
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|handle
operator|.
name|clear
argument_list|()
expr_stmt|;
name|handle
operator|.
name|put
argument_list|(
literal|"timestamp"
argument_list|,
name|SKIPVAL
argument_list|)
expr_stmt|;
name|del
argument_list|(
literal|"*:*"
argument_list|)
expr_stmt|;
name|queryAndCompareShards
argument_list|(
name|params
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
literal|"distrib"
argument_list|,
literal|"false"
argument_list|,
literal|"sanity_check"
argument_list|,
literal|"is_empty"
argument_list|)
argument_list|)
expr_stmt|;
comment|// ask every individual replica of every shard to update+commit the same doc id
comment|// with an incrementing counter on each update+commit
name|int
name|foo_i_counter
init|=
literal|0
decl_stmt|;
for|for
control|(
name|SolrClient
name|client
range|:
name|clients
control|)
block|{
name|foo_i_counter
operator|++
expr_stmt|;
name|indexDoc
argument_list|(
name|client
argument_list|,
name|params
argument_list|(
literal|"commit"
argument_list|,
literal|"true"
argument_list|)
argument_list|,
comment|// SOLR-4923
name|sdoc
argument_list|(
name|id
argument_list|,
literal|1
argument_list|,
name|i1
argument_list|,
literal|100
argument_list|,
name|tlong
argument_list|,
literal|100
argument_list|,
literal|"foo_i"
argument_list|,
name|foo_i_counter
argument_list|)
argument_list|)
expr_stmt|;
comment|// after every update+commit, check all the shards consistency
name|queryAndCompareShards
argument_list|(
name|params
argument_list|(
literal|"q"
argument_list|,
literal|"id:1"
argument_list|,
literal|"distrib"
argument_list|,
literal|"false"
argument_list|,
literal|"sanity_check"
argument_list|,
literal|"non_distrib_id_1_lookup"
argument_list|)
argument_list|)
expr_stmt|;
name|queryAndCompareShards
argument_list|(
name|params
argument_list|(
literal|"q"
argument_list|,
literal|"id:1"
argument_list|,
literal|"sanity_check"
argument_list|,
literal|"distrib_id_1_lookup"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|indexr
argument_list|(
name|id
argument_list|,
literal|1
argument_list|,
name|i1
argument_list|,
literal|100
argument_list|,
name|tlong
argument_list|,
literal|100
argument_list|,
name|t1
argument_list|,
literal|"now is the time for all good men"
argument_list|,
literal|"foo_f"
argument_list|,
literal|1.414f
argument_list|,
literal|"foo_b"
argument_list|,
literal|"true"
argument_list|,
literal|"foo_d"
argument_list|,
literal|1.414d
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|2
argument_list|,
name|i1
argument_list|,
literal|50
argument_list|,
name|tlong
argument_list|,
literal|50
argument_list|,
name|t1
argument_list|,
literal|"to come to the aid of their country."
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|3
argument_list|,
name|i1
argument_list|,
literal|2
argument_list|,
name|tlong
argument_list|,
literal|2
argument_list|,
name|t1
argument_list|,
literal|"how now brown cow"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|4
argument_list|,
name|i1
argument_list|,
operator|-
literal|100
argument_list|,
name|tlong
argument_list|,
literal|101
argument_list|,
name|t1
argument_list|,
literal|"the quick fox jumped over the lazy dog"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|5
argument_list|,
name|i1
argument_list|,
literal|500
argument_list|,
name|tlong
argument_list|,
literal|500
argument_list|,
name|t1
argument_list|,
literal|"the quick fox jumped way over the lazy dog"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|6
argument_list|,
name|i1
argument_list|,
operator|-
literal|600
argument_list|,
name|tlong
argument_list|,
literal|600
argument_list|,
name|t1
argument_list|,
literal|"humpty dumpy sat on a wall"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|7
argument_list|,
name|i1
argument_list|,
literal|123
argument_list|,
name|tlong
argument_list|,
literal|123
argument_list|,
name|t1
argument_list|,
literal|"humpty dumpy had a great fall"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|8
argument_list|,
name|i1
argument_list|,
literal|876
argument_list|,
name|tlong
argument_list|,
literal|876
argument_list|,
name|t1
argument_list|,
literal|"all the kings horses and all the kings men"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|9
argument_list|,
name|i1
argument_list|,
literal|7
argument_list|,
name|tlong
argument_list|,
literal|7
argument_list|,
name|t1
argument_list|,
literal|"couldn't put humpty together again"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|10
argument_list|,
name|i1
argument_list|,
literal|4321
argument_list|,
name|tlong
argument_list|,
literal|4321
argument_list|,
name|t1
argument_list|,
literal|"this too shall pass"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|11
argument_list|,
name|i1
argument_list|,
operator|-
literal|987
argument_list|,
name|tlong
argument_list|,
literal|987
argument_list|,
name|t1
argument_list|,
literal|"An eye for eye only ends up making the whole world blind."
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|12
argument_list|,
name|i1
argument_list|,
literal|379
argument_list|,
name|tlong
argument_list|,
literal|379
argument_list|,
name|t1
argument_list|,
literal|"Great works are performed, not by strength, but by perseverance."
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|13
argument_list|,
name|i1
argument_list|,
literal|232
argument_list|,
name|tlong
argument_list|,
literal|232
argument_list|,
name|t1
argument_list|,
literal|"no eggs on wall, lesson learned"
argument_list|,
name|oddField
argument_list|,
literal|"odd man out"
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|14
argument_list|,
literal|"SubjectTerms_mfacet"
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"mathematical models"
block|,
literal|"mathematical analysis"
block|}
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|15
argument_list|,
literal|"SubjectTerms_mfacet"
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"test 1"
block|,
literal|"test 2"
block|,
literal|"test3"
block|}
argument_list|)
expr_stmt|;
name|indexr
argument_list|(
name|id
argument_list|,
literal|16
argument_list|,
literal|"SubjectTerms_mfacet"
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"test 1"
block|,
literal|"test 2"
block|,
literal|"test3"
block|}
argument_list|)
expr_stmt|;
name|String
index|[]
name|vals
init|=
operator|new
name|String
index|[
literal|100
index|]
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|vals
index|[
name|i
index|]
operator|=
literal|"test "
operator|+
name|i
expr_stmt|;
block|}
name|indexr
argument_list|(
name|id
argument_list|,
literal|17
argument_list|,
literal|"SubjectTerms_mfacet"
argument_list|,
name|vals
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|100
init|;
name|i
operator|<
literal|150
condition|;
name|i
operator|++
control|)
block|{
name|indexr
argument_list|(
name|id
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|commit
argument_list|()
expr_stmt|;
name|queryAndCompareShards
argument_list|(
name|params
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
literal|"sort"
argument_list|,
literal|"id desc"
argument_list|,
literal|"distrib"
argument_list|,
literal|"false"
argument_list|,
literal|"sanity_check"
argument_list|,
literal|"is_empty"
argument_list|)
argument_list|)
expr_stmt|;
comment|// random value sort
for|for
control|(
name|String
name|f
range|:
name|fieldNames
control|)
block|{
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"sort"
block|,
name|f
operator|+
literal|" desc"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"sort"
block|,
name|f
operator|+
literal|" asc"
block|}
argument_list|)
expr_stmt|;
block|}
comment|// these queries should be exactly ordered and scores should exactly match
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"sort"
block|,
name|i1
operator|+
literal|" desc"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"sort"
block|,
name|i1
operator|+
literal|" asc"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"sort"
block|,
name|i1
operator|+
literal|" desc"
block|,
literal|"fl"
block|,
literal|"*,score"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"sort"
block|,
literal|"n_tl1 asc"
block|,
literal|"fl"
block|,
literal|"*,score"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"sort"
block|,
literal|"n_tl1 desc"
block|}
argument_list|)
expr_stmt|;
name|handle
operator|.
name|put
argument_list|(
literal|"maxScore"
argument_list|,
name|SKIPVAL
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"{!func}"
operator|+
name|i1
block|}
argument_list|)
expr_stmt|;
comment|// does not expect maxScore. So if it comes ,ignore it. JavaBinCodec.writeSolrDocumentList()
comment|//is agnostic of request params.
name|handle
operator|.
name|remove
argument_list|(
literal|"maxScore"
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"{!func}"
operator|+
name|i1
block|,
literal|"fl"
block|,
literal|"*,score"
block|}
argument_list|)
expr_stmt|;
comment|// even scores should match exactly here
name|handle
operator|.
name|put
argument_list|(
literal|"highlighting"
argument_list|,
name|UNORDERED
argument_list|)
expr_stmt|;
name|handle
operator|.
name|put
argument_list|(
literal|"response"
argument_list|,
name|UNORDERED
argument_list|)
expr_stmt|;
name|handle
operator|.
name|put
argument_list|(
literal|"maxScore"
argument_list|,
name|SKIPVAL
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"quick"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"all"
block|,
literal|"fl"
block|,
literal|"id"
block|,
literal|"start"
block|,
literal|"0"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"all"
block|,
literal|"fl"
block|,
literal|"foofoofoo"
block|,
literal|"start"
block|,
literal|"0"
block|}
argument_list|)
expr_stmt|;
comment|// no fields in returned docs
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"all"
block|,
literal|"fl"
block|,
literal|"id"
block|,
literal|"start"
block|,
literal|"100"
block|}
argument_list|)
expr_stmt|;
name|handle
operator|.
name|put
argument_list|(
literal|"score"
argument_list|,
name|SKIPVAL
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"quick"
block|,
literal|"fl"
block|,
literal|"*,score"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"all"
block|,
literal|"fl"
block|,
literal|"*,score"
block|,
literal|"start"
block|,
literal|"1"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"all"
block|,
literal|"fl"
block|,
literal|"*,score"
block|,
literal|"start"
block|,
literal|"100"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"now their fox sat had put"
block|,
literal|"fl"
block|,
literal|"*,score"
block|,
literal|"hl"
block|,
literal|"true"
block|,
literal|"hl.fl"
block|,
name|t1
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"now their fox sat had put"
block|,
literal|"fl"
block|,
literal|"foofoofoo"
block|,
literal|"hl"
block|,
literal|"true"
block|,
literal|"hl.fl"
block|,
name|t1
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|String
index|[]
block|{
literal|"q"
block|,
literal|"matchesnothing"
block|,
literal|"fl"
block|,
literal|"*,score"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"facet.limit"
block|,
operator|-
literal|1
block|,
literal|"facet.sort"
block|,
literal|"count"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"facet.limit"
block|,
operator|-
literal|1
block|,
literal|"facet.sort"
block|,
literal|"count"
block|,
literal|"facet.mincount"
block|,
literal|2
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"facet.limit"
block|,
operator|-
literal|1
block|,
literal|"facet.sort"
block|,
literal|"index"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"facet.limit"
block|,
operator|-
literal|1
block|,
literal|"facet.sort"
block|,
literal|"index"
block|,
literal|"facet.mincount"
block|,
literal|2
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"facet.limit"
block|,
literal|1
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.query"
block|,
literal|"quick"
block|,
literal|"facet.query"
block|,
literal|"all"
block|,
literal|"facet.query"
block|,
literal|"*:*"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"facet.offset"
block|,
literal|1
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"facet.mincount"
block|,
literal|2
block|}
argument_list|)
expr_stmt|;
comment|// test faceting multiple things at once
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.query"
block|,
literal|"quick"
block|,
literal|"facet.query"
block|,
literal|"all"
block|,
literal|"facet.query"
block|,
literal|"*:*"
block|,
literal|"facet.field"
block|,
name|t1
block|}
argument_list|)
expr_stmt|;
comment|// test filter tagging, facet exclusion, and naming (multi-select facet support)
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.query"
block|,
literal|"{!key=myquick}quick"
block|,
literal|"facet.query"
block|,
literal|"{!key=myall ex=a}all"
block|,
literal|"facet.query"
block|,
literal|"*:*"
block|,
literal|"facet.field"
block|,
literal|"{!key=mykey ex=a}"
operator|+
name|t1
block|,
literal|"facet.field"
block|,
literal|"{!key=other ex=b}"
operator|+
name|t1
block|,
literal|"facet.field"
block|,
literal|"{!key=again ex=a,b}"
operator|+
name|t1
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"fq"
block|,
literal|"{!tag=a}id:[1 TO 7]"
block|,
literal|"fq"
block|,
literal|"{!tag=b}id:[3 TO 9]"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
literal|"{!ex=t1}SubjectTerms_mfacet"
block|,
literal|"fq"
block|,
literal|"{!tag=t1}SubjectTerms_mfacet:(test 1)"
block|,
literal|"facet.limit"
block|,
literal|"10"
block|,
literal|"facet.mincount"
block|,
literal|"1"
block|}
argument_list|)
expr_stmt|;
comment|// test field that is valid in schema but missing in all shards
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|missingField
block|,
literal|"facet.mincount"
block|,
literal|2
block|}
argument_list|)
expr_stmt|;
comment|// test field that is valid in schema and missing in some shards
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|oddField
block|,
literal|"facet.mincount"
block|,
literal|2
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"sort"
block|,
name|i1
operator|+
literal|" desc"
block|,
literal|"stats"
block|,
literal|"true"
block|,
literal|"stats.field"
block|,
name|i1
block|}
argument_list|)
expr_stmt|;
comment|/*** TODO: the failure may come back in "exception"     try {       // test error produced for field that is invalid for schema       query("q","*:*", "rows",100, "facet","true", "facet.field",invalidField, "facet.mincount",2);       TestCase.fail("SolrServerException expected for invalid field that is not in schema");     } catch (SolrServerException ex) {       // expected     }     ***/
comment|// Try to get better coverage for refinement queries by turning off over requesting.
comment|// This makes it much more likely that we may not get the top facet values and hence
comment|// we turn of that checking.
name|handle
operator|.
name|put
argument_list|(
literal|"facet_fields"
argument_list|,
name|SKIPVAL
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|0
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
name|t1
block|,
literal|"facet.limit"
block|,
literal|5
block|,
literal|"facet.shard.limit"
block|,
literal|5
block|}
argument_list|)
expr_stmt|;
comment|// check a complex key name
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|0
block|,
literal|"facet"
block|,
literal|"true"
block|,
literal|"facet.field"
block|,
literal|"{!key='a b/c \\' \\} foo'}"
operator|+
name|t1
block|,
literal|"facet.limit"
block|,
literal|5
block|,
literal|"facet.shard.limit"
block|,
literal|5
block|}
argument_list|)
expr_stmt|;
name|handle
operator|.
name|remove
argument_list|(
literal|"facet_fields"
argument_list|)
expr_stmt|;
comment|// index the same document to two servers and make sure things
comment|// don't blow up.
if|if
condition|(
name|clients
operator|.
name|size
argument_list|()
operator|>=
literal|2
condition|)
block|{
name|index
argument_list|(
name|id
argument_list|,
literal|100
argument_list|,
name|i1
argument_list|,
literal|107
argument_list|,
name|t1
argument_list|,
literal|"oh no, a duplicate!"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|clients
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|index_specific
argument_list|(
name|i
argument_list|,
name|id
argument_list|,
literal|100
argument_list|,
name|i1
argument_list|,
literal|107
argument_list|,
name|t1
argument_list|,
literal|"oh no, a duplicate!"
argument_list|)
expr_stmt|;
block|}
name|commit
argument_list|()
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"duplicate"
block|,
literal|"hl"
block|,
literal|"true"
block|,
literal|"hl.fl"
block|,
name|t1
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"fox duplicate horses"
block|,
literal|"hl"
block|,
literal|"true"
block|,
literal|"hl.fl"
block|,
name|t1
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"*:*"
block|,
literal|"rows"
block|,
literal|100
block|}
argument_list|)
expr_stmt|;
block|}
comment|// test debugging
name|handle
operator|.
name|put
argument_list|(
literal|"explain"
argument_list|,
name|SKIPVAL
argument_list|)
expr_stmt|;
name|handle
operator|.
name|put
argument_list|(
literal|"debug"
argument_list|,
name|UNORDERED
argument_list|)
expr_stmt|;
name|handle
operator|.
name|put
argument_list|(
literal|"time"
argument_list|,
name|SKIPVAL
argument_list|)
expr_stmt|;
name|handle
operator|.
name|put
argument_list|(
literal|"track"
argument_list|,
name|SKIP
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"now their fox sat had put"
block|,
literal|"fl"
block|,
literal|"*,score"
block|,
name|CommonParams
operator|.
name|DEBUG_QUERY
block|,
literal|"true"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"id:[1 TO 5]"
block|,
name|CommonParams
operator|.
name|DEBUG_QUERY
block|,
literal|"true"
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"id:[1 TO 5]"
block|,
name|CommonParams
operator|.
name|DEBUG
block|,
name|CommonParams
operator|.
name|TIMING
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"id:[1 TO 5]"
block|,
name|CommonParams
operator|.
name|DEBUG
block|,
name|CommonParams
operator|.
name|RESULTS
block|}
argument_list|)
expr_stmt|;
name|query
argument_list|(
literal|false
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|"q"
block|,
literal|"id:[1 TO 5]"
block|,
name|CommonParams
operator|.
name|DEBUG
block|,
name|CommonParams
operator|.
name|QUERY
block|}
argument_list|)
expr_stmt|;
comment|// try add commitWithin
name|long
name|before
init|=
name|cloudClient
operator|.
name|query
argument_list|(
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
for|for
control|(
name|SolrClient
name|client
range|:
name|clients
control|)
block|{
name|assertEquals
argument_list|(
literal|"unexpected pre-commitWithin document count on node: "
operator|+
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
argument_list|,
name|before
argument_list|,
name|client
operator|.
name|query
argument_list|(
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|ModifiableSolrParams
name|params
init|=
operator|new
name|ModifiableSolrParams
argument_list|()
decl_stmt|;
name|params
operator|.
name|set
argument_list|(
literal|"commitWithin"
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|add
argument_list|(
name|cloudClient
argument_list|,
name|params
argument_list|,
name|getDoc
argument_list|(
literal|"id"
argument_list|,
literal|300
argument_list|)
argument_list|,
name|getDoc
argument_list|(
literal|"id"
argument_list|,
literal|301
argument_list|)
argument_list|)
expr_stmt|;
name|waitForDocCount
argument_list|(
name|before
operator|+
literal|2
argument_list|,
literal|30000
argument_list|,
literal|"add commitWithin did not work"
argument_list|)
expr_stmt|;
comment|// try deleteById commitWithin
name|UpdateRequest
name|deleteByIdReq
init|=
operator|new
name|UpdateRequest
argument_list|()
decl_stmt|;
name|deleteByIdReq
operator|.
name|deleteById
argument_list|(
literal|"300"
argument_list|)
expr_stmt|;
name|deleteByIdReq
operator|.
name|setCommitWithin
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|deleteByIdReq
operator|.
name|process
argument_list|(
name|cloudClient
argument_list|)
expr_stmt|;
name|waitForDocCount
argument_list|(
name|before
operator|+
literal|1
argument_list|,
literal|30000
argument_list|,
literal|"deleteById commitWithin did not work"
argument_list|)
expr_stmt|;
comment|// try deleteByQuery commitWithin
name|UpdateRequest
name|deleteByQueryReq
init|=
operator|new
name|UpdateRequest
argument_list|()
decl_stmt|;
name|deleteByQueryReq
operator|.
name|deleteByQuery
argument_list|(
literal|"id:301"
argument_list|)
expr_stmt|;
name|deleteByQueryReq
operator|.
name|setCommitWithin
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|deleteByQueryReq
operator|.
name|process
argument_list|(
name|cloudClient
argument_list|)
expr_stmt|;
name|waitForDocCount
argument_list|(
name|before
argument_list|,
literal|30000
argument_list|,
literal|"deleteByQuery commitWithin did not work"
argument_list|)
expr_stmt|;
comment|// TODO: This test currently fails because debug info is obtained only
comment|// on shards with matches.
comment|// query("q","matchesnothing","fl","*,score", "debugQuery", "true");
comment|// would be better if these where all separate tests - but much, much
comment|// slower
name|doOptimisticLockingAndUpdating
argument_list|()
expr_stmt|;
name|testShardParamVariations
argument_list|()
expr_stmt|;
name|testMultipleCollections
argument_list|()
expr_stmt|;
name|testANewCollectionInOneInstance
argument_list|()
expr_stmt|;
name|testSearchByCollectionName
argument_list|()
expr_stmt|;
name|testUpdateByCollectionName
argument_list|()
expr_stmt|;
name|testANewCollectionInOneInstanceWithManualShardAssignement
argument_list|()
expr_stmt|;
name|testNumberOfCommitsWithCommitAfterAdd
argument_list|()
expr_stmt|;
name|testUpdateProcessorsRunOnlyOnce
argument_list|(
literal|"distrib-dup-test-chain-explicit"
argument_list|)
expr_stmt|;
name|testUpdateProcessorsRunOnlyOnce
argument_list|(
literal|"distrib-dup-test-chain-implicit"
argument_list|)
expr_stmt|;
name|testStopAndStartCoresInOneInstance
argument_list|()
expr_stmt|;
comment|// Thread.sleep(10000000000L);
if|if
condition|(
name|DEBUG
condition|)
block|{
name|super
operator|.
name|printLayout
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|waitForDocCount
specifier|private
name|void
name|waitForDocCount
parameter_list|(
name|long
name|expectedNumFound
parameter_list|,
name|long
name|waitMillis
parameter_list|,
name|String
name|failureMessage
parameter_list|)
throws|throws
name|SolrServerException
throws|,
name|IOException
throws|,
name|InterruptedException
block|{
name|RTimer
name|timer
init|=
operator|new
name|RTimer
argument_list|()
decl_stmt|;
name|long
name|timeout
init|=
operator|(
name|long
operator|)
name|timer
operator|.
name|getTime
argument_list|()
operator|+
name|waitMillis
decl_stmt|;
while|while
condition|(
name|cloudClient
operator|.
name|query
argument_list|(
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
operator|!=
name|expectedNumFound
condition|)
block|{
if|if
condition|(
name|timeout
operator|<=
operator|(
name|long
operator|)
name|timer
operator|.
name|getTime
argument_list|()
condition|)
block|{
name|fail
argument_list|(
name|failureMessage
argument_list|)
expr_stmt|;
block|}
name|Thread
operator|.
name|sleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|SolrClient
name|client
range|:
name|clients
control|)
block|{
name|assertEquals
argument_list|(
name|failureMessage
argument_list|,
name|expectedNumFound
argument_list|,
name|client
operator|.
name|query
argument_list|(
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testShardParamVariations
specifier|private
name|void
name|testShardParamVariations
parameter_list|()
throws|throws
name|Exception
block|{
name|SolrQuery
name|query
init|=
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|shardCounts
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|shard
range|:
name|shardToJetty
operator|.
name|keySet
argument_list|()
control|)
block|{
comment|// every client should give the same numDocs for this shard
comment|// shffle the clients in a diff order for each shard
name|List
argument_list|<
name|SolrClient
argument_list|>
name|solrclients
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|this
operator|.
name|clients
argument_list|)
decl_stmt|;
name|Collections
operator|.
name|shuffle
argument_list|(
name|solrclients
argument_list|,
name|random
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|SolrClient
name|client
range|:
name|solrclients
control|)
block|{
name|query
operator|.
name|set
argument_list|(
literal|"shards"
argument_list|,
name|shard
argument_list|)
expr_stmt|;
name|long
name|numDocs
init|=
name|client
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
literal|"numDocs< 0 for shard "
operator|+
name|shard
operator|+
literal|" via "
operator|+
name|client
argument_list|,
literal|0
operator|<=
name|numDocs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|shardCounts
operator|.
name|containsKey
argument_list|(
name|shard
argument_list|)
condition|)
block|{
name|shardCounts
operator|.
name|put
argument_list|(
name|shard
argument_list|,
name|numDocs
argument_list|)
expr_stmt|;
block|}
name|assertEquals
argument_list|(
literal|"inconsitent numDocs for shard "
operator|+
name|shard
operator|+
literal|" via "
operator|+
name|client
argument_list|,
name|shardCounts
operator|.
name|get
argument_list|(
name|shard
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|,
name|numDocs
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|CloudJettyRunner
argument_list|>
name|replicaJetties
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|shardToJetty
operator|.
name|get
argument_list|(
name|shard
argument_list|)
argument_list|)
decl_stmt|;
name|Collections
operator|.
name|shuffle
argument_list|(
name|replicaJetties
argument_list|,
name|random
argument_list|()
argument_list|)
expr_stmt|;
comment|// each replica should also give the same numDocs
name|ArrayList
argument_list|<
name|String
argument_list|>
name|replicaAlts
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|replicaJetties
operator|.
name|size
argument_list|()
operator|*
literal|2
argument_list|)
decl_stmt|;
for|for
control|(
name|CloudJettyRunner
name|replicaJetty
range|:
name|shardToJetty
operator|.
name|get
argument_list|(
name|shard
argument_list|)
control|)
block|{
name|String
name|replica
init|=
name|replicaJetty
operator|.
name|url
decl_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"shards"
argument_list|,
name|replica
argument_list|)
expr_stmt|;
comment|// replicas already shuffled, use this in the alternative check below
if|if
condition|(
literal|0
operator|==
name|random
argument_list|()
operator|.
name|nextInt
argument_list|(
literal|3
argument_list|)
operator|||
name|replicaAlts
operator|.
name|size
argument_list|()
operator|<
literal|2
condition|)
block|{
name|replicaAlts
operator|.
name|add
argument_list|(
name|replica
argument_list|)
expr_stmt|;
block|}
name|numDocs
operator|=
name|client
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"numDocs< 0 for replica "
operator|+
name|replica
operator|+
literal|" via "
operator|+
name|client
argument_list|,
literal|0
operator|<=
name|numDocs
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"inconsitent numDocs for shard "
operator|+
name|shard
operator|+
literal|" in replica "
operator|+
name|replica
operator|+
literal|" via "
operator|+
name|client
argument_list|,
name|shardCounts
operator|.
name|get
argument_list|(
name|shard
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|,
name|numDocs
argument_list|)
expr_stmt|;
block|}
comment|// any combination of replica alternatives should give same numDocs
name|String
name|replicas
init|=
name|StringUtils
operator|.
name|join
argument_list|(
name|replicaAlts
operator|.
name|toArray
argument_list|()
argument_list|,
literal|"|"
argument_list|)
decl_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"shards"
argument_list|,
name|replicas
argument_list|)
expr_stmt|;
name|numDocs
operator|=
name|client
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
expr_stmt|;
name|assertTrue
argument_list|(
literal|"numDocs< 0 for replicas "
operator|+
name|replicas
operator|+
literal|" via "
operator|+
name|client
argument_list|,
literal|0
operator|<=
name|numDocs
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"inconsitent numDocs for replicas "
operator|+
name|replicas
operator|+
literal|" via "
operator|+
name|client
argument_list|,
name|shardCounts
operator|.
name|get
argument_list|(
name|shard
argument_list|)
operator|.
name|longValue
argument_list|()
argument_list|,
name|numDocs
argument_list|)
expr_stmt|;
block|}
block|}
comment|// sums of multiple shards should add up regardless of how we
comment|// query those shards or which client we use
name|long
name|randomShardCountsExpected
init|=
literal|0
decl_stmt|;
name|ArrayList
argument_list|<
name|String
argument_list|>
name|randomShards
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|shardCounts
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|shardData
range|:
name|shardCounts
operator|.
name|entrySet
argument_list|()
control|)
block|{
if|if
condition|(
name|random
argument_list|()
operator|.
name|nextBoolean
argument_list|()
operator|||
name|randomShards
operator|.
name|size
argument_list|()
operator|<
literal|2
condition|)
block|{
name|String
name|shard
init|=
name|shardData
operator|.
name|getKey
argument_list|()
decl_stmt|;
name|randomShardCountsExpected
operator|+=
name|shardData
operator|.
name|getValue
argument_list|()
expr_stmt|;
if|if
condition|(
name|random
argument_list|()
operator|.
name|nextBoolean
argument_list|()
condition|)
block|{
comment|// use shard id
name|randomShards
operator|.
name|add
argument_list|(
name|shard
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// use some set explicit replicas
name|ArrayList
argument_list|<
name|String
argument_list|>
name|replicas
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
literal|7
argument_list|)
decl_stmt|;
for|for
control|(
name|CloudJettyRunner
name|replicaJetty
range|:
name|shardToJetty
operator|.
name|get
argument_list|(
name|shard
argument_list|)
control|)
block|{
if|if
condition|(
literal|0
operator|==
name|random
argument_list|()
operator|.
name|nextInt
argument_list|(
literal|3
argument_list|)
operator|||
literal|0
operator|==
name|replicas
operator|.
name|size
argument_list|()
condition|)
block|{
name|replicas
operator|.
name|add
argument_list|(
name|replicaJetty
operator|.
name|url
argument_list|)
expr_stmt|;
block|}
block|}
name|Collections
operator|.
name|shuffle
argument_list|(
name|replicas
argument_list|,
name|random
argument_list|()
argument_list|)
expr_stmt|;
name|randomShards
operator|.
name|add
argument_list|(
name|StringUtils
operator|.
name|join
argument_list|(
name|replicas
argument_list|,
literal|"|"
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|String
name|randShards
init|=
name|StringUtils
operator|.
name|join
argument_list|(
name|randomShards
argument_list|,
literal|","
argument_list|)
decl_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"shards"
argument_list|,
name|randShards
argument_list|)
expr_stmt|;
for|for
control|(
name|SolrClient
name|client
range|:
name|this
operator|.
name|clients
control|)
block|{
name|assertEquals
argument_list|(
literal|"numDocs for "
operator|+
name|randShards
operator|+
literal|" via "
operator|+
name|client
argument_list|,
name|randomShardCountsExpected
argument_list|,
name|client
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// total num docs must match sum of every shard's numDocs
name|query
operator|=
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
expr_stmt|;
name|long
name|totalShardNumDocs
init|=
literal|0
decl_stmt|;
for|for
control|(
name|Long
name|c
range|:
name|shardCounts
operator|.
name|values
argument_list|()
control|)
block|{
name|totalShardNumDocs
operator|+=
name|c
expr_stmt|;
block|}
for|for
control|(
name|SolrClient
name|client
range|:
name|clients
control|)
block|{
name|assertEquals
argument_list|(
literal|"sum of shard numDocs on client: "
operator|+
name|client
argument_list|,
name|totalShardNumDocs
argument_list|,
name|client
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|assertTrue
argument_list|(
literal|"total numDocs<= 0, WTF? Test is useless"
argument_list|,
literal|0
operator|<
name|totalShardNumDocs
argument_list|)
expr_stmt|;
block|}
DECL|method|testStopAndStartCoresInOneInstance
specifier|private
name|void
name|testStopAndStartCoresInOneInstance
parameter_list|()
throws|throws
name|Exception
block|{
name|SolrClient
name|client
init|=
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|String
name|url3
init|=
name|getBaseUrl
argument_list|(
name|client
argument_list|)
decl_stmt|;
try|try
init|(
specifier|final
name|HttpSolrClient
name|httpSolrClient
init|=
operator|new
name|HttpSolrClient
argument_list|(
name|url3
argument_list|)
init|)
block|{
name|httpSolrClient
operator|.
name|setConnectionTimeout
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
name|httpSolrClient
operator|.
name|setSoTimeout
argument_list|(
literal|60000
argument_list|)
expr_stmt|;
name|ThreadPoolExecutor
name|executor
init|=
literal|null
decl_stmt|;
try|try
block|{
name|executor
operator|=
operator|new
name|ExecutorUtil
operator|.
name|MDCAwareThreadPoolExecutor
argument_list|(
literal|0
argument_list|,
name|Integer
operator|.
name|MAX_VALUE
argument_list|,
literal|5
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|,
operator|new
name|SynchronousQueue
argument_list|<
name|Runnable
argument_list|>
argument_list|()
argument_list|,
operator|new
name|DefaultSolrThreadFactory
argument_list|(
literal|"testExecutor"
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|cnt
init|=
literal|3
decl_stmt|;
comment|// create the cores
name|createCores
argument_list|(
name|httpSolrClient
argument_list|,
name|executor
argument_list|,
literal|"multiunload2"
argument_list|,
literal|1
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|executor
operator|!=
literal|null
condition|)
block|{
name|ExecutorUtil
operator|.
name|shutdownAndAwaitTermination
argument_list|(
name|executor
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ChaosMonkey
operator|.
name|stop
argument_list|(
name|cloudJettys
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|jetty
argument_list|)
expr_stmt|;
name|printLayout
argument_list|()
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
name|ChaosMonkey
operator|.
name|start
argument_list|(
name|cloudJettys
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|jetty
argument_list|)
expr_stmt|;
name|cloudClient
operator|.
name|getZkStateReader
argument_list|()
operator|.
name|updateClusterState
argument_list|()
expr_stmt|;
try|try
block|{
name|cloudClient
operator|.
name|getZkStateReader
argument_list|()
operator|.
name|getLeaderRetry
argument_list|(
literal|"multiunload2"
argument_list|,
literal|"shard1"
argument_list|,
literal|30000
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SolrException
name|e
parameter_list|)
block|{
name|printLayout
argument_list|()
expr_stmt|;
throw|throw
name|e
throw|;
block|}
name|printLayout
argument_list|()
expr_stmt|;
block|}
DECL|method|createCores
specifier|protected
name|void
name|createCores
parameter_list|(
specifier|final
name|HttpSolrClient
name|client
parameter_list|,
name|ThreadPoolExecutor
name|executor
parameter_list|,
specifier|final
name|String
name|collection
parameter_list|,
specifier|final
name|int
name|numShards
parameter_list|,
name|int
name|cnt
parameter_list|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
specifier|final
name|int
name|freezeI
init|=
name|i
decl_stmt|;
name|executor
operator|.
name|execute
argument_list|(
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
name|Create
name|createCmd
init|=
operator|new
name|Create
argument_list|()
decl_stmt|;
name|createCmd
operator|.
name|setCoreName
argument_list|(
name|collection
operator|+
name|freezeI
argument_list|)
expr_stmt|;
name|createCmd
operator|.
name|setCollection
argument_list|(
name|collection
argument_list|)
expr_stmt|;
name|createCmd
operator|.
name|setNumShards
argument_list|(
name|numShards
argument_list|)
expr_stmt|;
try|try
block|{
name|String
name|core3dataDir
init|=
name|createTempDir
argument_list|(
name|collection
argument_list|)
operator|.
name|toFile
argument_list|()
operator|.
name|getAbsolutePath
argument_list|()
decl_stmt|;
name|createCmd
operator|.
name|setDataDir
argument_list|(
name|getDataDir
argument_list|(
name|core3dataDir
argument_list|)
argument_list|)
expr_stmt|;
name|client
operator|.
name|request
argument_list|(
name|createCmd
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SolrServerException
decl||
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|getBaseUrl
specifier|protected
name|String
name|getBaseUrl
parameter_list|(
name|SolrClient
name|client
parameter_list|)
block|{
name|String
name|url2
init|=
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|length
argument_list|()
operator|-
name|DEFAULT_COLLECTION
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
return|return
name|url2
return|;
block|}
DECL|method|createCollection
specifier|protected
name|CollectionAdminResponse
name|createCollection
parameter_list|(
name|Map
argument_list|<
name|String
argument_list|,
name|List
argument_list|<
name|Integer
argument_list|>
argument_list|>
name|collectionInfos
parameter_list|,
name|String
name|collectionName
parameter_list|,
name|int
name|numShards
parameter_list|,
name|int
name|numReplicas
parameter_list|,
name|int
name|maxShardsPerNode
parameter_list|,
name|SolrClient
name|client
parameter_list|,
name|String
name|createNodeSetStr
parameter_list|)
throws|throws
name|SolrServerException
throws|,
name|IOException
block|{
comment|// TODO: Use CollectionAdminRequest for this test
name|ModifiableSolrParams
name|params
init|=
operator|new
name|ModifiableSolrParams
argument_list|()
decl_stmt|;
name|params
operator|.
name|set
argument_list|(
literal|"action"
argument_list|,
name|CollectionAction
operator|.
name|CREATE
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|params
operator|.
name|set
argument_list|(
name|OverseerCollectionMessageHandler
operator|.
name|NUM_SLICES
argument_list|,
name|numShards
argument_list|)
expr_stmt|;
name|params
operator|.
name|set
argument_list|(
name|ZkStateReader
operator|.
name|REPLICATION_FACTOR
argument_list|,
name|numReplicas
argument_list|)
expr_stmt|;
name|params
operator|.
name|set
argument_list|(
name|ZkStateReader
operator|.
name|MAX_SHARDS_PER_NODE
argument_list|,
name|maxShardsPerNode
argument_list|)
expr_stmt|;
if|if
condition|(
name|createNodeSetStr
operator|!=
literal|null
condition|)
name|params
operator|.
name|set
argument_list|(
name|OverseerCollectionMessageHandler
operator|.
name|CREATE_NODE_SET
argument_list|,
name|createNodeSetStr
argument_list|)
expr_stmt|;
name|int
name|clientIndex
init|=
name|clients
operator|.
name|size
argument_list|()
operator|>
literal|1
condition|?
name|random
argument_list|()
operator|.
name|nextInt
argument_list|(
literal|2
argument_list|)
else|:
literal|0
decl_stmt|;
name|List
argument_list|<
name|Integer
argument_list|>
name|list
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|list
operator|.
name|add
argument_list|(
name|numShards
argument_list|)
expr_stmt|;
name|list
operator|.
name|add
argument_list|(
name|numReplicas
argument_list|)
expr_stmt|;
if|if
condition|(
name|collectionInfos
operator|!=
literal|null
condition|)
block|{
name|collectionInfos
operator|.
name|put
argument_list|(
name|collectionName
argument_list|,
name|list
argument_list|)
expr_stmt|;
block|}
name|params
operator|.
name|set
argument_list|(
literal|"name"
argument_list|,
name|collectionName
argument_list|)
expr_stmt|;
name|SolrRequest
name|request
init|=
operator|new
name|QueryRequest
argument_list|(
name|params
argument_list|)
decl_stmt|;
name|request
operator|.
name|setPath
argument_list|(
literal|"/admin/collections"
argument_list|)
expr_stmt|;
name|CollectionAdminResponse
name|res
init|=
operator|new
name|CollectionAdminResponse
argument_list|()
decl_stmt|;
if|if
condition|(
name|client
operator|==
literal|null
condition|)
block|{
specifier|final
name|String
name|baseUrl
init|=
operator|(
operator|(
name|HttpSolrClient
operator|)
name|clients
operator|.
name|get
argument_list|(
name|clientIndex
argument_list|)
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
operator|(
operator|(
name|HttpSolrClient
operator|)
name|clients
operator|.
name|get
argument_list|(
name|clientIndex
argument_list|)
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|length
argument_list|()
operator|-
name|DEFAULT_COLLECTION
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
try|try
init|(
name|SolrClient
name|aClient
init|=
name|createNewSolrClient
argument_list|(
literal|""
argument_list|,
name|baseUrl
argument_list|)
init|)
block|{
name|res
operator|.
name|setResponse
argument_list|(
name|aClient
operator|.
name|request
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|.
name|setResponse
argument_list|(
name|client
operator|.
name|request
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
DECL|method|getLeaderUrlFromZk
specifier|protected
name|ZkCoreNodeProps
name|getLeaderUrlFromZk
parameter_list|(
name|String
name|collection
parameter_list|,
name|String
name|slice
parameter_list|)
block|{
name|ClusterState
name|clusterState
init|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
operator|.
name|getClusterState
argument_list|()
decl_stmt|;
name|ZkNodeProps
name|leader
init|=
name|clusterState
operator|.
name|getLeader
argument_list|(
name|collection
argument_list|,
name|slice
argument_list|)
decl_stmt|;
if|if
condition|(
name|leader
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"Could not find leader:"
operator|+
name|collection
operator|+
literal|" "
operator|+
name|slice
argument_list|)
throw|;
block|}
return|return
operator|new
name|ZkCoreNodeProps
argument_list|(
name|leader
argument_list|)
return|;
block|}
comment|/**    * Expects a RegexReplaceProcessorFactories in the chain which will    * "double up" the values in two (stored) string fields.    *<p>    * If the values are "double-doubled" or "not-doubled" then we know     * the processor was not run the appropriate number of times    *</p>    */
DECL|method|testUpdateProcessorsRunOnlyOnce
specifier|private
name|void
name|testUpdateProcessorsRunOnlyOnce
parameter_list|(
specifier|final
name|String
name|chain
parameter_list|)
throws|throws
name|Exception
block|{
specifier|final
name|String
name|fieldA
init|=
literal|"regex_dup_A_s"
decl_stmt|;
specifier|final
name|String
name|fieldB
init|=
literal|"regex_dup_B_s"
decl_stmt|;
specifier|final
name|String
name|val
init|=
literal|"x"
decl_stmt|;
specifier|final
name|String
name|expected
init|=
literal|"x_x"
decl_stmt|;
specifier|final
name|ModifiableSolrParams
name|updateParams
init|=
operator|new
name|ModifiableSolrParams
argument_list|()
decl_stmt|;
name|updateParams
operator|.
name|add
argument_list|(
name|UpdateParams
operator|.
name|UPDATE_CHAIN
argument_list|,
name|chain
argument_list|)
expr_stmt|;
specifier|final
name|int
name|numLoops
init|=
name|atLeast
argument_list|(
literal|50
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|numLoops
condition|;
name|i
operator|++
control|)
block|{
comment|// add doc to random client
name|SolrClient
name|updateClient
init|=
name|clients
operator|.
name|get
argument_list|(
name|random
argument_list|()
operator|.
name|nextInt
argument_list|(
name|clients
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|SolrInputDocument
name|doc
init|=
operator|new
name|SolrInputDocument
argument_list|()
decl_stmt|;
name|addFields
argument_list|(
name|doc
argument_list|,
name|id
argument_list|,
name|i
argument_list|,
name|fieldA
argument_list|,
name|val
argument_list|,
name|fieldB
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|UpdateResponse
name|ures
init|=
name|add
argument_list|(
name|updateClient
argument_list|,
name|updateParams
argument_list|,
name|doc
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|chain
operator|+
literal|": update failed"
argument_list|,
literal|0
argument_list|,
name|ures
operator|.
name|getStatus
argument_list|()
argument_list|)
expr_stmt|;
name|ures
operator|=
name|updateClient
operator|.
name|commit
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|chain
operator|+
literal|": commit failed"
argument_list|,
literal|0
argument_list|,
name|ures
operator|.
name|getStatus
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// query for each doc, and check both fields to ensure the value is correct
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|numLoops
condition|;
name|i
operator|++
control|)
block|{
specifier|final
name|String
name|query
init|=
name|id
operator|+
literal|":"
operator|+
name|i
decl_stmt|;
name|QueryResponse
name|qres
init|=
name|queryServer
argument_list|(
operator|new
name|SolrQuery
argument_list|(
name|query
argument_list|)
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|chain
operator|+
literal|": query failed: "
operator|+
name|query
argument_list|,
literal|0
argument_list|,
name|qres
operator|.
name|getStatus
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|chain
operator|+
literal|": didn't find correct # docs with query: "
operator|+
name|query
argument_list|,
literal|1
argument_list|,
name|qres
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
argument_list|)
expr_stmt|;
name|SolrDocument
name|doc
init|=
name|qres
operator|.
name|getResults
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|field
range|:
operator|new
name|String
index|[]
block|{
name|fieldA
block|,
name|fieldB
block|}
control|)
block|{
name|assertEquals
argument_list|(
name|chain
operator|+
literal|": doc#"
operator|+
name|i
operator|+
literal|" has wrong value for "
operator|+
name|field
argument_list|,
name|expected
argument_list|,
name|doc
operator|.
name|getFirstValue
argument_list|(
name|field
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// cloud level test mainly needed just to make sure that versions and errors are propagated correctly
DECL|method|doOptimisticLockingAndUpdating
specifier|private
name|void
name|doOptimisticLockingAndUpdating
parameter_list|()
throws|throws
name|Exception
block|{
name|log
operator|.
name|info
argument_list|(
literal|"### STARTING doOptimisticLockingAndUpdating"
argument_list|)
expr_stmt|;
name|printLayout
argument_list|()
expr_stmt|;
name|SolrInputDocument
name|sd
init|=
name|sdoc
argument_list|(
literal|"id"
argument_list|,
literal|1000
argument_list|,
literal|"_version_"
argument_list|,
operator|-
literal|1
argument_list|)
decl_stmt|;
name|indexDoc
argument_list|(
name|sd
argument_list|)
expr_stmt|;
name|ignoreException
argument_list|(
literal|"version conflict"
argument_list|)
expr_stmt|;
for|for
control|(
name|SolrClient
name|client
range|:
name|clients
control|)
block|{
try|try
block|{
name|client
operator|.
name|add
argument_list|(
name|sd
argument_list|)
expr_stmt|;
name|fail
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SolrException
name|e
parameter_list|)
block|{
name|assertEquals
argument_list|(
literal|409
argument_list|,
name|e
operator|.
name|code
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|unIgnoreException
argument_list|(
literal|"version conflict"
argument_list|)
expr_stmt|;
comment|// TODO: test deletes.  SolrJ needs a good way to pass version for delete...
name|sd
operator|=
name|sdoc
argument_list|(
literal|"id"
argument_list|,
literal|1000
argument_list|,
literal|"foo_i"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|add
argument_list|(
name|sd
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|Integer
argument_list|>
name|expected
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|int
name|val
init|=
literal|0
decl_stmt|;
for|for
control|(
name|SolrClient
name|client
range|:
name|clients
control|)
block|{
name|val
operator|+=
literal|10
expr_stmt|;
name|client
operator|.
name|add
argument_list|(
name|sdoc
argument_list|(
literal|"id"
argument_list|,
literal|1000
argument_list|,
literal|"val_i"
argument_list|,
name|map
argument_list|(
literal|"add"
argument_list|,
name|val
argument_list|)
argument_list|,
literal|"foo_i"
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|expected
operator|.
name|add
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
name|QueryRequest
name|qr
init|=
operator|new
name|QueryRequest
argument_list|(
name|params
argument_list|(
literal|"qt"
argument_list|,
literal|"/get"
argument_list|,
literal|"id"
argument_list|,
literal|"1000"
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|SolrClient
name|client
range|:
name|clients
control|)
block|{
name|val
operator|+=
literal|10
expr_stmt|;
name|NamedList
name|rsp
init|=
name|client
operator|.
name|request
argument_list|(
name|qr
argument_list|)
decl_stmt|;
name|String
name|match
init|=
name|JSONTestUtil
operator|.
name|matchObj
argument_list|(
literal|"/val_i"
argument_list|,
name|rsp
operator|.
name|get
argument_list|(
literal|"doc"
argument_list|)
argument_list|,
name|expected
argument_list|)
decl_stmt|;
if|if
condition|(
name|match
operator|!=
literal|null
condition|)
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|match
argument_list|)
throw|;
block|}
block|}
DECL|method|testNumberOfCommitsWithCommitAfterAdd
specifier|private
name|void
name|testNumberOfCommitsWithCommitAfterAdd
parameter_list|()
throws|throws
name|SolrServerException
throws|,
name|IOException
block|{
name|log
operator|.
name|info
argument_list|(
literal|"### STARTING testNumberOfCommitsWithCommitAfterAdd"
argument_list|)
expr_stmt|;
name|long
name|startCommits
init|=
name|getNumCommits
argument_list|(
operator|(
name|HttpSolrClient
operator|)
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
decl_stmt|;
name|ContentStreamUpdateRequest
name|up
init|=
operator|new
name|ContentStreamUpdateRequest
argument_list|(
literal|"/update"
argument_list|)
decl_stmt|;
name|up
operator|.
name|addFile
argument_list|(
name|getFile
argument_list|(
literal|"books_numeric_ids.csv"
argument_list|)
argument_list|,
literal|"application/csv"
argument_list|)
expr_stmt|;
name|up
operator|.
name|setCommitWithin
argument_list|(
literal|900000
argument_list|)
expr_stmt|;
name|up
operator|.
name|setAction
argument_list|(
name|AbstractUpdateRequest
operator|.
name|ACTION
operator|.
name|COMMIT
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|NamedList
argument_list|<
name|Object
argument_list|>
name|result
init|=
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|request
argument_list|(
name|up
argument_list|)
decl_stmt|;
name|long
name|endCommits
init|=
name|getNumCommits
argument_list|(
operator|(
name|HttpSolrClient
operator|)
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|startCommits
operator|+
literal|1L
argument_list|,
name|endCommits
argument_list|)
expr_stmt|;
block|}
DECL|method|getNumCommits
specifier|private
name|Long
name|getNumCommits
parameter_list|(
name|HttpSolrClient
name|sourceClient
parameter_list|)
throws|throws
name|SolrServerException
throws|,
name|IOException
block|{
try|try
init|(
name|HttpSolrClient
name|client
init|=
operator|new
name|HttpSolrClient
argument_list|(
name|sourceClient
operator|.
name|getBaseURL
argument_list|()
argument_list|)
init|)
block|{
name|client
operator|.
name|setConnectionTimeout
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
name|client
operator|.
name|setSoTimeout
argument_list|(
literal|60000
argument_list|)
expr_stmt|;
name|ModifiableSolrParams
name|params
init|=
operator|new
name|ModifiableSolrParams
argument_list|()
decl_stmt|;
name|params
operator|.
name|set
argument_list|(
literal|"qt"
argument_list|,
literal|"/admin/mbeans?key=updateHandler&stats=true"
argument_list|)
expr_stmt|;
comment|// use generic request to avoid extra processing of queries
name|QueryRequest
name|req
init|=
operator|new
name|QueryRequest
argument_list|(
name|params
argument_list|)
decl_stmt|;
name|NamedList
argument_list|<
name|Object
argument_list|>
name|resp
init|=
name|client
operator|.
name|request
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|NamedList
name|mbeans
init|=
operator|(
name|NamedList
operator|)
name|resp
operator|.
name|get
argument_list|(
literal|"solr-mbeans"
argument_list|)
decl_stmt|;
name|NamedList
name|uhandlerCat
init|=
operator|(
name|NamedList
operator|)
name|mbeans
operator|.
name|get
argument_list|(
literal|"UPDATEHANDLER"
argument_list|)
decl_stmt|;
name|NamedList
name|uhandler
init|=
operator|(
name|NamedList
operator|)
name|uhandlerCat
operator|.
name|get
argument_list|(
literal|"updateHandler"
argument_list|)
decl_stmt|;
name|NamedList
name|stats
init|=
operator|(
name|NamedList
operator|)
name|uhandler
operator|.
name|get
argument_list|(
literal|"stats"
argument_list|)
decl_stmt|;
return|return
operator|(
name|Long
operator|)
name|stats
operator|.
name|get
argument_list|(
literal|"commits"
argument_list|)
return|;
block|}
block|}
DECL|method|testANewCollectionInOneInstanceWithManualShardAssignement
specifier|private
name|void
name|testANewCollectionInOneInstanceWithManualShardAssignement
parameter_list|()
throws|throws
name|Exception
block|{
name|log
operator|.
name|info
argument_list|(
literal|"### STARTING testANewCollectionInOneInstanceWithManualShardAssignement"
argument_list|)
expr_stmt|;
name|System
operator|.
name|clearProperty
argument_list|(
literal|"numShards"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|SolrClient
argument_list|>
name|collectionClients
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|SolrClient
name|client
init|=
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
specifier|final
name|String
name|baseUrl
init|=
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|length
argument_list|()
operator|-
name|DEFAULT_COLLECTION
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
name|createSolrCore
argument_list|(
name|oneInstanceCollection2
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
literal|1
argument_list|,
literal|"slice1"
argument_list|)
expr_stmt|;
name|createSolrCore
argument_list|(
name|oneInstanceCollection2
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
literal|2
argument_list|,
literal|"slice2"
argument_list|)
expr_stmt|;
name|createSolrCore
argument_list|(
name|oneInstanceCollection2
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
literal|3
argument_list|,
literal|"slice2"
argument_list|)
expr_stmt|;
name|createSolrCore
argument_list|(
name|oneInstanceCollection2
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
literal|4
argument_list|,
literal|"slice1"
argument_list|)
expr_stmt|;
while|while
condition|(
name|pending
operator|!=
literal|null
operator|&&
name|pending
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|Future
argument_list|<
name|Object
argument_list|>
name|future
init|=
name|completionService
operator|.
name|take
argument_list|()
decl_stmt|;
name|pending
operator|.
name|remove
argument_list|(
name|future
argument_list|)
expr_stmt|;
block|}
name|SolrClient
name|client1
init|=
name|collectionClients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|SolrClient
name|client2
init|=
name|collectionClients
operator|.
name|get
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|SolrClient
name|client3
init|=
name|collectionClients
operator|.
name|get
argument_list|(
literal|2
argument_list|)
decl_stmt|;
name|SolrClient
name|client4
init|=
name|collectionClients
operator|.
name|get
argument_list|(
literal|3
argument_list|)
decl_stmt|;
comment|// no one should be recovering
name|waitForRecoveriesToFinish
argument_list|(
name|oneInstanceCollection2
argument_list|,
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
argument_list|,
literal|false
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|assertAllActive
argument_list|(
name|oneInstanceCollection2
argument_list|,
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
argument_list|)
expr_stmt|;
comment|//printLayout();
comment|// TODO: enable when we don't falsely get slice1...
comment|// solrj.getZkStateReader().getLeaderUrl(oneInstanceCollection2, "slice1", 30000);
comment|// solrj.getZkStateReader().getLeaderUrl(oneInstanceCollection2, "slice2", 30000);
name|client2
operator|.
name|add
argument_list|(
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"1"
argument_list|)
argument_list|)
expr_stmt|;
name|client3
operator|.
name|add
argument_list|(
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"2"
argument_list|)
argument_list|)
expr_stmt|;
name|client4
operator|.
name|add
argument_list|(
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"3"
argument_list|)
argument_list|)
expr_stmt|;
name|client1
operator|.
name|commit
argument_list|()
expr_stmt|;
name|SolrQuery
name|query
init|=
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
decl_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"distrib"
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|long
name|oneDocs
init|=
name|client1
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|long
name|twoDocs
init|=
name|client2
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|long
name|threeDocs
init|=
name|client3
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|long
name|fourDocs
init|=
name|client4
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"collection"
argument_list|,
name|oneInstanceCollection2
argument_list|)
expr_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"distrib"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|long
name|allDocs
init|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
comment|//    System.out.println("1:" + oneDocs);
comment|//    System.out.println("2:" + twoDocs);
comment|//    System.out.println("3:" + threeDocs);
comment|//    System.out.println("4:" + fourDocs);
comment|//    System.out.println("All Docs:" + allDocs);
comment|//    assertEquals(oneDocs, threeDocs);
comment|//    assertEquals(twoDocs, fourDocs);
comment|//    assertNotSame(oneDocs, twoDocs);
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|allDocs
argument_list|)
expr_stmt|;
comment|// we added a role of none on these creates - check for it
name|ZkStateReader
name|zkStateReader
init|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
decl_stmt|;
name|zkStateReader
operator|.
name|updateClusterState
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Slice
argument_list|>
name|slices
init|=
name|zkStateReader
operator|.
name|getClusterState
argument_list|()
operator|.
name|getSlicesMap
argument_list|(
name|oneInstanceCollection2
argument_list|)
decl_stmt|;
name|assertNotNull
argument_list|(
name|slices
argument_list|)
expr_stmt|;
name|String
name|roles
init|=
name|slices
operator|.
name|get
argument_list|(
literal|"slice1"
argument_list|)
operator|.
name|getReplicasMap
argument_list|()
operator|.
name|values
argument_list|()
operator|.
name|iterator
argument_list|()
operator|.
name|next
argument_list|()
operator|.
name|getStr
argument_list|(
name|ZkStateReader
operator|.
name|ROLES_PROP
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"none"
argument_list|,
name|roles
argument_list|)
expr_stmt|;
name|ZkCoreNodeProps
name|props
init|=
operator|new
name|ZkCoreNodeProps
argument_list|(
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
operator|.
name|getClusterState
argument_list|()
operator|.
name|getLeader
argument_list|(
name|oneInstanceCollection2
argument_list|,
literal|"slice1"
argument_list|)
argument_list|)
decl_stmt|;
comment|// now test that unloading a core gets us a new leader
try|try
init|(
name|HttpSolrClient
name|unloadClient
init|=
operator|new
name|HttpSolrClient
argument_list|(
name|baseUrl
argument_list|)
init|)
block|{
name|unloadClient
operator|.
name|setConnectionTimeout
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
name|unloadClient
operator|.
name|setSoTimeout
argument_list|(
literal|60000
argument_list|)
expr_stmt|;
name|Unload
name|unloadCmd
init|=
operator|new
name|Unload
argument_list|(
literal|true
argument_list|)
decl_stmt|;
name|unloadCmd
operator|.
name|setCoreName
argument_list|(
name|props
operator|.
name|getCoreName
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|leader
init|=
name|props
operator|.
name|getCoreUrl
argument_list|()
decl_stmt|;
name|unloadClient
operator|.
name|request
argument_list|(
name|unloadCmd
argument_list|)
expr_stmt|;
name|int
name|tries
init|=
literal|50
decl_stmt|;
while|while
condition|(
name|leader
operator|.
name|equals
argument_list|(
name|zkStateReader
operator|.
name|getLeaderUrl
argument_list|(
name|oneInstanceCollection2
argument_list|,
literal|"slice1"
argument_list|,
literal|10000
argument_list|)
argument_list|)
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|tries
operator|--
operator|==
literal|0
condition|)
block|{
name|fail
argument_list|(
literal|"Leader never changed"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|IOUtils
operator|.
name|close
argument_list|(
name|collectionClients
argument_list|)
expr_stmt|;
block|}
DECL|method|testSearchByCollectionName
specifier|private
name|void
name|testSearchByCollectionName
parameter_list|()
throws|throws
name|SolrServerException
throws|,
name|IOException
block|{
name|log
operator|.
name|info
argument_list|(
literal|"### STARTING testSearchByCollectionName"
argument_list|)
expr_stmt|;
name|SolrClient
name|client
init|=
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
specifier|final
name|String
name|baseUrl
init|=
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|length
argument_list|()
operator|-
name|DEFAULT_COLLECTION
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
comment|// the cores each have different names, but if we add the collection name to the url
comment|// we should get mapped to the right core
try|try
init|(
name|SolrClient
name|client1
init|=
name|createNewSolrClient
argument_list|(
name|oneInstanceCollection
argument_list|,
name|baseUrl
argument_list|)
init|)
block|{
name|SolrQuery
name|query
init|=
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
decl_stmt|;
name|long
name|oneDocs
init|=
name|client1
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|oneDocs
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testUpdateByCollectionName
specifier|private
name|void
name|testUpdateByCollectionName
parameter_list|()
throws|throws
name|SolrServerException
throws|,
name|IOException
block|{
name|log
operator|.
name|info
argument_list|(
literal|"### STARTING testUpdateByCollectionName"
argument_list|)
expr_stmt|;
name|SolrClient
name|client
init|=
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
specifier|final
name|String
name|baseUrl
init|=
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|length
argument_list|()
operator|-
name|DEFAULT_COLLECTION
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
comment|// the cores each have different names, but if we add the collection name to the url
comment|// we should get mapped to the right core
comment|// test hitting an update url
try|try
init|(
name|SolrClient
name|client1
init|=
name|createNewSolrClient
argument_list|(
name|oneInstanceCollection
argument_list|,
name|baseUrl
argument_list|)
init|)
block|{
name|client1
operator|.
name|commit
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|testANewCollectionInOneInstance
specifier|private
name|void
name|testANewCollectionInOneInstance
parameter_list|()
throws|throws
name|Exception
block|{
name|log
operator|.
name|info
argument_list|(
literal|"### STARTING testANewCollectionInOneInstance"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|SolrClient
argument_list|>
name|collectionClients
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|SolrClient
name|client
init|=
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
specifier|final
name|String
name|baseUrl
init|=
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|length
argument_list|()
operator|-
name|DEFAULT_COLLECTION
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
name|createCollection
argument_list|(
name|oneInstanceCollection
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|createCollection
argument_list|(
name|oneInstanceCollection
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|createCollection
argument_list|(
name|oneInstanceCollection
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|createCollection
argument_list|(
name|oneInstanceCollection
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
literal|4
argument_list|)
expr_stmt|;
while|while
condition|(
name|pending
operator|!=
literal|null
operator|&&
name|pending
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|Future
argument_list|<
name|Object
argument_list|>
name|future
init|=
name|completionService
operator|.
name|take
argument_list|()
decl_stmt|;
if|if
condition|(
name|future
operator|==
literal|null
condition|)
return|return;
name|pending
operator|.
name|remove
argument_list|(
name|future
argument_list|)
expr_stmt|;
block|}
name|SolrClient
name|client1
init|=
name|collectionClients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|SolrClient
name|client2
init|=
name|collectionClients
operator|.
name|get
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|SolrClient
name|client3
init|=
name|collectionClients
operator|.
name|get
argument_list|(
literal|2
argument_list|)
decl_stmt|;
name|SolrClient
name|client4
init|=
name|collectionClients
operator|.
name|get
argument_list|(
literal|3
argument_list|)
decl_stmt|;
name|waitForRecoveriesToFinish
argument_list|(
name|oneInstanceCollection
argument_list|,
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|assertAllActive
argument_list|(
name|oneInstanceCollection
argument_list|,
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
argument_list|)
expr_stmt|;
name|client2
operator|.
name|add
argument_list|(
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"1"
argument_list|)
argument_list|)
expr_stmt|;
name|client3
operator|.
name|add
argument_list|(
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"2"
argument_list|)
argument_list|)
expr_stmt|;
name|client4
operator|.
name|add
argument_list|(
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"3"
argument_list|)
argument_list|)
expr_stmt|;
name|client1
operator|.
name|commit
argument_list|()
expr_stmt|;
name|SolrQuery
name|query
init|=
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
decl_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"distrib"
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|long
name|oneDocs
init|=
name|client1
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|long
name|twoDocs
init|=
name|client2
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|long
name|threeDocs
init|=
name|client3
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|long
name|fourDocs
init|=
name|client4
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"collection"
argument_list|,
name|oneInstanceCollection
argument_list|)
expr_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"distrib"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|long
name|allDocs
init|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
comment|//    System.out.println("1:" + oneDocs);
comment|//    System.out.println("2:" + twoDocs);
comment|//    System.out.println("3:" + threeDocs);
comment|//    System.out.println("4:" + fourDocs);
comment|//    System.out.println("All Docs:" + allDocs);
name|assertEquals
argument_list|(
literal|3
argument_list|,
name|allDocs
argument_list|)
expr_stmt|;
name|IOUtils
operator|.
name|close
argument_list|(
name|collectionClients
argument_list|)
expr_stmt|;
block|}
DECL|method|createCollection
specifier|private
name|void
name|createCollection
parameter_list|(
name|String
name|collection
parameter_list|,
name|List
argument_list|<
name|SolrClient
argument_list|>
name|collectionClients
parameter_list|,
name|String
name|baseUrl
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|createSolrCore
argument_list|(
name|collection
argument_list|,
name|collectionClients
argument_list|,
name|baseUrl
argument_list|,
name|num
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
DECL|method|createSolrCore
specifier|private
name|void
name|createSolrCore
parameter_list|(
specifier|final
name|String
name|collection
parameter_list|,
name|List
argument_list|<
name|SolrClient
argument_list|>
name|collectionClients
parameter_list|,
specifier|final
name|String
name|baseUrl
parameter_list|,
specifier|final
name|int
name|num
parameter_list|,
specifier|final
name|String
name|shardId
parameter_list|)
block|{
name|Callable
name|call
init|=
operator|new
name|Callable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Object
name|call
parameter_list|()
block|{
try|try
init|(
name|HttpSolrClient
name|client
init|=
operator|new
name|HttpSolrClient
argument_list|(
name|baseUrl
argument_list|)
init|)
block|{
name|client
operator|.
name|setConnectionTimeout
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
name|Create
name|createCmd
init|=
operator|new
name|Create
argument_list|()
decl_stmt|;
name|createCmd
operator|.
name|setRoles
argument_list|(
literal|"none"
argument_list|)
expr_stmt|;
name|createCmd
operator|.
name|setCoreName
argument_list|(
name|collection
operator|+
name|num
argument_list|)
expr_stmt|;
name|createCmd
operator|.
name|setCollection
argument_list|(
name|collection
argument_list|)
expr_stmt|;
if|if
condition|(
name|random
argument_list|()
operator|.
name|nextBoolean
argument_list|()
condition|)
block|{
comment|// sometimes we use an explicit core node name
name|createCmd
operator|.
name|setCoreNodeName
argument_list|(
literal|"anode"
operator|+
name|nodeCounter
operator|.
name|incrementAndGet
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|shardId
operator|==
literal|null
condition|)
block|{
name|createCmd
operator|.
name|setNumShards
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|createCmd
operator|.
name|setDataDir
argument_list|(
name|getDataDir
argument_list|(
name|createTempDir
argument_list|(
name|collection
argument_list|)
operator|.
name|toFile
argument_list|()
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|shardId
operator|!=
literal|null
condition|)
block|{
name|createCmd
operator|.
name|setShardId
argument_list|(
name|shardId
argument_list|)
expr_stmt|;
block|}
name|client
operator|.
name|request
argument_list|(
name|createCmd
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
comment|//fail
block|}
return|return
literal|null
return|;
block|}
block|}
decl_stmt|;
name|pending
operator|.
name|add
argument_list|(
name|completionService
operator|.
name|submit
argument_list|(
name|call
argument_list|)
argument_list|)
expr_stmt|;
name|collectionClients
operator|.
name|add
argument_list|(
name|createNewSolrClient
argument_list|(
name|collection
operator|+
name|num
argument_list|,
name|baseUrl
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|testMultipleCollections
specifier|private
name|void
name|testMultipleCollections
parameter_list|()
throws|throws
name|Exception
block|{
name|log
operator|.
name|info
argument_list|(
literal|"### STARTING testMultipleCollections"
argument_list|)
expr_stmt|;
comment|// create another 2 collections and search across them
name|createNewCollection
argument_list|(
literal|"collection2"
argument_list|)
expr_stmt|;
name|createNewCollection
argument_list|(
literal|"collection3"
argument_list|)
expr_stmt|;
while|while
condition|(
name|pending
operator|!=
literal|null
operator|&&
name|pending
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|Future
argument_list|<
name|Object
argument_list|>
name|future
init|=
name|completionService
operator|.
name|take
argument_list|()
decl_stmt|;
if|if
condition|(
name|future
operator|==
literal|null
condition|)
return|return;
name|pending
operator|.
name|remove
argument_list|(
name|future
argument_list|)
expr_stmt|;
block|}
name|indexDoc
argument_list|(
literal|"collection2"
argument_list|,
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"10000000"
argument_list|)
argument_list|)
expr_stmt|;
name|indexDoc
argument_list|(
literal|"collection2"
argument_list|,
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"10000001"
argument_list|)
argument_list|)
expr_stmt|;
name|indexDoc
argument_list|(
literal|"collection2"
argument_list|,
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"10000003"
argument_list|)
argument_list|)
expr_stmt|;
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|setDefaultCollection
argument_list|(
literal|"collection2"
argument_list|)
expr_stmt|;
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|add
argument_list|(
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"10000004"
argument_list|)
argument_list|)
expr_stmt|;
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|setDefaultCollection
argument_list|(
literal|null
argument_list|)
expr_stmt|;
name|indexDoc
argument_list|(
literal|"collection3"
argument_list|,
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"20000000"
argument_list|)
argument_list|)
expr_stmt|;
name|indexDoc
argument_list|(
literal|"collection3"
argument_list|,
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"20000001"
argument_list|)
argument_list|)
expr_stmt|;
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|setDefaultCollection
argument_list|(
literal|"collection3"
argument_list|)
expr_stmt|;
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|add
argument_list|(
name|getDoc
argument_list|(
name|id
argument_list|,
literal|"10000005"
argument_list|)
argument_list|)
expr_stmt|;
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|setDefaultCollection
argument_list|(
literal|null
argument_list|)
expr_stmt|;
name|otherCollectionClients
operator|.
name|get
argument_list|(
literal|"collection2"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|commit
argument_list|()
expr_stmt|;
name|otherCollectionClients
operator|.
name|get
argument_list|(
literal|"collection3"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|commit
argument_list|()
expr_stmt|;
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|setDefaultCollection
argument_list|(
literal|"collection1"
argument_list|)
expr_stmt|;
name|long
name|collection1Docs
init|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|query
argument_list|(
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|long
name|collection2Docs
init|=
name|otherCollectionClients
operator|.
name|get
argument_list|(
literal|"collection2"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|query
argument_list|(
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"found2: "
operator|+
name|collection2Docs
argument_list|)
expr_stmt|;
name|long
name|collection3Docs
init|=
name|otherCollectionClients
operator|.
name|get
argument_list|(
literal|"collection3"
argument_list|)
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|query
argument_list|(
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"found3: "
operator|+
name|collection3Docs
argument_list|)
expr_stmt|;
name|SolrQuery
name|query
init|=
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
decl_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"collection"
argument_list|,
literal|"collection2,collection3"
argument_list|)
expr_stmt|;
name|long
name|found
init|=
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|collection2Docs
operator|+
name|collection3Docs
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|query
operator|=
operator|new
name|SolrQuery
argument_list|(
literal|"*:*"
argument_list|)
expr_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"collection"
argument_list|,
literal|"collection1,collection2,collection3"
argument_list|)
expr_stmt|;
name|found
operator|=
name|clients
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|collection1Docs
operator|+
name|collection2Docs
operator|+
name|collection3Docs
argument_list|,
name|found
argument_list|)
expr_stmt|;
comment|// try to search multiple with cloud client
name|found
operator|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|collection1Docs
operator|+
name|collection2Docs
operator|+
name|collection3Docs
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"collection"
argument_list|,
literal|"collection2,collection3"
argument_list|)
expr_stmt|;
name|found
operator|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|collection2Docs
operator|+
name|collection3Docs
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|query
operator|.
name|set
argument_list|(
literal|"collection"
argument_list|,
literal|"collection3"
argument_list|)
expr_stmt|;
name|found
operator|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|collection3Docs
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|query
operator|.
name|remove
argument_list|(
literal|"collection"
argument_list|)
expr_stmt|;
name|found
operator|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|query
argument_list|(
name|query
argument_list|)
operator|.
name|getResults
argument_list|()
operator|.
name|getNumFound
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
name|collection1Docs
argument_list|,
name|found
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|collection3Docs
argument_list|,
name|collection2Docs
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|getDoc
specifier|protected
name|SolrInputDocument
name|getDoc
parameter_list|(
name|Object
modifier|...
name|fields
parameter_list|)
throws|throws
name|Exception
block|{
name|SolrInputDocument
name|doc
init|=
operator|new
name|SolrInputDocument
argument_list|()
decl_stmt|;
name|addFields
argument_list|(
name|doc
argument_list|,
name|fields
argument_list|)
expr_stmt|;
return|return
name|doc
return|;
block|}
DECL|method|indexDoc
specifier|protected
name|void
name|indexDoc
parameter_list|(
name|String
name|collection
parameter_list|,
name|SolrInputDocument
name|doc
parameter_list|)
throws|throws
name|IOException
throws|,
name|SolrServerException
block|{
name|List
argument_list|<
name|SolrClient
argument_list|>
name|clients
init|=
name|otherCollectionClients
operator|.
name|get
argument_list|(
name|collection
argument_list|)
decl_stmt|;
name|int
name|which
init|=
operator|(
name|doc
operator|.
name|getField
argument_list|(
name|id
argument_list|)
operator|.
name|toString
argument_list|()
operator|.
name|hashCode
argument_list|()
operator|&
literal|0x7fffffff
operator|)
operator|%
name|clients
operator|.
name|size
argument_list|()
decl_stmt|;
name|SolrClient
name|client
init|=
name|clients
operator|.
name|get
argument_list|(
name|which
argument_list|)
decl_stmt|;
name|client
operator|.
name|add
argument_list|(
name|doc
argument_list|)
expr_stmt|;
block|}
DECL|method|createNewCollection
specifier|private
name|void
name|createNewCollection
parameter_list|(
specifier|final
name|String
name|collection
parameter_list|)
throws|throws
name|InterruptedException
block|{
specifier|final
name|List
argument_list|<
name|SolrClient
argument_list|>
name|collectionClients
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|otherCollectionClients
operator|.
name|put
argument_list|(
name|collection
argument_list|,
name|collectionClients
argument_list|)
expr_stmt|;
name|int
name|unique
init|=
literal|0
decl_stmt|;
for|for
control|(
specifier|final
name|SolrClient
name|client
range|:
name|clients
control|)
block|{
name|unique
operator|++
expr_stmt|;
specifier|final
name|String
name|baseUrl
init|=
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
operator|(
operator|(
name|HttpSolrClient
operator|)
name|client
operator|)
operator|.
name|getBaseURL
argument_list|()
operator|.
name|length
argument_list|()
operator|-
name|DEFAULT_COLLECTION
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
specifier|final
name|int
name|frozeUnique
init|=
name|unique
decl_stmt|;
name|Callable
name|call
init|=
operator|new
name|Callable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Object
name|call
parameter_list|()
block|{
try|try
init|(
name|HttpSolrClient
name|client
init|=
operator|new
name|HttpSolrClient
argument_list|(
name|baseUrl
argument_list|)
init|)
block|{
name|client
operator|.
name|setConnectionTimeout
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
name|client
operator|.
name|setSoTimeout
argument_list|(
literal|60000
argument_list|)
expr_stmt|;
name|Create
name|createCmd
init|=
operator|new
name|Create
argument_list|()
decl_stmt|;
name|createCmd
operator|.
name|setCoreName
argument_list|(
name|collection
argument_list|)
expr_stmt|;
name|createCmd
operator|.
name|setDataDir
argument_list|(
name|getDataDir
argument_list|(
name|createTempDir
argument_list|(
name|collection
argument_list|)
operator|.
name|toFile
argument_list|()
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|client
operator|.
name|request
argument_list|(
name|createCmd
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
comment|//fails
block|}
return|return
literal|null
return|;
block|}
block|}
decl_stmt|;
name|collectionClients
operator|.
name|add
argument_list|(
name|createNewSolrClient
argument_list|(
name|collection
argument_list|,
name|baseUrl
argument_list|)
argument_list|)
expr_stmt|;
name|pending
operator|.
name|add
argument_list|(
name|completionService
operator|.
name|submit
argument_list|(
name|call
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|pending
operator|!=
literal|null
operator|&&
name|pending
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|Future
argument_list|<
name|Object
argument_list|>
name|future
init|=
name|completionService
operator|.
name|take
argument_list|()
decl_stmt|;
if|if
condition|(
name|future
operator|==
literal|null
condition|)
return|return;
name|pending
operator|.
name|remove
argument_list|(
name|future
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|createNewSolrClient
specifier|protected
name|SolrClient
name|createNewSolrClient
parameter_list|(
name|String
name|collection
parameter_list|,
name|String
name|baseUrl
parameter_list|)
block|{
try|try
block|{
comment|// setup the server...
name|HttpSolrClient
name|client
init|=
operator|new
name|HttpSolrClient
argument_list|(
name|baseUrl
operator|+
literal|"/"
operator|+
name|collection
argument_list|)
decl_stmt|;
name|client
operator|.
name|setSoTimeout
argument_list|(
literal|120000
argument_list|)
expr_stmt|;
name|client
operator|.
name|setDefaultMaxConnectionsPerHost
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|client
operator|.
name|setMaxTotalConnections
argument_list|(
literal|100
argument_list|)
expr_stmt|;
return|return
name|client
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|ex
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
DECL|method|queryServer
specifier|protected
name|QueryResponse
name|queryServer
parameter_list|(
name|ModifiableSolrParams
name|params
parameter_list|)
throws|throws
name|SolrServerException
throws|,
name|IOException
block|{
if|if
condition|(
name|r
operator|.
name|nextBoolean
argument_list|()
condition|)
return|return
name|super
operator|.
name|queryServer
argument_list|(
name|params
argument_list|)
return|;
if|if
condition|(
name|r
operator|.
name|nextBoolean
argument_list|()
condition|)
name|params
operator|.
name|set
argument_list|(
literal|"collection"
argument_list|,
name|DEFAULT_COLLECTION
argument_list|)
expr_stmt|;
name|QueryResponse
name|rsp
init|=
name|getCommonCloudSolrClient
argument_list|()
operator|.
name|query
argument_list|(
name|params
argument_list|)
decl_stmt|;
return|return
name|rsp
return|;
block|}
annotation|@
name|Override
DECL|method|distribTearDown
specifier|public
name|void
name|distribTearDown
parameter_list|()
throws|throws
name|Exception
block|{
name|super
operator|.
name|distribTearDown
argument_list|()
expr_stmt|;
if|if
condition|(
name|otherCollectionClients
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|List
argument_list|<
name|SolrClient
argument_list|>
name|clientList
range|:
name|otherCollectionClients
operator|.
name|values
argument_list|()
control|)
block|{
name|IOUtils
operator|.
name|close
argument_list|(
name|clientList
argument_list|)
expr_stmt|;
block|}
block|}
name|otherCollectionClients
operator|=
literal|null
expr_stmt|;
name|List
argument_list|<
name|Runnable
argument_list|>
name|tasks
init|=
name|executor
operator|.
name|shutdownNow
argument_list|()
decl_stmt|;
name|assertTrue
argument_list|(
name|tasks
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_class
end_unit
