begin_unit
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_package
DECL|package|org.apache.solr.util
package|package
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
package|;
end_package
begin_import
import|import
name|java
operator|.
name|text
operator|.
name|DateFormat
import|;
end_import
begin_import
import|import
name|java
operator|.
name|text
operator|.
name|ParseException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|text
operator|.
name|SimpleDateFormat
import|;
end_import
begin_import
import|import
name|java
operator|.
name|time
operator|.
name|Instant
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Calendar
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TimeZone
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|LuceneTestCase
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|DateMathParser
operator|.
name|UTC
import|;
end_import
begin_comment
comment|/**  * Tests that the functions in DateMathParser  */
end_comment
begin_class
DECL|class|DateMathParserTest
specifier|public
class|class
name|DateMathParserTest
extends|extends
name|LuceneTestCase
block|{
comment|/**    * A formatter for specifying every last nuance of a Date for easy    * refernece in assertion statements    */
DECL|field|fmt
specifier|private
name|DateFormat
name|fmt
decl_stmt|;
comment|/**    * A parser for reading in explicit dates that are convinient to type    * in a test    */
DECL|field|parser
specifier|private
name|DateFormat
name|parser
decl_stmt|;
DECL|method|DateMathParserTest
specifier|public
name|DateMathParserTest
parameter_list|()
block|{
name|super
argument_list|()
expr_stmt|;
name|fmt
operator|=
operator|new
name|SimpleDateFormat
argument_list|(
literal|"G yyyyy MM ww WW DD dd F E aa HH hh mm ss SSS z Z"
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
expr_stmt|;
name|fmt
operator|.
name|setTimeZone
argument_list|(
name|UTC
argument_list|)
expr_stmt|;
name|parser
operator|=
operator|new
name|SimpleDateFormat
argument_list|(
literal|"yyyy-MM-dd'T'HH:mm:ss.SSS"
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
expr_stmt|;
name|parser
operator|.
name|setTimeZone
argument_list|(
name|UTC
argument_list|)
expr_stmt|;
block|}
comment|/** MACRO: Round: parses s, rounds with u, fmts */
DECL|method|r
specifier|protected
name|String
name|r
parameter_list|(
name|String
name|s
parameter_list|,
name|String
name|u
parameter_list|)
throws|throws
name|Exception
block|{
name|Date
name|d
init|=
name|parser
operator|.
name|parse
argument_list|(
name|s
argument_list|)
decl_stmt|;
name|Calendar
name|c
init|=
name|Calendar
operator|.
name|getInstance
argument_list|(
name|UTC
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
decl_stmt|;
name|c
operator|.
name|setTime
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|DateMathParser
operator|.
name|round
argument_list|(
name|c
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return
name|fmt
operator|.
name|format
argument_list|(
name|c
operator|.
name|getTime
argument_list|()
argument_list|)
return|;
block|}
comment|/** MACRO: Add: parses s, adds v u, fmts */
DECL|method|a
specifier|protected
name|String
name|a
parameter_list|(
name|String
name|s
parameter_list|,
name|int
name|v
parameter_list|,
name|String
name|u
parameter_list|)
throws|throws
name|Exception
block|{
name|Date
name|d
init|=
name|parser
operator|.
name|parse
argument_list|(
name|s
argument_list|)
decl_stmt|;
name|Calendar
name|c
init|=
name|Calendar
operator|.
name|getInstance
argument_list|(
name|UTC
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
decl_stmt|;
name|c
operator|.
name|setTime
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|DateMathParser
operator|.
name|add
argument_list|(
name|c
argument_list|,
name|v
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return
name|fmt
operator|.
name|format
argument_list|(
name|c
operator|.
name|getTime
argument_list|()
argument_list|)
return|;
block|}
comment|/** MACRO: Expected: parses s, fmts */
DECL|method|e
specifier|protected
name|String
name|e
parameter_list|(
name|String
name|s
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|fmt
operator|.
name|format
argument_list|(
name|parser
operator|.
name|parse
argument_list|(
name|s
argument_list|)
argument_list|)
return|;
block|}
DECL|method|assertRound
specifier|protected
name|void
name|assertRound
parameter_list|(
name|String
name|e
parameter_list|,
name|String
name|i
parameter_list|,
name|String
name|u
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|ee
init|=
name|e
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|String
name|rr
init|=
name|r
argument_list|(
name|i
argument_list|,
name|u
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|ee
operator|+
literal|" != "
operator|+
name|rr
operator|+
literal|" round:"
operator|+
name|i
operator|+
literal|":"
operator|+
name|u
argument_list|,
name|ee
argument_list|,
name|rr
argument_list|)
expr_stmt|;
block|}
DECL|method|assertAdd
specifier|protected
name|void
name|assertAdd
parameter_list|(
name|String
name|e
parameter_list|,
name|String
name|i
parameter_list|,
name|int
name|v
parameter_list|,
name|String
name|u
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|ee
init|=
name|e
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|String
name|aa
init|=
name|a
argument_list|(
name|i
argument_list|,
name|v
argument_list|,
name|u
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|ee
operator|+
literal|" != "
operator|+
name|aa
operator|+
literal|" add:"
operator|+
name|i
operator|+
literal|"+"
operator|+
name|v
operator|+
literal|":"
operator|+
name|u
argument_list|,
name|ee
argument_list|,
name|aa
argument_list|)
expr_stmt|;
block|}
DECL|method|assertMath
specifier|protected
name|void
name|assertMath
parameter_list|(
name|String
name|e
parameter_list|,
name|DateMathParser
name|p
parameter_list|,
name|String
name|i
parameter_list|)
throws|throws
name|Exception
block|{
name|String
name|ee
init|=
name|e
argument_list|(
name|e
argument_list|)
decl_stmt|;
name|String
name|aa
init|=
name|fmt
operator|.
name|format
argument_list|(
name|p
operator|.
name|parseMath
argument_list|(
name|i
argument_list|)
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|ee
operator|+
literal|" != "
operator|+
name|aa
operator|+
literal|" math:"
operator|+
name|parser
operator|.
name|format
argument_list|(
name|p
operator|.
name|getNow
argument_list|()
argument_list|)
operator|+
literal|":"
operator|+
name|i
argument_list|,
name|ee
argument_list|,
name|aa
argument_list|)
expr_stmt|;
block|}
DECL|method|testCalendarUnitsConsistency
specifier|public
name|void
name|testCalendarUnitsConsistency
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|input
init|=
literal|"2001-07-04T12:08:56.235"
decl_stmt|;
for|for
control|(
name|String
name|u
range|:
name|DateMathParser
operator|.
name|CALENDAR_UNITS
operator|.
name|keySet
argument_list|()
control|)
block|{
try|try
block|{
name|r
argument_list|(
name|input
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IllegalStateException
name|e
parameter_list|)
block|{
name|assertNotNull
argument_list|(
literal|"no logic for rounding: "
operator|+
name|u
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|a
argument_list|(
name|input
argument_list|,
literal|1
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IllegalStateException
name|e
parameter_list|)
block|{
name|assertNotNull
argument_list|(
literal|"no logic for rounding: "
operator|+
name|u
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|testRound
specifier|public
name|void
name|testRound
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|input
init|=
literal|"2001-07-04T12:08:56.235"
decl_stmt|;
name|assertRound
argument_list|(
literal|"2001-07-04T12:08:56.000"
argument_list|,
name|input
argument_list|,
literal|"SECOND"
argument_list|)
expr_stmt|;
name|assertRound
argument_list|(
literal|"2001-07-04T12:08:00.000"
argument_list|,
name|input
argument_list|,
literal|"MINUTE"
argument_list|)
expr_stmt|;
name|assertRound
argument_list|(
literal|"2001-07-04T12:00:00.000"
argument_list|,
name|input
argument_list|,
literal|"HOUR"
argument_list|)
expr_stmt|;
name|assertRound
argument_list|(
literal|"2001-07-04T00:00:00.000"
argument_list|,
name|input
argument_list|,
literal|"DAY"
argument_list|)
expr_stmt|;
name|assertRound
argument_list|(
literal|"2001-07-01T00:00:00.000"
argument_list|,
name|input
argument_list|,
literal|"MONTH"
argument_list|)
expr_stmt|;
name|assertRound
argument_list|(
literal|"2001-01-01T00:00:00.000"
argument_list|,
name|input
argument_list|,
literal|"YEAR"
argument_list|)
expr_stmt|;
block|}
DECL|method|testAddZero
specifier|public
name|void
name|testAddZero
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|input
init|=
literal|"2001-07-04T12:08:56.235"
decl_stmt|;
for|for
control|(
name|String
name|u
range|:
name|DateMathParser
operator|.
name|CALENDAR_UNITS
operator|.
name|keySet
argument_list|()
control|)
block|{
name|assertAdd
argument_list|(
name|input
argument_list|,
name|input
argument_list|,
literal|0
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
block|}
DECL|method|testAdd
specifier|public
name|void
name|testAdd
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|input
init|=
literal|"2001-07-04T12:08:56.235"
decl_stmt|;
name|assertAdd
argument_list|(
literal|"2001-07-04T12:08:56.236"
argument_list|,
name|input
argument_list|,
literal|1
argument_list|,
literal|"MILLISECOND"
argument_list|)
expr_stmt|;
name|assertAdd
argument_list|(
literal|"2001-07-04T12:08:57.235"
argument_list|,
name|input
argument_list|,
literal|1
argument_list|,
literal|"SECOND"
argument_list|)
expr_stmt|;
name|assertAdd
argument_list|(
literal|"2001-07-04T12:09:56.235"
argument_list|,
name|input
argument_list|,
literal|1
argument_list|,
literal|"MINUTE"
argument_list|)
expr_stmt|;
name|assertAdd
argument_list|(
literal|"2001-07-04T13:08:56.235"
argument_list|,
name|input
argument_list|,
literal|1
argument_list|,
literal|"HOUR"
argument_list|)
expr_stmt|;
name|assertAdd
argument_list|(
literal|"2001-07-05T12:08:56.235"
argument_list|,
name|input
argument_list|,
literal|1
argument_list|,
literal|"DAY"
argument_list|)
expr_stmt|;
name|assertAdd
argument_list|(
literal|"2001-08-04T12:08:56.235"
argument_list|,
name|input
argument_list|,
literal|1
argument_list|,
literal|"MONTH"
argument_list|)
expr_stmt|;
name|assertAdd
argument_list|(
literal|"2002-07-04T12:08:56.235"
argument_list|,
name|input
argument_list|,
literal|1
argument_list|,
literal|"YEAR"
argument_list|)
expr_stmt|;
block|}
DECL|method|testParseStatelessness
specifier|public
name|void
name|testParseStatelessness
parameter_list|()
throws|throws
name|Exception
block|{
name|DateMathParser
name|p
init|=
operator|new
name|DateMathParser
argument_list|(
name|UTC
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
decl_stmt|;
name|p
operator|.
name|setNow
argument_list|(
name|parser
operator|.
name|parse
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|e
init|=
name|fmt
operator|.
name|format
argument_list|(
name|p
operator|.
name|parseMath
argument_list|(
literal|""
argument_list|)
argument_list|)
decl_stmt|;
name|Date
name|trash
init|=
name|p
operator|.
name|parseMath
argument_list|(
literal|"+7YEARS"
argument_list|)
decl_stmt|;
name|trash
operator|=
name|p
operator|.
name|parseMath
argument_list|(
literal|"/MONTH"
argument_list|)
expr_stmt|;
name|trash
operator|=
name|p
operator|.
name|parseMath
argument_list|(
literal|"-5DAYS+20MINUTES"
argument_list|)
expr_stmt|;
name|Thread
operator|.
name|currentThread
argument_list|()
expr_stmt|;
name|Thread
operator|.
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|String
name|a
init|=
name|fmt
operator|.
name|format
argument_list|(
name|p
operator|.
name|parseMath
argument_list|(
literal|""
argument_list|)
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
literal|"State of DateMathParser changed"
argument_list|,
name|e
argument_list|,
name|a
argument_list|)
expr_stmt|;
block|}
DECL|method|testParseMath
specifier|public
name|void
name|testParseMath
parameter_list|()
throws|throws
name|Exception
block|{
name|DateMathParser
name|p
init|=
operator|new
name|DateMathParser
argument_list|(
name|UTC
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
decl_stmt|;
name|p
operator|.
name|setNow
argument_list|(
name|parser
operator|.
name|parse
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|)
argument_list|)
expr_stmt|;
comment|// No-Op
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|// simple round
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.000"
argument_list|,
name|p
argument_list|,
literal|"/SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:00.000"
argument_list|,
name|p
argument_list|,
literal|"/MINUTE"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T00:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-01T00:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-01-01T00:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/YEAR"
argument_list|)
expr_stmt|;
comment|// simple addition
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.236"
argument_list|,
name|p
argument_list|,
literal|"+1MILLISECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:57.235"
argument_list|,
name|p
argument_list|,
literal|"+1SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:09:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1MINUTE"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T13:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-05T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-08-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2002-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1YEAR"
argument_list|)
expr_stmt|;
comment|// simple subtraction
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.234"
argument_list|,
name|p
argument_list|,
literal|"-1MILLISECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:55.235"
argument_list|,
name|p
argument_list|,
literal|"-1SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:07:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1MINUTE"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T11:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-03T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-06-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR"
argument_list|)
expr_stmt|;
comment|// simple '+/-'
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1MILLISECOND-1MILLISECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1SECOND-1SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1MINUTE-1MINUTE"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1HOUR-1HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1DAY-1DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1MONTH-1MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1YEAR-1YEAR"
argument_list|)
expr_stmt|;
comment|// simple '-/+'
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1MILLISECOND+1MILLISECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1SECOND+1SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1MINUTE+1MINUTE"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1HOUR+1HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1DAY+1DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1MONTH+1MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1YEAR"
argument_list|)
expr_stmt|;
comment|// more complex stuff
name|assertMath
argument_list|(
literal|"2000-07-04T12:08:56.236"
argument_list|,
name|p
argument_list|,
literal|"+1MILLISECOND-1YEAR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T12:08:57.235"
argument_list|,
name|p
argument_list|,
literal|"+1SECOND-1YEAR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T12:09:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1MINUTE-1YEAR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T13:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1HOUR-1YEAR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-05T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1DAY-1YEAR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-08-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"+1MONTH-1YEAR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T12:08:56.236"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1MILLISECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T12:08:57.235"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T12:09:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1MINUTE"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T13:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-05T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-08-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-01T00:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1MILLISECOND/MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T00:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1SECOND/DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T00:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1MINUTE/DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-04T13:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1HOUR/HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-07-05T12:08:56.000"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1DAY/SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2000-08-04T12:08:56.000"
argument_list|,
name|p
argument_list|,
literal|"-1YEAR+1MONTH/SECOND"
argument_list|)
expr_stmt|;
comment|// "tricky" cases
name|p
operator|.
name|setNow
argument_list|(
name|parser
operator|.
name|parse
argument_list|(
literal|"2006-01-31T17:09:59.999"
argument_list|)
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2006-02-28T17:09:59.999"
argument_list|,
name|p
argument_list|,
literal|"+1MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2008-02-29T17:09:59.999"
argument_list|,
name|p
argument_list|,
literal|"+25MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2006-02-01T00:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/MONTH+35DAYS/MONTH"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2006-01-31T17:10:00.000"
argument_list|,
name|p
argument_list|,
literal|"+3MILLIS/MINUTE"
argument_list|)
expr_stmt|;
block|}
DECL|method|testParseMathTz
specifier|public
name|void
name|testParseMathTz
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|String
name|PLUS_TZS
init|=
literal|"America/Los_Angeles"
decl_stmt|;
specifier|final
name|String
name|NEG_TZS
init|=
literal|"Europe/Paris"
decl_stmt|;
name|assumeTrue
argument_list|(
literal|"Test requires JVM to know about about TZ: "
operator|+
name|PLUS_TZS
argument_list|,
name|TimeZoneUtils
operator|.
name|KNOWN_TIMEZONE_IDS
operator|.
name|contains
argument_list|(
name|PLUS_TZS
argument_list|)
argument_list|)
expr_stmt|;
name|assumeTrue
argument_list|(
literal|"Test requires JVM to know about about TZ: "
operator|+
name|NEG_TZS
argument_list|,
name|TimeZoneUtils
operator|.
name|KNOWN_TIMEZONE_IDS
operator|.
name|contains
argument_list|(
name|NEG_TZS
argument_list|)
argument_list|)
expr_stmt|;
comment|// US, Positive Offset with DST
name|TimeZone
name|tz
init|=
name|TimeZone
operator|.
name|getTimeZone
argument_list|(
name|PLUS_TZS
argument_list|)
decl_stmt|;
name|DateMathParser
name|p
init|=
operator|new
name|DateMathParser
argument_list|(
name|tz
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
decl_stmt|;
name|p
operator|.
name|setNow
argument_list|(
name|parser
operator|.
name|parse
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|)
argument_list|)
expr_stmt|;
comment|// No-Op
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|,
name|p
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.000"
argument_list|,
name|p
argument_list|,
literal|"/SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:00.000"
argument_list|,
name|p
argument_list|,
literal|"/MINUTE"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T07:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-01T07:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/MONTH"
argument_list|)
expr_stmt|;
comment|// no DST in jan
name|assertMath
argument_list|(
literal|"2001-01-01T08:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/YEAR"
argument_list|)
expr_stmt|;
comment|// no DST in nov 2001
name|assertMath
argument_list|(
literal|"2001-11-04T08:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"+4MONTH/DAY"
argument_list|)
expr_stmt|;
comment|// yes DST in nov 2010
name|assertMath
argument_list|(
literal|"2010-11-04T07:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"+9YEAR+4MONTH/DAY"
argument_list|)
expr_stmt|;
comment|// France, Negative Offset with DST
name|tz
operator|=
name|TimeZone
operator|.
name|getTimeZone
argument_list|(
name|NEG_TZS
argument_list|)
expr_stmt|;
name|p
operator|=
operator|new
name|DateMathParser
argument_list|(
name|tz
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
expr_stmt|;
name|p
operator|.
name|setNow
argument_list|(
name|parser
operator|.
name|parse
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|)
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:56.000"
argument_list|,
name|p
argument_list|,
literal|"/SECOND"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:08:00.000"
argument_list|,
name|p
argument_list|,
literal|"/MINUTE"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-04T12:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/HOUR"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-07-03T22:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/DAY"
argument_list|)
expr_stmt|;
name|assertMath
argument_list|(
literal|"2001-06-30T22:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/MONTH"
argument_list|)
expr_stmt|;
comment|// no DST in dec
name|assertMath
argument_list|(
literal|"2000-12-31T23:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"/YEAR"
argument_list|)
expr_stmt|;
comment|// no DST in nov
name|assertMath
argument_list|(
literal|"2001-11-03T23:00:00.000"
argument_list|,
name|p
argument_list|,
literal|"+4MONTH/DAY"
argument_list|)
expr_stmt|;
block|}
DECL|method|testParseMathExceptions
specifier|public
name|void
name|testParseMathExceptions
parameter_list|()
throws|throws
name|Exception
block|{
name|DateMathParser
name|p
init|=
operator|new
name|DateMathParser
argument_list|(
name|UTC
argument_list|,
name|Locale
operator|.
name|ROOT
argument_list|)
decl_stmt|;
name|p
operator|.
name|setNow
argument_list|(
name|parser
operator|.
name|parse
argument_list|(
literal|"2001-07-04T12:08:56.235"
argument_list|)
argument_list|)
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|Integer
argument_list|>
name|badCommands
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"/"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"+"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"-"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"/BOB"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"+SECOND"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"-2MILLI/"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|" +BOB"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"+2SECONDS "
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"/4"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|badCommands
operator|.
name|put
argument_list|(
literal|"?SECONDS"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|command
range|:
name|badCommands
operator|.
name|keySet
argument_list|()
control|)
block|{
try|try
block|{
name|Date
name|out
init|=
name|p
operator|.
name|parseMath
argument_list|(
name|command
argument_list|)
decl_stmt|;
name|fail
argument_list|(
literal|"Didn't generate SyntaxError for: "
operator|+
name|command
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ParseException
name|e
parameter_list|)
block|{
name|assertEquals
argument_list|(
literal|"Wrong pos for: "
operator|+
name|command
operator|+
literal|" => "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|badCommands
operator|.
name|get
argument_list|(
name|command
argument_list|)
operator|.
name|intValue
argument_list|()
argument_list|,
name|e
operator|.
name|getErrorOffset
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/*   PARSING / FORMATTING (without date math)  Formerly in DateFieldTest.    */
DECL|method|testFormatter
specifier|public
name|void
name|testFormatter
parameter_list|()
block|{
name|assertFormat
argument_list|(
literal|"1995-12-31T23:59:59.999Z"
argument_list|,
literal|820454399999l
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1995-12-31T23:59:59.990Z"
argument_list|,
literal|820454399990l
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1995-12-31T23:59:59.900Z"
argument_list|,
literal|820454399900l
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1995-12-31T23:59:59Z"
argument_list|,
literal|820454399000l
argument_list|)
expr_stmt|;
comment|// just after epoch
name|assertFormat
argument_list|(
literal|"1970-01-01T00:00:00.005Z"
argument_list|,
literal|5L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1970-01-01T00:00:00Z"
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1970-01-01T00:00:00.370Z"
argument_list|,
literal|370L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1970-01-01T00:00:00.900Z"
argument_list|,
literal|900L
argument_list|)
expr_stmt|;
comment|// well after epoch
name|assertFormat
argument_list|(
literal|"1999-12-31T23:59:59.005Z"
argument_list|,
literal|946684799005L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1999-12-31T23:59:59Z"
argument_list|,
literal|946684799000L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1999-12-31T23:59:59.370Z"
argument_list|,
literal|946684799370L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"1999-12-31T23:59:59.900Z"
argument_list|,
literal|946684799900L
argument_list|)
expr_stmt|;
comment|// waaaay after epoch  ('+' is required for more than 4 digits in a year)
name|assertFormat
argument_list|(
literal|"+12345-12-31T23:59:59.005Z"
argument_list|,
literal|327434918399005L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"+12345-12-31T23:59:59Z"
argument_list|,
literal|327434918399000L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"+12345-12-31T23:59:59.370Z"
argument_list|,
literal|327434918399370L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"+12345-12-31T23:59:59.900Z"
argument_list|,
literal|327434918399900L
argument_list|)
expr_stmt|;
comment|// well before epoch
name|assertFormat
argument_list|(
literal|"0299-12-31T23:59:59Z"
argument_list|,
operator|-
literal|52700112001000L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"0299-12-31T23:59:59.123Z"
argument_list|,
operator|-
literal|52700112000877L
argument_list|)
expr_stmt|;
name|assertFormat
argument_list|(
literal|"0299-12-31T23:59:59.090Z"
argument_list|,
operator|-
literal|52700112000910L
argument_list|)
expr_stmt|;
comment|// BC (negative years)
name|assertFormat
argument_list|(
literal|"-12021-12-01T02:02:02Z"
argument_list|,
name|Instant
operator|.
name|parse
argument_list|(
literal|"-12021-12-01T02:02:02Z"
argument_list|)
operator|.
name|toEpochMilli
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|assertFormat
specifier|private
name|void
name|assertFormat
parameter_list|(
specifier|final
name|String
name|expected
parameter_list|,
specifier|final
name|long
name|millis
parameter_list|)
block|{
name|assertEquals
argument_list|(
name|expected
argument_list|,
name|Instant
operator|.
name|ofEpochMilli
argument_list|(
name|millis
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Using dates in the canonical format, verify that parsing+formatting    * is an identify function    */
DECL|method|testRoundTrip
specifier|public
name|void
name|testRoundTrip
parameter_list|()
throws|throws
name|Exception
block|{
comment|// NOTE: the 2nd arg is what the round trip result looks like (may be null if same as input)
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.999666Z"
argument_list|,
literal|"1995-12-31T23:59:59.999Z"
argument_list|)
expr_stmt|;
comment|// beyond millis is truncated
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.999Z"
argument_list|,
literal|"1995-12-31T23:59:59.999Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.99Z"
argument_list|,
literal|"1995-12-31T23:59:59.990Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.9Z"
argument_list|,
literal|"1995-12-31T23:59:59.900Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59Z"
argument_list|,
literal|"1995-12-31T23:59:59Z"
argument_list|)
expr_stmt|;
comment|// here the input isn't in the canonical form, but we should be forgiving
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.990Z"
argument_list|,
literal|"1995-12-31T23:59:59.990Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.900Z"
argument_list|,
literal|"1995-12-31T23:59:59.900Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.90Z"
argument_list|,
literal|"1995-12-31T23:59:59.900Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.000Z"
argument_list|,
literal|"1995-12-31T23:59:59Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.00Z"
argument_list|,
literal|"1995-12-31T23:59:59Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.0Z"
argument_list|,
literal|"1995-12-31T23:59:59Z"
argument_list|)
expr_stmt|;
comment|// kind of kludgy, but we have other tests for the actual date math
comment|//assertParseFormatEquals("NOW/DAY", p.parseMath("/DAY").toInstant().toString());
comment|// as of Solr 1.3
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59Z/DAY"
argument_list|,
literal|"1995-12-31T00:00:00Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.123Z/DAY"
argument_list|,
literal|"1995-12-31T00:00:00Z"
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.123999Z/DAY"
argument_list|,
literal|"1995-12-31T00:00:00Z"
argument_list|)
expr_stmt|;
comment|// typical dates, various precision  (0,1,2,3 digits of millis)
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.987Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.98Z"
argument_list|,
literal|"1995-12-31T23:59:59.980Z"
argument_list|)
expr_stmt|;
comment|//add 0 ms
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.9Z"
argument_list|,
literal|"1995-12-31T23:59:59.900Z"
argument_list|)
expr_stmt|;
comment|//add 00 ms
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1976-03-06T03:06:00Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"1995-12-31T23:59:59.987654Z"
argument_list|,
literal|"1995-12-31T23:59:59.987Z"
argument_list|)
expr_stmt|;
comment|//truncate nanoseconds off
comment|// dates with atypical years
name|assertParseFormatEquals
argument_list|(
literal|"0001-01-01T01:01:01Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"+12021-12-01T03:03:03Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"0000-04-04T04:04:04Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
comment|// note: 0 AD is also known as 1 BC
comment|// dates with negative years (BC)
name|assertParseFormatEquals
argument_list|(
literal|"-0005-05-05T05:05:05Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"-2021-12-01T04:04:04Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|assertParseFormatEquals
argument_list|(
literal|"-12021-12-01T02:02:02Z"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
DECL|method|testParseLenient
specifier|public
name|void
name|testParseLenient
parameter_list|()
throws|throws
name|Exception
block|{
comment|// dates that only parse thanks to lenient mode of DateTimeFormatter
name|assertParseFormatEquals
argument_list|(
literal|"10995-12-31T23:59:59.990Z"
argument_list|,
literal|"+10995-12-31T23:59:59.990Z"
argument_list|)
expr_stmt|;
comment|// missing '+' 5 digit year
name|assertParseFormatEquals
argument_list|(
literal|"995-1-2T3:4:5Z"
argument_list|,
literal|"0995-01-02T03:04:05Z"
argument_list|)
expr_stmt|;
comment|// wasn't 0 padded
block|}
DECL|method|assertParseFormatEquals
specifier|private
name|void
name|assertParseFormatEquals
parameter_list|(
name|String
name|inputStr
parameter_list|,
name|String
name|expectedStr
parameter_list|)
block|{
if|if
condition|(
name|expectedStr
operator|==
literal|null
condition|)
block|{
name|expectedStr
operator|=
name|inputStr
expr_stmt|;
block|}
name|Date
name|inputDate
init|=
name|DateMathParser
operator|.
name|parseMath
argument_list|(
literal|null
argument_list|,
name|inputStr
argument_list|)
decl_stmt|;
name|String
name|resultStr
init|=
name|inputDate
operator|.
name|toInstant
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"d:"
operator|+
name|inputDate
operator|.
name|getTime
argument_list|()
argument_list|,
name|expectedStr
argument_list|,
name|resultStr
argument_list|)
expr_stmt|;
block|}
block|}
end_class
end_unit
