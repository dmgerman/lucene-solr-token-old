begin_unit
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_package
DECL|package|org.apache.solr.core
package|package
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|core
package|;
end_package
begin_import
import|import
name|com
operator|.
name|carrotsearch
operator|.
name|randomizedtesting
operator|.
name|rules
operator|.
name|SystemPropertiesRestoreRule
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|io
operator|.
name|FileUtils
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|lang
operator|.
name|StringUtils
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|IOUtils
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|SolrTestCaseJ4
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CoreAdminParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|admin
operator|.
name|CoreAdminHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|response
operator|.
name|SolrQueryResponse
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|BeforeClass
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Rule
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|RuleChain
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|TestRule
import|;
end_import
begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Document
import|;
end_import
begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|NamedNodeMap
import|;
end_import
begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Node
import|;
end_import
begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|NodeList
import|;
end_import
begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|parsers
operator|.
name|DocumentBuilder
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|parsers
operator|.
name|DocumentBuilderFactory
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|parsers
operator|.
name|ParserConfigurationException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import
begin_class
DECL|class|TestSolrXmlPersistence
specifier|public
class|class
name|TestSolrXmlPersistence
extends|extends
name|SolrTestCaseJ4
block|{
DECL|field|solrHomeDirectory
specifier|private
specifier|final
name|File
name|solrHomeDirectory
init|=
operator|new
name|File
argument_list|(
name|TEMP_DIR
argument_list|,
name|this
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
annotation|@
name|BeforeClass
DECL|method|beforeClass
specifier|public
specifier|static
name|void
name|beforeClass
parameter_list|()
throws|throws
name|Exception
block|{
name|initCore
argument_list|(
literal|"solrconfig-minimal.xml"
argument_list|,
literal|"schema-tiny.xml"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Rule
DECL|field|solrTestRules
specifier|public
name|TestRule
name|solrTestRules
init|=
name|RuleChain
operator|.
name|outerRule
argument_list|(
operator|new
name|SystemPropertiesRestoreRule
argument_list|()
argument_list|)
decl_stmt|;
DECL|method|init
specifier|private
name|CoreContainer
name|init
parameter_list|(
name|String
name|solrXmlString
parameter_list|,
name|String
modifier|...
name|subDirs
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|solrHomeDirectory
operator|.
name|exists
argument_list|()
condition|)
block|{
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
name|solrHomeDirectory
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|String
name|s
range|:
name|subDirs
control|)
block|{
name|copyMinConf
argument_list|(
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
name|s
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|File
name|solrXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"solr.xml"
argument_list|)
decl_stmt|;
name|FileUtils
operator|.
name|write
argument_list|(
name|solrXml
argument_list|,
name|solrXmlString
argument_list|,
name|IOUtils
operator|.
name|CHARSET_UTF_8
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|CoreContainer
name|cores
init|=
operator|new
name|CoreContainer
argument_list|(
name|solrHomeDirectory
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
decl_stmt|;
name|cores
operator|.
name|load
argument_list|(
name|solrHomeDirectory
operator|.
name|getAbsolutePath
argument_list|()
argument_list|,
name|solrXml
argument_list|)
expr_stmt|;
name|cores
operator|.
name|setPersistent
argument_list|(
literal|false
argument_list|)
expr_stmt|;
return|return
name|cores
return|;
block|}
comment|// take a solr.xml with system vars in<solr>,<cores> and<core> and<core/properties> tags that have system
comment|// variables defined. Insure that after persisting solr.xml, they're all still there as ${} syntax.
comment|// Also insure that nothing extra crept in.
annotation|@
name|Test
DECL|method|testSystemVars
specifier|public
name|void
name|testSystemVars
parameter_list|()
throws|throws
name|Exception
block|{
comment|//Set these system props in order to insure that we don't write out the values rather than the ${} syntax.
name|System
operator|.
name|setProperty
argument_list|(
literal|"solr.zkclienttimeout"
argument_list|,
literal|"93"
argument_list|)
expr_stmt|;
name|System
operator|.
name|setProperty
argument_list|(
literal|"solrconfig"
argument_list|,
literal|"solrconfig-minimal.xml"
argument_list|)
expr_stmt|;
name|System
operator|.
name|setProperty
argument_list|(
literal|"schema"
argument_list|,
literal|"schema-tiny.xml"
argument_list|)
expr_stmt|;
name|System
operator|.
name|setProperty
argument_list|(
literal|"zkHostSet"
argument_list|,
literal|"localhost:9983"
argument_list|)
expr_stmt|;
name|CoreContainer
name|cc
init|=
name|init
argument_list|(
name|SOLR_XML_LOTS_SYSVARS
argument_list|,
literal|"SystemVars1"
argument_list|,
literal|"SystemVars2"
argument_list|)
decl_stmt|;
try|try
block|{
comment|// This seems odd, but it's just a little self check to see if the comparison strings are being created correctly
name|origMatchesPersist
argument_list|(
name|cc
argument_list|,
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"solr_copy.xml"
argument_list|)
argument_list|)
expr_stmt|;
comment|// Is everything in the persisted file identical to the original?
specifier|final
name|File
name|persistXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"sysvars.solr.xml"
argument_list|)
decl_stmt|;
comment|// Side effect here is that the new file is persisted and available later.
name|origMatchesPersist
argument_list|(
name|cc
argument_list|,
name|persistXml
argument_list|)
expr_stmt|;
comment|// Is everything in the original contained in the persisted one?
name|assertXmlFile
argument_list|(
name|persistXml
argument_list|,
name|getAllNodes
argument_list|(
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"solr.xml"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cc
operator|.
name|shutdown
argument_list|()
expr_stmt|;
if|if
condition|(
name|solrHomeDirectory
operator|.
name|exists
argument_list|()
condition|)
block|{
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
name|solrHomeDirectory
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testReload
specifier|public
name|void
name|testReload
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Whether the core is transient or not can make a difference.
name|doReloadTest
argument_list|(
literal|"SystemVars2"
argument_list|)
expr_stmt|;
name|doReloadTest
argument_list|(
literal|"SystemVars1"
argument_list|)
expr_stmt|;
block|}
DECL|method|doReloadTest
specifier|private
name|void
name|doReloadTest
parameter_list|(
name|String
name|which
parameter_list|)
throws|throws
name|Exception
block|{
name|CoreContainer
name|cc
init|=
name|init
argument_list|(
name|SOLR_XML_LOTS_SYSVARS
argument_list|,
literal|"SystemVars1"
argument_list|,
literal|"SystemVars2"
argument_list|)
decl_stmt|;
try|try
block|{
specifier|final
name|CoreAdminHandler
name|admin
init|=
operator|new
name|CoreAdminHandler
argument_list|(
name|cc
argument_list|)
decl_stmt|;
name|SolrQueryResponse
name|resp
init|=
operator|new
name|SolrQueryResponse
argument_list|()
decl_stmt|;
name|admin
operator|.
name|handleRequestBody
argument_list|(
name|req
argument_list|(
name|CoreAdminParams
operator|.
name|ACTION
argument_list|,
name|CoreAdminParams
operator|.
name|CoreAdminAction
operator|.
name|RELOAD
operator|.
name|toString
argument_list|()
argument_list|,
name|CoreAdminParams
operator|.
name|CORE
argument_list|,
name|which
argument_list|)
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|assertNull
argument_list|(
literal|"Exception on reload"
argument_list|,
name|resp
operator|.
name|getException
argument_list|()
argument_list|)
expr_stmt|;
name|origMatchesPersist
argument_list|(
name|cc
argument_list|,
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"reload1.solr.xml"
argument_list|)
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cc
operator|.
name|shutdown
argument_list|()
expr_stmt|;
if|if
condition|(
name|solrHomeDirectory
operator|.
name|exists
argument_list|()
condition|)
block|{
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
name|solrHomeDirectory
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testRename
specifier|public
name|void
name|testRename
parameter_list|()
throws|throws
name|Exception
block|{
name|doTestRename
argument_list|(
literal|"SystemVars1"
argument_list|)
expr_stmt|;
name|doTestRename
argument_list|(
literal|"SystemVars2"
argument_list|)
expr_stmt|;
block|}
DECL|method|doTestRename
specifier|private
name|void
name|doTestRename
parameter_list|(
name|String
name|which
parameter_list|)
throws|throws
name|Exception
block|{
name|CoreContainer
name|cc
init|=
name|init
argument_list|(
name|SOLR_XML_LOTS_SYSVARS
argument_list|,
literal|"SystemVars1"
argument_list|,
literal|"SystemVars2"
argument_list|)
decl_stmt|;
try|try
block|{
specifier|final
name|CoreAdminHandler
name|admin
init|=
operator|new
name|CoreAdminHandler
argument_list|(
name|cc
argument_list|)
decl_stmt|;
name|SolrQueryResponse
name|resp
init|=
operator|new
name|SolrQueryResponse
argument_list|()
decl_stmt|;
name|admin
operator|.
name|handleRequestBody
argument_list|(
name|req
argument_list|(
name|CoreAdminParams
operator|.
name|ACTION
argument_list|,
name|CoreAdminParams
operator|.
name|CoreAdminAction
operator|.
name|RENAME
operator|.
name|toString
argument_list|()
argument_list|,
name|CoreAdminParams
operator|.
name|CORE
argument_list|,
name|which
argument_list|,
name|CoreAdminParams
operator|.
name|OTHER
argument_list|,
literal|"RenamedCore"
argument_list|)
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|assertNull
argument_list|(
literal|"Exception on rename"
argument_list|,
name|resp
operator|.
name|getException
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|persistXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"rename.solr.xml"
argument_list|)
decl_stmt|;
name|File
name|origXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"solr.xml"
argument_list|)
decl_stmt|;
comment|// OK, Assure that if I change everything that has been renamed with the original value for the core, it matches
comment|// the old list
name|cc
operator|.
name|persistFile
argument_list|(
name|persistXml
argument_list|)
expr_stmt|;
name|String
index|[]
name|persistList
init|=
name|getAllNodes
argument_list|(
name|persistXml
argument_list|)
decl_stmt|;
name|String
index|[]
name|expressions
init|=
operator|new
name|String
index|[
name|persistList
operator|.
name|length
index|]
decl_stmt|;
for|for
control|(
name|int
name|idx
init|=
literal|0
init|;
name|idx
operator|<
name|persistList
operator|.
name|length
condition|;
operator|++
name|idx
control|)
block|{
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
operator|.
name|replaceAll
argument_list|(
literal|"RenamedCore"
argument_list|,
name|which
argument_list|)
expr_stmt|;
block|}
name|assertXmlFile
argument_list|(
name|origXml
argument_list|,
name|expressions
argument_list|)
expr_stmt|;
comment|// Now the other way, If I replace the original name in the original XML file with "RenamedCore", does it match
comment|// what was persisted?
name|persistList
operator|=
name|getAllNodes
argument_list|(
name|origXml
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|idx
init|=
literal|0
init|;
name|idx
operator|<
name|persistList
operator|.
name|length
condition|;
operator|++
name|idx
control|)
block|{
comment|// /solr/cores/core[@name='SystemVars1' and @collection='${collection:collection1}']
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
operator|.
name|replace
argument_list|(
literal|"@name='"
operator|+
name|which
operator|+
literal|"'"
argument_list|,
literal|"@name='RenamedCore'"
argument_list|)
expr_stmt|;
block|}
name|assertXmlFile
argument_list|(
name|persistXml
argument_list|,
name|expressions
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cc
operator|.
name|shutdown
argument_list|()
expr_stmt|;
if|if
condition|(
name|solrHomeDirectory
operator|.
name|exists
argument_list|()
condition|)
block|{
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
name|solrHomeDirectory
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testSwap
specifier|public
name|void
name|testSwap
parameter_list|()
throws|throws
name|Exception
block|{
name|doTestSwap
argument_list|(
literal|"SystemVars1"
argument_list|,
literal|"SystemVars2"
argument_list|)
expr_stmt|;
name|doTestSwap
argument_list|(
literal|"SystemVars2"
argument_list|,
literal|"SystemVars1"
argument_list|)
expr_stmt|;
block|}
DECL|method|doTestSwap
specifier|private
name|void
name|doTestSwap
parameter_list|(
name|String
name|from
parameter_list|,
name|String
name|to
parameter_list|)
throws|throws
name|Exception
block|{
name|CoreContainer
name|cc
init|=
name|init
argument_list|(
name|SOLR_XML_LOTS_SYSVARS
argument_list|,
literal|"SystemVars1"
argument_list|,
literal|"SystemVars2"
argument_list|)
decl_stmt|;
try|try
block|{
specifier|final
name|CoreAdminHandler
name|admin
init|=
operator|new
name|CoreAdminHandler
argument_list|(
name|cc
argument_list|)
decl_stmt|;
name|SolrQueryResponse
name|resp
init|=
operator|new
name|SolrQueryResponse
argument_list|()
decl_stmt|;
name|admin
operator|.
name|handleRequestBody
argument_list|(
name|req
argument_list|(
name|CoreAdminParams
operator|.
name|ACTION
argument_list|,
name|CoreAdminParams
operator|.
name|CoreAdminAction
operator|.
name|SWAP
operator|.
name|toString
argument_list|()
argument_list|,
name|CoreAdminParams
operator|.
name|CORE
argument_list|,
name|from
argument_list|,
name|CoreAdminParams
operator|.
name|OTHER
argument_list|,
name|to
argument_list|)
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|assertNull
argument_list|(
literal|"Exception on swap"
argument_list|,
name|resp
operator|.
name|getException
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|persistXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"rename.solr.xml"
argument_list|)
decl_stmt|;
name|File
name|origXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"solr.xml"
argument_list|)
decl_stmt|;
name|cc
operator|.
name|persistFile
argument_list|(
name|persistXml
argument_list|)
expr_stmt|;
name|String
index|[]
name|persistList
init|=
name|getAllNodes
argument_list|(
name|persistXml
argument_list|)
decl_stmt|;
name|String
index|[]
name|expressions
init|=
operator|new
name|String
index|[
name|persistList
operator|.
name|length
index|]
decl_stmt|;
comment|// Now manually change the names back and it should match exactly to the original XML.
for|for
control|(
name|int
name|idx
init|=
literal|0
init|;
name|idx
operator|<
name|persistList
operator|.
name|length
condition|;
operator|++
name|idx
control|)
block|{
name|String
name|fromName
init|=
literal|"@name='"
operator|+
name|from
operator|+
literal|"'"
decl_stmt|;
name|String
name|toName
init|=
literal|"@name='"
operator|+
name|to
operator|+
literal|"'"
decl_stmt|;
if|if
condition|(
name|persistList
index|[
name|idx
index|]
operator|.
name|contains
argument_list|(
name|fromName
argument_list|)
condition|)
block|{
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
operator|.
name|replace
argument_list|(
name|fromName
argument_list|,
name|toName
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
operator|.
name|replace
argument_list|(
name|toName
argument_list|,
name|fromName
argument_list|)
expr_stmt|;
block|}
block|}
name|assertXmlFile
argument_list|(
name|origXml
argument_list|,
name|expressions
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cc
operator|.
name|shutdown
argument_list|()
expr_stmt|;
if|if
condition|(
name|solrHomeDirectory
operator|.
name|exists
argument_list|()
condition|)
block|{
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
name|solrHomeDirectory
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testUnloadCreate
specifier|public
name|void
name|testUnloadCreate
parameter_list|()
throws|throws
name|Exception
block|{
name|doTestUnloadCreate
argument_list|(
literal|"SystemVars1"
argument_list|)
expr_stmt|;
name|doTestUnloadCreate
argument_list|(
literal|"SystemVars2"
argument_list|)
expr_stmt|;
block|}
DECL|method|doTestUnloadCreate
specifier|private
name|void
name|doTestUnloadCreate
parameter_list|(
name|String
name|which
parameter_list|)
throws|throws
name|Exception
block|{
name|CoreContainer
name|cc
init|=
name|init
argument_list|(
name|SOLR_XML_LOTS_SYSVARS
argument_list|,
literal|"SystemVars1"
argument_list|,
literal|"SystemVars2"
argument_list|)
decl_stmt|;
try|try
block|{
specifier|final
name|CoreAdminHandler
name|admin
init|=
operator|new
name|CoreAdminHandler
argument_list|(
name|cc
argument_list|)
decl_stmt|;
name|SolrQueryResponse
name|resp
init|=
operator|new
name|SolrQueryResponse
argument_list|()
decl_stmt|;
name|admin
operator|.
name|handleRequestBody
argument_list|(
name|req
argument_list|(
name|CoreAdminParams
operator|.
name|ACTION
argument_list|,
name|CoreAdminParams
operator|.
name|CoreAdminAction
operator|.
name|UNLOAD
operator|.
name|toString
argument_list|()
argument_list|,
name|CoreAdminParams
operator|.
name|CORE
argument_list|,
name|which
argument_list|)
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|assertNull
argument_list|(
literal|"Exception on unload"
argument_list|,
name|resp
operator|.
name|getException
argument_list|()
argument_list|)
expr_stmt|;
name|origMatchesPersist
argument_list|(
name|cc
argument_list|,
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"unloadcreate1.solr.xml"
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|instPath
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
name|which
argument_list|)
operator|.
name|getAbsolutePath
argument_list|()
decl_stmt|;
name|admin
operator|.
name|handleRequestBody
argument_list|(
name|req
argument_list|(
name|CoreAdminParams
operator|.
name|ACTION
argument_list|,
name|CoreAdminParams
operator|.
name|CoreAdminAction
operator|.
name|CREATE
operator|.
name|toString
argument_list|()
argument_list|,
name|CoreAdminParams
operator|.
name|INSTANCE_DIR
argument_list|,
name|instPath
argument_list|,
name|CoreAdminParams
operator|.
name|CONFIG
argument_list|,
literal|"solrconfig-minimal.xml"
argument_list|,
name|CoreAdminParams
operator|.
name|SCHEMA
argument_list|,
literal|"schema-tiny.xml"
argument_list|,
name|CoreAdminParams
operator|.
name|NAME
argument_list|,
name|which
argument_list|)
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|assertNull
argument_list|(
literal|"Exception on create"
argument_list|,
name|resp
operator|.
name|getException
argument_list|()
argument_list|)
expr_stmt|;
name|File
name|persistXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"rename.solr.xml"
argument_list|)
decl_stmt|;
name|File
name|origXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"solr.xml"
argument_list|)
decl_stmt|;
name|cc
operator|.
name|persistFile
argument_list|(
name|persistXml
argument_list|)
expr_stmt|;
name|String
index|[]
name|persistList
init|=
name|getAllNodes
argument_list|(
name|persistXml
argument_list|)
decl_stmt|;
name|String
index|[]
name|expressions
init|=
operator|new
name|String
index|[
name|persistList
operator|.
name|length
index|]
decl_stmt|;
comment|// Now manually change the names back and it should match exactly to the original XML.
for|for
control|(
name|int
name|idx
init|=
literal|0
init|;
name|idx
operator|<
name|persistList
operator|.
name|length
condition|;
operator|++
name|idx
control|)
block|{
name|String
name|name
init|=
literal|"@name='"
operator|+
name|which
operator|+
literal|"'"
decl_stmt|;
if|if
condition|(
name|persistList
index|[
name|idx
index|]
operator|.
name|contains
argument_list|(
name|name
argument_list|)
condition|)
block|{
if|if
condition|(
name|persistList
index|[
name|idx
index|]
operator|.
name|contains
argument_list|(
literal|"@schema='schema-tiny.xml'"
argument_list|)
condition|)
block|{
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
operator|.
name|replace
argument_list|(
literal|"schema-tiny.xml"
argument_list|,
literal|"${schema:schema-tiny.xml}"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|persistList
index|[
name|idx
index|]
operator|.
name|contains
argument_list|(
literal|"@config='solrconfig-minimal.xml'"
argument_list|)
condition|)
block|{
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
operator|.
name|replace
argument_list|(
literal|"solrconfig-minimal.xml"
argument_list|,
literal|"${solrconfig:solrconfig-minimal.xml}"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|persistList
index|[
name|idx
index|]
operator|.
name|contains
argument_list|(
literal|"@instanceDir="
argument_list|)
condition|)
block|{
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
operator|.
name|replaceFirst
argument_list|(
literal|"instanceDir\\='.*?'"
argument_list|,
literal|"instanceDir='"
operator|+
name|which
operator|+
literal|"'"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|expressions
index|[
name|idx
index|]
operator|=
name|persistList
index|[
name|idx
index|]
expr_stmt|;
block|}
block|}
name|assertXmlFile
argument_list|(
name|origXml
argument_list|,
name|expressions
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cc
operator|.
name|shutdown
argument_list|()
expr_stmt|;
if|if
condition|(
name|solrHomeDirectory
operator|.
name|exists
argument_list|()
condition|)
block|{
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
name|solrHomeDirectory
argument_list|)
expr_stmt|;
block|}
block|}
block|}
DECL|method|origMatchesPersist
specifier|private
name|void
name|origMatchesPersist
parameter_list|(
name|CoreContainer
name|cc
parameter_list|,
name|File
name|persistXml
parameter_list|)
throws|throws
name|IOException
throws|,
name|SAXException
throws|,
name|ParserConfigurationException
block|{
name|cc
operator|.
name|persistFile
argument_list|(
name|persistXml
argument_list|)
expr_stmt|;
comment|// Is everything that's in the original file persisted?
name|String
index|[]
name|expressions
init|=
name|getAllNodes
argument_list|(
name|persistXml
argument_list|)
decl_stmt|;
name|assertXmlFile
argument_list|(
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"solr.xml"
argument_list|)
argument_list|,
name|expressions
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testCreatePersistCore
specifier|public
name|void
name|testCreatePersistCore
parameter_list|()
throws|throws
name|Exception
block|{
comment|// Template for creating a core.
name|CoreContainer
name|cc
init|=
name|init
argument_list|(
name|SOLR_XML_LOTS_SYSVARS
argument_list|,
literal|"SystemVars1"
argument_list|,
literal|"SystemVars2"
argument_list|,
literal|"props1"
argument_list|,
literal|"props2"
argument_list|)
decl_stmt|;
try|try
block|{
specifier|final
name|CoreAdminHandler
name|admin
init|=
operator|new
name|CoreAdminHandler
argument_list|(
name|cc
argument_list|)
decl_stmt|;
comment|// create a new core (using CoreAdminHandler) w/ properties
name|String
name|instPath1
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"props1"
argument_list|)
operator|.
name|getAbsolutePath
argument_list|()
decl_stmt|;
name|SolrQueryResponse
name|resp
init|=
operator|new
name|SolrQueryResponse
argument_list|()
decl_stmt|;
name|admin
operator|.
name|handleRequestBody
argument_list|(
name|req
argument_list|(
name|CoreAdminParams
operator|.
name|ACTION
argument_list|,
name|CoreAdminParams
operator|.
name|CoreAdminAction
operator|.
name|CREATE
operator|.
name|toString
argument_list|()
argument_list|,
name|CoreAdminParams
operator|.
name|INSTANCE_DIR
argument_list|,
name|instPath1
argument_list|,
name|CoreAdminParams
operator|.
name|NAME
argument_list|,
literal|"props1"
argument_list|,
name|CoreAdminParams
operator|.
name|TRANSIENT
argument_list|,
literal|"true"
argument_list|,
name|CoreAdminParams
operator|.
name|LOAD_ON_STARTUP
argument_list|,
literal|"true"
argument_list|,
name|CoreAdminParams
operator|.
name|PROPERTY_PREFIX
operator|+
literal|"prefix1"
argument_list|,
literal|"valuep1"
argument_list|,
name|CoreAdminParams
operator|.
name|PROPERTY_PREFIX
operator|+
literal|"prefix2"
argument_list|,
literal|"valueP2"
argument_list|,
name|CoreAdminParams
operator|.
name|CONFIG
argument_list|,
literal|"solrconfig-minimal.xml"
argument_list|,
name|CoreAdminParams
operator|.
name|SCHEMA
argument_list|,
literal|"schema-tiny.xml"
argument_list|)
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|assertNull
argument_list|(
literal|"Exception on create"
argument_list|,
name|resp
operator|.
name|getException
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|instPath2
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"props2"
argument_list|)
operator|.
name|getAbsolutePath
argument_list|()
decl_stmt|;
name|admin
operator|.
name|handleRequestBody
argument_list|(
name|req
argument_list|(
name|CoreAdminParams
operator|.
name|ACTION
argument_list|,
name|CoreAdminParams
operator|.
name|CoreAdminAction
operator|.
name|CREATE
operator|.
name|toString
argument_list|()
argument_list|,
name|CoreAdminParams
operator|.
name|INSTANCE_DIR
argument_list|,
name|instPath2
argument_list|,
name|CoreAdminParams
operator|.
name|NAME
argument_list|,
literal|"props2"
argument_list|,
name|CoreAdminParams
operator|.
name|PROPERTY_PREFIX
operator|+
literal|"prefix2_1"
argument_list|,
literal|"valuep2_1"
argument_list|,
name|CoreAdminParams
operator|.
name|PROPERTY_PREFIX
operator|+
literal|"prefix2_2"
argument_list|,
literal|"valueP2_2"
argument_list|,
name|CoreAdminParams
operator|.
name|CONFIG
argument_list|,
literal|"solrconfig-minimal.xml"
argument_list|,
name|CoreAdminParams
operator|.
name|DATA_DIR
argument_list|,
literal|"./dataDirTest"
argument_list|,
name|CoreAdminParams
operator|.
name|SCHEMA
argument_list|,
literal|"schema-tiny.xml"
argument_list|)
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|assertNull
argument_list|(
literal|"Exception on create"
argument_list|,
name|resp
operator|.
name|getException
argument_list|()
argument_list|)
expr_stmt|;
comment|// Everything that was in the original XML file should be in the persisted one.
specifier|final
name|File
name|persistXml
init|=
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"persist_create_core.solr.xml"
argument_list|)
decl_stmt|;
name|cc
operator|.
name|persistFile
argument_list|(
name|persistXml
argument_list|)
expr_stmt|;
name|String
index|[]
name|expressions
init|=
name|getAllNodes
argument_list|(
operator|new
name|File
argument_list|(
name|solrHomeDirectory
argument_list|,
literal|"solr.xml"
argument_list|)
argument_list|)
decl_stmt|;
name|assertXmlFile
argument_list|(
name|persistXml
argument_list|,
name|expressions
argument_list|)
expr_stmt|;
comment|// And the params for the new core should be in the persisted file.
name|assertXmlFile
argument_list|(
name|persistXml
argument_list|,
literal|"/solr/cores/core[@name='props1']/property[@name='prefix1' and @value='valuep1']"
argument_list|,
literal|"/solr/cores/core[@name='props1']/property[@name='prefix2' and @value='valueP2']"
argument_list|,
literal|"/solr/cores/core[@name='props1' and @config='solrconfig-minimal.xml']"
argument_list|,
literal|"/solr/cores/core[@name='props1' and @schema='schema-tiny.xml']"
argument_list|,
literal|"/solr/cores/core[@name='props1' and @transient='true']"
argument_list|,
literal|"/solr/cores/core[@name='props1' and @loadOnStartup='true']"
argument_list|,
literal|"/solr/cores/core[@name='props2']/property[@name='prefix2_1' and @value='valuep2_1']"
argument_list|,
literal|"/solr/cores/core[@name='props2']/property[@name='prefix2_2' and @value='valueP2_2']"
argument_list|,
literal|"/solr/cores/core[@name='props2' and @config='solrconfig-minimal.xml']"
argument_list|,
literal|"/solr/cores/core[@name='props2' and @schema='schema-tiny.xml']"
argument_list|,
literal|"/solr/cores/core[@name='props2' and not(@loadOnStartup)]"
argument_list|,
literal|"/solr/cores/core[@name='props2' and not(@transient)]"
argument_list|,
literal|"/solr/cores/core[@name='props2' and @dataDir='./dataDirTest']"
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|cc
operator|.
name|shutdown
argument_list|()
expr_stmt|;
if|if
condition|(
name|solrHomeDirectory
operator|.
name|exists
argument_list|()
condition|)
block|{
name|FileUtils
operator|.
name|deleteDirectory
argument_list|(
name|solrHomeDirectory
argument_list|)
expr_stmt|;
block|}
block|}
comment|// / insure that after you create a core and persist solr.xml the created core has
comment|// all expected and no extraneous values, both attribs and<property> tags.
comment|// How to create this core with sysprops?
block|}
DECL|method|getAllNodes
specifier|private
name|String
index|[]
name|getAllNodes
parameter_list|(
name|File
name|xmlFile
parameter_list|)
throws|throws
name|ParserConfigurationException
throws|,
name|IOException
throws|,
name|SAXException
block|{
name|List
argument_list|<
name|String
argument_list|>
name|expressions
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
comment|// XPATH and value for all elements in the indicated XML
name|DocumentBuilderFactory
name|docBuilderFactory
init|=
name|DocumentBuilderFactory
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|DocumentBuilder
name|docBuilder
init|=
name|docBuilderFactory
operator|.
name|newDocumentBuilder
argument_list|()
decl_stmt|;
name|Document
name|document
init|=
name|docBuilder
operator|.
name|parse
argument_list|(
name|xmlFile
argument_list|)
decl_stmt|;
name|Node
name|root
init|=
name|document
operator|.
name|getDocumentElement
argument_list|()
decl_stmt|;
name|gatherNodes
argument_list|(
name|root
argument_list|,
name|expressions
argument_list|,
literal|""
argument_list|)
expr_stmt|;
return|return
name|expressions
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|expressions
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
comment|// Note this is pretty specialized for a solr.xml file because working with the DOM is such a pain.
DECL|field|qualified
specifier|private
specifier|static
name|List
argument_list|<
name|String
argument_list|>
name|qualified
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
block|{
block|{
name|add
argument_list|(
literal|"core"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"property"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"int"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"str"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"long"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"property"
argument_list|)
expr_stmt|;
block|}
block|}
decl_stmt|;
DECL|field|addText
specifier|private
specifier|static
name|List
argument_list|<
name|String
argument_list|>
name|addText
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
block|{
block|{
name|add
argument_list|(
literal|"int"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"str"
argument_list|)
expr_stmt|;
name|add
argument_list|(
literal|"long"
argument_list|)
expr_stmt|;
block|}
block|}
decl_stmt|;
comment|// path is the path to parent node
DECL|method|gatherNodes
specifier|private
name|void
name|gatherNodes
parameter_list|(
name|Node
name|node
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|expressions
parameter_list|,
name|String
name|path
parameter_list|)
block|{
name|String
name|nodeName
init|=
name|node
operator|.
name|getNodeName
argument_list|()
decl_stmt|;
name|String
name|thisPath
init|=
name|path
operator|+
literal|"/"
operator|+
name|nodeName
decl_stmt|;
comment|//Parent[@id='1']/Children/child[@name]
comment|// Add in the xpaths for verification of any attributes.
name|NamedNodeMap
name|attrs
init|=
name|node
operator|.
name|getAttributes
argument_list|()
decl_stmt|;
name|String
name|qualifier
init|=
literal|""
decl_stmt|;
if|if
condition|(
name|attrs
operator|.
name|getLength
argument_list|()
operator|>
literal|0
condition|)
block|{
comment|// Assemble the prefix for qualifying all of the attributes with the same name
if|if
condition|(
name|qualified
operator|.
name|contains
argument_list|(
name|nodeName
argument_list|)
condition|)
block|{
name|qualifier
operator|=
literal|"@name='"
operator|+
name|node
operator|.
name|getAttributes
argument_list|()
operator|.
name|getNamedItem
argument_list|(
literal|"name"
argument_list|)
operator|.
name|getTextContent
argument_list|()
operator|+
literal|"'"
expr_stmt|;
block|}
for|for
control|(
name|int
name|idx
init|=
literal|0
init|;
name|idx
operator|<
name|attrs
operator|.
name|getLength
argument_list|()
condition|;
operator|++
name|idx
control|)
block|{
name|Node
name|attr
init|=
name|attrs
operator|.
name|item
argument_list|(
name|idx
argument_list|)
decl_stmt|;
if|if
condition|(
name|StringUtils
operator|.
name|isNotBlank
argument_list|(
name|qualifier
argument_list|)
operator|&&
literal|"name"
operator|.
name|equals
argument_list|(
name|attr
operator|.
name|getNodeName
argument_list|()
argument_list|)
condition|)
block|{
continue|continue;
comment|// Already added "name" attribute in qualifier string.
block|}
if|if
condition|(
name|StringUtils
operator|.
name|isNotBlank
argument_list|(
name|qualifier
argument_list|)
condition|)
block|{
comment|// Create [@name="stuff" and @attrib="value"] fragment
name|expressions
operator|.
name|add
argument_list|(
name|thisPath
operator|+
literal|"["
operator|+
name|qualifier
operator|+
literal|" and @"
operator|+
name|attr
operator|.
name|getNodeName
argument_list|()
operator|+
literal|"='"
operator|+
name|attr
operator|.
name|getTextContent
argument_list|()
operator|+
literal|"']"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Create [@attrib="value"] fragment
name|expressions
operator|.
name|add
argument_list|(
name|thisPath
operator|+
literal|"["
operator|+
name|qualifier
operator|+
literal|" @"
operator|+
name|attr
operator|.
name|getNodeName
argument_list|()
operator|+
literal|"='"
operator|+
name|attr
operator|.
name|getTextContent
argument_list|()
operator|+
literal|"']"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// Now add the text for special nodes
comment|// a[normalize-space(text())='somesite']
if|if
condition|(
name|addText
operator|.
name|contains
argument_list|(
name|nodeName
argument_list|)
condition|)
block|{
name|expressions
operator|.
name|add
argument_list|(
name|thisPath
operator|+
literal|"["
operator|+
name|qualifier
operator|+
literal|" and text()='"
operator|+
name|node
operator|.
name|getTextContent
argument_list|()
operator|+
literal|"']"
argument_list|)
expr_stmt|;
block|}
comment|// Now collect all the child element nodes.
name|NodeList
name|nodeList
init|=
name|node
operator|.
name|getChildNodes
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nodeList
operator|.
name|getLength
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|Node
name|currentNode
init|=
name|nodeList
operator|.
name|item
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|currentNode
operator|.
name|getNodeType
argument_list|()
operator|==
name|Node
operator|.
name|ELEMENT_NODE
condition|)
block|{
if|if
condition|(
name|StringUtils
operator|.
name|isNotBlank
argument_list|(
name|qualifier
argument_list|)
condition|)
block|{
name|gatherNodes
argument_list|(
name|currentNode
argument_list|,
name|expressions
argument_list|,
name|thisPath
operator|+
literal|"["
operator|+
name|qualifier
operator|+
literal|"]"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gatherNodes
argument_list|(
name|currentNode
argument_list|,
name|expressions
argument_list|,
name|thisPath
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
DECL|field|SOLR_XML_LOTS_SYSVARS
specifier|private
specifier|static
name|String
name|SOLR_XML_LOTS_SYSVARS
init|=
literal|"<solr persistent=\"${solr.xml.persist:false}\" coreLoadThreads=\"12\" sharedLib=\"${something:.}\">\n"
operator|+
literal|"<logging class=\"${logclass:log4j.class}\" enabled=\"{logenable:true}\">\n"
operator|+
literal|"<watcher size=\"{watchSize:13}\" threshold=\"${logThresh:54}\" />\n"
operator|+
literal|"</logging>\n"
operator|+
literal|"<shardHandlerFactory name=\"${shhandler:shardHandlerFactory}\" class=\"${handlefac:HttpShardHandlerFactory}\">\n"
operator|+
literal|"<int name=\"socketTimeout\">${socketTimeout:120000}</int> \n"
operator|+
literal|"<int name=\"connTimeout\">${connTimeout:15000}</int> \n"
operator|+
literal|"</shardHandlerFactory> \n"
operator|+
literal|"<cores adminPath=\"/admin/cores\" defaultCoreName=\"SystemVars1\" host=\"127.0.0.1\" \n"
operator|+
literal|"       hostPort=\"${hostPort:8983}\" hostContext=\"${hostContext:solr}\" \n"
operator|+
literal|"       zkClientTimeout=\"${solr.zkclienttimeout:30000}\" \n"
operator|+
literal|"       shareSchema=\"${shareSchema:false}\" distribUpdateConnTimeout=\"${distribUpdateConnTimeout:15000}\" \n"
operator|+
literal|"       distribUpdateSoTimeout=\"${distribUpdateSoTimeout:120000}\" \n"
operator|+
literal|"       leaderVoteWait=\"${leadVoteWait:32}\" managementPath=\"${manpath:/var/lib/path}\" transientCacheSize=\"${tranSize:128}\"> \n"
operator|+
literal|"<core name=\"SystemVars1\" instanceDir=\"SystemVars1\" shard=\"${shard:32}\" \n"
operator|+
literal|"          collection=\"${collection:collection1}\" config=\"${solrconfig:solrconfig-minimal.xml}\" \n"
operator|+
literal|"          schema=\"${schema:schema-tiny.xml}\" ulogDir=\"${ulog:./}\" roles=\"${myrole:boss}\" \n"
operator|+
literal|"          dataDir=\"${data:./}\" loadOnStartup=\"${onStart:true}\" transient=\"${tran:true}\" \n"
operator|+
literal|"          coreNodeName=\"${coreNode:utterlyridiculous}\" \n"
operator|+
literal|">\n"
operator|+
literal|"</core>\n"
operator|+
literal|"<core name=\"SystemVars2\" instanceDir=\"SystemVars2\" shard=\"${shard:32}\" \n"
operator|+
literal|"          collection=\"${collection:collection2}\" config=\"${solrconfig:solrconfig-minimal.xml}\" \n"
operator|+
literal|"          coreNodeName=\"${coreNodeName:}\" schema=\"${schema:schema-tiny.xml}\">\n"
operator|+
literal|"<property name=\"collection\" value=\"{collection:collection2}\"/>\n"
operator|+
literal|"<property name=\"schema\" value=\"${schema:schema-tiny.xml}\"/>\n"
operator|+
literal|"<property name=\"coreNodeName\" value=\"EricksCore\"/>\n"
operator|+
literal|"</core>\n"
operator|+
literal|"</cores>\n"
operator|+
literal|"</solr>"
decl_stmt|;
block|}
end_class
end_unit
