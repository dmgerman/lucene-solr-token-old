begin_unit
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_package
DECL|package|org.apache.solr.request
package|package
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|request
package|;
end_package
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Random
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|DocValues
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|SortedSetDocValues
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|Term
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|TermsEnum
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|BytesRef
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|SolrTestCaseJ4
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|SolrException
operator|.
name|ErrorCode
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|FacetParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|search
operator|.
name|SolrIndexSearcher
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|uninverting
operator|.
name|DocTermOrds
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|RefCounted
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|After
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|BeforeClass
import|;
end_import
begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import
begin_comment
comment|/**  *  */
end_comment
begin_class
DECL|class|TestFaceting
specifier|public
class|class
name|TestFaceting
extends|extends
name|SolrTestCaseJ4
block|{
annotation|@
name|BeforeClass
DECL|method|beforeClass
specifier|public
specifier|static
name|void
name|beforeClass
parameter_list|()
throws|throws
name|Exception
block|{
name|initCore
argument_list|(
literal|"solrconfig.xml"
argument_list|,
literal|"schema11.xml"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|setUp
specifier|public
name|void
name|setUp
parameter_list|()
throws|throws
name|Exception
block|{
name|super
operator|.
name|setUp
argument_list|()
expr_stmt|;
name|clearIndex
argument_list|()
expr_stmt|;
block|}
annotation|@
name|After
annotation|@
name|Override
DECL|method|tearDown
specifier|public
name|void
name|tearDown
parameter_list|()
throws|throws
name|Exception
block|{
name|close
argument_list|()
expr_stmt|;
name|super
operator|.
name|tearDown
argument_list|()
expr_stmt|;
block|}
DECL|method|t
name|String
name|t
parameter_list|(
name|int
name|tnum
parameter_list|)
block|{
return|return
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"%08d"
argument_list|,
name|tnum
argument_list|)
return|;
block|}
DECL|method|createIndex
name|void
name|createIndex
parameter_list|(
name|int
name|nTerms
parameter_list|)
block|{
name|assertU
argument_list|(
name|delQ
argument_list|(
literal|"*:*"
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nTerms
condition|;
name|i
operator|++
control|)
block|{
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
name|Float
operator|.
name|toString
argument_list|(
name|i
argument_list|)
argument_list|,
name|proto
operator|.
name|field
argument_list|()
argument_list|,
name|t
argument_list|(
name|i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|assertU
argument_list|(
name|optimize
argument_list|()
argument_list|)
expr_stmt|;
comment|// squeeze out any possible deleted docs
block|}
DECL|field|proto
name|Term
name|proto
init|=
operator|new
name|Term
argument_list|(
literal|"field_s"
argument_list|,
literal|""
argument_list|)
decl_stmt|;
DECL|field|req
name|SolrQueryRequest
name|req
decl_stmt|;
comment|// used to get a searcher
DECL|method|close
name|void
name|close
parameter_list|()
block|{
if|if
condition|(
name|req
operator|!=
literal|null
condition|)
name|req
operator|.
name|close
argument_list|()
expr_stmt|;
name|req
operator|=
literal|null
expr_stmt|;
block|}
DECL|method|doTermEnum
name|void
name|doTermEnum
parameter_list|(
name|int
name|size
parameter_list|)
throws|throws
name|Exception
block|{
comment|//System.out.println("doTermEnum size=" + size);
name|close
argument_list|()
expr_stmt|;
name|createIndex
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|req
operator|=
name|lrf
operator|.
name|makeRequest
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|)
expr_stmt|;
name|SortedSetDocValues
name|dv
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|req
operator|.
name|getSearcher
argument_list|()
operator|.
name|getLeafReader
argument_list|()
argument_list|,
name|proto
operator|.
name|field
argument_list|()
argument_list|)
decl_stmt|;
name|assertEquals
argument_list|(
name|size
argument_list|,
name|dv
operator|.
name|getValueCount
argument_list|()
argument_list|)
expr_stmt|;
name|TermsEnum
name|te
init|=
name|dv
operator|.
name|termsEnum
argument_list|()
decl_stmt|;
name|Random
name|r
init|=
operator|new
name|Random
argument_list|(
name|size
argument_list|)
decl_stmt|;
comment|// test seeking by term string
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|size
operator|*
literal|2
operator|+
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|int
name|rnum
init|=
name|r
operator|.
name|nextInt
argument_list|(
name|size
operator|+
literal|2
argument_list|)
decl_stmt|;
name|String
name|s
init|=
name|t
argument_list|(
name|rnum
argument_list|)
decl_stmt|;
comment|//System.out.println("s=" + s);
specifier|final
name|BytesRef
name|br
decl_stmt|;
if|if
condition|(
name|te
operator|==
literal|null
condition|)
block|{
name|br
operator|=
literal|null
expr_stmt|;
block|}
else|else
block|{
name|TermsEnum
operator|.
name|SeekStatus
name|status
init|=
name|te
operator|.
name|seekCeil
argument_list|(
operator|new
name|BytesRef
argument_list|(
name|s
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|status
operator|==
name|TermsEnum
operator|.
name|SeekStatus
operator|.
name|END
condition|)
block|{
name|br
operator|=
literal|null
expr_stmt|;
block|}
else|else
block|{
name|br
operator|=
name|te
operator|.
name|term
argument_list|()
expr_stmt|;
block|}
block|}
name|assertEquals
argument_list|(
name|br
operator|!=
literal|null
argument_list|,
name|rnum
operator|<
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rnum
operator|<
name|size
condition|)
block|{
name|assertEquals
argument_list|(
name|rnum
argument_list|,
operator|(
name|int
operator|)
name|te
operator|.
name|ord
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|s
argument_list|,
name|te
operator|.
name|term
argument_list|()
operator|.
name|utf8ToString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|// test seeking before term
if|if
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|assertEquals
argument_list|(
name|size
operator|>
literal|0
argument_list|,
name|te
operator|.
name|seekCeil
argument_list|(
operator|new
name|BytesRef
argument_list|(
literal|"000"
argument_list|)
argument_list|)
operator|!=
name|TermsEnum
operator|.
name|SeekStatus
operator|.
name|END
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|0
argument_list|,
name|te
operator|.
name|ord
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|t
argument_list|(
literal|0
argument_list|)
argument_list|,
name|te
operator|.
name|term
argument_list|()
operator|.
name|utf8ToString
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|0
condition|)
block|{
comment|// test seeking by term number
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|size
operator|*
literal|2
operator|+
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|int
name|rnum
init|=
name|r
operator|.
name|nextInt
argument_list|(
name|size
argument_list|)
decl_stmt|;
name|String
name|s
init|=
name|t
argument_list|(
name|rnum
argument_list|)
decl_stmt|;
name|te
operator|.
name|seekExact
argument_list|(
operator|(
name|long
operator|)
name|rnum
argument_list|)
expr_stmt|;
name|BytesRef
name|br
init|=
name|te
operator|.
name|term
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|br
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|rnum
argument_list|,
operator|(
name|int
operator|)
name|te
operator|.
name|ord
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|s
argument_list|,
name|te
operator|.
name|term
argument_list|()
operator|.
name|utf8ToString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testTermEnum
specifier|public
name|void
name|testTermEnum
parameter_list|()
throws|throws
name|Exception
block|{
name|doTermEnum
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|doTermEnum
argument_list|(
literal|1
argument_list|)
expr_stmt|;
specifier|final
name|int
name|DEFAULT_INDEX_INTERVAL
init|=
literal|1
operator|<<
name|DocTermOrds
operator|.
name|DEFAULT_INDEX_INTERVAL_BITS
decl_stmt|;
name|doTermEnum
argument_list|(
name|DEFAULT_INDEX_INTERVAL
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|// test boundaries around the block size
name|doTermEnum
argument_list|(
name|DEFAULT_INDEX_INTERVAL
argument_list|)
expr_stmt|;
name|doTermEnum
argument_list|(
name|DEFAULT_INDEX_INTERVAL
operator|+
literal|1
argument_list|)
expr_stmt|;
name|doTermEnum
argument_list|(
name|DEFAULT_INDEX_INTERVAL
operator|*
literal|2
operator|+
literal|2
argument_list|)
expr_stmt|;
comment|// doTermEnum(DEFAULT_INDEX_INTERVAL * 3 + 3);
block|}
annotation|@
name|Test
DECL|method|testFacets
specifier|public
name|void
name|testFacets
parameter_list|()
throws|throws
name|Exception
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
comment|// go over 4096 to test some of the buffer resizing
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|5000
condition|;
name|i
operator|++
control|)
block|{
name|sb
operator|.
name|append
argument_list|(
name|t
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"1"
argument_list|,
literal|"many_ws"
argument_list|,
name|sb
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|method
range|:
operator|new
name|String
index|[]
block|{
literal|"fc"
block|,
literal|"uif"
block|}
control|)
block|{
name|assertQ
argument_list|(
literal|"check many tokens"
argument_list|,
name|req
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.method"
argument_list|,
name|method
argument_list|,
literal|"facet.field"
argument_list|,
literal|"many_ws"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='many_ws']/int)=5000]"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|0
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|1
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|2
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|3
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|5
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4092
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4093
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4094
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4095
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4096
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4097
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4098
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4090
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4999
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|)
expr_stmt|;
block|}
comment|// add second document, check facets for items with count =2
name|sb
operator|=
operator|new
name|StringBuilder
argument_list|()
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
name|t
argument_list|(
literal|0
argument_list|)
argument_list|)
operator|.
name|append
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
name|t
argument_list|(
literal|150
argument_list|)
argument_list|)
operator|.
name|append
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
name|t
argument_list|(
literal|4999
argument_list|)
argument_list|)
operator|.
name|append
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"2"
argument_list|,
literal|"many_ws"
argument_list|,
name|sb
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|method
range|:
operator|new
name|String
index|[]
block|{
literal|"fc"
block|,
literal|"uif"
block|}
control|)
block|{
name|assertQ
argument_list|(
literal|"check many tokens"
argument_list|,
name|req
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.method"
argument_list|,
name|method
argument_list|,
literal|"facet.field"
argument_list|,
literal|"many_ws"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='many_ws']/int)=5000]"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|0
argument_list|)
operator|+
literal|"'][.='2']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|1
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|150
argument_list|)
operator|+
literal|"'][.='2']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4998
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
literal|4999
argument_list|)
operator|+
literal|"'][.='2']"
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
DECL|method|testRegularBig
specifier|public
name|void
name|testRegularBig
parameter_list|()
throws|throws
name|Exception
block|{
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
comment|// go over 4096 to test some of the buffer resizing
name|int
name|nTerms
init|=
literal|7
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nTerms
condition|;
name|i
operator|++
control|)
block|{
name|sb
operator|.
name|append
argument_list|(
name|t
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
block|}
name|int
name|i1
init|=
literal|1000000
decl_stmt|;
comment|// int iter=65536+10;
name|int
name|iter
init|=
literal|1000
decl_stmt|;
name|int
name|commitInterval
init|=
name|iter
operator|/
literal|9
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|iter
condition|;
name|i
operator|++
control|)
block|{
comment|// assertU(adoc("id", t(i), "many_ws", many_ws + t(i1+i) + " " + t(i1*2+i)));
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
name|t
argument_list|(
name|i
argument_list|)
argument_list|,
literal|"many_ws"
argument_list|,
name|t
argument_list|(
name|i1
operator|+
name|i
argument_list|)
operator|+
literal|" "
operator|+
name|t
argument_list|(
name|i1
operator|*
literal|2
operator|+
name|i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iter
operator|%
name|commitInterval
operator|==
literal|0
condition|)
block|{
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|int
name|methodSeed
init|=
name|random
argument_list|()
operator|.
name|nextInt
argument_list|(
literal|2
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|iter
condition|;
name|i
operator|+=
name|iter
operator|/
literal|10
control|)
block|{
name|assertQ
argument_list|(
literal|"check many tokens"
argument_list|,
name|req
argument_list|(
literal|"q"
argument_list|,
literal|"id:"
operator|+
name|t
argument_list|(
name|i
argument_list|)
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.method"
argument_list|,
operator|(
operator|(
name|methodSeed
operator|+
name|i
operator|)
operator|%
literal|2
operator|==
literal|0
condition|?
literal|"fc"
else|:
literal|"uif"
operator|)
argument_list|,
literal|"facet.field"
argument_list|,
literal|"many_ws"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|,
literal|"facet.mincount"
argument_list|,
literal|"1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='many_ws']/int)="
operator|+
literal|2
operator|+
literal|"]"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
name|i1
operator|+
name|i
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
name|i1
operator|*
literal|2
operator|+
name|i
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|)
expr_stmt|;
block|}
name|int
name|i
init|=
name|iter
operator|-
literal|1
decl_stmt|;
name|assertQ
argument_list|(
literal|"check many tokens"
argument_list|,
name|req
argument_list|(
literal|"q"
argument_list|,
literal|"id:"
operator|+
name|t
argument_list|(
name|i
argument_list|)
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.method"
argument_list|,
operator|(
operator|(
name|methodSeed
operator|+
name|i
operator|)
operator|%
literal|2
operator|==
literal|0
condition|?
literal|"fc"
else|:
literal|"uif"
operator|)
argument_list|,
literal|"facet.field"
argument_list|,
literal|"many_ws"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|,
literal|"facet.mincount"
argument_list|,
literal|"1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='many_ws']/int)="
operator|+
literal|2
operator|+
literal|"]"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
name|i1
operator|+
name|i
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|,
literal|"//lst[@name='many_ws']/int[@name='"
operator|+
name|t
argument_list|(
name|i1
operator|*
literal|2
operator|+
name|i
argument_list|)
operator|+
literal|"'][.='1']"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testTrieFields
specifier|public
name|void
name|testTrieFields
parameter_list|()
block|{
comment|// make sure that terms are correctly filtered even for trie fields that index several
comment|// terms for a single value
name|List
argument_list|<
name|String
argument_list|>
name|fields
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|fields
operator|.
name|add
argument_list|(
literal|"id"
argument_list|)
expr_stmt|;
name|fields
operator|.
name|add
argument_list|(
literal|"7"
argument_list|)
expr_stmt|;
specifier|final
name|String
index|[]
name|suffixes
init|=
operator|new
name|String
index|[]
block|{
literal|"ti"
block|,
literal|"tis"
block|,
literal|"tf"
block|,
literal|"tfs"
block|,
literal|"tl"
block|,
literal|"tls"
block|,
literal|"td"
block|,
literal|"tds"
block|}
decl_stmt|;
for|for
control|(
name|String
name|suffix
range|:
name|suffixes
control|)
block|{
name|fields
operator|.
name|add
argument_list|(
literal|"f_"
operator|+
name|suffix
argument_list|)
expr_stmt|;
name|fields
operator|.
name|add
argument_list|(
literal|"42"
argument_list|)
expr_stmt|;
block|}
name|assertU
argument_list|(
name|adoc
argument_list|(
name|fields
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
literal|0
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|suffix
range|:
name|suffixes
control|)
block|{
for|for
control|(
name|String
name|facetMethod
range|:
operator|new
name|String
index|[]
block|{
name|FacetParams
operator|.
name|FACET_METHOD_enum
block|,
name|FacetParams
operator|.
name|FACET_METHOD_fc
block|,
name|FacetParams
operator|.
name|FACET_METHOD_fcs
block|,
name|FacetParams
operator|.
name|FACET_METHOD_uif
block|}
control|)
block|{
for|for
control|(
name|String
name|facetSort
range|:
operator|new
name|String
index|[]
block|{
name|FacetParams
operator|.
name|FACET_SORT_COUNT
block|,
name|FacetParams
operator|.
name|FACET_SORT_INDEX
block|}
control|)
block|{
for|for
control|(
name|String
name|value
range|:
operator|new
name|String
index|[]
block|{
literal|"42"
block|,
literal|"43"
block|}
control|)
block|{
comment|// match or not
specifier|final
name|String
name|field
init|=
literal|"f_"
operator|+
name|suffix
decl_stmt|;
name|assertQ
argument_list|(
literal|"field="
operator|+
name|field
operator|+
literal|",method="
operator|+
name|facetMethod
operator|+
literal|",sort="
operator|+
name|facetSort
argument_list|,
name|req
argument_list|(
literal|"q"
argument_list|,
name|field
operator|+
literal|":"
operator|+
name|value
argument_list|,
name|FacetParams
operator|.
name|FACET
argument_list|,
literal|"true"
argument_list|,
name|FacetParams
operator|.
name|FACET_FIELD
argument_list|,
name|field
argument_list|,
name|FacetParams
operator|.
name|FACET_MINCOUNT
argument_list|,
literal|"0"
argument_list|,
name|FacetParams
operator|.
name|FACET_SORT
argument_list|,
name|facetSort
argument_list|,
name|FacetParams
operator|.
name|FACET_METHOD
argument_list|,
name|facetMethod
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='"
operator|+
name|field
operator|+
literal|"']/int)=1]"
argument_list|)
expr_stmt|;
comment|// exactly 1 facet count
block|}
block|}
block|}
block|}
block|}
annotation|@
name|Test
DECL|method|testFacetSortWithMinCount
specifier|public
name|void
name|testFacetSortWithMinCount
parameter_list|()
block|{
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"1.0"
argument_list|,
literal|"f_td"
argument_list|,
literal|"-420.126"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"2.0"
argument_list|,
literal|"f_td"
argument_list|,
literal|"-285.672"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"3.0"
argument_list|,
literal|"f_td"
argument_list|,
literal|"-1.218"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
name|assertQ
argument_list|(
name|req
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
name|FacetParams
operator|.
name|FACET
argument_list|,
literal|"true"
argument_list|,
name|FacetParams
operator|.
name|FACET_FIELD
argument_list|,
literal|"f_td"
argument_list|,
literal|"f.f_td.facet.sort"
argument_list|,
name|FacetParams
operator|.
name|FACET_SORT_INDEX
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='f_td']/int)=3]"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[1][@name='-420.126']"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[2][@name='-285.672']"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[3][@name='-1.218']"
argument_list|)
expr_stmt|;
name|assertQ
argument_list|(
name|req
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
name|FacetParams
operator|.
name|FACET
argument_list|,
literal|"true"
argument_list|,
name|FacetParams
operator|.
name|FACET_FIELD
argument_list|,
literal|"f_td"
argument_list|,
literal|"f.f_td.facet.sort"
argument_list|,
name|FacetParams
operator|.
name|FACET_SORT_INDEX
argument_list|,
name|FacetParams
operator|.
name|FACET_MINCOUNT
argument_list|,
literal|"1"
argument_list|,
name|FacetParams
operator|.
name|FACET_METHOD
argument_list|,
name|FacetParams
operator|.
name|FACET_METHOD_fc
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='f_td']/int)=3]"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[1][@name='-420.126']"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[2][@name='-285.672']"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[3][@name='-1.218']"
argument_list|)
expr_stmt|;
name|assertQ
argument_list|(
name|req
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
name|FacetParams
operator|.
name|FACET
argument_list|,
literal|"true"
argument_list|,
name|FacetParams
operator|.
name|FACET_FIELD
argument_list|,
literal|"f_td"
argument_list|,
literal|"f.f_td.facet.sort"
argument_list|,
name|FacetParams
operator|.
name|FACET_SORT_INDEX
argument_list|,
name|FacetParams
operator|.
name|FACET_MINCOUNT
argument_list|,
literal|"1"
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='f_td']/int)=3]"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[1][@name='-420.126']"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[2][@name='-285.672']"
argument_list|,
literal|"//lst[@name='facet_fields']/lst[@name='f_td']/int[3][@name='-1.218']"
argument_list|)
expr_stmt|;
block|}
DECL|method|testSimpleFacetCountsWithMultipleConfigurationsForSameField
specifier|public
name|void
name|testSimpleFacetCountsWithMultipleConfigurationsForSameField
parameter_list|()
block|{
name|clearIndex
argument_list|()
expr_stmt|;
name|String
name|fname
init|=
literal|"trait_ss"
decl_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"42"
argument_list|,
name|fname
argument_list|,
literal|"Tool"
argument_list|,
name|fname
argument_list|,
literal|"Obnoxious"
argument_list|,
literal|"name_s"
argument_list|,
literal|"Zapp Brannigan"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"43"
argument_list|,
literal|"title_s"
argument_list|,
literal|"Democratic Order of Planets"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"44"
argument_list|,
name|fname
argument_list|,
literal|"Tool"
argument_list|,
literal|"name_s"
argument_list|,
literal|"The Zapper"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"45"
argument_list|,
name|fname
argument_list|,
literal|"Chauvinist"
argument_list|,
literal|"title_s"
argument_list|,
literal|"25 star General"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"46"
argument_list|,
name|fname
argument_list|,
literal|"Obnoxious"
argument_list|,
literal|"subject_s"
argument_list|,
literal|"Defeated the pacifists of the Gandhi nebula"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
literal|"47"
argument_list|,
name|fname
argument_list|,
literal|"Pig"
argument_list|,
literal|"text_t"
argument_list|,
literal|"line up and fly directly at the enemy death cannons, clogging them with wreckage!"
argument_list|)
argument_list|)
expr_stmt|;
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|String
index|[]
name|methodParam
range|:
operator|new
name|String
index|[]
index|[]
block|{
operator|new
name|String
index|[]
block|{}
block|,
operator|new
name|String
index|[]
block|{
literal|"facet.method"
block|,
literal|"uif"
block|}
block|}
control|)
block|{
name|assertQ
argument_list|(
literal|"checking facets when one has missing=true&mincount=2 and the other has missing=false&mincount=0"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:[42 TO 47]"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.zeros"
argument_list|,
literal|"false"
argument_list|,
literal|"fq"
argument_list|,
literal|"id:[42 TO 45]"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=foo "
operator|+
literal|"facet.mincount=0 "
operator|+
literal|"facet.missing=false "
operator|+
literal|"}"
operator|+
name|fname
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=bar "
operator|+
literal|"facet.mincount=2 "
operator|+
literal|"facet.missing=true "
operator|+
literal|"}"
operator|+
name|fname
argument_list|)
argument_list|,
literal|"*[count(//doc)=4]"
argument_list|,
literal|"*[count(//lst[@name='foo']/int)=4]"
argument_list|,
literal|"*[count(//lst[@name='bar']/int)=2]"
argument_list|,
literal|"//lst[@name='foo']/int[@name='Tool'][.='2']"
argument_list|,
literal|"//lst[@name='foo']/int[@name='Obnoxious'][.='1']"
argument_list|,
literal|"//lst[@name='foo']/int[@name='Chauvinist'][.='1']"
argument_list|,
literal|"//lst[@name='foo']/int[@name='Pig'][.='0']"
argument_list|,
literal|"//lst[@name='foo']/int[@name='Tool'][.='2']"
argument_list|,
literal|"//lst[@name='bar']/int[not(@name)][.='1']"
argument_list|)
expr_stmt|;
name|assertQforUIF
argument_list|(
literal|"checking facets when one has missing=true&mincount=2 and the other has missing=false&mincount=0"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:[42 TO 47]"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.zeros"
argument_list|,
literal|"false"
argument_list|,
literal|"fq"
argument_list|,
literal|"id:[42 TO 45]"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=foo "
operator|+
literal|"facet.prefix=Too "
operator|+
literal|"}"
operator|+
name|fname
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=bar "
operator|+
literal|"facet.limit=2 "
operator|+
literal|"facet.sort=false "
operator|+
literal|"}"
operator|+
name|fname
argument_list|)
argument_list|,
literal|"*[count(//doc)=4]"
argument_list|,
literal|"*[count(//lst[@name='foo']/int)=1]"
argument_list|,
literal|"*[count(//lst[@name='bar']/int)=2]"
argument_list|,
literal|"//lst[@name='foo']/int[@name='Tool'][.='2']"
argument_list|,
literal|"//lst[@name='bar']/int[@name='Chauvinist'][.='1']"
argument_list|,
literal|"//lst[@name='bar']/int[@name='Obnoxious'][.='1']"
argument_list|)
expr_stmt|;
name|assertQ
argument_list|(
literal|"localparams in one facet variant should not affect defaults in another: facet.sort vs facet.missing"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:[42 TO 47]"
argument_list|,
literal|"rows"
argument_list|,
literal|"0"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"fq"
argument_list|,
literal|"id:[42 TO 45]"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=foo "
operator|+
literal|"facet.sort=index"
operator|+
literal|"}"
operator|+
name|fname
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=bar "
operator|+
literal|"facet.missing=true"
operator|+
literal|"}"
operator|+
name|fname
argument_list|)
comment|// foo is in index order w/o missing
argument_list|,
literal|"*[count(//lst[@name='foo']/int)=4]"
argument_list|,
literal|"//lst[@name='foo']/int[1][@name='Chauvinist'][.='1']"
argument_list|,
literal|"//lst[@name='foo']/int[2][@name='Obnoxious'][.='1']"
argument_list|,
literal|"//lst[@name='foo']/int[3][@name='Pig'][.='0']"
argument_list|,
literal|"//lst[@name='foo']/int[4][@name='Tool'][.='2']"
comment|// bar is in count order by default and includes missing
argument_list|,
literal|"*[count(//lst[@name='bar']/int)=5]"
argument_list|,
literal|"//lst[@name='bar']/int[1][@name='Tool'][.='2']"
comment|// don't assume tie breaker for slots 3& 4, behavior undefined?
argument_list|,
literal|"//lst[@name='bar']/int[4][@name='Pig'][.='0']"
argument_list|,
literal|"//lst[@name='bar']/int[5][not(@name)][.='1']"
argument_list|)
expr_stmt|;
name|assertQ
argument_list|(
literal|"localparams in one facet variant should not affect defaults in another: facet.mincount"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:[42 TO 47]"
argument_list|,
literal|"rows"
argument_list|,
literal|"0"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"fq"
argument_list|,
literal|"id:[42 TO 45]"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=foo "
operator|+
literal|"facet.mincount=2"
operator|+
literal|"}"
operator|+
name|fname
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=bar}"
operator|+
name|fname
argument_list|)
comment|// only Tool for foo
argument_list|,
literal|"*[count(//lst[@name='foo']/int)=1]"
argument_list|,
literal|"//lst[@name='foo']/int[1][@name='Tool'][.='2']"
comment|// all for bar
argument_list|,
literal|"*[count(//lst[@name='bar']/int)=4]"
argument_list|,
literal|"//lst[@name='bar']/int[1][@name='Tool'][.='2']"
comment|// don't assume tie breaker for slots 3& 4, behavior undefined?
argument_list|,
literal|"//lst[@name='bar']/int[4][@name='Pig'][.='0']"
argument_list|)
expr_stmt|;
name|assertQ
argument_list|(
literal|"localparams in one facet variant should not affect defaults in another: facet.missing"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:[42 TO 47]"
argument_list|,
literal|"rows"
argument_list|,
literal|"0"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"fq"
argument_list|,
literal|"id:[42 TO 45]"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=foo "
operator|+
literal|"facet.missing=true"
operator|+
literal|"}"
operator|+
name|fname
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=bar}"
operator|+
name|fname
argument_list|)
comment|// foo includes missing
argument_list|,
literal|"*[count(//lst[@name='foo']/int)=5]"
argument_list|,
literal|"//lst[@name='foo']/int[1][@name='Tool'][.='2']"
comment|// don't assume tie breaker for slots 3& 4, behavior undefined?
argument_list|,
literal|"//lst[@name='foo']/int[4][@name='Pig'][.='0']"
argument_list|,
literal|"//lst[@name='foo']/int[5][not(@name)][.='1']"
comment|// bar does not
argument_list|,
literal|"*[count(//lst[@name='bar']/int)=4]"
argument_list|,
literal|"//lst[@name='bar']/int[1][@name='Tool'][.='2']"
comment|// don't assume tie breaker for slots 3& 4, behavior undefined?
argument_list|,
literal|"//lst[@name='bar']/int[4][@name='Pig'][.='0']"
argument_list|)
expr_stmt|;
name|assertQforUIF
argument_list|(
literal|"checking facets when local facet.prefix param used after regular/raw field faceting"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.field"
argument_list|,
name|fname
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=foo "
operator|+
literal|"facet.prefix=T "
operator|+
literal|"}"
operator|+
name|fname
argument_list|)
argument_list|,
literal|"*[count(//doc)=6]"
argument_list|,
literal|"*[count(//lst[@name='"
operator|+
name|fname
operator|+
literal|"']/int)=4]"
argument_list|,
literal|"*[count(//lst[@name='foo']/int)=1]"
argument_list|,
literal|"//lst[@name='foo']/int[@name='Tool'][.='2']"
argument_list|)
expr_stmt|;
name|assertQforUIF
argument_list|(
literal|"checking facets when local facet.prefix param used before regular/raw field faceting"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"{!key=foo "
operator|+
literal|"facet.prefix=T "
operator|+
literal|"}"
operator|+
name|fname
argument_list|,
literal|"facet.field"
argument_list|,
name|fname
argument_list|)
argument_list|,
literal|"*[count(//doc)=6]"
argument_list|,
literal|"*[count(//lst[@name='"
operator|+
name|fname
operator|+
literal|"']/int)=4]"
argument_list|,
literal|"*[count(//lst[@name='foo']/int)=1]"
argument_list|,
literal|"//lst[@name='foo']/int[@name='Tool'][.='2']"
argument_list|)
expr_stmt|;
block|}
specifier|final
name|String
name|foo_range_facet
init|=
literal|"{!key=foo facet.range.gap=2}val_i"
decl_stmt|;
specifier|final
name|String
name|val_range_facet
init|=
literal|"val_i"
decl_stmt|;
for|for
control|(
name|boolean
name|toggle
range|:
operator|new
name|boolean
index|[]
block|{
literal|true
block|,
literal|false
block|}
control|)
block|{
name|assertQ
argument_list|(
literal|"local gap param mixed w/raw range faceting: "
operator|+
name|toggle
argument_list|,
name|req
argument_list|(
literal|"q"
argument_list|,
literal|"*:*"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"rows"
argument_list|,
literal|"0"
argument_list|,
literal|"facet.range.start"
argument_list|,
literal|"0"
argument_list|,
literal|"facet.range.end"
argument_list|,
literal|"10"
argument_list|,
literal|"facet.range.gap"
argument_list|,
literal|"1"
argument_list|,
literal|"facet.range"
argument_list|,
operator|(
name|toggle
condition|?
name|foo_range_facet
else|:
name|val_range_facet
operator|)
argument_list|,
literal|"facet.range"
argument_list|,
operator|(
name|toggle
condition|?
name|val_range_facet
else|:
name|foo_range_facet
operator|)
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='val_i']/lst[@name='counts']/int)=10]"
argument_list|,
literal|"*[count(//lst[@name='foo']/lst[@name='counts']/int)=5]"
argument_list|)
expr_stmt|;
block|}
name|clearIndex
argument_list|()
expr_stmt|;
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|assertQforUIF
specifier|private
name|void
name|assertQforUIF
parameter_list|(
name|String
name|message
parameter_list|,
name|SolrQueryRequest
name|request
parameter_list|,
name|String
modifier|...
name|tests
parameter_list|)
block|{
comment|// handle any differences for uif here, like skipping unsupported options
name|assertQ
argument_list|(
name|message
argument_list|,
name|request
argument_list|,
name|tests
argument_list|)
expr_stmt|;
block|}
DECL|method|add50ocs
specifier|private
name|void
name|add50ocs
parameter_list|()
block|{
comment|// Gimme 50 docs with 10 facet fields each
for|for
control|(
name|int
name|idx
init|=
literal|0
init|;
name|idx
operator|<
literal|50
condition|;
operator|++
name|idx
control|)
block|{
name|String
name|f0
init|=
operator|(
name|idx
operator|%
literal|2
operator|==
literal|0
operator|)
condition|?
literal|"zero_2"
else|:
literal|"zero_1"
decl_stmt|;
name|String
name|f1
init|=
operator|(
name|idx
operator|%
literal|3
operator|==
literal|0
operator|)
condition|?
literal|"one_3"
else|:
literal|"one_1"
decl_stmt|;
name|String
name|f2
init|=
operator|(
name|idx
operator|%
literal|4
operator|==
literal|0
operator|)
condition|?
literal|"two_4"
else|:
literal|"two_1"
decl_stmt|;
name|String
name|f3
init|=
operator|(
name|idx
operator|%
literal|5
operator|==
literal|0
operator|)
condition|?
literal|"three_5"
else|:
literal|"three_1"
decl_stmt|;
name|String
name|f4
init|=
operator|(
name|idx
operator|%
literal|6
operator|==
literal|0
operator|)
condition|?
literal|"four_6"
else|:
literal|"four_1"
decl_stmt|;
name|String
name|f5
init|=
operator|(
name|idx
operator|%
literal|7
operator|==
literal|0
operator|)
condition|?
literal|"five_7"
else|:
literal|"five_1"
decl_stmt|;
name|String
name|f6
init|=
operator|(
name|idx
operator|%
literal|8
operator|==
literal|0
operator|)
condition|?
literal|"six_8"
else|:
literal|"six_1"
decl_stmt|;
name|String
name|f7
init|=
operator|(
name|idx
operator|%
literal|9
operator|==
literal|0
operator|)
condition|?
literal|"seven_9"
else|:
literal|"seven_1"
decl_stmt|;
name|String
name|f8
init|=
operator|(
name|idx
operator|%
literal|10
operator|==
literal|0
operator|)
condition|?
literal|"eight_10"
else|:
literal|"eight_1"
decl_stmt|;
name|String
name|f9
init|=
operator|(
name|idx
operator|%
literal|11
operator|==
literal|0
operator|)
condition|?
literal|"nine_11"
else|:
literal|"nine_1"
decl_stmt|;
name|assertU
argument_list|(
name|adoc
argument_list|(
literal|"id"
argument_list|,
name|Integer
operator|.
name|toString
argument_list|(
name|idx
argument_list|)
argument_list|,
literal|"f0_ws"
argument_list|,
name|f0
argument_list|,
literal|"f1_ws"
argument_list|,
name|f1
argument_list|,
literal|"f2_ws"
argument_list|,
name|f2
argument_list|,
literal|"f3_ws"
argument_list|,
name|f3
argument_list|,
literal|"f4_ws"
argument_list|,
name|f4
argument_list|,
literal|"f5_ws"
argument_list|,
name|f5
argument_list|,
literal|"f6_ws"
argument_list|,
name|f6
argument_list|,
literal|"f7_ws"
argument_list|,
name|f7
argument_list|,
literal|"f8_ws"
argument_list|,
name|f8
argument_list|,
literal|"f9_ws"
argument_list|,
name|f9
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|assertU
argument_list|(
name|commit
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testThreadWait
specifier|public
name|void
name|testThreadWait
parameter_list|()
throws|throws
name|Exception
block|{
name|add50ocs
argument_list|()
expr_stmt|;
name|String
index|[]
name|methodParam
init|=
name|random
argument_list|()
operator|.
name|nextBoolean
argument_list|()
condition|?
operator|new
name|String
index|[]
block|{}
else|:
operator|new
name|String
index|[]
block|{
literal|"facet.method"
block|,
literal|"uif"
block|}
decl_stmt|;
comment|// All I really care about here is the chance to fire off a bunch of threads to the UnIninvertedField.get method
comment|// to insure that we get into/out of the lock. Again, it's not entirely deterministic, but it might catch bad
comment|// stuff occasionally...
name|assertQ
argument_list|(
literal|"check threading, more threads than fields"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:*"
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"fl"
argument_list|,
literal|"id"
argument_list|,
literal|"rows"
argument_list|,
literal|"1"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.threads"
argument_list|,
literal|"1000"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst)=10]"
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst/int)=20]"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
DECL|method|testMultiThreadedFacets
specifier|public
name|void
name|testMultiThreadedFacets
parameter_list|()
throws|throws
name|Exception
block|{
name|add50ocs
argument_list|()
expr_stmt|;
name|String
index|[]
name|methodParam
init|=
name|random
argument_list|()
operator|.
name|nextBoolean
argument_list|()
condition|?
operator|new
name|String
index|[]
block|{}
else|:
operator|new
name|String
index|[]
block|{
literal|"facet.method"
block|,
literal|"uif"
block|}
decl_stmt|;
name|assertQ
argument_list|(
literal|"check no threading, threads == 0"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:*"
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"fl"
argument_list|,
literal|"id"
argument_list|,
literal|"rows"
argument_list|,
literal|"1"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.threads"
argument_list|,
literal|"0"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst)=10]"
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst/int)=20]"
argument_list|,
literal|"//lst[@name='f0_ws']/int[@name='zero_1'][.='25']"
argument_list|,
literal|"//lst[@name='f0_ws']/int[@name='zero_2'][.='25']"
argument_list|,
literal|"//lst[@name='f1_ws']/int[@name='one_1'][.='33']"
argument_list|,
literal|"//lst[@name='f1_ws']/int[@name='one_3'][.='17']"
argument_list|,
literal|"//lst[@name='f2_ws']/int[@name='two_1'][.='37']"
argument_list|,
literal|"//lst[@name='f2_ws']/int[@name='two_4'][.='13']"
argument_list|,
literal|"//lst[@name='f3_ws']/int[@name='three_1'][.='40']"
argument_list|,
literal|"//lst[@name='f3_ws']/int[@name='three_5'][.='10']"
argument_list|,
literal|"//lst[@name='f4_ws']/int[@name='four_1'][.='41']"
argument_list|,
literal|"//lst[@name='f4_ws']/int[@name='four_6'][.='9']"
argument_list|,
literal|"//lst[@name='f5_ws']/int[@name='five_1'][.='42']"
argument_list|,
literal|"//lst[@name='f5_ws']/int[@name='five_7'][.='8']"
argument_list|,
literal|"//lst[@name='f6_ws']/int[@name='six_1'][.='43']"
argument_list|,
literal|"//lst[@name='f6_ws']/int[@name='six_8'][.='7']"
argument_list|,
literal|"//lst[@name='f7_ws']/int[@name='seven_1'][.='44']"
argument_list|,
literal|"//lst[@name='f7_ws']/int[@name='seven_9'][.='6']"
argument_list|,
literal|"//lst[@name='f8_ws']/int[@name='eight_1'][.='45']"
argument_list|,
literal|"//lst[@name='f8_ws']/int[@name='eight_10'][.='5']"
argument_list|,
literal|"//lst[@name='f9_ws']/int[@name='nine_1'][.='45']"
argument_list|,
literal|"//lst[@name='f9_ws']/int[@name='nine_11'][.='5']"
argument_list|)
expr_stmt|;
name|RefCounted
argument_list|<
name|SolrIndexSearcher
argument_list|>
name|currentSearcherRef
init|=
name|h
operator|.
name|getCore
argument_list|()
operator|.
name|getSearcher
argument_list|()
decl_stmt|;
try|try
block|{
name|SolrIndexSearcher
name|currentSearcher
init|=
name|currentSearcherRef
operator|.
name|get
argument_list|()
decl_stmt|;
name|SortedSetDocValues
name|ui0
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f0_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui1
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f1_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui2
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f2_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui3
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f3_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui4
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f4_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui5
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f5_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui6
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f6_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui7
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f7_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui8
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f8_ws"
argument_list|)
decl_stmt|;
name|SortedSetDocValues
name|ui9
init|=
name|DocValues
operator|.
name|getSortedSet
argument_list|(
name|currentSearcher
operator|.
name|getLeafReader
argument_list|()
argument_list|,
literal|"f9_ws"
argument_list|)
decl_stmt|;
name|assertQ
argument_list|(
literal|"check threading, more threads than fields"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:*"
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"fl"
argument_list|,
literal|"id"
argument_list|,
literal|"rows"
argument_list|,
literal|"1"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.threads"
argument_list|,
literal|"1000"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst)=10]"
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst/int)=20]"
argument_list|,
literal|"//lst[@name='f0_ws']/int[@name='zero_1'][.='25']"
argument_list|,
literal|"//lst[@name='f0_ws']/int[@name='zero_2'][.='25']"
argument_list|,
literal|"//lst[@name='f1_ws']/int[@name='one_1'][.='33']"
argument_list|,
literal|"//lst[@name='f1_ws']/int[@name='one_3'][.='17']"
argument_list|,
literal|"//lst[@name='f2_ws']/int[@name='two_1'][.='37']"
argument_list|,
literal|"//lst[@name='f2_ws']/int[@name='two_4'][.='13']"
argument_list|,
literal|"//lst[@name='f3_ws']/int[@name='three_1'][.='40']"
argument_list|,
literal|"//lst[@name='f3_ws']/int[@name='three_5'][.='10']"
argument_list|,
literal|"//lst[@name='f4_ws']/int[@name='four_1'][.='41']"
argument_list|,
literal|"//lst[@name='f4_ws']/int[@name='four_6'][.='9']"
argument_list|,
literal|"//lst[@name='f5_ws']/int[@name='five_1'][.='42']"
argument_list|,
literal|"//lst[@name='f5_ws']/int[@name='five_7'][.='8']"
argument_list|,
literal|"//lst[@name='f6_ws']/int[@name='six_1'][.='43']"
argument_list|,
literal|"//lst[@name='f6_ws']/int[@name='six_8'][.='7']"
argument_list|,
literal|"//lst[@name='f7_ws']/int[@name='seven_1'][.='44']"
argument_list|,
literal|"//lst[@name='f7_ws']/int[@name='seven_9'][.='6']"
argument_list|,
literal|"//lst[@name='f8_ws']/int[@name='eight_1'][.='45']"
argument_list|,
literal|"//lst[@name='f8_ws']/int[@name='eight_10'][.='5']"
argument_list|,
literal|"//lst[@name='f9_ws']/int[@name='nine_1'][.='45']"
argument_list|,
literal|"//lst[@name='f9_ws']/int[@name='nine_11'][.='5']"
argument_list|)
expr_stmt|;
name|assertQ
argument_list|(
literal|"check threading, fewer threads than fields"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:*"
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"fl"
argument_list|,
literal|"id"
argument_list|,
literal|"rows"
argument_list|,
literal|"1"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.threads"
argument_list|,
literal|"3"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst)=10]"
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst/int)=20]"
argument_list|,
literal|"//lst[@name='f0_ws']/int[@name='zero_1'][.='25']"
argument_list|,
literal|"//lst[@name='f0_ws']/int[@name='zero_2'][.='25']"
argument_list|,
literal|"//lst[@name='f1_ws']/int[@name='one_1'][.='33']"
argument_list|,
literal|"//lst[@name='f1_ws']/int[@name='one_3'][.='17']"
argument_list|,
literal|"//lst[@name='f2_ws']/int[@name='two_1'][.='37']"
argument_list|,
literal|"//lst[@name='f2_ws']/int[@name='two_4'][.='13']"
argument_list|,
literal|"//lst[@name='f3_ws']/int[@name='three_1'][.='40']"
argument_list|,
literal|"//lst[@name='f3_ws']/int[@name='three_5'][.='10']"
argument_list|,
literal|"//lst[@name='f4_ws']/int[@name='four_1'][.='41']"
argument_list|,
literal|"//lst[@name='f4_ws']/int[@name='four_6'][.='9']"
argument_list|,
literal|"//lst[@name='f5_ws']/int[@name='five_1'][.='42']"
argument_list|,
literal|"//lst[@name='f5_ws']/int[@name='five_7'][.='8']"
argument_list|,
literal|"//lst[@name='f6_ws']/int[@name='six_1'][.='43']"
argument_list|,
literal|"//lst[@name='f6_ws']/int[@name='six_8'][.='7']"
argument_list|,
literal|"//lst[@name='f7_ws']/int[@name='seven_1'][.='44']"
argument_list|,
literal|"//lst[@name='f7_ws']/int[@name='seven_9'][.='6']"
argument_list|,
literal|"//lst[@name='f8_ws']/int[@name='eight_1'][.='45']"
argument_list|,
literal|"//lst[@name='f8_ws']/int[@name='eight_10'][.='5']"
argument_list|,
literal|"//lst[@name='f9_ws']/int[@name='nine_1'][.='45']"
argument_list|,
literal|"//lst[@name='f9_ws']/int[@name='nine_11'][.='5']"
argument_list|)
expr_stmt|;
comment|// After this all, the uninverted fields should be exactly the same as they were the first time, even if we
comment|// blast a whole bunch of identical fields at the facet code.
comment|// The way fetching the uninverted field is written, all this is really testing is if the cache is working.
comment|// It's NOT testing whether the pending/sleep is actually functioning, I had to do that by hand since I don't
comment|// see how to make sure that uninverting the field multiple times actually happens to hit the wait state.
name|assertQ
argument_list|(
literal|"check threading, more threads than fields"
argument_list|,
name|req
argument_list|(
name|methodParam
argument_list|,
literal|"q"
argument_list|,
literal|"id:*"
argument_list|,
literal|"indent"
argument_list|,
literal|"true"
argument_list|,
literal|"fl"
argument_list|,
literal|"id"
argument_list|,
literal|"rows"
argument_list|,
literal|"1"
argument_list|,
literal|"facet"
argument_list|,
literal|"true"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f0_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f1_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f2_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f3_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f4_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f5_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f6_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f7_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f8_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.field"
argument_list|,
literal|"f9_ws"
argument_list|,
literal|"facet.threads"
argument_list|,
literal|"1000"
argument_list|,
literal|"facet.limit"
argument_list|,
literal|"-1"
argument_list|)
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst)=10]"
argument_list|,
literal|"*[count(//lst[@name='facet_fields']/lst/int)=20]"
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|currentSearcherRef
operator|.
name|decref
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_class
end_unit
