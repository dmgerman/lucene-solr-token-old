begin_unit
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_package
DECL|package|org.apache.solr.core
package|package
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|core
package|;
end_package
begin_import
import|import static
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Preconditions
operator|.
name|checkNotNull
import|;
end_import
begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|Collections
operator|.
name|EMPTY_MAP
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
operator|.
name|AUTHC_PATH
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
operator|.
name|AUTHZ_PATH
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
operator|.
name|COLLECTIONS_HANDLER_PATH
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
operator|.
name|CONFIGSETS_HANDLER_PATH
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
operator|.
name|CORES_HANDLER_PATH
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
operator|.
name|INFO_HANDLER_PATH
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|CommonParams
operator|.
name|ZK_PATH
import|;
end_import
begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|security
operator|.
name|AuthenticationPlugin
operator|.
name|AUTHENTICATION_PLUGIN_PROP
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|invoke
operator|.
name|MethodHandles
import|;
end_import
begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Path
import|;
end_import
begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|file
operator|.
name|Paths
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Properties
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Callable
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentHashMap
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutionException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutorService
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Future
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|http
operator|.
name|auth
operator|.
name|AuthSchemeProvider
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|http
operator|.
name|client
operator|.
name|CredentialsProvider
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|http
operator|.
name|config
operator|.
name|Lookup
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|impl
operator|.
name|HttpClientUtil
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|impl
operator|.
name|SolrHttpClientBuilder
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|impl
operator|.
name|SolrHttpClientContextBuilder
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|impl
operator|.
name|SolrHttpClientContextBuilder
operator|.
name|AuthSchemeRegistryProvider
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|impl
operator|.
name|SolrHttpClientContextBuilder
operator|.
name|CredentialsProviderProvider
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|client
operator|.
name|solrj
operator|.
name|util
operator|.
name|SolrIdentifierValidator
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|cloud
operator|.
name|Overseer
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|cloud
operator|.
name|ZkController
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|SolrException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|SolrException
operator|.
name|ErrorCode
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|cloud
operator|.
name|ZkStateReader
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|ExecutorUtil
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|IOUtils
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|Utils
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|RequestHandlerBase
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|admin
operator|.
name|CollectionsHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|admin
operator|.
name|ConfigSetsHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|admin
operator|.
name|CoreAdminHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|admin
operator|.
name|InfoHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|admin
operator|.
name|SecurityConfHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|admin
operator|.
name|ZookeeperInfoHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|component
operator|.
name|ShardHandlerFactory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|logging
operator|.
name|LogWatcher
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|logging
operator|.
name|MDCLoggingContext
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|request
operator|.
name|SolrRequestHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|security
operator|.
name|AuthenticationPlugin
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|security
operator|.
name|AuthorizationPlugin
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|security
operator|.
name|HttpClientBuilderPlugin
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|security
operator|.
name|PKIAuthenticationPlugin
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|security
operator|.
name|SecurityPluginHolder
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|update
operator|.
name|SolrCoreState
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|update
operator|.
name|UpdateShardHandler
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|DefaultSolrThreadFactory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|KeeperException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import
begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableMap
import|;
end_import
begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Maps
import|;
end_import
begin_comment
comment|/**  *  * @since solr 1.3  */
end_comment
begin_class
DECL|class|CoreContainer
specifier|public
class|class
name|CoreContainer
block|{
DECL|field|log
specifier|private
specifier|static
specifier|final
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|MethodHandles
operator|.
name|lookup
argument_list|()
operator|.
name|lookupClass
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|solrCores
specifier|final
name|SolrCores
name|solrCores
init|=
operator|new
name|SolrCores
argument_list|(
name|this
argument_list|)
decl_stmt|;
DECL|class|CoreLoadFailure
specifier|public
specifier|static
class|class
name|CoreLoadFailure
block|{
DECL|field|cd
specifier|public
specifier|final
name|CoreDescriptor
name|cd
decl_stmt|;
DECL|field|exception
specifier|public
specifier|final
name|Exception
name|exception
decl_stmt|;
DECL|method|CoreLoadFailure
specifier|public
name|CoreLoadFailure
parameter_list|(
name|CoreDescriptor
name|cd
parameter_list|,
name|Exception
name|loadFailure
parameter_list|)
block|{
name|this
operator|.
name|cd
operator|=
name|cd
expr_stmt|;
name|this
operator|.
name|exception
operator|=
name|loadFailure
expr_stmt|;
block|}
block|}
DECL|field|coreInitFailures
specifier|protected
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|CoreLoadFailure
argument_list|>
name|coreInitFailures
init|=
operator|new
name|ConcurrentHashMap
argument_list|<>
argument_list|()
decl_stmt|;
DECL|field|coreAdminHandler
specifier|protected
name|CoreAdminHandler
name|coreAdminHandler
init|=
literal|null
decl_stmt|;
DECL|field|collectionsHandler
specifier|protected
name|CollectionsHandler
name|collectionsHandler
init|=
literal|null
decl_stmt|;
DECL|field|infoHandler
specifier|private
name|InfoHandler
name|infoHandler
decl_stmt|;
DECL|field|configSetsHandler
specifier|protected
name|ConfigSetsHandler
name|configSetsHandler
init|=
literal|null
decl_stmt|;
DECL|field|pkiAuthenticationPlugin
specifier|private
name|PKIAuthenticationPlugin
name|pkiAuthenticationPlugin
decl_stmt|;
DECL|field|containerProperties
specifier|protected
name|Properties
name|containerProperties
decl_stmt|;
DECL|field|coreConfigService
specifier|private
name|ConfigSetService
name|coreConfigService
decl_stmt|;
DECL|field|zkSys
specifier|protected
name|ZkContainer
name|zkSys
init|=
operator|new
name|ZkContainer
argument_list|()
decl_stmt|;
DECL|field|shardHandlerFactory
specifier|protected
name|ShardHandlerFactory
name|shardHandlerFactory
decl_stmt|;
DECL|field|updateShardHandler
specifier|private
name|UpdateShardHandler
name|updateShardHandler
decl_stmt|;
DECL|field|coreContainerWorkExecutor
specifier|private
name|ExecutorService
name|coreContainerWorkExecutor
init|=
name|ExecutorUtil
operator|.
name|newMDCAwareCachedThreadPool
argument_list|(
operator|new
name|DefaultSolrThreadFactory
argument_list|(
literal|"coreContainerWorkExecutor"
argument_list|)
argument_list|)
decl_stmt|;
DECL|field|logging
specifier|protected
name|LogWatcher
name|logging
init|=
literal|null
decl_stmt|;
DECL|field|backgroundCloser
specifier|private
name|CloserThread
name|backgroundCloser
init|=
literal|null
decl_stmt|;
DECL|field|cfg
specifier|protected
specifier|final
name|NodeConfig
name|cfg
decl_stmt|;
DECL|field|loader
specifier|protected
specifier|final
name|SolrResourceLoader
name|loader
decl_stmt|;
DECL|field|solrHome
specifier|protected
specifier|final
name|String
name|solrHome
decl_stmt|;
DECL|field|coresLocator
specifier|protected
specifier|final
name|CoresLocator
name|coresLocator
decl_stmt|;
DECL|field|hostName
specifier|private
name|String
name|hostName
decl_stmt|;
DECL|field|blobRepository
specifier|private
specifier|final
name|BlobRepository
name|blobRepository
init|=
operator|new
name|BlobRepository
argument_list|(
name|this
argument_list|)
decl_stmt|;
DECL|field|containerHandlers
specifier|private
name|PluginBag
argument_list|<
name|SolrRequestHandler
argument_list|>
name|containerHandlers
init|=
operator|new
name|PluginBag
argument_list|<>
argument_list|(
name|SolrRequestHandler
operator|.
name|class
argument_list|,
literal|null
argument_list|)
decl_stmt|;
DECL|field|asyncSolrCoreLoad
specifier|private
name|boolean
name|asyncSolrCoreLoad
decl_stmt|;
DECL|field|securityConfHandler
specifier|protected
name|SecurityConfHandler
name|securityConfHandler
decl_stmt|;
DECL|field|authorizationPlugin
specifier|private
name|SecurityPluginHolder
argument_list|<
name|AuthorizationPlugin
argument_list|>
name|authorizationPlugin
decl_stmt|;
DECL|field|authenticationPlugin
specifier|private
name|SecurityPluginHolder
argument_list|<
name|AuthenticationPlugin
argument_list|>
name|authenticationPlugin
decl_stmt|;
DECL|method|getCoreZkRegisterExecutorService
specifier|public
name|ExecutorService
name|getCoreZkRegisterExecutorService
parameter_list|()
block|{
return|return
name|zkSys
operator|.
name|getCoreZkRegisterExecutorService
argument_list|()
return|;
block|}
DECL|method|getRequestHandler
specifier|public
name|SolrRequestHandler
name|getRequestHandler
parameter_list|(
name|String
name|path
parameter_list|)
block|{
return|return
name|RequestHandlerBase
operator|.
name|getRequestHandler
argument_list|(
name|path
argument_list|,
name|containerHandlers
argument_list|)
return|;
block|}
DECL|method|getRequestHandlers
specifier|public
name|PluginBag
argument_list|<
name|SolrRequestHandler
argument_list|>
name|getRequestHandlers
parameter_list|()
block|{
return|return
name|this
operator|.
name|containerHandlers
return|;
block|}
comment|// private ClientConnectionManager clientConnectionManager = new PoolingClientConnectionManager();
block|{
name|log
operator|.
name|info
argument_list|(
literal|"New CoreContainer "
operator|+
name|System
operator|.
name|identityHashCode
argument_list|(
name|this
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Create a new CoreContainer using system properties to detect the solr home    * directory.  The container's cores are not loaded.    * @see #load()    */
DECL|method|CoreContainer
specifier|public
name|CoreContainer
parameter_list|()
block|{
name|this
argument_list|(
operator|new
name|SolrResourceLoader
argument_list|(
name|SolrResourceLoader
operator|.
name|locateSolrHome
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Create a new CoreContainer using the given SolrResourceLoader.  The container's    * cores are not loaded.    * @param loader the SolrResourceLoader    * @see #load()    */
DECL|method|CoreContainer
specifier|public
name|CoreContainer
parameter_list|(
name|SolrResourceLoader
name|loader
parameter_list|)
block|{
name|this
argument_list|(
name|SolrXmlConfig
operator|.
name|fromSolrHome
argument_list|(
name|loader
argument_list|,
name|loader
operator|.
name|getInstancePath
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Create a new CoreContainer using the given solr home directory.  The container's    * cores are not loaded.    * @param solrHome a String containing the path to the solr home directory    * @see #load()    */
DECL|method|CoreContainer
specifier|public
name|CoreContainer
parameter_list|(
name|String
name|solrHome
parameter_list|)
block|{
name|this
argument_list|(
operator|new
name|SolrResourceLoader
argument_list|(
name|Paths
operator|.
name|get
argument_list|(
name|solrHome
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Create a new CoreContainer using the given SolrResourceLoader,    * configuration and CoresLocator.  The container's cores are    * not loaded.    * @param config a ConfigSolr representation of this container's configuration    * @see #load()    */
DECL|method|CoreContainer
specifier|public
name|CoreContainer
parameter_list|(
name|NodeConfig
name|config
parameter_list|)
block|{
name|this
argument_list|(
name|config
argument_list|,
operator|new
name|Properties
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|CoreContainer
specifier|public
name|CoreContainer
parameter_list|(
name|NodeConfig
name|config
parameter_list|,
name|Properties
name|properties
parameter_list|)
block|{
name|this
argument_list|(
name|config
argument_list|,
name|properties
argument_list|,
operator|new
name|CorePropertiesLocator
argument_list|(
name|config
operator|.
name|getCoreRootDirectory
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|CoreContainer
specifier|public
name|CoreContainer
parameter_list|(
name|NodeConfig
name|config
parameter_list|,
name|Properties
name|properties
parameter_list|,
name|boolean
name|asyncSolrCoreLoad
parameter_list|)
block|{
name|this
argument_list|(
name|config
argument_list|,
name|properties
argument_list|,
operator|new
name|CorePropertiesLocator
argument_list|(
name|config
operator|.
name|getCoreRootDirectory
argument_list|()
argument_list|)
argument_list|,
name|asyncSolrCoreLoad
argument_list|)
expr_stmt|;
block|}
DECL|method|CoreContainer
specifier|public
name|CoreContainer
parameter_list|(
name|NodeConfig
name|config
parameter_list|,
name|Properties
name|properties
parameter_list|,
name|CoresLocator
name|locator
parameter_list|)
block|{
name|this
argument_list|(
name|config
argument_list|,
name|properties
argument_list|,
name|locator
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
DECL|method|CoreContainer
specifier|public
name|CoreContainer
parameter_list|(
name|NodeConfig
name|config
parameter_list|,
name|Properties
name|properties
parameter_list|,
name|CoresLocator
name|locator
parameter_list|,
name|boolean
name|asyncSolrCoreLoad
parameter_list|)
block|{
name|this
operator|.
name|loader
operator|=
name|config
operator|.
name|getSolrResourceLoader
argument_list|()
expr_stmt|;
name|this
operator|.
name|solrHome
operator|=
name|loader
operator|.
name|getInstancePath
argument_list|()
operator|.
name|toString
argument_list|()
expr_stmt|;
name|this
operator|.
name|cfg
operator|=
name|checkNotNull
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|this
operator|.
name|coresLocator
operator|=
name|locator
expr_stmt|;
name|this
operator|.
name|containerProperties
operator|=
operator|new
name|Properties
argument_list|(
name|properties
argument_list|)
expr_stmt|;
name|this
operator|.
name|asyncSolrCoreLoad
operator|=
name|asyncSolrCoreLoad
expr_stmt|;
block|}
DECL|method|initializeAuthorizationPlugin
specifier|private
specifier|synchronized
name|void
name|initializeAuthorizationPlugin
parameter_list|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|authorizationConf
parameter_list|)
block|{
name|authorizationConf
operator|=
name|Utils
operator|.
name|getDeepCopy
argument_list|(
name|authorizationConf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|//Initialize the Authorization module
name|SecurityPluginHolder
argument_list|<
name|AuthorizationPlugin
argument_list|>
name|old
init|=
name|authorizationPlugin
decl_stmt|;
name|SecurityPluginHolder
argument_list|<
name|AuthorizationPlugin
argument_list|>
name|authorizationPlugin
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|authorizationConf
operator|!=
literal|null
condition|)
block|{
name|String
name|klas
init|=
operator|(
name|String
operator|)
name|authorizationConf
operator|.
name|get
argument_list|(
literal|"class"
argument_list|)
decl_stmt|;
if|if
condition|(
name|klas
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"class is required for authorization plugin"
argument_list|)
throw|;
block|}
if|if
condition|(
name|old
operator|!=
literal|null
operator|&&
name|old
operator|.
name|getZnodeVersion
argument_list|()
operator|==
name|readVersion
argument_list|(
name|authorizationConf
argument_list|)
condition|)
block|{
return|return;
block|}
name|log
operator|.
name|info
argument_list|(
literal|"Initializing authorization plugin: "
operator|+
name|klas
argument_list|)
expr_stmt|;
name|authorizationPlugin
operator|=
operator|new
name|SecurityPluginHolder
argument_list|<>
argument_list|(
name|readVersion
argument_list|(
name|authorizationConf
argument_list|)
argument_list|,
name|getResourceLoader
argument_list|()
operator|.
name|newInstance
argument_list|(
name|klas
argument_list|,
name|AuthorizationPlugin
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
comment|// Read and pass the authorization context to the plugin
name|authorizationPlugin
operator|.
name|plugin
operator|.
name|init
argument_list|(
name|authorizationConf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Security conf doesn't exist. Skipping setup for authorization module."
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|authorizationPlugin
operator|=
name|authorizationPlugin
expr_stmt|;
if|if
condition|(
name|old
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|old
operator|.
name|plugin
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{       }
block|}
block|}
DECL|method|initializeAuthenticationPlugin
specifier|private
specifier|synchronized
name|void
name|initializeAuthenticationPlugin
parameter_list|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|authenticationConfig
parameter_list|)
block|{
name|authenticationConfig
operator|=
name|Utils
operator|.
name|getDeepCopy
argument_list|(
name|authenticationConfig
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|String
name|pluginClassName
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|authenticationConfig
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|authenticationConfig
operator|.
name|containsKey
argument_list|(
literal|"class"
argument_list|)
condition|)
block|{
name|pluginClassName
operator|=
name|String
operator|.
name|valueOf
argument_list|(
name|authenticationConfig
operator|.
name|get
argument_list|(
literal|"class"
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"No 'class' specified for authentication in ZK."
argument_list|)
throw|;
block|}
block|}
if|if
condition|(
name|pluginClassName
operator|!=
literal|null
condition|)
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Authentication plugin class obtained from ZK: "
operator|+
name|pluginClassName
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|System
operator|.
name|getProperty
argument_list|(
name|AUTHENTICATION_PLUGIN_PROP
argument_list|)
operator|!=
literal|null
condition|)
block|{
name|pluginClassName
operator|=
name|System
operator|.
name|getProperty
argument_list|(
name|AUTHENTICATION_PLUGIN_PROP
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Authentication plugin class obtained from system property '"
operator|+
name|AUTHENTICATION_PLUGIN_PROP
operator|+
literal|"': "
operator|+
name|pluginClassName
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
operator|.
name|info
argument_list|(
literal|"No authentication plugin used."
argument_list|)
expr_stmt|;
block|}
name|SecurityPluginHolder
argument_list|<
name|AuthenticationPlugin
argument_list|>
name|old
init|=
name|authenticationPlugin
decl_stmt|;
name|SecurityPluginHolder
argument_list|<
name|AuthenticationPlugin
argument_list|>
name|authenticationPlugin
init|=
literal|null
decl_stmt|;
comment|// Initialize the plugin
if|if
condition|(
name|pluginClassName
operator|!=
literal|null
condition|)
block|{
name|authenticationPlugin
operator|=
operator|new
name|SecurityPluginHolder
argument_list|<>
argument_list|(
name|readVersion
argument_list|(
name|authenticationConfig
argument_list|)
argument_list|,
name|getResourceLoader
argument_list|()
operator|.
name|newInstance
argument_list|(
name|pluginClassName
argument_list|,
name|AuthenticationPlugin
operator|.
name|class
argument_list|,
literal|null
argument_list|,
operator|new
name|Class
index|[]
block|{
name|CoreContainer
operator|.
name|class
block|}
argument_list|,
operator|new
name|Object
index|[]
block|{
name|this
block|}
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|authenticationPlugin
operator|!=
literal|null
condition|)
block|{
name|authenticationPlugin
operator|.
name|plugin
operator|.
name|init
argument_list|(
name|authenticationConfig
argument_list|)
expr_stmt|;
name|setupHttpClientForAuthPlugin
argument_list|(
name|authenticationPlugin
operator|.
name|plugin
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|authenticationPlugin
operator|=
name|authenticationPlugin
expr_stmt|;
try|try
block|{
if|if
condition|(
name|old
operator|!=
literal|null
condition|)
name|old
operator|.
name|plugin
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
comment|/*do nothing*/
block|}
block|}
DECL|method|setupHttpClientForAuthPlugin
specifier|private
name|void
name|setupHttpClientForAuthPlugin
parameter_list|(
name|Object
name|authcPlugin
parameter_list|)
block|{
if|if
condition|(
name|authcPlugin
operator|instanceof
name|HttpClientBuilderPlugin
condition|)
block|{
comment|// Setup HttpClient for internode communication
name|SolrHttpClientBuilder
name|builder
init|=
operator|(
operator|(
name|HttpClientBuilderPlugin
operator|)
name|authcPlugin
operator|)
operator|.
name|getHttpClientBuilder
argument_list|(
name|HttpClientUtil
operator|.
name|getHttpClientBuilder
argument_list|()
argument_list|)
decl_stmt|;
comment|// The default http client of the core container's shardHandlerFactory has already been created and
comment|// configured using the default httpclient configurer. We need to reconfigure it using the plugin's
comment|// http client configurer to set it up for internode communication.
name|log
operator|.
name|info
argument_list|(
literal|"Reconfiguring HttpClient settings."
argument_list|)
expr_stmt|;
name|SolrHttpClientContextBuilder
name|httpClientBuilder
init|=
operator|new
name|SolrHttpClientContextBuilder
argument_list|()
decl_stmt|;
if|if
condition|(
name|builder
operator|.
name|getCredentialsProviderProvider
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|httpClientBuilder
operator|.
name|setDefaultCredentialsProvider
argument_list|(
operator|new
name|CredentialsProviderProvider
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|CredentialsProvider
name|getCredentialsProvider
parameter_list|()
block|{
return|return
name|builder
operator|.
name|getCredentialsProviderProvider
argument_list|()
operator|.
name|getCredentialsProvider
argument_list|()
return|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|builder
operator|.
name|getAuthSchemeRegistryProvider
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|httpClientBuilder
operator|.
name|setAuthSchemeRegistryProvider
argument_list|(
operator|new
name|AuthSchemeRegistryProvider
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Lookup
argument_list|<
name|AuthSchemeProvider
argument_list|>
name|getAuthSchemeRegistry
parameter_list|()
block|{
return|return
name|builder
operator|.
name|getAuthSchemeRegistryProvider
argument_list|()
operator|.
name|getAuthSchemeRegistry
argument_list|()
return|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
name|HttpClientUtil
operator|.
name|setHttpClientRequestContextBuilder
argument_list|(
name|httpClientBuilder
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pkiAuthenticationPlugin
operator|!=
literal|null
condition|)
block|{
comment|//this happened due to an authc plugin reload. no need to register the pkiAuthc plugin again
if|if
condition|(
name|pkiAuthenticationPlugin
operator|.
name|isInterceptorRegistered
argument_list|()
condition|)
return|return;
name|log
operator|.
name|info
argument_list|(
literal|"PKIAuthenticationPlugin is managing internode requests"
argument_list|)
expr_stmt|;
name|setupHttpClientForAuthPlugin
argument_list|(
name|pkiAuthenticationPlugin
argument_list|)
expr_stmt|;
name|pkiAuthenticationPlugin
operator|.
name|setInterceptorRegistered
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|method|readVersion
specifier|private
specifier|static
name|int
name|readVersion
parameter_list|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|conf
parameter_list|)
block|{
if|if
condition|(
name|conf
operator|==
literal|null
condition|)
return|return
operator|-
literal|1
return|;
name|Map
name|meta
init|=
operator|(
name|Map
operator|)
name|conf
operator|.
name|get
argument_list|(
literal|""
argument_list|)
decl_stmt|;
if|if
condition|(
name|meta
operator|==
literal|null
condition|)
return|return
operator|-
literal|1
return|;
name|Number
name|v
init|=
operator|(
name|Number
operator|)
name|meta
operator|.
name|get
argument_list|(
literal|"v"
argument_list|)
decl_stmt|;
return|return
name|v
operator|==
literal|null
condition|?
operator|-
literal|1
else|:
name|v
operator|.
name|intValue
argument_list|()
return|;
block|}
comment|/**    * This method allows subclasses to construct a CoreContainer    * without any default init behavior.    *    * @param testConstructor pass (Object)null.    * @lucene.experimental    */
DECL|method|CoreContainer
specifier|protected
name|CoreContainer
parameter_list|(
name|Object
name|testConstructor
parameter_list|)
block|{
name|solrHome
operator|=
literal|null
expr_stmt|;
name|loader
operator|=
literal|null
expr_stmt|;
name|coresLocator
operator|=
literal|null
expr_stmt|;
name|cfg
operator|=
literal|null
expr_stmt|;
name|containerProperties
operator|=
literal|null
expr_stmt|;
block|}
DECL|method|createAndLoad
specifier|public
specifier|static
name|CoreContainer
name|createAndLoad
parameter_list|(
name|Path
name|solrHome
parameter_list|)
block|{
return|return
name|createAndLoad
argument_list|(
name|solrHome
argument_list|,
name|solrHome
operator|.
name|resolve
argument_list|(
name|SolrXmlConfig
operator|.
name|SOLR_XML_FILE
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * Create a new CoreContainer and load its cores    * @param solrHome the solr home directory    * @param configFile the file containing this container's configuration    * @return a loaded CoreContainer    */
DECL|method|createAndLoad
specifier|public
specifier|static
name|CoreContainer
name|createAndLoad
parameter_list|(
name|Path
name|solrHome
parameter_list|,
name|Path
name|configFile
parameter_list|)
block|{
name|SolrResourceLoader
name|loader
init|=
operator|new
name|SolrResourceLoader
argument_list|(
name|solrHome
argument_list|)
decl_stmt|;
name|CoreContainer
name|cc
init|=
operator|new
name|CoreContainer
argument_list|(
name|SolrXmlConfig
operator|.
name|fromFile
argument_list|(
name|loader
argument_list|,
name|configFile
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|cc
operator|.
name|load
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|cc
operator|.
name|shutdown
argument_list|()
expr_stmt|;
throw|throw
name|e
throw|;
block|}
return|return
name|cc
return|;
block|}
DECL|method|getContainerProperties
specifier|public
name|Properties
name|getContainerProperties
parameter_list|()
block|{
return|return
name|containerProperties
return|;
block|}
DECL|method|getPkiAuthenticationPlugin
specifier|public
name|PKIAuthenticationPlugin
name|getPkiAuthenticationPlugin
parameter_list|()
block|{
return|return
name|pkiAuthenticationPlugin
return|;
block|}
comment|//-------------------------------------------------------------------
comment|// Initialization / Cleanup
comment|//-------------------------------------------------------------------
comment|/**    * Load the cores defined for this CoreContainer    */
DECL|method|load
specifier|public
name|void
name|load
parameter_list|()
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Loading cores into CoreContainer [instanceDir={}]"
argument_list|,
name|loader
operator|.
name|getInstancePath
argument_list|()
argument_list|)
expr_stmt|;
comment|// add the sharedLib to the shared resource loader before initializing cfg based plugins
name|String
name|libDir
init|=
name|cfg
operator|.
name|getSharedLibDirectory
argument_list|()
decl_stmt|;
if|if
condition|(
name|libDir
operator|!=
literal|null
condition|)
block|{
name|Path
name|libPath
init|=
name|loader
operator|.
name|getInstancePath
argument_list|()
operator|.
name|resolve
argument_list|(
name|libDir
argument_list|)
decl_stmt|;
try|try
block|{
name|loader
operator|.
name|addToClassLoader
argument_list|(
name|SolrResourceLoader
operator|.
name|getURLs
argument_list|(
name|libPath
argument_list|)
argument_list|)
expr_stmt|;
name|loader
operator|.
name|reloadLuceneSPI
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Couldn't add files from {} to classpath: {}"
argument_list|,
name|libPath
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|shardHandlerFactory
operator|=
name|ShardHandlerFactory
operator|.
name|newInstance
argument_list|(
name|cfg
operator|.
name|getShardHandlerFactoryPluginInfo
argument_list|()
argument_list|,
name|loader
argument_list|)
expr_stmt|;
name|updateShardHandler
operator|=
operator|new
name|UpdateShardHandler
argument_list|(
name|cfg
operator|.
name|getUpdateShardHandlerConfig
argument_list|()
argument_list|)
expr_stmt|;
name|solrCores
operator|.
name|allocateLazyCores
argument_list|(
name|cfg
operator|.
name|getTransientCacheSize
argument_list|()
argument_list|,
name|loader
argument_list|)
expr_stmt|;
name|logging
operator|=
name|LogWatcher
operator|.
name|newRegisteredLogWatcher
argument_list|(
name|cfg
operator|.
name|getLogWatcherConfig
argument_list|()
argument_list|,
name|loader
argument_list|)
expr_stmt|;
name|hostName
operator|=
name|cfg
operator|.
name|getNodeName
argument_list|()
expr_stmt|;
name|zkSys
operator|.
name|initZooKeeper
argument_list|(
name|this
argument_list|,
name|solrHome
argument_list|,
name|cfg
operator|.
name|getCloudConfig
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|isZooKeeperAware
argument_list|()
condition|)
name|pkiAuthenticationPlugin
operator|=
operator|new
name|PKIAuthenticationPlugin
argument_list|(
name|this
argument_list|,
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|.
name|getNodeName
argument_list|()
argument_list|)
expr_stmt|;
name|ZkStateReader
operator|.
name|ConfigData
name|securityConfig
init|=
name|isZooKeeperAware
argument_list|()
condition|?
name|getZkController
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
operator|.
name|getSecurityProps
argument_list|(
literal|false
argument_list|)
else|:
operator|new
name|ZkStateReader
operator|.
name|ConfigData
argument_list|(
name|EMPTY_MAP
argument_list|,
operator|-
literal|1
argument_list|)
decl_stmt|;
name|initializeAuthorizationPlugin
argument_list|(
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|securityConfig
operator|.
name|data
operator|.
name|get
argument_list|(
literal|"authorization"
argument_list|)
argument_list|)
expr_stmt|;
name|initializeAuthenticationPlugin
argument_list|(
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|securityConfig
operator|.
name|data
operator|.
name|get
argument_list|(
literal|"authentication"
argument_list|)
argument_list|)
expr_stmt|;
name|containerHandlers
operator|.
name|put
argument_list|(
name|ZK_PATH
argument_list|,
operator|new
name|ZookeeperInfoHandler
argument_list|(
name|this
argument_list|)
argument_list|)
expr_stmt|;
name|securityConfHandler
operator|=
operator|new
name|SecurityConfHandler
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|collectionsHandler
operator|=
name|createHandler
argument_list|(
name|cfg
operator|.
name|getCollectionsHandlerClass
argument_list|()
argument_list|,
name|CollectionsHandler
operator|.
name|class
argument_list|)
expr_stmt|;
name|containerHandlers
operator|.
name|put
argument_list|(
name|COLLECTIONS_HANDLER_PATH
argument_list|,
name|collectionsHandler
argument_list|)
expr_stmt|;
name|infoHandler
operator|=
name|createHandler
argument_list|(
name|cfg
operator|.
name|getInfoHandlerClass
argument_list|()
argument_list|,
name|InfoHandler
operator|.
name|class
argument_list|)
expr_stmt|;
name|containerHandlers
operator|.
name|put
argument_list|(
name|INFO_HANDLER_PATH
argument_list|,
name|infoHandler
argument_list|)
expr_stmt|;
name|coreAdminHandler
operator|=
name|createHandler
argument_list|(
name|cfg
operator|.
name|getCoreAdminHandlerClass
argument_list|()
argument_list|,
name|CoreAdminHandler
operator|.
name|class
argument_list|)
expr_stmt|;
name|containerHandlers
operator|.
name|put
argument_list|(
name|CORES_HANDLER_PATH
argument_list|,
name|coreAdminHandler
argument_list|)
expr_stmt|;
name|configSetsHandler
operator|=
name|createHandler
argument_list|(
name|cfg
operator|.
name|getConfigSetsHandlerClass
argument_list|()
argument_list|,
name|ConfigSetsHandler
operator|.
name|class
argument_list|)
expr_stmt|;
name|containerHandlers
operator|.
name|put
argument_list|(
name|CONFIGSETS_HANDLER_PATH
argument_list|,
name|configSetsHandler
argument_list|)
expr_stmt|;
name|containerHandlers
operator|.
name|put
argument_list|(
name|AUTHZ_PATH
argument_list|,
name|securityConfHandler
argument_list|)
expr_stmt|;
name|containerHandlers
operator|.
name|put
argument_list|(
name|AUTHC_PATH
argument_list|,
name|securityConfHandler
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkiAuthenticationPlugin
operator|!=
literal|null
condition|)
name|containerHandlers
operator|.
name|put
argument_list|(
name|PKIAuthenticationPlugin
operator|.
name|PATH
argument_list|,
name|pkiAuthenticationPlugin
operator|.
name|getRequestHandler
argument_list|()
argument_list|)
expr_stmt|;
name|coreConfigService
operator|=
name|ConfigSetService
operator|.
name|createConfigSetService
argument_list|(
name|cfg
argument_list|,
name|loader
argument_list|,
name|zkSys
operator|.
name|zkController
argument_list|)
expr_stmt|;
name|containerProperties
operator|.
name|putAll
argument_list|(
name|cfg
operator|.
name|getSolrProperties
argument_list|()
argument_list|)
expr_stmt|;
comment|// setup executor to load cores in parallel
comment|// do not limit the size of the executor in zk mode since cores may try and wait for each other.
name|ExecutorService
name|coreLoadExecutor
init|=
name|ExecutorUtil
operator|.
name|newMDCAwareFixedThreadPool
argument_list|(
operator|(
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|==
literal|null
condition|?
name|cfg
operator|.
name|getCoreLoadThreadCount
argument_list|()
else|:
name|Integer
operator|.
name|MAX_VALUE
operator|)
argument_list|,
operator|new
name|DefaultSolrThreadFactory
argument_list|(
literal|"coreLoadExecutor"
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|List
argument_list|<
name|Future
argument_list|<
name|SolrCore
argument_list|>
argument_list|>
name|futures
init|=
operator|new
name|ArrayList
argument_list|<
name|Future
argument_list|<
name|SolrCore
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
try|try
block|{
name|List
argument_list|<
name|CoreDescriptor
argument_list|>
name|cds
init|=
name|coresLocator
operator|.
name|discover
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|checkForDuplicateCoreNames
argument_list|(
name|cds
argument_list|)
expr_stmt|;
for|for
control|(
specifier|final
name|CoreDescriptor
name|cd
range|:
name|cds
control|)
block|{
if|if
condition|(
name|cd
operator|.
name|isTransient
argument_list|()
operator|||
operator|!
name|cd
operator|.
name|isLoadOnStartup
argument_list|()
condition|)
block|{
name|solrCores
operator|.
name|putDynamicDescriptor
argument_list|(
name|cd
operator|.
name|getName
argument_list|()
argument_list|,
name|cd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|asyncSolrCoreLoad
condition|)
block|{
name|solrCores
operator|.
name|markCoreAsLoading
argument_list|(
name|cd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cd
operator|.
name|isLoadOnStartup
argument_list|()
condition|)
block|{
name|futures
operator|.
name|add
argument_list|(
name|coreLoadExecutor
operator|.
name|submit
argument_list|(
parameter_list|()
lambda|->
block|{
name|SolrCore
name|core
decl_stmt|;
try|try
block|{
if|if
condition|(
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|.
name|throwErrorIfReplicaReplaced
argument_list|(
name|cd
argument_list|)
expr_stmt|;
block|}
name|core
operator|=
name|create
argument_list|(
name|cd
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|asyncSolrCoreLoad
condition|)
block|{
name|solrCores
operator|.
name|markCoreAsNotLoading
argument_list|(
name|cd
argument_list|)
expr_stmt|;
block|}
block|}
try|try
block|{
name|zkSys
operator|.
name|registerInZk
argument_list|(
name|core
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|RuntimeException
name|e
parameter_list|)
block|{
name|SolrException
operator|.
name|log
argument_list|(
name|log
argument_list|,
literal|"Error registering SolrCore"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
return|return
name|core
return|;
block|}
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Start the background thread
name|backgroundCloser
operator|=
operator|new
name|CloserThread
argument_list|(
name|this
argument_list|,
name|solrCores
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
name|backgroundCloser
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|asyncSolrCoreLoad
operator|&&
name|futures
operator|!=
literal|null
condition|)
block|{
name|Thread
name|shutdownThread
init|=
operator|new
name|Thread
argument_list|()
block|{
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
for|for
control|(
name|Future
argument_list|<
name|SolrCore
argument_list|>
name|future
range|:
name|futures
control|)
block|{
try|try
block|{
name|future
operator|.
name|get
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ExecutionException
name|e
parameter_list|)
block|{
name|log
operator|.
name|error
argument_list|(
literal|"Error waiting for SolrCore to be created"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
finally|finally
block|{
name|ExecutorUtil
operator|.
name|shutdownAndAwaitTermination
argument_list|(
name|coreLoadExecutor
argument_list|)
expr_stmt|;
block|}
block|}
block|}
decl_stmt|;
name|coreContainerWorkExecutor
operator|.
name|submit
argument_list|(
name|shutdownThread
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ExecutorUtil
operator|.
name|shutdownAndAwaitTermination
argument_list|(
name|coreLoadExecutor
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|isZooKeeperAware
argument_list|()
condition|)
block|{
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|.
name|checkOverseerDesignate
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|securityNodeChanged
specifier|public
name|void
name|securityNodeChanged
parameter_list|()
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Security node changed"
argument_list|)
expr_stmt|;
name|ZkStateReader
operator|.
name|ConfigData
name|securityConfig
init|=
name|getZkController
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
operator|.
name|getSecurityProps
argument_list|(
literal|false
argument_list|)
decl_stmt|;
name|initializeAuthorizationPlugin
argument_list|(
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|securityConfig
operator|.
name|data
operator|.
name|get
argument_list|(
literal|"authorization"
argument_list|)
argument_list|)
expr_stmt|;
name|initializeAuthenticationPlugin
argument_list|(
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|securityConfig
operator|.
name|data
operator|.
name|get
argument_list|(
literal|"authentication"
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|checkForDuplicateCoreNames
specifier|private
specifier|static
name|void
name|checkForDuplicateCoreNames
parameter_list|(
name|List
argument_list|<
name|CoreDescriptor
argument_list|>
name|cds
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Path
argument_list|>
name|addedCores
init|=
name|Maps
operator|.
name|newHashMap
argument_list|()
decl_stmt|;
for|for
control|(
name|CoreDescriptor
name|cd
range|:
name|cds
control|)
block|{
specifier|final
name|String
name|name
init|=
name|cd
operator|.
name|getName
argument_list|()
decl_stmt|;
if|if
condition|(
name|addedCores
operator|.
name|containsKey
argument_list|(
name|name
argument_list|)
condition|)
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
literal|"Found multiple cores with the name [%s], with instancedirs [%s] and [%s]"
argument_list|,
name|name
argument_list|,
name|addedCores
operator|.
name|get
argument_list|(
name|name
argument_list|)
argument_list|,
name|cd
operator|.
name|getInstanceDir
argument_list|()
argument_list|)
argument_list|)
throw|;
name|addedCores
operator|.
name|put
argument_list|(
name|name
argument_list|,
name|cd
operator|.
name|getInstanceDir
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
DECL|field|isShutDown
specifier|private
specifier|volatile
name|boolean
name|isShutDown
init|=
literal|false
decl_stmt|;
DECL|method|isShutDown
specifier|public
name|boolean
name|isShutDown
parameter_list|()
block|{
return|return
name|isShutDown
return|;
block|}
comment|/**    * Stops all cores.    */
DECL|method|shutdown
specifier|public
name|void
name|shutdown
parameter_list|()
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Shutting down CoreContainer instance="
operator|+
name|System
operator|.
name|identityHashCode
argument_list|(
name|this
argument_list|)
argument_list|)
expr_stmt|;
name|isShutDown
operator|=
literal|true
expr_stmt|;
name|ExecutorUtil
operator|.
name|shutdownAndAwaitTermination
argument_list|(
name|coreContainerWorkExecutor
argument_list|)
expr_stmt|;
if|if
condition|(
name|isZooKeeperAware
argument_list|()
condition|)
block|{
name|cancelCoreRecoveries
argument_list|()
expr_stmt|;
name|zkSys
operator|.
name|zkController
operator|.
name|publishNodeAsDown
argument_list|(
name|zkSys
operator|.
name|zkController
operator|.
name|getNodeName
argument_list|()
argument_list|)
expr_stmt|;
block|}
try|try
block|{
if|if
condition|(
name|coreAdminHandler
operator|!=
literal|null
condition|)
name|coreAdminHandler
operator|.
name|shutdown
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Error shutting down CoreAdminHandler. Continuing to close CoreContainer."
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
try|try
block|{
comment|// First wake up the closer thread, it'll terminate almost immediately since it checks isShutDown.
synchronized|synchronized
init|(
name|solrCores
operator|.
name|getModifyLock
argument_list|()
init|)
block|{
name|solrCores
operator|.
name|getModifyLock
argument_list|()
operator|.
name|notifyAll
argument_list|()
expr_stmt|;
comment|// wake up anyone waiting
block|}
if|if
condition|(
name|backgroundCloser
operator|!=
literal|null
condition|)
block|{
comment|// Doesn't seem right, but tests get in here without initializing the core.
try|try
block|{
name|backgroundCloser
operator|.
name|join
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
if|if
condition|(
name|log
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"backgroundCloser thread was interrupted before finishing"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// Now clear all the cores that are being operated upon.
name|solrCores
operator|.
name|close
argument_list|()
expr_stmt|;
comment|// It's still possible that one of the pending dynamic load operation is waiting, so wake it up if so.
comment|// Since all the pending operations queues have been drained, there should be nothing to do.
synchronized|synchronized
init|(
name|solrCores
operator|.
name|getModifyLock
argument_list|()
init|)
block|{
name|solrCores
operator|.
name|getModifyLock
argument_list|()
operator|.
name|notifyAll
argument_list|()
expr_stmt|;
comment|// wake up the thread
block|}
block|}
finally|finally
block|{
try|try
block|{
if|if
condition|(
name|shardHandlerFactory
operator|!=
literal|null
condition|)
block|{
name|shardHandlerFactory
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
finally|finally
block|{
try|try
block|{
if|if
condition|(
name|updateShardHandler
operator|!=
literal|null
condition|)
block|{
name|updateShardHandler
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
finally|finally
block|{
comment|// we want to close zk stuff last
name|zkSys
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
comment|// It should be safe to close the authorization plugin at this point.
try|try
block|{
if|if
condition|(
name|authorizationPlugin
operator|!=
literal|null
condition|)
block|{
name|authorizationPlugin
operator|.
name|plugin
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Exception while closing authorization plugin."
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
comment|// It should be safe to close the authentication plugin at this point.
try|try
block|{
if|if
condition|(
name|authenticationPlugin
operator|!=
literal|null
condition|)
block|{
name|authenticationPlugin
operator|.
name|plugin
operator|.
name|close
argument_list|()
expr_stmt|;
name|authenticationPlugin
operator|=
literal|null
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Exception while closing authentication plugin."
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|IOUtils
operator|.
name|closeWhileHandlingException
argument_list|(
name|loader
argument_list|)
expr_stmt|;
comment|// best effort
block|}
DECL|method|cancelCoreRecoveries
specifier|public
name|void
name|cancelCoreRecoveries
parameter_list|()
block|{
name|List
argument_list|<
name|SolrCore
argument_list|>
name|cores
init|=
name|solrCores
operator|.
name|getCores
argument_list|()
decl_stmt|;
comment|// we must cancel without holding the cores sync
comment|// make sure we wait for any recoveries to stop
for|for
control|(
name|SolrCore
name|core
range|:
name|cores
control|)
block|{
try|try
block|{
name|core
operator|.
name|getSolrCoreState
argument_list|()
operator|.
name|cancelRecovery
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|SolrException
operator|.
name|log
argument_list|(
name|log
argument_list|,
literal|"Error canceling recovery for core"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
DECL|method|finalize
specifier|protected
name|void
name|finalize
parameter_list|()
throws|throws
name|Throwable
block|{
try|try
block|{
if|if
condition|(
operator|!
name|isShutDown
condition|)
block|{
name|log
operator|.
name|error
argument_list|(
literal|"CoreContainer was not close prior to finalize(), indicates a bug -- POSSIBLE RESOURCE LEAK!!!  instance="
operator|+
name|System
operator|.
name|identityHashCode
argument_list|(
name|this
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|super
operator|.
name|finalize
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|getCoresLocator
specifier|public
name|CoresLocator
name|getCoresLocator
parameter_list|()
block|{
return|return
name|coresLocator
return|;
block|}
DECL|method|registerCore
specifier|protected
name|SolrCore
name|registerCore
parameter_list|(
name|String
name|name
parameter_list|,
name|SolrCore
name|core
parameter_list|,
name|boolean
name|registerInZk
parameter_list|)
block|{
if|if
condition|(
name|core
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"Can not register a null core."
argument_list|)
throw|;
block|}
comment|// We can register a core when creating them via the admin UI, so we need to ensure that the dynamic descriptors
comment|// are up to date
name|CoreDescriptor
name|cd
init|=
name|core
operator|.
name|getCoreDescriptor
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|cd
operator|.
name|isTransient
argument_list|()
operator|||
operator|!
name|cd
operator|.
name|isLoadOnStartup
argument_list|()
operator|)
operator|&&
name|solrCores
operator|.
name|getDynamicDescriptor
argument_list|(
name|name
argument_list|)
operator|==
literal|null
condition|)
block|{
comment|// Store it away for later use. includes non-transient but not
comment|// loaded at startup cores.
name|solrCores
operator|.
name|putDynamicDescriptor
argument_list|(
name|name
argument_list|,
name|cd
argument_list|)
expr_stmt|;
block|}
name|SolrCore
name|old
decl_stmt|;
if|if
condition|(
name|isShutDown
condition|)
block|{
name|core
operator|.
name|close
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"This CoreContainer has been closed"
argument_list|)
throw|;
block|}
if|if
condition|(
name|cd
operator|.
name|isTransient
argument_list|()
condition|)
block|{
name|old
operator|=
name|solrCores
operator|.
name|putTransientCore
argument_list|(
name|cfg
argument_list|,
name|name
argument_list|,
name|core
argument_list|,
name|loader
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|old
operator|=
name|solrCores
operator|.
name|putCore
argument_list|(
name|name
argument_list|,
name|core
argument_list|)
expr_stmt|;
block|}
comment|/*       * set both the name of the descriptor and the name of the       * core, since the descriptors name is used for persisting.       */
name|core
operator|.
name|setName
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|coreInitFailures
operator|.
name|remove
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|old
operator|==
literal|null
operator|||
name|old
operator|==
name|core
condition|)
block|{
name|log
operator|.
name|info
argument_list|(
literal|"registering core: "
operator|+
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|registerInZk
condition|)
block|{
name|zkSys
operator|.
name|registerInZk
argument_list|(
name|core
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
else|else
block|{
name|log
operator|.
name|info
argument_list|(
literal|"replacing core: "
operator|+
name|name
argument_list|)
expr_stmt|;
name|old
operator|.
name|close
argument_list|()
expr_stmt|;
if|if
condition|(
name|registerInZk
condition|)
block|{
name|zkSys
operator|.
name|registerInZk
argument_list|(
name|core
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
return|return
name|old
return|;
block|}
block|}
comment|/**    * Creates a new core, publishing the core state to the cluster    * @param coreName the core name    * @param parameters the core parameters    * @return the newly created core    */
DECL|method|create
specifier|public
name|SolrCore
name|create
parameter_list|(
name|String
name|coreName
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|parameters
parameter_list|)
block|{
return|return
name|create
argument_list|(
name|coreName
argument_list|,
name|cfg
operator|.
name|getCoreRootDirectory
argument_list|()
operator|.
name|resolve
argument_list|(
name|coreName
argument_list|)
argument_list|,
name|parameters
argument_list|)
return|;
block|}
comment|/**    * Creates a new core in a specified instance directory, publishing the core state to the cluster    * @param coreName the core name    * @param instancePath the instance directory    * @param parameters the core parameters    * @return the newly created core    */
DECL|method|create
specifier|public
name|SolrCore
name|create
parameter_list|(
name|String
name|coreName
parameter_list|,
name|Path
name|instancePath
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|parameters
parameter_list|)
block|{
name|CoreDescriptor
name|cd
init|=
operator|new
name|CoreDescriptor
argument_list|(
name|this
argument_list|,
name|coreName
argument_list|,
name|instancePath
argument_list|,
name|parameters
argument_list|)
decl_stmt|;
comment|// TODO: There's a race here, isn't there?
if|if
condition|(
name|getAllCoreNames
argument_list|()
operator|.
name|contains
argument_list|(
name|coreName
argument_list|)
condition|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Creating a core with existing name is not allowed"
argument_list|)
expr_stmt|;
comment|// TODO: Shouldn't this be a BAD_REQUEST?
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Core with name '"
operator|+
name|coreName
operator|+
literal|"' already exists."
argument_list|)
throw|;
block|}
name|boolean
name|preExisitingZkEntry
init|=
literal|false
decl_stmt|;
try|try
block|{
if|if
condition|(
name|getZkController
argument_list|()
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
operator|!
name|Overseer
operator|.
name|isLegacy
argument_list|(
name|getZkController
argument_list|()
operator|.
name|getZkStateReader
argument_list|()
argument_list|)
condition|)
block|{
if|if
condition|(
name|cd
operator|.
name|getCloudDescriptor
argument_list|()
operator|.
name|getCoreNodeName
argument_list|()
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"non legacy mode coreNodeName missing "
operator|+
name|parameters
operator|.
name|toString
argument_list|()
argument_list|)
throw|;
block|}
block|}
name|preExisitingZkEntry
operator|=
name|getZkController
argument_list|()
operator|.
name|checkIfCoreNodeNameAlreadyExists
argument_list|(
name|cd
argument_list|)
expr_stmt|;
block|}
name|SolrCore
name|core
init|=
name|create
argument_list|(
name|cd
argument_list|,
literal|true
argument_list|)
decl_stmt|;
comment|// only write out the descriptor if the core is successfully created
name|coresLocator
operator|.
name|create
argument_list|(
name|this
argument_list|,
name|cd
argument_list|)
expr_stmt|;
return|return
name|core
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
if|if
condition|(
name|isZooKeeperAware
argument_list|()
operator|&&
operator|!
name|preExisitingZkEntry
condition|)
block|{
try|try
block|{
name|getZkController
argument_list|()
operator|.
name|unregister
argument_list|(
name|coreName
argument_list|,
name|cd
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
name|SolrException
operator|.
name|log
argument_list|(
name|log
argument_list|,
literal|null
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|KeeperException
name|e
parameter_list|)
block|{
name|SolrException
operator|.
name|log
argument_list|(
name|log
argument_list|,
literal|null
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
name|Throwable
name|tc
init|=
name|ex
decl_stmt|;
name|Throwable
name|c
init|=
literal|null
decl_stmt|;
do|do
block|{
name|tc
operator|=
name|tc
operator|.
name|getCause
argument_list|()
expr_stmt|;
if|if
condition|(
name|tc
operator|!=
literal|null
condition|)
block|{
name|c
operator|=
name|tc
expr_stmt|;
block|}
block|}
do|while
condition|(
name|tc
operator|!=
literal|null
condition|)
do|;
name|String
name|rootMsg
init|=
literal|""
decl_stmt|;
if|if
condition|(
name|c
operator|!=
literal|null
condition|)
block|{
name|rootMsg
operator|=
literal|" Caused by: "
operator|+
name|c
operator|.
name|getMessage
argument_list|()
expr_stmt|;
block|}
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|BAD_REQUEST
argument_list|,
literal|"Error CREATEing SolrCore '"
operator|+
name|coreName
operator|+
literal|"': "
operator|+
name|ex
operator|.
name|getMessage
argument_list|()
operator|+
name|rootMsg
argument_list|,
name|ex
argument_list|)
throw|;
block|}
block|}
comment|/**    * Creates a new core based on a CoreDescriptor.    *    * @param dcore        a core descriptor    * @param publishState publish core state to the cluster if true    *    * @return the newly created core    */
DECL|method|create
specifier|private
name|SolrCore
name|create
parameter_list|(
name|CoreDescriptor
name|dcore
parameter_list|,
name|boolean
name|publishState
parameter_list|)
block|{
if|if
condition|(
name|isShutDown
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVICE_UNAVAILABLE
argument_list|,
literal|"Solr has been shutdown."
argument_list|)
throw|;
block|}
name|SolrCore
name|core
init|=
literal|null
decl_stmt|;
try|try
block|{
name|MDCLoggingContext
operator|.
name|setCore
argument_list|(
name|core
argument_list|)
expr_stmt|;
name|SolrIdentifierValidator
operator|.
name|validateCoreName
argument_list|(
name|dcore
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|.
name|preRegister
argument_list|(
name|dcore
argument_list|)
expr_stmt|;
block|}
name|ConfigSet
name|coreConfig
init|=
name|coreConfigService
operator|.
name|getConfig
argument_list|(
name|dcore
argument_list|)
decl_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Creating SolrCore '{}' using configuration from {}"
argument_list|,
name|dcore
operator|.
name|getName
argument_list|()
argument_list|,
name|coreConfig
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|core
operator|=
operator|new
name|SolrCore
argument_list|(
name|dcore
argument_list|,
name|coreConfig
argument_list|)
expr_stmt|;
comment|// always kick off recovery if we are in non-Cloud mode
if|if
condition|(
operator|!
name|isZooKeeperAware
argument_list|()
operator|&&
name|core
operator|.
name|getUpdateHandler
argument_list|()
operator|.
name|getUpdateLog
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|core
operator|.
name|getUpdateHandler
argument_list|()
operator|.
name|getUpdateLog
argument_list|()
operator|.
name|recoverFromLog
argument_list|()
expr_stmt|;
block|}
name|registerCore
argument_list|(
name|dcore
operator|.
name|getName
argument_list|()
argument_list|,
name|core
argument_list|,
name|publishState
argument_list|)
expr_stmt|;
return|return
name|core
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|coreInitFailures
operator|.
name|put
argument_list|(
name|dcore
operator|.
name|getName
argument_list|()
argument_list|,
operator|new
name|CoreLoadFailure
argument_list|(
name|dcore
argument_list|,
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|error
argument_list|(
literal|"Error creating core [{}]: {}"
argument_list|,
name|dcore
operator|.
name|getName
argument_list|()
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
specifier|final
name|SolrException
name|solrException
init|=
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Unable to create core ["
operator|+
name|dcore
operator|.
name|getName
argument_list|()
operator|+
literal|"]"
argument_list|,
name|e
argument_list|)
decl_stmt|;
if|if
condition|(
name|core
operator|!=
literal|null
operator|&&
operator|!
name|core
operator|.
name|isClosed
argument_list|()
condition|)
name|IOUtils
operator|.
name|closeQuietly
argument_list|(
name|core
argument_list|)
expr_stmt|;
throw|throw
name|solrException
throw|;
block|}
catch|catch
parameter_list|(
name|Throwable
name|t
parameter_list|)
block|{
name|SolrException
name|e
init|=
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"JVM Error creating core ["
operator|+
name|dcore
operator|.
name|getName
argument_list|()
operator|+
literal|"]: "
operator|+
name|t
operator|.
name|getMessage
argument_list|()
argument_list|,
name|t
argument_list|)
decl_stmt|;
name|log
operator|.
name|error
argument_list|(
literal|"Error creating core [{}]: {}"
argument_list|,
name|dcore
operator|.
name|getName
argument_list|()
argument_list|,
name|t
operator|.
name|getMessage
argument_list|()
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|coreInitFailures
operator|.
name|put
argument_list|(
name|dcore
operator|.
name|getName
argument_list|()
argument_list|,
operator|new
name|CoreLoadFailure
argument_list|(
name|dcore
argument_list|,
name|e
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|core
operator|!=
literal|null
operator|&&
operator|!
name|core
operator|.
name|isClosed
argument_list|()
condition|)
name|IOUtils
operator|.
name|closeQuietly
argument_list|(
name|core
argument_list|)
expr_stmt|;
throw|throw
name|t
throw|;
block|}
finally|finally
block|{
name|MDCLoggingContext
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * @return a Collection of registered SolrCores    */
DECL|method|getCores
specifier|public
name|Collection
argument_list|<
name|SolrCore
argument_list|>
name|getCores
parameter_list|()
block|{
return|return
name|solrCores
operator|.
name|getCores
argument_list|()
return|;
block|}
comment|/**    * @return a Collection of the names that cores are mapped to    */
DECL|method|getCoreNames
specifier|public
name|Collection
argument_list|<
name|String
argument_list|>
name|getCoreNames
parameter_list|()
block|{
return|return
name|solrCores
operator|.
name|getCoreNames
argument_list|()
return|;
block|}
comment|/** This method is currently experimental.    * @return a Collection of the names that a specific core is mapped to.    */
DECL|method|getCoreNames
specifier|public
name|Collection
argument_list|<
name|String
argument_list|>
name|getCoreNames
parameter_list|(
name|SolrCore
name|core
parameter_list|)
block|{
return|return
name|solrCores
operator|.
name|getCoreNames
argument_list|(
name|core
argument_list|)
return|;
block|}
comment|/**    * get a list of all the cores that are currently loaded    * @return a list of al lthe available core names in either permanent or transient core lists.    */
DECL|method|getAllCoreNames
specifier|public
name|Collection
argument_list|<
name|String
argument_list|>
name|getAllCoreNames
parameter_list|()
block|{
return|return
name|solrCores
operator|.
name|getAllCoreNames
argument_list|()
return|;
block|}
comment|/**    * Returns an immutable Map of Exceptions that occured when initializing     * SolrCores (either at startup, or do to runtime requests to create cores)     * keyed off of the name (String) of the SolrCore that had the Exception     * during initialization.    *<p>    * While the Map returned by this method is immutable and will not change     * once returned to the client, the source data used to generate this Map     * can be changed as various SolrCore operations are performed:    *</p>    *<ul>    *<li>Failed attempts to create new SolrCores will add new Exceptions.</li>    *<li>Failed attempts to re-create a SolrCore using a name already contained in this Map will replace the Exception.</li>    *<li>Failed attempts to reload a SolrCore will cause an Exception to be added to this list -- even though the existing SolrCore with that name will continue to be available.</li>    *<li>Successful attempts to re-created a SolrCore using a name already contained in this Map will remove the Exception.</li>    *<li>Registering an existing SolrCore with a name already contained in this Map (ie: ALIAS or SWAP) will remove the Exception.</li>    *</ul>    */
DECL|method|getCoreInitFailures
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|CoreLoadFailure
argument_list|>
name|getCoreInitFailures
parameter_list|()
block|{
return|return
name|ImmutableMap
operator|.
name|copyOf
argument_list|(
name|coreInitFailures
argument_list|)
return|;
block|}
comment|// ---------------- Core name related methods ---------------
comment|/**    * Recreates a SolrCore.    * While the new core is loading, requests will continue to be dispatched to    * and processed by the old core    *     * @param name the name of the SolrCore to reload    */
DECL|method|reload
specifier|public
name|void
name|reload
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|SolrCore
name|core
init|=
name|solrCores
operator|.
name|getCoreFromAnyList
argument_list|(
name|name
argument_list|,
literal|false
argument_list|)
decl_stmt|;
if|if
condition|(
name|core
operator|==
literal|null
condition|)
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|BAD_REQUEST
argument_list|,
literal|"No such core: "
operator|+
name|name
argument_list|)
throw|;
name|CoreDescriptor
name|cd
init|=
name|core
operator|.
name|getCoreDescriptor
argument_list|()
decl_stmt|;
try|try
block|{
name|solrCores
operator|.
name|waitAddPendingCoreOps
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|ConfigSet
name|coreConfig
init|=
name|coreConfigService
operator|.
name|getConfig
argument_list|(
name|cd
argument_list|)
decl_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Reloading SolrCore '{}' using configuration from {}"
argument_list|,
name|cd
operator|.
name|getName
argument_list|()
argument_list|,
name|coreConfig
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|SolrCore
name|newCore
init|=
name|core
operator|.
name|reload
argument_list|(
name|coreConfig
argument_list|)
decl_stmt|;
name|registerCore
argument_list|(
name|name
argument_list|,
name|newCore
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SolrCoreState
operator|.
name|CoreIsClosedException
name|e
parameter_list|)
block|{
throw|throw
name|e
throw|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|coreInitFailures
operator|.
name|put
argument_list|(
name|cd
operator|.
name|getName
argument_list|()
argument_list|,
operator|new
name|CoreLoadFailure
argument_list|(
name|cd
argument_list|,
name|e
argument_list|)
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Unable to reload core ["
operator|+
name|cd
operator|.
name|getName
argument_list|()
operator|+
literal|"]"
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|solrCores
operator|.
name|removeFromPendingOps
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Swaps two SolrCore descriptors.    */
DECL|method|swap
specifier|public
name|void
name|swap
parameter_list|(
name|String
name|n0
parameter_list|,
name|String
name|n1
parameter_list|)
block|{
if|if
condition|(
name|n0
operator|==
literal|null
operator|||
name|n1
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|BAD_REQUEST
argument_list|,
literal|"Can not swap unnamed cores."
argument_list|)
throw|;
block|}
name|solrCores
operator|.
name|swap
argument_list|(
name|n0
argument_list|,
name|n1
argument_list|)
expr_stmt|;
name|coresLocator
operator|.
name|swap
argument_list|(
name|this
argument_list|,
name|solrCores
operator|.
name|getCoreDescriptor
argument_list|(
name|n0
argument_list|)
argument_list|,
name|solrCores
operator|.
name|getCoreDescriptor
argument_list|(
name|n1
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"swapped: "
operator|+
name|n0
operator|+
literal|" with "
operator|+
name|n1
argument_list|)
expr_stmt|;
block|}
comment|/**    * Unload a core from this container, leaving all files on disk    * @param name the name of the core to unload    */
DECL|method|unload
specifier|public
name|void
name|unload
parameter_list|(
name|String
name|name
parameter_list|)
block|{
name|unload
argument_list|(
name|name
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|/**    * Unload a core from this container, optionally removing the core's data and configuration    *    * @param name the name of the core to unload    * @param deleteIndexDir if true, delete the core's index on close    * @param deleteDataDir if true, delete the core's data directory on close    * @param deleteInstanceDir if true, delete the core's instance directory on close    */
DECL|method|unload
specifier|public
name|void
name|unload
parameter_list|(
name|String
name|name
parameter_list|,
name|boolean
name|deleteIndexDir
parameter_list|,
name|boolean
name|deleteDataDir
parameter_list|,
name|boolean
name|deleteInstanceDir
parameter_list|)
block|{
if|if
condition|(
name|name
operator|!=
literal|null
condition|)
block|{
comment|// check for core-init errors first
name|CoreLoadFailure
name|loadFailure
init|=
name|coreInitFailures
operator|.
name|remove
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|loadFailure
operator|!=
literal|null
condition|)
block|{
comment|// getting the index directory requires opening a DirectoryFactory with a SolrConfig, etc,
comment|// which we may not be able to do because of the init error.  So we just go with what we
comment|// can glean from the CoreDescriptor - datadir and instancedir
name|SolrCore
operator|.
name|deleteUnloadedCore
argument_list|(
name|loadFailure
operator|.
name|cd
argument_list|,
name|deleteDataDir
argument_list|,
name|deleteInstanceDir
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|CoreDescriptor
name|cd
init|=
name|solrCores
operator|.
name|getCoreDescriptor
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|cd
operator|==
literal|null
condition|)
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|BAD_REQUEST
argument_list|,
literal|"Cannot unload non-existent core ["
operator|+
name|name
operator|+
literal|"]"
argument_list|)
throw|;
name|boolean
name|close
init|=
name|solrCores
operator|.
name|isLoadedNotPendingClose
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|SolrCore
name|core
init|=
name|solrCores
operator|.
name|remove
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|coresLocator
operator|.
name|delete
argument_list|(
name|this
argument_list|,
name|cd
argument_list|)
expr_stmt|;
if|if
condition|(
name|core
operator|==
literal|null
condition|)
block|{
comment|// transient core
name|SolrCore
operator|.
name|deleteUnloadedCore
argument_list|(
name|cd
argument_list|,
name|deleteDataDir
argument_list|,
name|deleteInstanceDir
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|!=
literal|null
condition|)
block|{
comment|// cancel recovery in cloud mode
name|core
operator|.
name|getSolrCoreState
argument_list|()
operator|.
name|cancelRecovery
argument_list|()
expr_stmt|;
block|}
name|core
operator|.
name|unloadOnClose
argument_list|(
name|deleteIndexDir
argument_list|,
name|deleteDataDir
argument_list|,
name|deleteInstanceDir
argument_list|)
expr_stmt|;
if|if
condition|(
name|close
condition|)
name|core
operator|.
name|closeAndWait
argument_list|()
expr_stmt|;
if|if
condition|(
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|.
name|unregister
argument_list|(
name|name
argument_list|,
name|cd
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Interrupted while unregistering core ["
operator|+
name|name
operator|+
literal|"] from cloud state"
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|KeeperException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Error unregistering core ["
operator|+
name|name
operator|+
literal|"] from cloud state"
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
DECL|method|rename
specifier|public
name|void
name|rename
parameter_list|(
name|String
name|name
parameter_list|,
name|String
name|toName
parameter_list|)
block|{
name|SolrIdentifierValidator
operator|.
name|validateCoreName
argument_list|(
name|toName
argument_list|)
expr_stmt|;
try|try
init|(
name|SolrCore
name|core
init|=
name|getCore
argument_list|(
name|name
argument_list|)
init|)
block|{
if|if
condition|(
name|core
operator|!=
literal|null
condition|)
block|{
name|registerCore
argument_list|(
name|toName
argument_list|,
name|core
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|SolrCore
name|old
init|=
name|solrCores
operator|.
name|remove
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|coresLocator
operator|.
name|rename
argument_list|(
name|this
argument_list|,
name|old
operator|.
name|getCoreDescriptor
argument_list|()
argument_list|,
name|core
operator|.
name|getCoreDescriptor
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Get the CoreDescriptors for all cores managed by this container    * @return a List of CoreDescriptors    */
DECL|method|getCoreDescriptors
specifier|public
name|List
argument_list|<
name|CoreDescriptor
argument_list|>
name|getCoreDescriptors
parameter_list|()
block|{
return|return
name|solrCores
operator|.
name|getCoreDescriptors
argument_list|()
return|;
block|}
DECL|method|getCoreDescriptor
specifier|public
name|CoreDescriptor
name|getCoreDescriptor
parameter_list|(
name|String
name|coreName
parameter_list|)
block|{
comment|// TODO make this less hideous!
for|for
control|(
name|CoreDescriptor
name|cd
range|:
name|getCoreDescriptors
argument_list|()
control|)
block|{
if|if
condition|(
name|cd
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|coreName
argument_list|)
condition|)
return|return
name|cd
return|;
block|}
return|return
literal|null
return|;
block|}
DECL|method|getCoreRootDirectory
specifier|public
name|Path
name|getCoreRootDirectory
parameter_list|()
block|{
return|return
name|cfg
operator|.
name|getCoreRootDirectory
argument_list|()
return|;
block|}
comment|/**    * Gets a core by name and increase its refcount.    *    * @see SolrCore#close()    * @param name the core name    * @return the core if found, null if a SolrCore by this name does not exist    * @exception SolrException if a SolrCore with this name failed to be initialized    */
DECL|method|getCore
specifier|public
name|SolrCore
name|getCore
parameter_list|(
name|String
name|name
parameter_list|)
block|{
comment|// Do this in two phases since we don't want to lock access to the cores over a load.
name|SolrCore
name|core
init|=
name|solrCores
operator|.
name|getCoreFromAnyList
argument_list|(
name|name
argument_list|,
literal|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|core
operator|!=
literal|null
condition|)
block|{
return|return
name|core
return|;
block|}
comment|// OK, it's not presently in any list, is it in the list of dynamic cores but not loaded yet? If so, load it.
name|CoreDescriptor
name|desc
init|=
name|solrCores
operator|.
name|getDynamicDescriptor
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|desc
operator|==
literal|null
condition|)
block|{
comment|//Nope, no transient core with this name
comment|// if there was an error initializing this core, throw a 500
comment|// error with the details for clients attempting to access it.
name|CoreLoadFailure
name|loadFailure
init|=
name|getCoreInitFailures
argument_list|()
operator|.
name|get
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
literal|null
operator|!=
name|loadFailure
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"SolrCore '"
operator|+
name|name
operator|+
literal|"' is not available due to init failure: "
operator|+
name|loadFailure
operator|.
name|exception
operator|.
name|getMessage
argument_list|()
argument_list|,
name|loadFailure
operator|.
name|exception
argument_list|)
throw|;
block|}
comment|// otherwise the user is simply asking for something that doesn't exist.
return|return
literal|null
return|;
block|}
comment|// This will put an entry in pending core ops if the core isn't loaded
name|core
operator|=
name|solrCores
operator|.
name|waitAddPendingCoreOps
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|isShutDown
condition|)
return|return
literal|null
return|;
comment|// We're quitting, so stop. This needs to be after the wait above since we may come off
comment|// the wait as a consequence of shutting down.
try|try
block|{
if|if
condition|(
name|core
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|.
name|throwErrorIfReplicaReplaced
argument_list|(
name|desc
argument_list|)
expr_stmt|;
block|}
name|core
operator|=
name|create
argument_list|(
name|desc
argument_list|,
literal|true
argument_list|)
expr_stmt|;
comment|// This should throw an error if it fails.
block|}
name|core
operator|.
name|open
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|solrCores
operator|.
name|removeFromPendingOps
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
return|return
name|core
return|;
block|}
DECL|method|getBlobRepository
specifier|public
name|BlobRepository
name|getBlobRepository
parameter_list|()
block|{
return|return
name|blobRepository
return|;
block|}
comment|/**    * If using asyncSolrCoreLoad=true, calling this after {@link #load()} will    * not return until all cores have finished loading.    *     * @param timeoutMs timeout, upon which method simply returns    */
DECL|method|waitForLoadingCoresToFinish
specifier|public
name|void
name|waitForLoadingCoresToFinish
parameter_list|(
name|long
name|timeoutMs
parameter_list|)
block|{
name|solrCores
operator|.
name|waitForLoadingCoresToFinish
argument_list|(
name|timeoutMs
argument_list|)
expr_stmt|;
block|}
DECL|method|waitForLoadingCore
specifier|public
name|void
name|waitForLoadingCore
parameter_list|(
name|String
name|name
parameter_list|,
name|long
name|timeoutMs
parameter_list|)
block|{
name|solrCores
operator|.
name|waitForLoadingCoreToFinish
argument_list|(
name|name
argument_list|,
name|timeoutMs
argument_list|)
expr_stmt|;
block|}
comment|// ---------------- CoreContainer request handlers --------------
DECL|method|createHandler
specifier|protected
parameter_list|<
name|T
parameter_list|>
name|T
name|createHandler
parameter_list|(
name|String
name|handlerClass
parameter_list|,
name|Class
argument_list|<
name|T
argument_list|>
name|clazz
parameter_list|)
block|{
return|return
name|loader
operator|.
name|newInstance
argument_list|(
name|handlerClass
argument_list|,
name|clazz
argument_list|,
literal|null
argument_list|,
operator|new
name|Class
index|[]
block|{
name|CoreContainer
operator|.
name|class
block|}
argument_list|,
operator|new
name|Object
index|[]
block|{
name|this
block|}
argument_list|)
return|;
block|}
DECL|method|getMultiCoreHandler
specifier|public
name|CoreAdminHandler
name|getMultiCoreHandler
parameter_list|()
block|{
return|return
name|coreAdminHandler
return|;
block|}
DECL|method|getCollectionsHandler
specifier|public
name|CollectionsHandler
name|getCollectionsHandler
parameter_list|()
block|{
return|return
name|collectionsHandler
return|;
block|}
DECL|method|getInfoHandler
specifier|public
name|InfoHandler
name|getInfoHandler
parameter_list|()
block|{
return|return
name|infoHandler
return|;
block|}
DECL|method|getConfigSetsHandler
specifier|public
name|ConfigSetsHandler
name|getConfigSetsHandler
parameter_list|()
block|{
return|return
name|configSetsHandler
return|;
block|}
DECL|method|getHostName
specifier|public
name|String
name|getHostName
parameter_list|()
block|{
return|return
name|this
operator|.
name|hostName
return|;
block|}
comment|/**    * Gets the alternate path for multicore handling:    * This is used in case there is a registered unnamed core (aka name is "") to    * declare an alternate way of accessing named cores.    * This can also be used in a pseudo single-core environment so admins can prepare    * a new version before swapping.    */
DECL|method|getManagementPath
specifier|public
name|String
name|getManagementPath
parameter_list|()
block|{
return|return
name|cfg
operator|.
name|getManagementPath
argument_list|()
return|;
block|}
DECL|method|getLogging
specifier|public
name|LogWatcher
name|getLogging
parameter_list|()
block|{
return|return
name|logging
return|;
block|}
comment|/**    * Determines whether the core is already loaded or not but does NOT load the core    *    */
DECL|method|isLoaded
specifier|public
name|boolean
name|isLoaded
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|solrCores
operator|.
name|isLoaded
argument_list|(
name|name
argument_list|)
return|;
block|}
DECL|method|isLoadedNotPendingClose
specifier|public
name|boolean
name|isLoadedNotPendingClose
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|solrCores
operator|.
name|isLoadedNotPendingClose
argument_list|(
name|name
argument_list|)
return|;
block|}
comment|/**    * Gets a solr core descriptor for a core that is not loaded. Note that if the caller calls this on a    * loaded core, the unloaded descriptor will be returned.    *    * @param cname - name of the unloaded core descriptor to load. NOTE:    * @return a coreDescriptor. May return null    */
DECL|method|getUnloadedCoreDescriptor
specifier|public
name|CoreDescriptor
name|getUnloadedCoreDescriptor
parameter_list|(
name|String
name|cname
parameter_list|)
block|{
return|return
name|solrCores
operator|.
name|getUnloadedCoreDescriptor
argument_list|(
name|cname
argument_list|)
return|;
block|}
DECL|method|getSolrHome
specifier|public
name|String
name|getSolrHome
parameter_list|()
block|{
return|return
name|solrHome
return|;
block|}
DECL|method|isZooKeeperAware
specifier|public
name|boolean
name|isZooKeeperAware
parameter_list|()
block|{
return|return
name|zkSys
operator|.
name|getZkController
argument_list|()
operator|!=
literal|null
return|;
block|}
DECL|method|getZkController
specifier|public
name|ZkController
name|getZkController
parameter_list|()
block|{
return|return
name|zkSys
operator|.
name|getZkController
argument_list|()
return|;
block|}
DECL|method|getConfig
specifier|public
name|NodeConfig
name|getConfig
parameter_list|()
block|{
return|return
name|cfg
return|;
block|}
comment|/** The default ShardHandlerFactory used to communicate with other solr instances */
DECL|method|getShardHandlerFactory
specifier|public
name|ShardHandlerFactory
name|getShardHandlerFactory
parameter_list|()
block|{
return|return
name|shardHandlerFactory
return|;
block|}
DECL|method|getUpdateShardHandler
specifier|public
name|UpdateShardHandler
name|getUpdateShardHandler
parameter_list|()
block|{
return|return
name|updateShardHandler
return|;
block|}
DECL|method|getResourceLoader
specifier|public
name|SolrResourceLoader
name|getResourceLoader
parameter_list|()
block|{
return|return
name|loader
return|;
block|}
DECL|method|isCoreLoading
specifier|public
name|boolean
name|isCoreLoading
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|solrCores
operator|.
name|isCoreLoading
argument_list|(
name|name
argument_list|)
return|;
block|}
DECL|method|getAuthorizationPlugin
specifier|public
name|AuthorizationPlugin
name|getAuthorizationPlugin
parameter_list|()
block|{
return|return
name|authorizationPlugin
operator|==
literal|null
condition|?
literal|null
else|:
name|authorizationPlugin
operator|.
name|plugin
return|;
block|}
DECL|method|getAuthenticationPlugin
specifier|public
name|AuthenticationPlugin
name|getAuthenticationPlugin
parameter_list|()
block|{
return|return
name|authenticationPlugin
operator|==
literal|null
condition|?
literal|null
else|:
name|authenticationPlugin
operator|.
name|plugin
return|;
block|}
block|}
end_class
begin_class
DECL|class|CloserThread
class|class
name|CloserThread
extends|extends
name|Thread
block|{
DECL|field|container
name|CoreContainer
name|container
decl_stmt|;
DECL|field|solrCores
name|SolrCores
name|solrCores
decl_stmt|;
DECL|field|cfg
name|NodeConfig
name|cfg
decl_stmt|;
DECL|method|CloserThread
name|CloserThread
parameter_list|(
name|CoreContainer
name|container
parameter_list|,
name|SolrCores
name|solrCores
parameter_list|,
name|NodeConfig
name|cfg
parameter_list|)
block|{
name|this
operator|.
name|container
operator|=
name|container
expr_stmt|;
name|this
operator|.
name|solrCores
operator|=
name|solrCores
expr_stmt|;
name|this
operator|.
name|cfg
operator|=
name|cfg
expr_stmt|;
block|}
comment|// It's important that this be the _only_ thread removing things from pendingDynamicCloses!
comment|// This is single-threaded, but I tried a multi-threaded approach and didn't see any performance gains, so
comment|// there's no good justification for the complexity. I suspect that the locking on things like DefaultSolrCoreState
comment|// essentially create a single-threaded process anyway.
annotation|@
name|Override
DECL|method|run
specifier|public
name|void
name|run
parameter_list|()
block|{
while|while
condition|(
operator|!
name|container
operator|.
name|isShutDown
argument_list|()
condition|)
block|{
synchronized|synchronized
init|(
name|solrCores
operator|.
name|getModifyLock
argument_list|()
init|)
block|{
comment|// need this so we can wait and be awoken.
try|try
block|{
name|solrCores
operator|.
name|getModifyLock
argument_list|()
operator|.
name|wait
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
comment|// Well, if we've been told to stop, we will. Otherwise, continue on and check to see if there are
comment|// any cores to close.
block|}
block|}
for|for
control|(
name|SolrCore
name|removeMe
init|=
name|solrCores
operator|.
name|getCoreToClose
argument_list|()
init|;
name|removeMe
operator|!=
literal|null
operator|&&
operator|!
name|container
operator|.
name|isShutDown
argument_list|()
condition|;
name|removeMe
operator|=
name|solrCores
operator|.
name|getCoreToClose
argument_list|()
control|)
block|{
try|try
block|{
name|removeMe
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|solrCores
operator|.
name|removeFromPendingOps
argument_list|(
name|removeMe
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_class
end_unit
