begin_unit
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment
begin_package
DECL|package|org.apache.solr.handler.component
package|package
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|handler
operator|.
name|component
package|;
end_package
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import
begin_import
import|import
name|java
operator|.
name|io
operator|.
name|StringReader
import|;
end_import
begin_import
import|import
name|java
operator|.
name|net
operator|.
name|MalformedURLException
import|;
end_import
begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import
begin_import
import|import
name|java
operator|.
name|util
operator|.
name|WeakHashMap
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|QueryElevationParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import
begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|xpath
operator|.
name|XPath
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|xpath
operator|.
name|XPathConstants
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|xpath
operator|.
name|XPathExpressionException
import|;
end_import
begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|xpath
operator|.
name|XPathFactory
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|analysis
operator|.
name|Analyzer
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|analysis
operator|.
name|TokenStream
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|analysis
operator|.
name|tokenattributes
operator|.
name|CharTermAttribute
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|IndexReader
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|index
operator|.
name|Term
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|search
operator|.
name|*
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|StringHelper
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|lucene
operator|.
name|util
operator|.
name|BytesRef
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|SolrException
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|params
operator|.
name|SolrParams
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|DOMUtil
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|NamedList
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|common
operator|.
name|util
operator|.
name|SimpleOrderedMap
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|core
operator|.
name|Config
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|core
operator|.
name|SolrCore
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|schema
operator|.
name|StrField
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|schema
operator|.
name|FieldType
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|schema
operator|.
name|SchemaField
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|search
operator|.
name|SortSpec
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|search
operator|.
name|SolrIndexSearcher
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|VersionedFile
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|RefCounted
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|util
operator|.
name|plugin
operator|.
name|SolrCoreAware
import|;
end_import
begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|solr
operator|.
name|request
operator|.
name|SolrQueryRequest
import|;
end_import
begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|Node
import|;
end_import
begin_import
import|import
name|org
operator|.
name|w3c
operator|.
name|dom
operator|.
name|NodeList
import|;
end_import
begin_comment
comment|/**  * A component to elevate some documents to the top of the result set.  *   * @version $Id$  * @since solr 1.3  */
end_comment
begin_class
DECL|class|QueryElevationComponent
specifier|public
class|class
name|QueryElevationComponent
extends|extends
name|SearchComponent
implements|implements
name|SolrCoreAware
block|{
DECL|field|log
specifier|private
specifier|static
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|QueryElevationComponent
operator|.
name|class
argument_list|)
decl_stmt|;
comment|// Constants used in solrconfig.xml
DECL|field|FIELD_TYPE
specifier|static
specifier|final
name|String
name|FIELD_TYPE
init|=
literal|"queryFieldType"
decl_stmt|;
DECL|field|CONFIG_FILE
specifier|static
specifier|final
name|String
name|CONFIG_FILE
init|=
literal|"config-file"
decl_stmt|;
DECL|field|EXCLUDE
specifier|static
specifier|final
name|String
name|EXCLUDE
init|=
literal|"exclude"
decl_stmt|;
comment|// Runtime param -- should be in common?
DECL|field|initArgs
specifier|private
name|SolrParams
name|initArgs
init|=
literal|null
decl_stmt|;
DECL|field|analyzer
specifier|private
name|Analyzer
name|analyzer
init|=
literal|null
decl_stmt|;
DECL|field|idField
specifier|private
name|String
name|idField
init|=
literal|null
decl_stmt|;
DECL|field|forceElevation
name|boolean
name|forceElevation
init|=
literal|false
decl_stmt|;
comment|// For each IndexReader, keep a query->elevation map
comment|// When the configuration is loaded from the data directory.
comment|// The key is null if loaded from the config directory, and
comment|// is never re-loaded.
DECL|field|elevationCache
specifier|final
name|Map
argument_list|<
name|IndexReader
argument_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
argument_list|>
name|elevationCache
init|=
operator|new
name|WeakHashMap
argument_list|<
name|IndexReader
argument_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
DECL|class|ElevationObj
class|class
name|ElevationObj
block|{
DECL|field|text
specifier|final
name|String
name|text
decl_stmt|;
DECL|field|analyzed
specifier|final
name|String
name|analyzed
decl_stmt|;
DECL|field|exclude
specifier|final
name|BooleanClause
index|[]
name|exclude
decl_stmt|;
DECL|field|include
specifier|final
name|BooleanQuery
name|include
decl_stmt|;
DECL|field|priority
specifier|final
name|Map
argument_list|<
name|BytesRef
argument_list|,
name|Integer
argument_list|>
name|priority
decl_stmt|;
comment|// use singletons so hashCode/equals on Sort will just work
DECL|field|comparatorSource
specifier|final
name|FieldComparatorSource
name|comparatorSource
decl_stmt|;
DECL|method|ElevationObj
name|ElevationObj
parameter_list|(
name|String
name|qstr
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|elevate
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|exclude
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|text
operator|=
name|qstr
expr_stmt|;
name|this
operator|.
name|analyzed
operator|=
name|getAnalyzedQuery
argument_list|(
name|this
operator|.
name|text
argument_list|)
expr_stmt|;
name|this
operator|.
name|include
operator|=
operator|new
name|BooleanQuery
argument_list|()
expr_stmt|;
name|this
operator|.
name|include
operator|.
name|setBoost
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|this
operator|.
name|priority
operator|=
operator|new
name|HashMap
argument_list|<
name|BytesRef
argument_list|,
name|Integer
argument_list|>
argument_list|()
expr_stmt|;
name|int
name|max
init|=
name|elevate
operator|.
name|size
argument_list|()
operator|+
literal|5
decl_stmt|;
for|for
control|(
name|String
name|id
range|:
name|elevate
control|)
block|{
name|TermQuery
name|tq
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|idField
argument_list|,
name|id
argument_list|)
argument_list|)
decl_stmt|;
name|include
operator|.
name|add
argument_list|(
name|tq
argument_list|,
name|BooleanClause
operator|.
name|Occur
operator|.
name|SHOULD
argument_list|)
expr_stmt|;
name|this
operator|.
name|priority
operator|.
name|put
argument_list|(
operator|new
name|BytesRef
argument_list|(
name|id
argument_list|)
argument_list|,
name|max
operator|--
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|exclude
operator|==
literal|null
operator|||
name|exclude
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|this
operator|.
name|exclude
operator|=
literal|null
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|exclude
operator|=
operator|new
name|BooleanClause
index|[
name|exclude
operator|.
name|size
argument_list|()
index|]
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|exclude
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|TermQuery
name|tq
init|=
operator|new
name|TermQuery
argument_list|(
operator|new
name|Term
argument_list|(
name|idField
argument_list|,
name|exclude
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
name|this
operator|.
name|exclude
index|[
name|i
index|]
operator|=
operator|new
name|BooleanClause
argument_list|(
name|tq
argument_list|,
name|BooleanClause
operator|.
name|Occur
operator|.
name|MUST_NOT
argument_list|)
expr_stmt|;
block|}
block|}
name|this
operator|.
name|comparatorSource
operator|=
operator|new
name|ElevationComparatorSource
argument_list|(
name|priority
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|init
specifier|public
name|void
name|init
parameter_list|(
name|NamedList
name|args
parameter_list|)
block|{
name|this
operator|.
name|initArgs
operator|=
name|SolrParams
operator|.
name|toSolrParams
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
DECL|method|inform
specifier|public
name|void
name|inform
parameter_list|(
name|SolrCore
name|core
parameter_list|)
block|{
name|String
name|a
init|=
name|initArgs
operator|.
name|get
argument_list|(
name|FIELD_TYPE
argument_list|)
decl_stmt|;
if|if
condition|(
name|a
operator|!=
literal|null
condition|)
block|{
name|FieldType
name|ft
init|=
name|core
operator|.
name|getSchema
argument_list|()
operator|.
name|getFieldTypes
argument_list|()
operator|.
name|get
argument_list|(
name|a
argument_list|)
decl_stmt|;
if|if
condition|(
name|ft
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Unknown FieldType: '"
operator|+
name|a
operator|+
literal|"' used in QueryElevationComponent"
argument_list|)
throw|;
block|}
name|analyzer
operator|=
name|ft
operator|.
name|getQueryAnalyzer
argument_list|()
expr_stmt|;
block|}
name|SchemaField
name|sf
init|=
name|core
operator|.
name|getSchema
argument_list|()
operator|.
name|getUniqueKeyField
argument_list|()
decl_stmt|;
if|if
condition|(
name|sf
operator|==
literal|null
operator|||
operator|!
operator|(
name|sf
operator|.
name|getType
argument_list|()
operator|instanceof
name|StrField
operator|)
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"QueryElevationComponent requires the schema to have a uniqueKeyField implemented using StrField"
argument_list|)
throw|;
block|}
name|idField
operator|=
name|StringHelper
operator|.
name|intern
argument_list|(
name|sf
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|forceElevation
operator|=
name|initArgs
operator|.
name|getBool
argument_list|(
name|QueryElevationParams
operator|.
name|FORCE_ELEVATION
argument_list|,
name|forceElevation
argument_list|)
expr_stmt|;
try|try
block|{
synchronized|synchronized
init|(
name|elevationCache
init|)
block|{
name|elevationCache
operator|.
name|clear
argument_list|()
expr_stmt|;
name|String
name|f
init|=
name|initArgs
operator|.
name|get
argument_list|(
name|CONFIG_FILE
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"QueryElevationComponent must specify argument: '"
operator|+
name|CONFIG_FILE
operator|+
literal|"' -- path to elevate.xml"
argument_list|)
throw|;
block|}
name|File
name|fC
init|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getResourceLoader
argument_list|()
operator|.
name|getConfigDir
argument_list|()
argument_list|,
name|f
argument_list|)
decl_stmt|;
name|File
name|fD
init|=
operator|new
name|File
argument_list|(
name|core
operator|.
name|getDataDir
argument_list|()
argument_list|,
name|f
argument_list|)
decl_stmt|;
if|if
condition|(
name|fC
operator|.
name|exists
argument_list|()
operator|==
name|fD
operator|.
name|exists
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"QueryElevationComponent missing config file: '"
operator|+
name|f
operator|+
literal|"\n"
operator|+
literal|"either: "
operator|+
name|fC
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|" or "
operator|+
name|fD
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|" must exist, but not both."
argument_list|)
throw|;
block|}
if|if
condition|(
name|fC
operator|.
name|exists
argument_list|()
condition|)
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Loading QueryElevation from: "
operator|+
name|fC
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
name|Config
name|cfg
init|=
operator|new
name|Config
argument_list|(
name|core
operator|.
name|getResourceLoader
argument_list|()
argument_list|,
name|f
argument_list|)
decl_stmt|;
name|elevationCache
operator|.
name|put
argument_list|(
literal|null
argument_list|,
name|loadElevationMap
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// preload the first data
name|RefCounted
argument_list|<
name|SolrIndexSearcher
argument_list|>
name|searchHolder
init|=
literal|null
decl_stmt|;
try|try
block|{
name|searchHolder
operator|=
name|core
operator|.
name|getNewestSearcher
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|IndexReader
name|reader
init|=
name|searchHolder
operator|.
name|get
argument_list|()
operator|.
name|getReader
argument_list|()
decl_stmt|;
name|getElevationMap
argument_list|(
name|reader
argument_list|,
name|core
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|searchHolder
operator|!=
literal|null
condition|)
name|searchHolder
operator|.
name|decref
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Error initializing QueryElevationComponent."
argument_list|,
name|ex
argument_list|)
throw|;
block|}
block|}
DECL|method|getElevationMap
name|Map
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
name|getElevationMap
parameter_list|(
name|IndexReader
name|reader
parameter_list|,
name|SolrCore
name|core
parameter_list|)
throws|throws
name|Exception
block|{
synchronized|synchronized
init|(
name|elevationCache
init|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
name|map
init|=
name|elevationCache
operator|.
name|get
argument_list|(
literal|null
argument_list|)
decl_stmt|;
if|if
condition|(
name|map
operator|!=
literal|null
condition|)
return|return
name|map
return|;
name|map
operator|=
name|elevationCache
operator|.
name|get
argument_list|(
name|reader
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|==
literal|null
condition|)
block|{
name|String
name|f
init|=
name|initArgs
operator|.
name|get
argument_list|(
name|CONFIG_FILE
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"QueryElevationComponent must specify argument: "
operator|+
name|CONFIG_FILE
argument_list|)
throw|;
block|}
name|log
operator|.
name|info
argument_list|(
literal|"Loading QueryElevation from data dir: "
operator|+
name|f
argument_list|)
expr_stmt|;
name|InputStream
name|is
init|=
name|VersionedFile
operator|.
name|getLatestFile
argument_list|(
name|core
operator|.
name|getDataDir
argument_list|()
argument_list|,
name|f
argument_list|)
decl_stmt|;
name|Config
name|cfg
init|=
operator|new
name|Config
argument_list|(
name|core
operator|.
name|getResourceLoader
argument_list|()
argument_list|,
name|f
argument_list|,
name|is
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|map
operator|=
name|loadElevationMap
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
name|elevationCache
operator|.
name|put
argument_list|(
name|reader
argument_list|,
name|map
argument_list|)
expr_stmt|;
block|}
return|return
name|map
return|;
block|}
block|}
DECL|method|loadElevationMap
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
name|loadElevationMap
parameter_list|(
name|Config
name|cfg
parameter_list|)
throws|throws
name|IOException
block|{
name|XPath
name|xpath
init|=
name|XPathFactory
operator|.
name|newInstance
argument_list|()
operator|.
name|newXPath
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
name|map
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
argument_list|()
decl_stmt|;
name|NodeList
name|nodes
init|=
operator|(
name|NodeList
operator|)
name|cfg
operator|.
name|evaluate
argument_list|(
literal|"elevate/query"
argument_list|,
name|XPathConstants
operator|.
name|NODESET
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|nodes
operator|.
name|getLength
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|Node
name|node
init|=
name|nodes
operator|.
name|item
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|String
name|qstr
init|=
name|DOMUtil
operator|.
name|getAttr
argument_list|(
name|node
argument_list|,
literal|"text"
argument_list|,
literal|"missing query 'text'"
argument_list|)
decl_stmt|;
name|NodeList
name|children
init|=
literal|null
decl_stmt|;
try|try
block|{
name|children
operator|=
operator|(
name|NodeList
operator|)
name|xpath
operator|.
name|evaluate
argument_list|(
literal|"doc"
argument_list|,
name|node
argument_list|,
name|XPathConstants
operator|.
name|NODESET
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|XPathExpressionException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"query requires '<doc .../>' child"
argument_list|)
throw|;
block|}
name|ArrayList
argument_list|<
name|String
argument_list|>
name|include
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|ArrayList
argument_list|<
name|String
argument_list|>
name|exclude
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
name|children
operator|.
name|getLength
argument_list|()
condition|;
name|j
operator|++
control|)
block|{
name|Node
name|child
init|=
name|children
operator|.
name|item
argument_list|(
name|j
argument_list|)
decl_stmt|;
name|String
name|id
init|=
name|DOMUtil
operator|.
name|getAttr
argument_list|(
name|child
argument_list|,
literal|"id"
argument_list|,
literal|"missing 'id'"
argument_list|)
decl_stmt|;
name|String
name|e
init|=
name|DOMUtil
operator|.
name|getAttr
argument_list|(
name|child
argument_list|,
name|EXCLUDE
argument_list|,
literal|null
argument_list|)
decl_stmt|;
if|if
condition|(
name|e
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|Boolean
operator|.
name|valueOf
argument_list|(
name|e
argument_list|)
condition|)
block|{
name|exclude
operator|.
name|add
argument_list|(
name|id
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|include
operator|.
name|add
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
name|ElevationObj
name|elev
init|=
operator|new
name|ElevationObj
argument_list|(
name|qstr
argument_list|,
name|include
argument_list|,
name|exclude
argument_list|)
decl_stmt|;
if|if
condition|(
name|map
operator|.
name|containsKey
argument_list|(
name|elev
operator|.
name|analyzed
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Boosting query defined twice for query: '"
operator|+
name|elev
operator|.
name|text
operator|+
literal|"' ("
operator|+
name|elev
operator|.
name|analyzed
operator|+
literal|"')"
argument_list|)
throw|;
block|}
name|map
operator|.
name|put
argument_list|(
name|elev
operator|.
name|analyzed
argument_list|,
name|elev
argument_list|)
expr_stmt|;
block|}
return|return
name|map
return|;
block|}
comment|/**    * Helpful for testing without loading config.xml    * @throws IOException     */
DECL|method|setTopQueryResults
name|void
name|setTopQueryResults
parameter_list|(
name|IndexReader
name|reader
parameter_list|,
name|String
name|query
parameter_list|,
name|String
index|[]
name|ids
parameter_list|,
name|String
index|[]
name|ex
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|ids
operator|==
literal|null
condition|)
block|{
name|ids
operator|=
operator|new
name|String
index|[
literal|0
index|]
expr_stmt|;
block|}
if|if
condition|(
name|ex
operator|==
literal|null
condition|)
block|{
name|ex
operator|=
operator|new
name|String
index|[
literal|0
index|]
expr_stmt|;
block|}
name|Map
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
name|elev
init|=
name|elevationCache
operator|.
name|get
argument_list|(
name|reader
argument_list|)
decl_stmt|;
if|if
condition|(
name|elev
operator|==
literal|null
condition|)
block|{
name|elev
operator|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|ElevationObj
argument_list|>
argument_list|()
expr_stmt|;
name|elevationCache
operator|.
name|put
argument_list|(
name|reader
argument_list|,
name|elev
argument_list|)
expr_stmt|;
block|}
name|ElevationObj
name|obj
init|=
operator|new
name|ElevationObj
argument_list|(
name|query
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
name|ids
argument_list|)
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
name|ex
argument_list|)
argument_list|)
decl_stmt|;
name|elev
operator|.
name|put
argument_list|(
name|obj
operator|.
name|analyzed
argument_list|,
name|obj
argument_list|)
expr_stmt|;
block|}
DECL|method|getAnalyzedQuery
name|String
name|getAnalyzedQuery
parameter_list|(
name|String
name|query
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|analyzer
operator|==
literal|null
condition|)
block|{
return|return
name|query
return|;
block|}
name|StringBuilder
name|norm
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|TokenStream
name|tokens
init|=
name|analyzer
operator|.
name|reusableTokenStream
argument_list|(
literal|""
argument_list|,
operator|new
name|StringReader
argument_list|(
name|query
argument_list|)
argument_list|)
decl_stmt|;
name|tokens
operator|.
name|reset
argument_list|()
expr_stmt|;
name|CharTermAttribute
name|termAtt
init|=
name|tokens
operator|.
name|addAttribute
argument_list|(
name|CharTermAttribute
operator|.
name|class
argument_list|)
decl_stmt|;
while|while
condition|(
name|tokens
operator|.
name|incrementToken
argument_list|()
condition|)
block|{
name|norm
operator|.
name|append
argument_list|(
name|termAtt
operator|.
name|buffer
argument_list|()
argument_list|,
literal|0
argument_list|,
name|termAtt
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|norm
operator|.
name|toString
argument_list|()
return|;
block|}
comment|//---------------------------------------------------------------------------------
comment|// SearchComponent
comment|//---------------------------------------------------------------------------------
annotation|@
name|Override
DECL|method|prepare
specifier|public
name|void
name|prepare
parameter_list|(
name|ResponseBuilder
name|rb
parameter_list|)
throws|throws
name|IOException
block|{
name|SolrQueryRequest
name|req
init|=
name|rb
operator|.
name|req
decl_stmt|;
name|SolrParams
name|params
init|=
name|req
operator|.
name|getParams
argument_list|()
decl_stmt|;
comment|// A runtime param can skip
if|if
condition|(
operator|!
name|params
operator|.
name|getBool
argument_list|(
name|QueryElevationParams
operator|.
name|ENABLE
argument_list|,
literal|true
argument_list|)
condition|)
block|{
return|return;
block|}
name|boolean
name|exclusive
init|=
name|params
operator|.
name|getBool
argument_list|(
name|QueryElevationParams
operator|.
name|EXCLUSIVE
argument_list|,
literal|false
argument_list|)
decl_stmt|;
comment|// A runtime parameter can alter the config value for forceElevation
name|boolean
name|force
init|=
name|params
operator|.
name|getBool
argument_list|(
name|QueryElevationParams
operator|.
name|FORCE_ELEVATION
argument_list|,
name|forceElevation
argument_list|)
decl_stmt|;
name|Query
name|query
init|=
name|rb
operator|.
name|getQuery
argument_list|()
decl_stmt|;
name|String
name|qstr
init|=
name|rb
operator|.
name|getQueryString
argument_list|()
decl_stmt|;
if|if
condition|(
name|query
operator|==
literal|null
operator|||
name|qstr
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|qstr
operator|=
name|getAnalyzedQuery
argument_list|(
name|qstr
argument_list|)
expr_stmt|;
name|IndexReader
name|reader
init|=
name|req
operator|.
name|getSearcher
argument_list|()
operator|.
name|getReader
argument_list|()
decl_stmt|;
name|ElevationObj
name|booster
init|=
literal|null
decl_stmt|;
try|try
block|{
name|booster
operator|=
name|getElevationMap
argument_list|(
name|reader
argument_list|,
name|req
operator|.
name|getCore
argument_list|()
argument_list|)
operator|.
name|get
argument_list|(
name|qstr
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|SolrException
argument_list|(
name|SolrException
operator|.
name|ErrorCode
operator|.
name|SERVER_ERROR
argument_list|,
literal|"Error loading elevation"
argument_list|,
name|ex
argument_list|)
throw|;
block|}
if|if
condition|(
name|booster
operator|!=
literal|null
condition|)
block|{
comment|// Change the query to insert forced documents
if|if
condition|(
name|exclusive
operator|==
literal|true
condition|)
block|{
comment|//we only want these results
name|rb
operator|.
name|setQuery
argument_list|(
name|booster
operator|.
name|include
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BooleanQuery
name|newq
init|=
operator|new
name|BooleanQuery
argument_list|(
literal|true
argument_list|)
decl_stmt|;
name|newq
operator|.
name|add
argument_list|(
name|query
argument_list|,
name|BooleanClause
operator|.
name|Occur
operator|.
name|SHOULD
argument_list|)
expr_stmt|;
name|newq
operator|.
name|add
argument_list|(
name|booster
operator|.
name|include
argument_list|,
name|BooleanClause
operator|.
name|Occur
operator|.
name|SHOULD
argument_list|)
expr_stmt|;
if|if
condition|(
name|booster
operator|.
name|exclude
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|BooleanClause
name|bq
range|:
name|booster
operator|.
name|exclude
control|)
block|{
name|newq
operator|.
name|add
argument_list|(
name|bq
argument_list|)
expr_stmt|;
block|}
block|}
name|rb
operator|.
name|setQuery
argument_list|(
name|newq
argument_list|)
expr_stmt|;
block|}
comment|// if the sort is 'score desc' use a custom sorting method to
comment|// insert documents in their proper place
name|SortSpec
name|sortSpec
init|=
name|rb
operator|.
name|getSortSpec
argument_list|()
decl_stmt|;
if|if
condition|(
name|sortSpec
operator|.
name|getSort
argument_list|()
operator|==
literal|null
condition|)
block|{
name|sortSpec
operator|.
name|setSort
argument_list|(
operator|new
name|Sort
argument_list|(
operator|new
name|SortField
index|[]
block|{
operator|new
name|SortField
argument_list|(
name|idField
argument_list|,
name|booster
operator|.
name|comparatorSource
argument_list|,
literal|false
argument_list|)
block|,
operator|new
name|SortField
argument_list|(
literal|null
argument_list|,
name|SortField
operator|.
name|SCORE
argument_list|,
literal|false
argument_list|)
block|}
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Check if the sort is based on score
name|boolean
name|modify
init|=
literal|false
decl_stmt|;
name|SortField
index|[]
name|current
init|=
name|sortSpec
operator|.
name|getSort
argument_list|()
operator|.
name|getSort
argument_list|()
decl_stmt|;
name|ArrayList
argument_list|<
name|SortField
argument_list|>
name|sorts
init|=
operator|new
name|ArrayList
argument_list|<
name|SortField
argument_list|>
argument_list|(
name|current
operator|.
name|length
operator|+
literal|1
argument_list|)
decl_stmt|;
comment|// Perhaps force it to always sort by score
if|if
condition|(
name|force
operator|&&
name|current
index|[
literal|0
index|]
operator|.
name|getType
argument_list|()
operator|!=
name|SortField
operator|.
name|SCORE
condition|)
block|{
name|sorts
operator|.
name|add
argument_list|(
operator|new
name|SortField
argument_list|(
name|idField
argument_list|,
name|booster
operator|.
name|comparatorSource
argument_list|,
literal|false
argument_list|)
argument_list|)
expr_stmt|;
name|modify
operator|=
literal|true
expr_stmt|;
block|}
for|for
control|(
name|SortField
name|sf
range|:
name|current
control|)
block|{
if|if
condition|(
name|sf
operator|.
name|getType
argument_list|()
operator|==
name|SortField
operator|.
name|SCORE
condition|)
block|{
name|sorts
operator|.
name|add
argument_list|(
operator|new
name|SortField
argument_list|(
name|idField
argument_list|,
name|booster
operator|.
name|comparatorSource
argument_list|,
name|sf
operator|.
name|getReverse
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|modify
operator|=
literal|true
expr_stmt|;
block|}
name|sorts
operator|.
name|add
argument_list|(
name|sf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|modify
condition|)
block|{
name|sortSpec
operator|.
name|setSort
argument_list|(
operator|new
name|Sort
argument_list|(
name|sorts
operator|.
name|toArray
argument_list|(
operator|new
name|SortField
index|[
name|sorts
operator|.
name|size
argument_list|()
index|]
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// Add debugging information
if|if
condition|(
name|rb
operator|.
name|isDebug
argument_list|()
condition|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|match
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|booster
operator|!=
literal|null
condition|)
block|{
comment|// Extract the elevated terms into a list
name|match
operator|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|(
name|booster
operator|.
name|priority
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|Object
name|o
range|:
name|booster
operator|.
name|include
operator|.
name|clauses
argument_list|()
control|)
block|{
name|TermQuery
name|tq
init|=
call|(
name|TermQuery
call|)
argument_list|(
operator|(
name|BooleanClause
operator|)
name|o
argument_list|)
operator|.
name|getQuery
argument_list|()
decl_stmt|;
name|match
operator|.
name|add
argument_list|(
name|tq
operator|.
name|getTerm
argument_list|()
operator|.
name|text
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|SimpleOrderedMap
argument_list|<
name|Object
argument_list|>
name|dbg
init|=
operator|new
name|SimpleOrderedMap
argument_list|<
name|Object
argument_list|>
argument_list|()
decl_stmt|;
name|dbg
operator|.
name|add
argument_list|(
literal|"q"
argument_list|,
name|qstr
argument_list|)
expr_stmt|;
name|dbg
operator|.
name|add
argument_list|(
literal|"match"
argument_list|,
name|match
argument_list|)
expr_stmt|;
name|rb
operator|.
name|addDebugInfo
argument_list|(
literal|"queryBoosting"
argument_list|,
name|dbg
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|process
specifier|public
name|void
name|process
parameter_list|(
name|ResponseBuilder
name|rb
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Do nothing -- the real work is modifying the input query
block|}
comment|//---------------------------------------------------------------------------------
comment|// SolrInfoMBean
comment|//---------------------------------------------------------------------------------
annotation|@
name|Override
DECL|method|getDescription
specifier|public
name|String
name|getDescription
parameter_list|()
block|{
return|return
literal|"Query Boosting -- boost particular documents for a given query"
return|;
block|}
annotation|@
name|Override
DECL|method|getVersion
specifier|public
name|String
name|getVersion
parameter_list|()
block|{
return|return
literal|"$Revision$"
return|;
block|}
annotation|@
name|Override
DECL|method|getSourceId
specifier|public
name|String
name|getSourceId
parameter_list|()
block|{
return|return
literal|"$Id$"
return|;
block|}
annotation|@
name|Override
DECL|method|getSource
specifier|public
name|String
name|getSource
parameter_list|()
block|{
return|return
literal|"$URL$"
return|;
block|}
annotation|@
name|Override
DECL|method|getDocs
specifier|public
name|URL
index|[]
name|getDocs
parameter_list|()
block|{
try|try
block|{
return|return
operator|new
name|URL
index|[]
block|{
operator|new
name|URL
argument_list|(
literal|"http://wiki.apache.org/solr/QueryElevationComponent"
argument_list|)
block|}
return|;
block|}
catch|catch
parameter_list|(
name|MalformedURLException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
block|}
end_class
begin_class
DECL|class|ElevationComparatorSource
class|class
name|ElevationComparatorSource
extends|extends
name|FieldComparatorSource
block|{
DECL|field|priority
specifier|private
specifier|final
name|Map
argument_list|<
name|BytesRef
argument_list|,
name|Integer
argument_list|>
name|priority
decl_stmt|;
DECL|method|ElevationComparatorSource
specifier|public
name|ElevationComparatorSource
parameter_list|(
specifier|final
name|Map
argument_list|<
name|BytesRef
argument_list|,
name|Integer
argument_list|>
name|boosts
parameter_list|)
block|{
name|this
operator|.
name|priority
operator|=
name|boosts
expr_stmt|;
block|}
DECL|method|newComparator
specifier|public
name|FieldComparator
name|newComparator
parameter_list|(
specifier|final
name|String
name|fieldname
parameter_list|,
specifier|final
name|int
name|numHits
parameter_list|,
name|int
name|sortPos
parameter_list|,
name|boolean
name|reversed
parameter_list|)
throws|throws
name|IOException
block|{
return|return
operator|new
name|FieldComparator
argument_list|()
block|{
name|FieldCache
operator|.
name|DocTermsIndex
name|idIndex
decl_stmt|;
specifier|private
specifier|final
name|int
index|[]
name|values
init|=
operator|new
name|int
index|[
name|numHits
index|]
decl_stmt|;
name|int
name|bottomVal
decl_stmt|;
specifier|private
specifier|final
name|BytesRef
name|tempBR
init|=
operator|new
name|BytesRef
argument_list|()
decl_stmt|;
specifier|public
name|int
name|compare
parameter_list|(
name|int
name|slot1
parameter_list|,
name|int
name|slot2
parameter_list|)
block|{
return|return
name|values
index|[
name|slot2
index|]
operator|-
name|values
index|[
name|slot1
index|]
return|;
comment|// values will be small enough that there is no overflow concern
block|}
specifier|public
name|void
name|setBottom
parameter_list|(
name|int
name|slot
parameter_list|)
block|{
name|bottomVal
operator|=
name|values
index|[
name|slot
index|]
expr_stmt|;
block|}
specifier|private
name|int
name|docVal
parameter_list|(
name|int
name|doc
parameter_list|)
throws|throws
name|IOException
block|{
name|BytesRef
name|id
init|=
name|idIndex
operator|.
name|getTerm
argument_list|(
name|doc
argument_list|,
name|tempBR
argument_list|)
decl_stmt|;
name|Integer
name|prio
init|=
name|priority
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
return|return
name|prio
operator|==
literal|null
condition|?
literal|0
else|:
name|prio
operator|.
name|intValue
argument_list|()
return|;
block|}
specifier|public
name|int
name|compareBottom
parameter_list|(
name|int
name|doc
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|docVal
argument_list|(
name|doc
argument_list|)
operator|-
name|bottomVal
return|;
block|}
specifier|public
name|void
name|copy
parameter_list|(
name|int
name|slot
parameter_list|,
name|int
name|doc
parameter_list|)
throws|throws
name|IOException
block|{
name|values
index|[
name|slot
index|]
operator|=
name|docVal
argument_list|(
name|doc
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|setNextReader
parameter_list|(
name|IndexReader
name|reader
parameter_list|,
name|int
name|docBase
parameter_list|)
throws|throws
name|IOException
block|{
name|idIndex
operator|=
name|FieldCache
operator|.
name|DEFAULT
operator|.
name|getTermsIndex
argument_list|(
name|reader
argument_list|,
name|fieldname
argument_list|)
expr_stmt|;
block|}
specifier|public
name|Comparable
name|value
parameter_list|(
name|int
name|slot
parameter_list|)
block|{
return|return
name|values
index|[
name|slot
index|]
return|;
block|}
block|}
return|;
block|}
block|}
end_class
end_unit
